(function(S,w){typeof exports=="object"&&typeof module!="undefined"?w(exports):typeof define=="function"&&define.amd?define(["exports"],w):(S=typeof globalThis!="undefined"?globalThis:S||self,w(S.BimccGraph={}))})(this,function(S){"use strict";var ht=Object.defineProperty;var lt=(S,w,P)=>w in S?ht(S,w,{enumerable:!0,configurable:!0,writable:!0,value:P}):S[w]=P;var r=(S,w,P)=>(lt(S,typeof w!="symbol"?w+"":w,P),P);var be=(S,w,P)=>new Promise((me,ee)=>{var he=L=>{try{y(P.next(L))}catch(g){ee(g)}},ye=L=>{try{y(P.throw(L))}catch(g){ee(g)}},y=L=>L.done?me(L.value):Promise.resolve(L.value).then(he,ye);y((P=P.apply(S,w)).next())});var w=(d=>(d[d.UNSPECIFIED=0]="UNSPECIFIED",d[d.INPUT=1]="INPUT",d[d.OUTPUT=2]="OUTPUT",d))(w||{});let P=d=>crypto.getRandomValues(new Uint8Array(d)),me=(d,t,e)=>{let i=(2<<Math.log(d.length-1)/Math.LN2)-1,s=-~(1.6*i*t/d.length);return(o=t)=>{let n="";for(;;){let a=e(s),l=s;for(;l--;)if(n+=d[a[l]&i]||"",n.length===o)return n}}},ee=(d,t=21)=>me(d,t,P),he=(d=21)=>crypto.getRandomValues(new Uint8Array(d)).reduce((t,e)=>(e&=63,e<36?t+=e.toString(36):e<62?t+=(e-26).toString(36).toUpperCase():e>62?t+="-":t+="_",t),"");class ye{constructor(t){r(this,"handlerList",[]);r(this,"id");this.id=t}add(t){this.handlerList.push(t)}dispatch(...t){for(let e of this.handlerList)e(...t)}remove(t){const e=this.handlerList.indexOf(t);e!==-1&&this.handlerList.splice(e,1)}}var y=(d=>(d.Node="RenderNode",d.Link="RenderLink",d.UI="RenderUI",d))(y||{}),L=(d=>(d.Dom="DomRender",d.Svg="SvgRender",d.DomUI="DomUIRender",d))(L||{}),g=(d=>(d.MouseMove="MouseMove",d.MouseDown="MouseDown",d.MouseUp="MouseUp",d.SelectedNode="SelectedNode",d.NodeDown="NodeDown",d.NodeUp="NodeUp",d.NodeEnter="NodeEnter",d.NodeLeave="NodeLeave",d.DragNodeStart="DragNodeStart",d.DragNodeMove="DragNodeMove",d.DragNodeEnd="DragNodeEnd",d.WidgetDown="WidgetDown",d.WidgetUp="WidgetUp",d.WidgetEnter="WidgetEnter",d.WidgetLeave="WidgetLeave",d.SlotDown="SlotDown",d.SlotUp="SlotUp",d.SlotEnter="SlotEnter",d.SlotLeave="SlotLeave",d.DragSlotStart="DragSlotStart",d.DragSlotMove="DragSlotMove",d.DragSlotEnd="DragSlotEnd",d.DragViewStart="DragViewStart",d.DragViewMove="DragViewMove",d.DragViewEnd="DragViewEnd",d.OpenContextMenu="ContextMenu",d.CloseContextMenu="CloseContextMenu",d.OpenAssociativeMenu="OpenAssociativeMenu",d.CloseAssociativeMenu="CloseAssociativeMenu",d.Click="Click",d.DoubleClick="dblClick",d.DoubleLeftClick="DoubleLeftClick",d.DoubleRightClick="DoubleRightClick",d.ViewScale="ViewScale",d.ViewResize="ViewResize",d.LinksFresh="LinksFresh",d.AddRunLog="AddRunLog",d))(g||{}),M=(d=>(d.AddNode="ActionAddNode",d.RemoveNode="ActionRemoveNode",d.CloneNode="ActionCloneNode",d.AddNodeInput="ActionAddNodeInput",d.AddNodeOutput="ActionAddNodeOutput",d.FocusOnNode="FocusOnNode",d.StopRun="StopRun",d.StartRun="StartRun",d.RemoveNodeSlot="RemoveNodeSlot",d))(M||{}),z=(d=>(d.Resize="NodeRenderResize",d.Refresh="NodeRenderRefresh",d.Down="NodeRenderDown",d))(z||{}),we=(d=>(d.BeforeExecute="NodeBeforeExecute",d.AfterExecute="NodeAfterExecute",d))(we||{}),Y=(d=>(d.Widget="WidgetCustomEvetns",d.Node="NodeCustomEvetns",d))(Y||{});class Me{constructor(){r(this,"signalMap",{});r(this,"readOnly",!1)}create(t){const e=new ye(t);return this.signalMap[t]=e,e}delete(t){delete this.signalMap[t]}get(t){return this.signalMap[t]}add(t,e){this.signalMap[t]&&this.signalMap[t].add(e)}dispatch(t,...e){if(!this.signalMap[t])return;const i=[g.DragViewMove,g.ViewScale,Y.Widget,Y.Node];(!this.readOnly||i.indexOf(t)>-1)&&this.signalMap[t].dispatch(...e)}remove(t,e){this.signalMap[t]&&this.signalMap[t].remove(e)}setReadOnly(t){this.readOnly=t}}const Pe=d=>d===void 0,Ie=d=>d===null,Ve=({x:d,y:t})=>({x:d/Math.sqrt(Math.pow(d,2)+Math.pow(t,2)),y:t/Math.sqrt(Math.pow(d,2)+Math.pow(t,2))}),$e=({x:d,y:t})=>{let e=0,i=0;return t!==0?(e=1,i=-d/t):(i=1,e=-t/d),Ve({x:e,y:i})},He=d=>Object.prototype.toString.apply(d),V=d=>He(d)==="[object Number]",Se=(d=100)=>new Promise(t=>{setTimeout(()=>{t()},d)}),Ue=d=>{if(d.length===1)return!1;for(let t of d){let e=!1;const i=t.node;for(let s of i.outputs){for(let o of s.link){if(d.indexOf(o.targetNode.render)!==-1){e=!0;break}if(e)break}if(e)break}if(!e){for(let s of i.inputs){if(s.link&&d.indexOf(s.link.originNode.render)!==-1){e=!0;break}if(e)break}if(!e)return!1}}return!0},H=class H{constructor(t="div"){r(this,"DOM");this.DOM=document.createElement(t)}setId(t){return this.DOM.id=`${H.prefix}${t}`,this}getClientWidth(){return this.DOM.clientWidth}getClientHeight(){return this.DOM.clientHeight}getOffsetHeight(){return this.DOM.offsetHeight}getOffsetWidth(){return this.DOM.offsetWidth}getOffsetLeft(){return this.DOM.offsetLeft}getOffsetTop(){return this.DOM.offsetTop}setStyle(t){for(let e in t)this.DOM.style[e]=t[e];return this}setPosition(t="absolute",e=0,i=0,s=0,o="px"){return this.setStyle({position:t,top:V(e)?`${e}${o}`:e,left:V(i)?`${i}${o}`:i,zIndex:V(s)?`${s}`:s})}setAbsolute(t=0,e=0,i=0,s="px"){return this.setPosition("absolute",t,e,i,s)}setLeft(t,e="px"){return this.setStyle({left:V(t)?`${t}${e}`:t})}setRight(t,e="px"){return this.setStyle({right:V(t)?`${t}${e}`:t})}setTop(t,e="px"){return this.setStyle({top:V(t)?`${t}${e}`:t})}addClass(t){return this.DOM.classList.add(`${H.prefix}${t}`),this}removeClass(t){return this.DOM.classList.remove(`${H.prefix}${t}`),this}replaceClass(t,e){return this.DOM.classList.replace(`${H.prefix}${t}`,`${H.prefix}${e}`),this}show(){return this.setStyle({display:"block"})}isShow(){return this.DOM.style.display==="block"}hide(){return this.setStyle({display:"none"})}isHidden(){return this.DOM.style.display==="none"}toggle(){return this.DOM.style.display==="none"?this.show():this.hide(),this}setWidth(t,e="",i="px"){return this.setStyle({[`${e}${e?"W":"w"}idth`]:V(t)?`${t}${i}`:t})}setHeight(t,e="",i="px"){return this.setStyle({[`${e}${e?"H":"h"}eight`]:V(t)?`${t}${i}`:t})}setBackgroundColor(t){return this.setStyle({backgroundColor:t})}setBackground(t,e="Color"){return this.setStyle({[`background${e}`]:e==="Color"?t:`url(${t})`,backgroundSize:"100% 100%"})}setAttribute(t,e){return this.DOM.setAttribute(t,e),this}removeAttribute(t){this.DOM.removeAttribute(t)}getAttribute(t){return this.DOM.getAttribute(t)}setContentEditable(t=!1){return this.DOM.setAttribute("contentEditable",t.toString()),this}setPadding(t){return this.setStyle({padding:t})}setPaddingTop(t){return this.setStyle({paddingTop:t})}setPaddingBottom(t){return this.setStyle({paddingBottom:t})}setPaddingLeft(t){return this.setStyle({paddingLeft:t})}setPaddingRight(t){return this.setStyle({paddingRight:t})}setMargin(t){return this.setStyle({margin:t})}setMarginTop(t){return this.setStyle({marginTop:t})}setMarginLeft(t){return this.setStyle({marginLeft:t})}setMarginRight(t){return this.setStyle({marginRight:t})}setMarginBottom(t){return this.setStyle({marginBottom:t})}setFontSize(t,e="px"){return this.setStyle({fontSize:`${t}${e}`})}add(t){var e;return typeof t=="string"?this.DOM.appendChild(document.createTextNode(t)):this.DOM.appendChild((e=t.DOM)!=null?e:t),this}setBoxShadow(t="#ccc 0px 0px 10px 1px"){return this.setStyle({boxShadow:t})}setBorderRadius(t="5px"){return this.setStyle({borderRadius:t})}setColor(t){return this.setStyle({color:t})}setFlex(t="flex"){return this.setStyle({display:t})}setFlexWrap(t="nowrap"){return this.setStyle({flexWrap:t})}setJustifyContent(t="flex-start"){return this.setStyle({justifyContent:t})}setAlignItems(t="center"){return this.setStyle({alignItems:t})}setFlexDirection(t){return this.setStyle({flexDirection:t})}setOverflow(t="visible"){return this.setStyle({overflow:t})}setUserSelect(t="auto"){return this.setStyle({webkitUserSelect:t,userSelect:t})}setCursor(t="auto"){return this.setStyle({cursor:t})}setPointerEvents(t="auto"){return this.setStyle({pointerEvents:t})}setboxSizing(t="content-box"){return this.setStyle({boxSizing:t})}innerText(t){return this.DOM.innerText=t,this}getInnerText(){return this.DOM.innerText}remove(){this.DOM.remove()}clear(){this.DOM.innerHTML=""}onClick(t,e=!1){e?this.DOM.onclick=t:this.DOM.addEventListener("click",i=>{t(i)})}onWheel(t,e=!1,i=!0){e?this.DOM.onwheel=t:this.DOM.addEventListener("wheel",s=>{t(s)},{passive:i})}onContextmenu(t,e=!1){e?this.DOM.onclick=t:this.DOM.addEventListener("contextmenu",i=>{t(i)})}getBoundingClientRect(){return this.DOM.getBoundingClientRect()}onMouseover(t,e=!1){e?this.DOM.onmouseover=t:this.DOM.addEventListener("mouseover",i=>{t(i)})}onMouseout(t,e=!1){e?this.DOM.onmouseout=t:this.DOM.addEventListener("mouseout",i=>{t(i)})}onMousedown(t,e=!1){e?this.DOM.onmousedown=t:this.DOM.addEventListener("mousedown",i=>{t(i)})}onMouseup(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("mouseup",i=>{t(i)})}onMousemove(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("mousemove",i=>{t(i)})}onDblClick(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("dblclick",i=>{t(i)})}};r(H,"prefix","ra-graph-");let I=H;class Ce{constructor(t){r(this,"DOM");this.DOM=document.createElementNS("http://www.w3.org/2000/svg",t)}setAttribute(t,e){return this.DOM.setAttribute(t,e),this}add(t){return this.DOM.appendChild(t.DOM),this}setStyle(t){for(let e in t)this.DOM.style[e]=t[e];return this}show(){return this.setStyle({display:"block"})}isShow(){return this.DOM.style.display==="block"}hide(){return this.setStyle({display:"none"})}remove(){this.DOM.remove()}}class F extends I{constructor(){super();r(this,"id");r(this,"label",null);r(this,"isCustomClick",!1);r(this,"propertyName","");this.id=F.createId()}static createId(){return`widget_${ee("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",10)()}`}getLabel(){return this.label!==null?this.label:""}}class v extends I{}class $ extends I{constructor(e){super("button");r(this,"DOM");this.DOM=document.createElement("button"),this.setStyle({minWidth:"50px",height:"30px",borderRadius:"4px",cursor:"pointer",color:"black",paddingLeft:"5px",paddingRight:"5px"}),this.add(e)}}class te extends I{constructor(e,i){super("input");r(this,"DOM");this.DOM=document.createElement("input"),this.DOM.className="Input",this.DOM.style.padding="2px",this.DOM.style.width="calc(100% - 2px)",this.DOM.style.borderRadius="5px",this.DOM.style.border="1px solid transparent",this.DOM.style.outline="none",this.DOM.setAttribute("autocomplete","off"),this.DOM.addEventListener("keydown",function(s){s.stopPropagation()}),this.setValue(e),this.DOM.setAttribute("placeholder",i)}getValue(){return this.DOM.value}setValue(e){return this.DOM.value=e,this}onChange(e){this.DOM.addEventListener("input",i=>{e(i)})}}class Re extends F{constructor(e){super();r(this,"DOM");r(this,"inputDIVs");r(this,"closure",e=>{});if(this.inputDIVs=new v,this.inputDIVs.setFlex(),this.inputDIVs.setFlexDirection("column"),e!=null&&e.value){let o=[];typeof e.value=="string"?o=e.value.split(","):typeof e.value=="object"&&(o=e.value),o.forEach(n=>{this.addInputDIV(String(n))})}else this.addInputDIV();let i=new v;i.add(this.addButton());let s=new v;s.add(this.inputDIVs).add(i),this.DOM=s.DOM,this.DOM.addEventListener("dblclick",o=>{o.stopPropagation()})}addInputDIV(e=""){let i=new v;i.setStyle({minWidth:"170px"});let s=new te("","请输入");s.setColor("black"),s.DOM.addEventListener("input",()=>{this.closure(this.getValue())}),s.setStyle({width:"140px",marginBottom:"2px",marginRight:"2px"}),s.setValue(e),i.add(s).add(this.delButton(i.DOM)),this.inputDIVs.add(i)}addButton(){let e=new $("+");return e.setStyle({width:"20px",height:"20px"}),e.DOM.addEventListener("click",()=>{this.addInputDIV()}),e}delButton(e){let i=new $("-");return i.setStyle({width:"20px",height:"20px",minWidth:"20px"}),i.DOM.addEventListener("click",()=>{e.remove(),this.closure(this.getValue())}),i}onChange(e){this.closure=e,this.inputDIVs.DOM.childNodes.forEach(i=>{i.firstChild.addEventListener("input",()=>{this.closure(this.getValue())}),i.lastChild.addEventListener("click",()=>{this.closure(this.getValue())})})}getValue(){let e=[];return this.inputDIVs.DOM.childNodes.forEach(i=>{e.push(i.firstChild.value)}),e.join(",")}setValue(e){this.inputDIVs.DOM.childNodes.forEach(s=>{this.inputDIVs.DOM.removeChild(s)});let i=[];typeof e=="string"?i=e.split(","):typeof e=="object"&&(i=e),i.forEach(s=>{this.addInputDIV(String(s))})}}r(Re,"widgetType","array");class K extends I{constructor(t=""){super("span"),t&&(this.DOM.innerText=t)}}class je extends Ce{constructor(){super("svg")}}class Ye extends Ce{constructor(){super("path")}drawFillBezierLine(t,e,i,s,o,n,a){if(isNaN(t.x)||isNaN(t.y)||isNaN(e.x)||isNaN(e.y))return;const l=$e({x:e.x-t.x,y:e.y-t.y});if(isNaN(l.x)||isNaN(l.y))return;const h=[{x:t.x+l.x*i,y:t.y+l.y*i},{x:e.x+l.x*i,y:e.y+l.y*i},{x:e.x+-l.x*i,y:e.y+-l.y*i},{x:t.x+-l.x*i,y:t.y+-l.y*i}],u=[`M ${h[0].x} ${h[0].y} `,`C ${h[0].x+a} ${h[0].y}, ${h[1].x-a} ${h[1].y}, ${h[1].x} ${h[1].y} `,`L ${h[2].x} ${h[2].y} `,`C ${h[2].x-a} ${h[2].y}, ${h[3].x+a} ${h[3].y}, ${h[3].x} ${h[3].y} `,"Z"];this.setAttribute("d",u.join("")),this.setAttribute("stroke",o),this.setAttribute("stroke-width",`${n}`),this.setAttribute("fill",s)}}class Be extends Ce{constructor(){super("circle")}}var E=(d=>(d[d.None=0]="None",d[d.Node=1]="Node",d[d.Slot=2]="Slot",d[d.Widget=3]="Widget",d))(E||{});const Xe=230;class Ge{constructor(t,e){r(this,"rootDom");r(this,"selectedBox",null);r(this,"viewer");r(this,"menuItems");r(this,"mouseInfo");r(this,"viewPosition",{x:0,y:0});r(this,"selectPos",{x:0,y:0});r(this,"events",new Me);r(this,"scale",1);this.viewer=e,this.rootDom=t,this.rootDom.setBackgroundColor("#838383"),this.mouseInfo={button:-1,isDown:!1,isDrag:!1,target:null,type:0,beforePos:{x:0,y:0},enterTarget:null,enterType:0,timeStamp:{mouseDown:0,mouseUp:0}},this.selectedBox=null,this.initEventListener()}getScale(t=!1){return t?this.getParentScale()*this.scale:this.scale}getParentScale(){return this.viewer.graph.parentNode&&this.viewer.graph.parentNode.viewer?1/this.viewer.graph.parentNode.viewer.events.getScale(!0):1}setScale(t){this.scale=t,this.events.dispatch(g.ViewScale,this.scale)}get add(){return this.events.add.bind(this.events)}get dispatch(){return this.events.dispatch.bind(this.events)}get get(){return this.events.get.bind(this.events)}get setReadOnly(){return this.events.setReadOnly.bind(this.events)}initEventListener(){const t=[g.MouseDown,g.MouseUp,g.MouseMove,g.DoubleClick,g.NodeDown,g.DragNodeMove,g.NodeUp,g.SlotDown,g.DragSlotMove,g.SlotUp,g.DragViewStart,g.DragViewMove,g.DragViewEnd,g.OpenContextMenu,g.CloseContextMenu,g.Click,g.OpenAssociativeMenu,g.CloseAssociativeMenu,g.DragSlotStart,g.DragSlotEnd,g.DragNodeStart,g.DragNodeEnd,g.NodeEnter,g.NodeLeave,g.SlotEnter,g.SlotLeave,g.ViewScale,g.ViewResize,g.LinksFresh,g.AddRunLog,g.SelectedNode,g.DoubleRightClick,g.DoubleLeftClick,g.WidgetDown,g.WidgetUp,g.WidgetEnter,g.WidgetLeave,M.AddNode,M.RemoveNode,M.CloneNode,M.AddNodeInput,M.AddNodeOutput,M.FocusOnNode,M.StartRun,M.StopRun,M.RemoveNodeSlot,we.BeforeExecute,we.AfterExecute,Y.Node,Y.Widget];for(let o of t)this.events.create(o);const e=this.mouseInfo;let i=!0;this.rootDom.onContextmenu(o=>{o.preventDefault()}),this.rootDom.onMousedown(o=>{const n=this.rootDom.DOM.querySelectorAll(".ra-graph-select-dropdown");for(const h of n){const u=h;u.style.display="none"}this.rootDom.setCursor("auto");const a=this.rootDom.getBoundingClientRect(),l={x:o.clientX-a.x,y:o.clientY-a.y};if((o.ctrlKey||o.metaKey)&&(this.selectedBox=new v,this.selectPos={x:o.clientX-a.x,y:o.clientY-a.y},this.selectedBox.setStyle({position:"absolute",top:l.y+"px",left:l.x+"px",backgroundColor:"#00BFFF"}),this.rootDom.add(this.selectedBox)),o.ctrlKey||o.metaKey){this.selectedBox=new v,this.selectPos={x:o.clientX-a.x,y:o.clientY-a.y},this.selectedBox.setStyle({position:"absolute",top:l.y+"px",left:l.x+"px",backgroundColor:"rgba(173,175,173,0.3)"}),this.rootDom.add(this.selectedBox);return}this.events.dispatch(g.MouseDown,l),this.events.dispatch(g.CloseAssociativeMenu),this.events.dispatch(g.CloseContextMenu),e.button=o.button,e.isDown=!0,e.timeStamp.mouseDown=new Date().getTime()}),document.addEventListener("mouseup",o=>{const n=new Date().getTime();this.rootDom.setCursor("auto");const a=this.rootDom.getBoundingClientRect(),l={x:o.clientX-a.x,y:o.clientY-a.y};if(this.selectedBox){this.selectedBox.remove(),this.selectedBox=null;const h=l,u=this.selectPos;this.events.dispatch(g.SelectedNode,u,h);return}if(n-e.timeStamp.mouseUp<=Xe)switch(this.events.dispatch(g.DoubleClick,l,o),e.button){case 0:this.events.dispatch(g.DoubleLeftClick,l,e,o);break;case 2:this.events.dispatch(g.DoubleRightClick,l,e,o);break}else{if(this.events.dispatch(g.MouseUp,l),e.isDrag){if(e.button===0)switch(e.type){case 2:this.events.dispatch(g.DragSlotEnd,Object.assign({},l),e.target),e.enterType===0&&this.events.dispatch(g.OpenAssociativeMenu,Object.assign({},l),e.target);break;case 1:this.events.dispatch(g.DragNodeEnd,Object.assign({},l),e.target);break;case 0:this.events.dispatch(g.DragViewEnd,Object.assign({},l),e.target);break}}else e.button===0&&this.events.dispatch(g.Click,{type:e.type,target:e.target,position:Object.assign({},l)});o.button===2&&this.events.dispatch(g.OpenContextMenu,{position:Object.assign({},l),target:e.target,type:e.type})}e.isDown=!1,e.isDrag=!1,e.target=null,e.type=0,e.timeStamp.mouseUp=n,i=!0}),this.rootDom.onMousemove(o=>{const n=this.rootDom.getBoundingClientRect(),a={x:o.clientX-n.x,y:o.clientY-n.y};if(this.selectedBox){let l=0,h=0,u=0,c=0;a.x>=this.selectPos.x&&a.y>=this.selectPos.y?(l=a.x-this.selectPos.x,h=a.y-this.selectPos.y,c=this.selectPos.y,u=this.selectPos.x):a.x>=this.selectPos.x&&a.y<this.selectPos.y?(l=a.x-this.selectPos.x,h=this.selectPos.y-a.y,c=a.y,u=this.selectPos.x):a.x<this.selectPos.x&&a.y<this.selectPos.y?(l=this.selectPos.x-a.x,h=this.selectPos.y-a.y,c=a.y,u=a.x):a.x<this.selectPos.x&&a.y>=this.selectPos.y&&(l=this.selectPos.x-a.x,h=a.y-this.selectPos.y,c=this.selectPos.y,u=a.x),this.selectedBox.setStyle({top:c+"px",left:u+"px",width:l+"px",height:h+"px"});return}if(this.events.dispatch(g.MouseMove,a),e.isDown&&(e.isDrag=!0),e.isDrag){if(e.button===0)switch(e.type){case 2:i&&this.events.dispatch(g.DragSlotStart,Object.assign({},a),e.target),this.events.dispatch(g.DragSlotMove,Object.assign({},a),e.target);break;case 1:i&&this.events.dispatch(g.DragNodeStart,Object.assign({},a),e.target),this.events.dispatch(g.DragNodeMove,Object.assign({},a),e.target);break;case 0:this.rootDom.setCursor("move"),this.viewPosition.x+=a.x-e.beforePos.x,this.viewPosition.y+=a.y-e.beforePos.y,i&&this.events.dispatch(g.DragViewStart,Object.assign({},a),e.target),this.events.dispatch(g.DragViewMove,Object.assign({},a),e.target);break}i=!1}e.beforePos={x:a.x,y:a.y}}),this.rootDom.DOM.addEventListener("wheel",o=>{o.preventDefault();let n=o.clientX-this.rootDom.DOM.getBoundingClientRect().left,a=o.clientY-this.rootDom.DOM.getBoundingClientRect().top;const l=(n-this.viewPosition.x)/this.scale,h=(a-this.viewPosition.y)/this.scale;if(o.altKey||o.ctrlKey||o.metaKey||o.deltaY.toString().indexOf(".")>-1){const u=this.scale-o.deltaY/(o.ctrlKey?200:2e3),c={x:-l*u+n,y:-h*u+a};if(u<.4||u>3)return;this.viewPosition.x=c.x,this.viewPosition.y=c.y,this.setScale(u)}else o.preventDefault(),this.viewPosition.x+=o.deltaX/1.5,this.viewPosition.y+=o.deltaY/1.5,this.events.dispatch(g.DragViewMove,Object.assign({},{x:o.deltaX,y:o.deltaY}),e.target)},{passive:!1}),new ResizeObserver(o=>{for(const n of o){const{width:a,height:l}=n.contentRect;this.events.dispatch(g.ViewResize,a,l)}}).observe(this.rootDom.DOM),this.rootDom.DOM.addEventListener("resize",()=>{this.events.dispatch(g.ViewResize,this.rootDom.DOM.clientWidth,this.rootDom.DOM.clientHeight)}),this.events.add(g.SlotDown,(o,n,a)=>{e.button=o.button,e.isDown=!0,e.type=2,e.target={nodeRender:n,slotRender:a}}),this.events.add(g.NodeDown,(o,n)=>{e.button=o.button,e.isDown=!0,e.type=1,e.target={nodeRender:n}}),this.events.add(g.NodeEnter,o=>{this.mouseInfo.enterTarget=o,this.mouseInfo.enterType=1}),this.events.add(g.NodeLeave,o=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0}),this.events.add(g.SlotEnter,o=>{this.mouseInfo.enterTarget=o,this.mouseInfo.enterType=2}),this.events.add(g.SlotLeave,o=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0}),this.events.add(g.WidgetDown,(o,n,a)=>{e.button=o.button,e.isDown=!0,e.type=3,e.target={nodeRender:n,widget:a}}),this.events.add(g.WidgetEnter,(o,n,a)=>{this.mouseInfo.enterTarget=a,this.mouseInfo.enterType=3}),this.events.add(g.WidgetLeave,(o,n,a)=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0})}}class qe{constructor(){r(this,"zIndex",1e3);r(this,"style",{NodeHighLightColor:"#FFD700",NodeRunningColor:"#00FF00",LineRunningColor:"#00FF00",NodeEventColor:"#00BFFF",NodeTitleColor:"#363636",NodeFontColor:"#ffffff",NodeBackgroundColor:"#4b4b4b"});r(this,"createRandomStyleNode",!0);r(this,"nodeStyles",[{name:"默认",nodeColor:"rgb(75, 75, 75)",nodeTitleColor:"rgb(54, 54, 54)",nodeFontColor:"rgb(255, 255, 255)"},{name:"棕色",nodeColor:"#593930",nodeTitleColor:"#332922",nodeFontColor:"rgb(255, 255, 255)"},{name:"绿色",nodeColor:"#335533",nodeTitleColor:"#223322",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝色",nodeColor:"#333355",nodeTitleColor:"#222233",nodeFontColor:"rgb(255, 255, 255)"},{name:"浅蓝色",nodeColor:"#3F5159",nodeTitleColor:"#2A3638",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝绿色",nodeColor:"#335555",nodeTitleColor:"#223333",nodeFontColor:"rgb(255, 255, 255)"},{name:"紫色",nodeColor:"#553355",nodeTitleColor:"#332233",nodeFontColor:"rgb(255, 255, 255)"},{name:"黄色",nodeColor:"#665533",nodeTitleColor:"#443322",nodeFontColor:"rgb(255, 255, 255)"},{name:"黑色",nodeColor:"#000000",nodeTitleColor:"#222222",nodeFontColor:"rgb(255, 255, 255)"},{name:"深蓝色",nodeColor:"#001f3f",nodeTitleColor:"#0074D9",nodeFontColor:"#FFFFFF"},{name:"橙色",nodeColor:"#FF851B",nodeTitleColor:"#FF4136",nodeFontColor:"#FFFFFF"},{name:"紫红色",nodeColor:"#D5008F",nodeTitleColor:"#FF0066",nodeFontColor:"#FFFFFF"},{name:"柔和粉红",nodeColor:"#FFC0CB",nodeTitleColor:"#FF69B4",nodeFontColor:"#000000"},{name:"海洋蓝",nodeColor:"#0077B6",nodeTitleColor:"#00A8CC",nodeFontColor:"#FFFFFF"},{name:"阳光黄",nodeColor:"#FFD700",nodeTitleColor:"#FFA500",nodeFontColor:"#000000"},{name:"青草绿",nodeColor:"#7CB518",nodeTitleColor:"#4B830D",nodeFontColor:"#FFFFFF"},{name:"玫瑰金",nodeColor:"#E91E63",nodeTitleColor:"#FF5722",nodeFontColor:"#FFFFFF"},{name:"宁静紫",nodeColor:"#8E44AD",nodeTitleColor:"#9B59B6",nodeFontColor:"#FFFFFF"}]);r(this,"showGraphInfo",!0)}getRandomColor(){const t=parseInt((Math.random()*this.nodeStyles.length).toString());return this.nodeStyles[t]}}const N=new qe;class Ne{constructor(t,e,i){r(this,"parent");r(this,"slot");r(this,"parentDom");r(this,"horizontal",{root:new v,pin:new v,label:new v,pinLinked:new v});r(this,"vertical",{root:new v,pin:new v,label:new v,pinLinked:new v});r(this,"linkInfo",null);r(this,"slotSize",10);r(this,"events");this.parent=t,this.slot=i,this.parentDom=e,this.events=t.events,this._initHorizontal(),this._initVertical(),this.setVerticalMode(this.isVerticalMode)}get isVerticalMode(){return!!this.slot.options.isVertical}_initHorizontal(){const{pin:t,label:e,root:i,pinLinked:s}=this.horizontal,o=this.slot;if(this.createPin(t,s),e.setMarginLeft("5px"),e.setMarginRight("5px"),e.setFontSize(13),e.setStyle({whiteSpace:"nowrap"}),e.add(`${o.getLabel()}`),i.setFlex(),i.setStyle({alignItems:"center",marginBottom:"6px"}),o.type===w.INPUT?(i.add(t),i.add(e),i.setJustifyContent("flex-start")):(i.add(e),i.add(t),i.setJustifyContent("flex-end")),o.allow_input){let n=W.createWidget(o.inputWidgetType);n&&(n.setWidth(50,"min"),n.setValue(o.value),n.onChange(a=>{o.value=a}),i.add(n))}this.parentDom.add(i),[t,e].forEach(n=>{n.onMousedown(a=>{a.stopPropagation(),this.events.dispatch(g.SlotDown,a,this.parent,this)}),n.onMouseover(a=>{a.stopPropagation(),this.events.dispatch(g.SlotEnter,this)}),n.onMouseout(a=>{a.stopPropagation(),this.events.dispatch(g.SlotLeave,this)})})}_initVertical(){const{pin:t,label:e,root:i,pinLinked:s}=this.vertical,o=this.slot;this.createPin(t,s),e.setFontSize(13),e.setStyle({whiteSpace:"nowrap"}),e.add(`${o.getLabel()}`),t.setMarginLeft("0px").setMarginRight("0px"),this.slot.type===w.OUTPUT&&t.setBackgroundColor("rgb(54, 54, 54)"),i.setAbsolute(),i.add(t),i.add(e),this.parentDom.add(i),i.setStyle({marginBottom:"6px"}),i.onMousedown(n=>{n.stopPropagation(),this.events.dispatch(g.SlotDown,n,this.parent,this)}),[t,e].forEach(n=>{n.onMouseover(a=>{a.stopPropagation(),this.events.dispatch(g.SlotEnter,this)}),n.onMouseout(a=>{a.stopPropagation(),this.events.dispatch(g.SlotLeave,this)})})}refreshVerticalPosition(){return be(this,null,function*(){yield Se(0);const{pin:t,label:e,root:i,pinLinked:s}=this.vertical,o=this.parent.getContent().getClientWidth(),n=this.parent.getContent().getClientHeight(),a=this.slot;let l=0,h=0,u=0,c=0;if(e.setAbsolute().setLeft(-e.getClientWidth()/2+this.slotSize/2),a.type===w.INPUT){l=-this.slotSize/2;for(let p of a.node.inputs)p!==a&&(p.options.isVertical?u+=1:p.index<a.index&&(c+=1));e.setTop(-17)}else{l=n-this.slotSize/2;for(let p of a.node.outputs)p!==a&&(p.options.isVertical?u+=1:p.index<a.index&&(c+=1));e.setTop(13)}h=o/(u+2)*(a.index+1-c)-this.slotSize/2,i.setTop(l).setLeft(h)})}createPin(t=null,e=null){return t||(t=new v),e||(e=new v),e.setWidth(this.slotSize-2,"min"),e.setHeight(this.slotSize-2,"min"),e.setMarginTop("1px"),e.setMarginLeft("1px"),this.slot.valueType==oe||Array.isArray(this.slot.valueType)&&this.slot.valueType.indexOf(oe)>-1?e.setBackgroundColor(N.style.NodeHighLightColor):(e.setBackgroundColor(N.style.LineRunningColor),e.setStyle({borderRadius:"50%"}),t.setStyle({borderRadius:"50%"})),e.hide(),t.setWidth(this.slotSize,"min"),t.setHeight(this.slotSize,"min"),t.setMarginLeft("5px"),t.setMarginRight("5px"),t.setStyle({backgroundColor:"#767676",border:"1px solid rgb(36 36 36)"}),t.add(e),{pin:t,pinLinked:e}}onNodeInited(){this.refreshVerticalPosition()}setVerticalMode(t){this.slot.options.isVertical=t,t?(this.horizontal.root.hide(),this.refreshVerticalPosition()):this.vertical.root.hide()}getWidth(){return this.isVerticalMode?0:this.horizontal.root.getClientWidth()}setLinked(t){t?(this.horizontal.pinLinked.show(),this.vertical.pinLinked.show()):(this.horizontal.pinLinked.hide(),this.vertical.pinLinked.hide())}refresh(){const{label:t}=this.horizontal,{slot:e}=this;e.type===w.INPUT?this.setLinked(!!e.link):this.setLinked(e.link.length>0);const i=`${e.getLabel()}`;t.getInnerText()!==i&&(t.clear(),t.add(i)),this.refreshVerticalPosition()}getPosition(){const t=this.parent.getPosition();return this.isVerticalMode?{x:t.x+this.vertical.root.getOffsetLeft()+this.slotSize/2,y:t.y+this.vertical.root.getOffsetTop()+this.slotSize/2}:{x:t.x+this.horizontal.pin.getOffsetLeft()+this.slotSize/2,y:t.y+this.horizontal.pin.getOffsetTop()+this.slotSize/2}}getContextMenu(){const t=[];return this.slot.options.remove&&t.push({label:"删除插槽",callback:()=>{this.slot.options.removeFunc&&this.slot.options.removeFunc(this.slot),this.events.dispatch(M.RemoveNodeSlot,this)}}),t}remove(){this.horizontal.root.remove(),this.vertical.root.remove()}}class ke extends Ne{constructor(t,e,i){super(t,e,i)}}class De extends Ne{constructor(t,e,i){super(t,e,i)}}const ve=class ve{constructor(t,e,i,s){r(this,"events");r(this,"renderEvents",new Me);r(this,"node");r(this,"inputs",[]);r(this,"outputs",[]);r(this,"root");r(this,"title");r(this,"body");r(this,"subContent",null);r(this,"inputsDom");r(this,"outputsDom");r(this,"parentDom");r(this,"borderBox");r(this,"dragSpan");r(this,"dragImg","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjkwNTExMDkwODUxIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIyNzkiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik00NTEuMTA5IDk2MEgzNDhsNjEyLTYxMi0xLjY2MyAxMDMuMTA5TDQ1MS4xMDkgOTYweiBtMjY4LjQyNSAwSDYxNmwzNDQtMzQ0djEwMy41MzRMNzE5LjUzNCA5NjB6IiBmaWxsPSIjZjRlYTJhIiBwLWlkPSIyMjgwIj48L3BhdGg+PC9zdmc+");r(this,"viewPosition");r(this,"widgetsBox");r(this,"dragResize",!1);r(this,"minWidth",0);r(this,"minHeight",0);this.parentDom=t,this.node=e,this.root=new v,this.title=new v,this.body=new v,this.borderBox=new v,this.dragSpan=new K,this.inputsDom=new v,this.outputsDom=new v,this.events=s,this.viewPosition=i,this.widgetsBox=new v,this.widgetsBox.setStyle({width:"calc(100% - 4px)",display:"flex",flexDirection:"column"}),this.dragSpan.setStyle({position:"absolute",bottom:"1px",right:"1px",width:"20px",height:"20px",backgroundImage:`url('${this.dragImg}')`,backgroundPosition:"100% 100%",backgroundOrigin:"content-box",backgroundRepeat:"no-repeat",boxSizing:"border-box",cursor:"se-resize",zIndex:"100",pointerEvents:"visible"}),this._init(),this._initEventListener(),this.setTopIndex()}_init(){return be(this,null,function*(){var p,x,f;const{root:t,title:e,body:i,inputsDom:s,outputsDom:o}=this,n=this.node,a=25,l=new v;t.setPosition("absolute",0,0).setStyle({backgroundColor:(p=this.node.options.nodeColor)!=null?p:N.style.NodeBackgroundColor,borderRadius:"8px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",webkitUserSelect:"none",cursor:"pointer",color:(x=this.node.options.nodeFontColor)!=null?x:N.style.NodeFontColor}),n.getOption("clientWidth")&&t.setWidth(n.getOption("clientWidth"),"min"),n.getOption("clientHeight")&&t.setHeight(n.getOption("clientHeight"),"min"),e.setWidth("100%"),e.setHeight(a,"min"),e.setStyle({lineHeight:`${a}px`,textAlign:"center",backgroundColor:(f=this.node.options.nodeTitleColor)!=null?f:N.style.NodeTitleColor,borderRadius:"8px 8px 0px 0px",fontWeight:"bold",padding:"4px 40px",boxSizing:"border-box",whiteSpace:"nowrap"}),this.body.setStyle({height:"auto",padding:"4px",paddingBottom:"8px",minWidth:"120px",paddingTop:"10px"}),e.innerText(n.label),this.borderBox.add(this.dragSpan),this.borderBox.setWidth("100%").setHeight("100%").setPosition("absolute",-4,-4).setStyle({border:"2px solid "+N.style.NodeHighLightColor,borderRadius:"9px",padding:"2px",pointerEvents:"none"}).hide(),l.setFlex(),l.setJustifyContent("space-between"),s.setStyle({flex:"1"}),i.setHeight(`calc( 100% - ${a}px )`);for(let b of n.outputs)this.outputs.push(new De(this,o,b));for(let b of n.inputs)this.inputs.push(new ke(this,s,b));l.add(s).add(o),this.body.add(l).add(this.widgetsBox),this.root.add(this.title).add(this.body).add(this.borderBox),this.parentDom.add(this.root),this.setPosition(n.position.x,n.position.y);const{width:h,height:u}=this.root.getBoundingClientRect();this.minWidth=h,this.minHeight=u;const c=[...this.inputs,...this.outputs];for(let b of c)b.onNodeInited();yield Se(100),this.node.initedRender()})}setTopIndex(){N.zIndex=N.zIndex+1,this.root.setStyle({zIndex:N.zIndex+""})}_initEventListener(){this.renderEvents.create(z.Resize),this.renderEvents.create(z.Refresh),this.root.onMousedown(e=>{e.stopPropagation(),this.events.dispatch(g.NodeDown,e,this),this.setTopIndex(),console.log(`点击了节点【${this.node.label}】【${this.node.id}】`)});let t=null;this.root.onClick(e=>{e.detail===1&&(t=setTimeout(()=>{this.events.dispatch(Y.Node,e,this)},200))}),this.root.onDblClick(e=>{clearTimeout(t)}),this.root.onMouseover(e=>{this.events.dispatch(g.NodeEnter,this)}),this.root.onMouseout(e=>{this.events.dispatch(g.NodeLeave,this)}),this.dragSpan.onMousedown(e=>{e.stopPropagation(),e.preventDefault(),document.onmousemove=i=>{i.stopPropagation(),i.preventDefault();const s=i.clientX,o=i.clientY,{x:n,y:a}=this.root.getBoundingClientRect(),l=s-n,h=o-a;this.setSize(l,h),this.events.dispatch(g.LinksFresh,this.node.graph.runedNodes)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null}})}setSize(t,e){var n,a;const i=this.events.getScale();let s=this.minWidth,o=this.minHeight;if(t>this.minWidth*i&&(s=t/i),e>this.minHeight*i&&(o=e/i),s!=this.minWidth||o!=this.minHeight){for(let l of this.inputs)l.refresh();for(let l of this.outputs)l.refresh();if(this.node.subGraph){const l=this.node;l.minSize&&l.minSize.width*i<=t&&((n=l.graphWidget)==null||n.viewerDom.setWidth((l.originRect.width*i+t-l.minSize.width*i)/i)),l.minSize&&l.minSize.height*i<=e&&((a=l.graphWidget)==null||a.viewerDom.setHeight((l.originRect.height*i+e-l.minSize.height*i)/i))}this.renderEvents.dispatch(z.Resize,s*i,o*i)}this.root.setWidth(s,"min").setHeight(o,"min")}setPosition(t,e){this.events.getScale(),this.root.setLeft(t).setTop(e)}adaption(){const{root:t,title:e,body:i,inputs:s,outputs:o}=this,n=17,a={w:130,h:80};let l=e.getClientWidth(),h=e.getClientHeight(),u=0;for(let x of s){const f=x.getWidth();u<f&&(u=f)}let c=0;for(let x of o){const f=x.getWidth();c<f&&(c=f)}l<c+u&&(l=c+u),l=l>i.getClientWidth()?l:i.getClientWidth();let p=s.length>o.length?s.length:o.length;h+=p*n,h<a.h&&(h=a.h),l<a.w&&(l=a.w),this.setSize(l,h)}getInput(t){return this.inputs[t]}getOutput(t){return this.outputs[t]}getPosition(){return{x:this.node.position.x,y:this.node.position.y}}refresh(){var l;const{root:t,title:e,body:i,inputsDom:s,outputsDom:o}=this;if(this.setPosition(this.node.position.x,this.node.position.y),e.innerText(this.node.label),this.events.viewer.option.nodeIndexShow&&ve.showNodeIndex){let h=new v;h.innerText((l=this.node.index.toString())!=null?l:"\\"),h.setStyle({position:"absolute",left:"2px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",minWidth:"25px",borderRadius:"50%",padding:"0 4px",backgroundColor:"black",color:"white",boxSizing:"border-box"}),e.add(h)}this.node.options.nodeColor&&t.setStyle({backgroundColor:this.node.options.nodeColor}),this.node.options.nodeTitleColor&&e.setStyle({backgroundColor:this.node.options.nodeTitleColor}),this.node.options.nodeFontColor&&t.setStyle({color:this.node.options.nodeFontColor});const n=[],a=[];if(this.node.inputs.length<this.inputs.length){const h=this.inputs.splice(this.node.inputs.length,this.inputs.length-this.node.inputs.length);for(let u of h)u.remove()}if(this.node.outputs.length<this.outputs.length){const h=this.outputs.splice(this.node.outputs.length,this.outputs.length-this.node.outputs.length);for(let u of h)u.remove()}for(let h of this.node.inputs){const u=this.inputs[h.index];if(!u){n.push(new ke(this,s,h));continue}if(u.slot!==h){const c=new ke(this,s,h);h.link&&h.link.info&&(h.link.info.end=c,c.linkInfo=h.link.info),c.refresh(),n.push(c),u.remove()}else u.refresh(),n.push(u)}for(let h of this.node.outputs){const u=this.outputs[h.index];if(!u){a.push(new De(this,o,h));continue}if(u.slot!==h){const c=new De(this,o,h);if(h.link&&h.link.length>0)for(let p of h.link)p.info&&(p.info.start=c,c.linkInfo=p.info);c.refresh(),a.push(c),u.remove()}else u.refresh(),a.push(u)}this.inputs=n,this.outputs=a,this.widgetsBox.clear();for(let h of this.node.widgets){if(h.onMouseover(u=>{this.events.dispatch(g.WidgetEnter,u,this,h)},!0),h.onMouseout(u=>{this.events.dispatch(g.WidgetLeave,u,this,h)},!0),h.onMousedown(u=>{this.events.dispatch(g.WidgetDown,u,this,h)},!0),h.isCustomClick&&h.onClick(u=>{u.stopPropagation(),this.events.dispatch(Y.Widget,u,this,h)},!0),h.getLabel()){let u=new v;u.setFlex().setFlexDirection("row"),u.setStyle({justifyContent:"center",alignItems:"center",paddingLeft:"4px"});let c=new K(h.getLabel());c.setStyle({whiteSpace:"nowrap",lineHeight:"100%",fontSize:"14px",marginRight:"4px"}),h.setStyle({flexGrow:"1"}),u.add(c),u.add(h),u.setMarginBottom("6px"),this.widgetsBox.add(u)}else h.setMarginBottom("6px"),this.widgetsBox.add(h);this.renderEvents.dispatch(z.Refresh)}this.node.onRefresh&&this.node.onRefresh()}remove(){this.root.remove()}getContextMenu(){var i,s;const t=this.node.getContextMenu();!this.node.subGraph&&!this.node.options.notClone&&t.push({label:"克隆节点",callback:()=>{this.events.dispatch(M.CloneNode,this.node.id)}});let e=!1;if(this.node.options.addInput&&this.node.addInputsConfig.length>0){const o=[];for(let n of this.node.addInputsConfig)o.push({label:(i=n.label)!=null?i:"未命名输入",callback:()=>{this.events.dispatch(M.AddNodeInput,this,n)}});t.push({label:"添加输入",subMenu:o}),e=!0}if(this.node.options.addOutput&&this.node.addOutputsConfig.length>0){const o=[];for(let n of this.node.addOutputsConfig)o.push({label:(s=n.label)!=null?s:"未命名输出",callback:()=>{this.events.dispatch(M.AddNodeOutput,this,n)}});t.push({label:"添加输出",subMenu:o}),e=!0}return e&&t.push(null),t.push({label:"删除节点",callback:()=>{this.events.dispatch(M.RemoveNode,this.node.id)}}),t}setHighLight(t=""){this.node.onNodeHighLight(),t&&this.borderBox.setStyle({borderColor:t}),this.borderBox.show(),this.node.options.notResize?this.dragSpan.hide():this.dragSpan.show()}setLabel(t){this.node.setLabel(t),this.refresh()}shake(){const i=Date.now();let s=i,o=()=>{if(s=Date.now(),s-i<500){const a=Math.random()*5*2-5,l=Math.random()*5*2-5;this.root.DOM.style.transform=`translate(${a}px, ${l}px)`,requestAnimationFrame(o)}else this.root.DOM.style.transform="none"};o()}cancelHighLight(){this.borderBox.setStyle({borderColor:N.style.NodeHighLightColor}),this.borderBox.hide()}getContent(){return this.root}removeNode(){this.events.dispatch(M.RemoveNode,this.node.id)}setMinSize(t){this.minWidth=t.width,this.minHeight=t.height}};r(ve,"showNodeIndex",!0);let le=ve;class Ae{constructor(t,e){r(this,"type",L.Dom);r(this,"rootDom");r(this,"events");r(this,"nodeMap",{});r(this,"root");this.rootDom=t,this.events=e,this.root=new v,this.root.setStyle({transformOrigin:"top left"}),this.root.setPosition("absolute",0,0),this.rootDom.add(this.root)}getAllNodes(){return Object.values(this.nodeMap)}addNode(t){if(this.events.viewer.runMode)return null;if(this.nodeMap[t.id])return this.nodeMap[t.id];const e=new le(this.root,t,this.events.viewPosition,this.events);return this.nodeMap[t.id]=e,e}removeNode(t){this.nodeMap[t]&&(this.nodeMap[t].remove(),delete this.nodeMap[t])}getNodeRender(t){return this.nodeMap[t]}getSlotRender(t,e,i){const s=this.getNodeRender(t);return s?i?s.getOutput(e):s.getInput(e):null}refresh(){this.nodeMap;for(let t in this.nodeMap)this.nodeMap[t].refresh()}setPosition(){const t=this.events.getScale(!0),e=this.events.getScale();this.root.setStyle({transform:`scale(${t}) translate(${this.events.viewPosition.x/e}px,${this.events.viewPosition.y/e}px)`});let i=this.events.viewer.graph.getAllSubGraph();i.length&&i.forEach(s=>{s.getNodeManager().setPosition()})}}class ze extends I{constructor(){super("canvas");r(this,"ctx");this.ctx=this.DOM.getContext("2d"),this.ctx.translate(.5,.5)}}class Je{constructor(t,e){r(this,"type",L.Svg);r(this,"rootDom");r(this,"events");r(this,"root");r(this,"linkMap",{});r(this,"tempLine");r(this,"tempPoints");r(this,"commonLinks",{});r(this,"ctx");r(this,"canvas");r(this,"runedNodes",[]);r(this,"tempPointHeight",5);this.rootDom=t,this.events=e;let i=new ze;i.setHeight(this.rootDom.getClientHeight()).setWidth(this.rootDom.getClientWidth());const s=window.devicePixelRatio;i.setAttribute("width",`${this.rootDom.getClientWidth()*s}`),i.setAttribute("height",`${this.rootDom.getClientHeight()*s}`),i.ctx.scale(s,s),i.setStyle({webkitUserSelect:"none",userSelect:"none",position:"absolute",top:"0px",left:"0px",zIndex:"0",pointerEvents:"none"}),this.canvas=i,this.ctx=i.ctx,this.rootDom.DOM.insertBefore(i.DOM,this.rootDom.DOM.firstChild);let o=()=>{this.refresh(),requestAnimationFrame(o)};o();const n=this.root=new je;n.setAttribute("width",`${this.rootDom.getClientWidth()}`),n.setAttribute("height",`${this.rootDom.getClientHeight()}`),n.setStyle({position:"absolute",top:"0px",left:"0px"}),this.tempLine=new Ye,this.tempLine.hide(),this.tempPoints=[new Be,new Be],this.tempPoints[0].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[0].setAttribute("fill","#00ff00"),this.tempPoints[1].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[1].setAttribute("fill","#00ff00"),this.tempPoints[0].hide(),this.tempPoints[1].hide(),this.root.add(this.tempLine),this.root.add(this.tempPoints[0]),this.root.add(this.tempPoints[1]),this.rootDom.add(n.DOM),this.events.add(g.LinksFresh,a=>{a!==null&&(this.runedNodes=a!=null?a:[]),this.refresh()}),this.events.add(g.ViewResize,(a,l)=>{this.root.setAttribute("width",a),this.root.setAttribute("height",l),this.canvas.DOM.setAttribute("height",l),this.canvas.DOM.setAttribute("width",a),this.root.setStyle({width:a+"px",height:l+"px"}),this.canvas.setStyle({width:a+"px",height:l+"px"}),this.refresh()})}clear(){this.commonLinks={},this.refresh()}addLink(t,e,i){const s=e.getPosition(),o=i.getPosition();if(isNaN(s.x)||isNaN(s.y)||isNaN(o.x)||isNaN(o.y))return;const n={start:e,end:i,link:t};this.commonLinks[t.id]=n,e.linkInfo=n,i.linkInfo=n,t.info=n,this.refresh()}removeLink(t){const e=this.commonLinks[t];e&&(e.start.linkInfo=null,e.end.linkInfo=null,e.link.info=null,delete this.commonLinks[t],this.refresh())}getLinkRender(t){return this.linkMap[t]}displayTempLine(t){const e=this.events.getParentScale();this.tempPoints.forEach(i=>{i.setAttribute("r",`${this.tempPointHeight*e}`)}),t?(this.tempLine.show(),this.tempPoints[0].show(),this.tempPoints[1].show()):(this.tempLine.hide(),this.tempPoints[0].hide(),this.tempPoints[1].hide())}setTempLine(t,e,i){const s=this.events.getScale(!0),o=this.events.getParentScale(),n=2*s,a="#00ff00",l="#000000";i?(t={x:t.x*s+this.events.viewPosition.x*o,y:t.y*s+this.events.viewPosition.y*o},e={x:e.x*o,y:e.y*o}):(t={x:t.x*o,y:t.y*o},e={x:e.x*s+this.events.viewPosition.x*o,y:e.y*s+this.events.viewPosition.y*o}),this.tempLine.drawFillBezierLine(t,e,n,a,l,1,10),this.tempPoints[1].setAttribute("cx",`${e.x}`),this.tempPoints[1].setAttribute("cy",`${e.y}`),this.tempPoints[0].setAttribute("cx",`${t.x}`),this.tempPoints[0].setAttribute("cy",`${t.y}`)}refresh(){this.ctx.clearRect(0,0,this.rootDom.getOffsetWidth(),this.rootDom.getOffsetHeight());const t=this.events.getParentScale(),e=window.devicePixelRatio;this.canvas.setAttribute("width",`${this.rootDom.getClientWidth()*e/t}`),this.canvas.setAttribute("height",`${this.rootDom.getClientHeight()*e/t}`),this.canvas.ctx.scale(e/t,e/t),N.showGraphInfo&&(this.ctx.fillStyle="white",this.ctx.font=`${10*t}px Aria`,this.ctx.fillText(`缩放率：${parseInt((this.events.getScale()*100).toString())}%`,10*t,this.rootDom.getOffsetHeight()-40*t),this.ctx.fillText(`连线数：${this.events.viewer.graph.getLinks().length}`,10*t,this.rootDom.getOffsetHeight()-25*t),this.ctx.fillText(`节点数：${this.events.viewer.graph.getNodes().length}`,10*t,this.rootDom.getOffsetHeight()-10*t));for(let i in this.commonLinks){const s=this.commonLinks[i],o=s.start.getPosition(),n=s.end.getPosition(),a=this.getLinkColor(s);this.canvasDrawLink(o,n,a,s.start.isVerticalMode,s.end.isVerticalMode)}}getLinkColor(t){const e=t.start.slot.node.id;let i="black",s=[];this.events.viewer.ActiveNodes.forEach(o=>{s.push(o.node.id)}),X.ActiveNode&&s.push(X.ActiveNode.node.id),t.start.slot.node.options.nodeColor&&(i=t.start.slot.node.options.nodeColor),s.forEach(o=>{(o==e||o==t.end.slot.node.id)&&(i=N.style.NodeHighLightColor)});for(let o=0;o<this.runedNodes.length;o++)this.runedNodes[o].id==e&&(i=N.style.LineRunningColor);return i}canvasDrawLink(t,e,i="black",s=!1,o=!1){const n=this.events.getScale(!0),a=this.events.getParentScale(),l=t.x*n+this.events.viewPosition.x*a,h=t.y*n+this.events.viewPosition.y*a,u=e.x*n+this.events.viewPosition.x*a,c=e.y*n+this.events.viewPosition.y*a;let p=l+50*n,x=h;s&&(p=l,x=h+50*n);let f=u-50*n,b=c;o&&(f=u,b=c-50*n),this.ctx.beginPath(),this.ctx.lineWidth=3*n,this.ctx.strokeStyle=i,this.ctx.moveTo(l,h),this.ctx.bezierCurveTo(p,x,f,b,u,c),this.ctx.stroke()}}class Ke extends v{constructor(e){super();r(this,"viewer");r(this,"nodeManager");r(this,"inputInstance",null);r(this,"nodesBox",null);r(this,"pointer",null);r(this,"searchText",null);r(this,"isCreate",!0);this.viewer=e,this.nodeManager=this.viewer.graph.nodeManager,this.initBox(),this.viewer.events.add(g.DoubleLeftClick,(i,s,o)=>{if(o.target instanceof HTMLCanvasElement||o.target instanceof SVGElement){if(this.viewer.graph.parentNode){const n=this.viewer.graph.parentNode.widgets[0].viewerDom;if(i.x<0||i.y<0||i.x>n.getClientWidth()||i.y>n.getClientHeight())return}if(this.viewer.graph.isInSubgraph(i))this.hide();else{this.showBox(i);return}}else this.hide()}),this.viewer.events.add(g.MouseDown,()=>{this.hide()}),this.onWheel(i=>{i.stopPropagation()})}initBox(){this.setPosition("absolute").setWidth(200).setHeight(200,"min").setBackgroundColor("black").setStyle({opacity:"0.8",cursor:"pointer",display:"flex",flexDirection:"column",transformOrigin:"left top"}).setBorderRadius("20px").setPadding("10px"),this.DOM.addEventListener("dblclick",e=>{e.stopPropagation()}),this.onMousedown(e=>{e.stopPropagation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.hide()}),this.initSearchInput(),this.hide()}initSearchInput(){let e=new v;e.setWidth("100%").setHeight("20px").setMarginBottom("10px");let i=new te("","请输入关键字搜索");i.setWidth("100%").setStyle({opacity:"0.5",border:"0"}).setHeight("100%").setBorderRadius("8px").setPaddingLeft("10px").setMarginLeft("-6px").setColor("black").setFontSize(14),i.onChange(()=>{this.searchText=i.getValue(),this.refreshNodes()}),this.inputInstance=i,e.add(i),this.add(e);let s=new v;s.setStyle({display:"flex",justifyContent:"space-between",paddingBottom:"5px"}),this.add(s);let o=new $("新增节点");o.setWidth("49%").onClick(()=>{this.isCreate||(this.isCreate=!0,o.setBackgroundColor("white").setColor("black"),n.setBackgroundColor("black").setColor("white"),this.refreshNodes())});let n=new $("查询节点");n.setWidth("49%").setBackgroundColor("black").setColor("white").onClick(()=>{this.isCreate&&(this.isCreate=!1,o.setBackgroundColor("black").setColor("white"),n.setBackgroundColor("white").setColor("black"),this.refreshNodes())}),s.add(o).add(n)}refreshNodes(){if(this.nodesBox===null?(this.nodesBox=new v,this.nodesBox.setStyle({flexGrow:"1",overflowY:"auto",backgroundColor:"black",width:"100%",maxHeight:"200px",paddingTop:"5px"}),this.add(this.nodesBox)):this.nodesBox.clear(),this.isCreate)this.nodeManager.getNodeTypeList().forEach(i=>{this.searchText?(i.label.indexOf(this.searchText)>-1||i.type.indexOf(this.searchText)>-1)&&this.createNodeSelectItem(i):this.createNodeSelectItem(i)});else{const i=this.viewer.serialize().nodes;if(!i.length||!this.searchText)return;i.forEach(s=>{var o;JSON.stringify(s).indexOf(this.searchText)>-1&&this.createNodeSelectItem({label:`[${s.index}] ${(o=s._label)!=null?o:s.type}`,type:s.id})})}}createNodeSelectItem(e){var s;let i=new v;i.setColor("white").setStyle({lineHeight:"1.5rem",paddingLeft:".5rem",textAlign:"left"}).onMouseover(()=>{i.setBackgroundColor("white").setColor("black")}),i.onMouseout(()=>{i.setBackgroundColor("black").setColor("white")}),i.onClick(()=>{if(this.isCreate){const o=this.viewer.events.getScale();let n={x:this.pointer.x/o-60-this.viewer.events.viewPosition.x/o,y:this.pointer.y/o-this.viewer.events.viewPosition.y/o,z:0};this.viewer.addNode(e.type,n)}else this.viewer.focusOnNode(e.type);this.hide()}),i.DOM.innerText=e.label,(s=this.nodesBox)==null||s.add(i)}showBox(e){var s,o;this.searchText="",(s=this.inputInstance)==null||s.setValue(""),this.pointer=e;const i=this.viewer.events.getParentScale();this.setLeft(e.x*i-100*i).setTop(e.y*i-20*i).setStyle({transform:`scale(${i})`}),this.refreshNodes(),this.show(),(o=this.inputInstance)==null||o.DOM.focus()}show(){return this.setStyle({display:"flex"}),this}}class Qe extends v{constructor(e,i){super();r(this,"graph");r(this,"logPanel",null);r(this,"events");this.graph=e,this.events=i,this.initBox(),this.initButtons(),this.events.add(g.AddRunLog,s=>{var o;(o=this.logPanel)==null||o.log(s)})}initBox(){this.setStyle({position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"row",background:"black",opacity:"0.8",height:"30px",padding:"8px",borderRadius:"10px",cursor:"pointer",justifyContent:"center",alignItems:"center"}),this.DOM.addEventListener("dblclick",e=>{e.stopPropagation()})}initButtons(){let e=new Ze;e.setMarginRight("10px"),e.onClick(()=>{this.logPanel||(this.logPanel=new et,this.add(this.logPanel)),this.graph.start()}),this.add(e),this.events.add(M.StartRun,()=>{e.DOM.click()});let i=new _e;i.onClick(()=>{var s;(s=this.logPanel)==null||s.remove(),this.logPanel=null,e.stopAnimation(),this.graph.stop(),setTimeout(()=>{this.graph.stop()},this.graph.stepTime)}),this.events.add(M.StopRun,()=>{i.DOM.click()}),this.add(i)}addButton(e){if(!e.name||!e.callback){console.error("无效的按钮");return}let i=new $(e.name);i.onClick(()=>{e.callback()}),i.setMarginLeft("10px"),e.backgroundColor&&i.setBackgroundColor(e.backgroundColor),e.color&&i.setColor(e.color),this.add(i)}}class Ze extends v{constructor(){super();r(this,"isAnimating",!1);r(this,"animationFrameId",0);r(this,"scale",1);r(this,"scaleFactor",.01);r(this,"maxScale",1.2);r(this,"minScale",.8);this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">        <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />        <polygon points="10,7 18,12 10,17" fill="white" />      </svg>',this.setHeight(24),this.onClick(()=>{this.startAnimation()})}startAnimation(){this.isAnimating||(this.isAnimating=!0,this.animateScale())}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,cancelAnimationFrame(this.animationFrameId),this.scale=1,this.updateScale())}animateScale(){this.isAnimating&&(this.scale+=this.scaleFactor,(this.scale>=this.maxScale||this.scale<=this.minScale)&&(this.scaleFactor=-this.scaleFactor),this.updateScale(),this.animationFrameId=requestAnimationFrame(()=>{this.animateScale()}))}updateScale(){this.DOM.style.transform=`scale(${this.scale})`}}class _e extends v{constructor(){super(),this.setHeight(24),this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">    <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />    <rect x="8" y="8" width="8" height="8" stroke="white" stroke-width="2" />  </svg>'}}class et extends v{constructor(){super();r(this,"logs",[]);this.initBox(),this.render()}initBox(){this.setStyle({position:"absolute",left:"-20px",background:"black",height:"20px",width:"20px",top:"0",borderRadius:"6px",padding:"6px",overflowY:"auto",opacity:".8",transition:"all 0.5s ease"}),setTimeout(()=>{this.setWidth("200px").setLeft("-220px").setHeight("200px")},0),this.onWheel(e=>{e.stopPropagation()})}log(e){this.logs.unshift(e),this.render()}render(){this.clear(),this.logs.forEach(e=>{this.createLogItem(e)})}remove(){this.setLeft("0px").setTop(5).setWidth("24px").setHeight("24px"),setTimeout(()=>{this.clear()},300),setTimeout(()=>{super.remove()},500)}createLogItem(e){let i=new v;i.DOM.innerHTML=`节点${e.node.id} [${e.node.label}]：${e.msg}`,i.setStyle({color:"white",fontSize:"12px",padding:"2px",borderBottom:"1px solid white",borderRadius:"4px",cursor:"pointer",userSelect:"none",webkitUserSelect:"none"}),i.onMouseover(()=>{i.setStyle({background:"white",color:"black"})}),i.DOM.addEventListener("dblclick",s=>{s.stopPropagation()}),i.onMouseout(()=>{i.setStyle({background:"black",color:"white"})}),i.onClick(()=>{var s,o;(s=e.node.render)==null||s.events.dispatch(M.FocusOnNode,e.node.id),(o=e.node.render)==null||o.shake()}),this.add(i)}}class Q{constructor(t){r(this,"parent");r(this,"root");r(this,"label");r(this,"input");r(this,"isReadOnly",!1);r(this,"styles",{fontColor:"#ffffff",backColor:"#4b4b4b"});this.parent=t,this.root=new v,this.label=new v,this.input=new te("","请输入"),this.init()}setReadOnly(t){const{input:e}=this;t?(e.setAttribute("readonly","readonly"),e.setStyle({backgroundColor:this.styles.backColor,fontSize:"17px"})):(e.removeAttribute("readonly"),e.setStyle({backgroundColor:"#a8a8a8"})),this.isReadOnly=t}setValue(t,e){this.input.setValue(t),e&&this.label.innerText(e)}onChange(t){this.input.onChange(()=>{t(this.input.getValue())})}init(){const{root:t,label:e,input:i}=this;t.setStyle({display:"flex",width:"calc( 100% - 20px)",height:"30px",margin:"5px 10px 0px 10px",color:this.styles.fontColor,backgroundColor:this.styles.backColor}),e.setStyle({width:"100px",lineHeight:"30px"}),e.innerText("测试"),i.setStyle({lineHeight:"30px",backgroundColor:"#a8a8a8",color:this.styles.fontColor,borderRadius:"2px",fontSize:"16px"}),t.add(e),t.add(i),this.parent.add(t)}refresh(){const{root:t,label:e,input:i}=this;t.setStyle({color:this.styles.fontColor,backgroundColor:this.styles.backColor}),i.setStyle({color:this.styles.fontColor}),this.setReadOnly(this.isReadOnly)}remove(){this.root.remove()}}class tt{constructor(t){r(this,"parent");r(this,"render",null);r(this,"root");r(this,"title");r(this,"body");r(this,"footer");r(this,"isShow",!1);r(this,"onNodeRefresh",null);this.parent=t,this.root=new v,this.title={root:new v,label:new v};const e=new v;let i=new de;e.add(i),this.body={root:e,divider:i,title:new Q(e),idLabel:new Q(e),props:[]},this.body.root.add(new de("属性")),this.footer={root:new v,deleteBtn:new $("删除"),cancelBtn:new $("取消")},this.init()}init(){const{root:t,body:e,title:i,footer:s}=this;this.parent.DOM.addEventListener("mousedown",()=>{this.hide()}),t.setStyle({width:"400px",backgroundColor:"rgb(75 75 75)",borderRadius:"13px",color:"rgb(255 255 255)",transition:"all .5s ease-in-out",overflow:"hidden",border:"2px solid "+N.style.NodeHighLightColor}).setAbsolute(57,420),t.onMousemove(o=>{o.stopPropagation()}),t.onMouseup(o=>{o.stopPropagation()}),t.onMousedown(o=>{o.stopPropagation()}),t.onWheel(o=>{o.stopPropagation()}),this.initTitle(),this.initBody(),this.initFooter(),t.add(i.root),t.add(e.root),t.add(s.root),t.hide(),this.parent.add(this.root),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.isShow&&this.hide()})}initBody(){const{root:t,idLabel:e,title:i}=this.body;t.setStyle({width:"100%",overflowY:"auto",height:"calc(100% - 74px)"}),e.setReadOnly(!0),i.onChange(s=>{this.render.setLabel(s)})}initTitle(){const{root:t,label:e}=this.title;t.setStyle({width:"100%",backgroundColor:"rgb(54 54 54)",height:"40px",borderRadius:"5px 5px 0px 0px",fontWeight:"bold",lineHeight:"40px",textAlign:"center"}),e.innerText("测试"),t.add(e)}initFooter(){const{root:t,deleteBtn:e,cancelBtn:i}=this.footer;t.setStyle({width:"100%",height:"30px",textAlign:"center"}),[e,i].forEach(s=>{s.setStyle({height:"20px",marginTop:"5px"}),s.onMouseover(()=>{s.setStyle({backgroundColor:"#ffffff"})}),s.onMouseout(()=>{s.setStyle({backgroundColor:"#cacaca"})})}),e.onClick(()=>{this.render.removeNode(),this.hide()}),i.onClick(()=>{this.hide()}),i.setMarginLeft("15px"),t.add(e),t.add(i)}refresh(t){const e=this.render=t,i=e.node;this.title.label.innerText(`${i.label}`),this.body.title.setValue(i.label,"标题"),this.body.idLabel.setValue(i.id,"id"),this.body.divider.setMsg(`index: ${i.index.toString()}`);const s=i.getOption("nodeFontColor"),o=i.getOption("nodeTitleColor"),n=i.getOption("nodeColor");this.root.setStyle({backgroundColor:n!=null?n:"#4b4b4b"}),this.title.root.setStyle({backgroundColor:o!=null?o:"rgb(54 54 54)"}),this.body.idLabel.styles.fontColor=s!=null?s:"#ffffff",this.body.idLabel.styles.backColor=n!=null?n:"#4b4b4b",this.body.title.styles.fontColor=s!=null?s:"#ffffff",this.body.title.styles.backColor=n!=null?n:"#4b4b4b",this.body.idLabel.refresh(),this.body.title.refresh();for(let a of this.body.props)a.remove();this.body.props=[];for(let a in i.properties){const l=i.properties[a];switch(typeof l){case"string":const h=new Q(this.body.root);h.setValue(l.toString(),a),h.styles.backColor=n!=null?n:"#4b4b4b",h.styles.fontColor=s!=null?s:"#ffffff",h.refresh(),h.onChange(c=>{i.setProperty(a,c)}),this.body.props.push(h);break;case"number":const u=new Q(this.body.root);u.input.setAttribute("type","number"),u.setValue(l.toString(),a),u.styles.backColor=n!=null?n:"#4b4b4b",u.styles.fontColor=s!=null?s:"#ffffff",u.refresh(),u.onChange(c=>{i.setProperty(a,c)}),this.body.props.push(u);break}}if(e.node.inputs.length){let a=new de("输入参数");this.body.props.push(a),this.body.root.add(a);for(let l=0;l<e.node.inputs.length;l++){const h=e.node.inputs[l],u=new Q(this.body.root);u.setValue(h.label),u.label.innerText("输入"+(l+1)),u.onChange(c=>{var p,x;h.label=c,(x=(p=h.node.render)==null?void 0:p.getInput(l))==null||x.refresh()}),this.body.props.push(u)}}if(e.node.outputs.length){let a=new de("输出参数");this.body.root.add(a),this.body.props.push(a);for(let l=0;l<e.node.outputs.length;l++){const h=e.node.outputs[l],u=new Q(this.body.root);u.setValue(h.label),u.label.innerText("输入"+(l+1)),u.onChange(c=>{var p,x;h.label=c,(x=(p=h.node.render)==null?void 0:p.getOutput(l))==null||x.refresh()}),this.body.props.push(u)}}}show(t){this.render&&this.render.renderEvents.remove(z.Refresh,this.onNodeRefresh);const e=t,i=1/e.events.getScale(!0),s=e.events.getParentScale(),o=e.root.DOM.getBoundingClientRect(),n=this.parent.DOM.getBoundingClientRect(),a=(o.left-n.left)*s,l=(o.top-n.top)*s;this.root.setStyle({position:"absolute",width:o.width+"px",height:o.height+"px",top:l+"px",left:a+"px",opacity:"0.7",zIndex:"99999",boxSizing:"border-box",transformOrigin:"left top"}),setTimeout(()=>{let h=o.width*i*s*2,u=o.height*i*s*2,c=l-(u-o.height)/2*s,p=a-(h-o.width)/2*s;h>=n.width&&(h=n.width,p=0),u>=n.height&&(u=n.height,c=0),p<=0&&(p=0),c<=0&&(c=0),this.root.setStyle({width:h+"px",height:u+"px",left:p+"px",top:c+"px",opacity:"1",transform:`scale(${s})`})},0),this.refresh(t),this.onNodeRefresh=()=>{this.render&&this.refresh(this.render)},t.renderEvents.add(z.Refresh,this.onNodeRefresh),setTimeout(()=>{this.body.root.DOM.scrollTop=0},0),this.root.show(),this.isShow=!0}hide(){if(this.render){this.render.renderEvents.remove(z.Refresh,this.onNodeRefresh);const t=this.render,e=t.events.getParentScale(),i=t.root.DOM.getBoundingClientRect(),s=this.parent.DOM.getBoundingClientRect(),o=(i.left-s.left)*e,n=(i.top-s.top)*e;this.root.setStyle({width:i.width+"px",height:i.height+"px",top:n+"px",left:o+"px"})}Se(450).then(()=>{this.root.hide()}),this.render=null,this.isShow=!1}}class de extends v{constructor(e=""){super();r(this,"label");r(this,"msg","标题");e&&(this.msg=e),this.label=new v,this.init()}init(){this.setStyle({backgroundColor:"rgb(54 54 54)",width:"calc( 100% - 10px )",height:"4px",marginLeft:"5px",marginRight:"5px",marginTop:"15px",marginBottom:"15px",textAlign:"center",position:"relative",userSelect:"auto",webkitUserSelect:"auto"}),this.label.innerText(this.msg).setBackgroundColor("rgb(54 54 54)").setAbsolute().setFontSize(16).setPaddingLeft("10px").setPaddingRight("10px").setTop("-10px").setLeft("10px").setStyle({lineHeight:"24px"}),this.add(this.label)}setMsg(e=""){this.label.innerText(e)}}class it{constructor(t,e){r(this,"type",L.DomUI);r(this,"rootDom");r(this,"events");r(this,"contextMenu");r(this,"associativeMenu");r(this,"nodePanel");r(this,"isShowContextMenu",!1);this.rootDom=t,this.events=e,this.contextMenu=this.createMenu(this.rootDom),this.associativeMenu=this.createMenu(this.rootDom),this.nodePanel=new tt(this.rootDom),this.events.add(g.NodeDown,(i,s)=>{this.nodePanel.render&&s!==this.nodePanel.render&&this.nodePanel.hide()})}createMenu(t){const e=new v;e.setAbsolute(),e.addClass("g-menu").setStyle({minWidth:"88px",width:"88px",minHeight:"20px",backgroundColor:"rgb(59, 59, 59)",borderRadius:"3px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",display:"flex",alignContent:"center",flexWrap:"wrap",flex:"1"}).hide();const i=s=>(s.stopPropagation(),!1);return e.DOM.addEventListener("pointerdown",i),e.DOM.addEventListener("pointerup",i),e.DOM.addEventListener("pointermove",i),e.DOM.addEventListener("mousedown",i),e.DOM.addEventListener("mouseup",i),e.DOM.addEventListener("mousemove",i),e.onWheel(s=>{s.stopPropagation(),s.wheelDelta>0?e.setTop(e.getOffsetTop()+10):e.setTop(e.getOffsetTop()-10)}),t.add(e),{menu:e,width:0,directionX:"left"}}onMenuClick(t,e,i,s,o,n){return()=>{const a=i.menu;o&&o(t);const l=a.DOM.getElementsByClassName(`${v.prefix}g-menu`);for(let h of l)a.DOM.removeChild(h);if(!s)n&&n();else{const h=this.createMenu(a);h.directionX=i.directionX,h.menu.setStyle({display:"flex"}).setLeft(a.DOM.offsetWidth+2).setTop(26*e),i.directionX==="right"&&setTimeout(()=>{h.menu.setLeft(-h.menu.getClientWidth()-3)},0),this.addItemInMenu(t,h,s,n)}}}addItemInMenu(t,e,i,s){const o=e.menu;let n=0;for(let a in i){const l=i[a],h=new v;if(!l)n+=1,h.setStyle({backgroundColor:"#919191",width:"calc( 100% - 10px )",height:"1px",marginLeft:"5px",marginRight:"5px"});else{const{label:u,callback:c,subMenu:p}=l;h.setStyle({height:"18px",width:"100%",color:"white",fontSize:"13px",cursor:"pointer",borderRadius:"3px",padding:"4px",textAlign:"center"}).innerText(u),h.onMouseover(()=>{h.setStyle({backgroundColor:"#505050"})}),h.onMouseout(()=>{h.setStyle({backgroundColor:"rgb(59, 59, 59)"})});const x=Math.trunc(u.length/5);if(x>=1){const f=x*88+u.length%5*.1*88;o.getClientWidth()<f&&o.setWidth(f),e.width=f}else e.width=88;if(p){const f=new v;f.setStyle({position:"absolute",width:"3px",height:"18px",right:"3px",top:`${(parseInt(a)-n)*26+n*1+4}px`,background:"#61ff3c",borderRadius:"5px"}),h.add(f)}h.onClick(this.onMenuClick(t,parseInt(a)-n,e,p,c,s))}o.add(h)}}showMenu(t,e,i){const s=t.menu,o=this.events.getParentScale(),n=this.rootDom.getClientWidth();s.setStyle({transform:`scale(${o})`,transformOrigin:"left top"}),(t.width+e)*o>n?(s.setLeft((e-t.width)*o).setTop(i*o),t.directionX="right"):(s.setLeft(e*o).setTop(i*o),t.directionX="left"),setTimeout(()=>{s.setStyle({display:"flex"})},0)}openContextMenu({x:t,y:e},i){this.contextMenu.menu.innerText(""),this.addItemInMenu({x:t,y:e},this.contextMenu,i,()=>{this.closeContextMenu()}),this.showMenu(this.contextMenu,t,e),this.isShowContextMenu=!0}closeContextMenu(){this.contextMenu.menu.hide(),this.isShowContextMenu=!1}getContextMenu(t){const e=t.graph,i=e.getNodeClassInfo(),s=c=>{const p=this.events.getScale();return x=>{this.events.dispatch(M.AddNode,c,{x:(x.x-this.events.viewPosition.x)/p,y:(x.y-this.events.viewPosition.y)/p})}},o=[],n={};for(let c in i){const{label:p,path:x,notAddContextMenu:f}=i[c];if(f)continue;const b={label:p,callback:s(c)};if(x==="")o.push(b);else{const m=x.split("/");let C="";for(let k in m){const O=m[k],A=`${C}_${O}`;if(parseInt(k)===0){if(!n[A]){const j=[];n[A]=j,o.push({label:O,subMenu:j})}}else if(!n[A]){const j=n[C],ae=[];n[A]=ae,j.push({label:O,subMenu:ae})}parseInt(k)===m.length-1&&n[A].push(b),C=A}}}const a=[],l=e.externalGraph,h=this.events.getScale();for(let c in l){const{name:p,data:x}=l[c];a.push({label:p,callback:f=>{const b=new _;b.deserialize(x);const m=t.addNode(e.subGraphType,{x:(f.x-this.events.viewPosition.x)/h,y:(f.y-this.events.viewPosition.y)/h,z:0});m&&(m.setSubGraph(b),m.refreshViewer(),m.getLabel=()=>p)}})}const u=[{label:"添加节点",subMenu:o}];return a.length!==0&&u.push({label:"游离子图",subMenu:a}),u}openAssociativeMenu(t,e,i,s){const o=[];this.associativeMenu.menu.innerText("");for(let{type:n,label:a,path:l,associativeNode:h}of s)o.push({label:a,callback:()=>{t.viewer&&(i.x-=t.viewer.events.viewPosition.x,i.y-=t.viewer.events.viewPosition.y),this.events.dispatch(M.AddNode,n,i)}});o.length!==0&&(this.addItemInMenu(i,this.associativeMenu,o,()=>{this.closeAssociativeMenu()}),this.showMenu(this.associativeMenu,i.x,i.y))}closeAssociativeMenu(){this.associativeMenu.menu.hide()}openNodePanel(t){this.nodePanel.show(t)}}class st extends ze{constructor(e){super();r(this,"viewer");r(this,"viewStart",null);r(this,"viewEnd",null);this.viewer=e,this.setStyle({position:"absolute",right:"10px",bottom:"10px",width:"304px",height:"204px",background:"black",opacity:"0.8",borderRadius:"10px",cursor:"pointer"});const i=window.devicePixelRatio;this.setAttribute("width",`${304*i}`),this.setAttribute("height",`${204*i}`),this.ctx.scale(i,i);let s=()=>{this.render(),requestAnimationFrame(s)};s(),this.initEvents()}initEvents(){this.onDblClick(i=>{i.stopPropagation()});let e=null;this.onMousedown(i=>{i.stopPropagation(),e={x:i.offsetX,y:i.offsetY},this.setViewPosition({x:i.offsetX,y:i.offsetY})}),this.onMousemove(i=>{e!==null&&(i.stopPropagation(),this.setViewPosition({x:i.offsetX,y:i.offsetY}))}),document.addEventListener("mouseup",i=>{e=null})}setViewPosition(e){const{Xscale:i,Yscale:s,viewStart:o,viewEnd:n,minX:a,minY:l}=this.getViewInfo();let h={x:-a,y:-l},u={x:(e.x-Math.abs(n.x-o.x)/2)/i,y:(e.y-Math.abs(n.y-o.y)/2)/s};const c=this.viewer.events.getScale();h={x:(h.x-u.x)*c,y:(h.y-u.y)*c},this.viewer.events.viewPosition=h,this.viewer.getRenderByTarget(y.Node).setPosition()}getViewInfo(){const e=this.viewer.graph.getNodes(),i=this.viewer.rootDom.DOM.getBoundingClientRect();e.sort((b,m)=>b.position.x-m.position.x);let s=e[e.length-1].position.x;const o=e[0].position.x;e.sort((b,m)=>b.position.y-m.position.y);let n=e[e.length-1].position.y;const a=e[0].position.y;n-a<i.height&&(n=a+i.height),s-o<i.width&&(s=o+i.width);const l=300/(s-o),h=200/(n-a);let u=b=>{let m=(b.position.x-o)*l,C=(b.position.y-a)*h;return{x:m,y:C}};const c=this.viewer.events.getScale(),p=this.viewer.events.viewPosition,x={x:(-p.x/c-o)*l,y:(-p.y/c-a)*h};this.viewStart=x;const f={x:x.x+i.width*l/c,y:x.y+i.height*h/c};return{Xscale:l,Yscale:h,viewStart:x,viewEnd:f,minX:o,minY:a,getMiniPosition:u}}render(){this.ctx.clearRect(0,0,304,204);const e=this.viewer.graph.getNodes();if(!e.length)return;const{viewStart:i,viewEnd:s,getMiniPosition:o}=this.getViewInfo();this.ctx.beginPath(),this.ctx.lineWidth=2,this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(i.x,s.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(s.x,i.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.closePath(),e.forEach(n=>{let a=o(n);this.viewer.graph.checkNodeRuned(n)?(this.ctx.fillStyle=N.style.NodeRunningColor,this.ctx.strokeStyle=N.style.LineRunningColor):(this.ctx.fillStyle=N.style.NodeHighLightColor,this.ctx.strokeStyle="white"),this.ctx.fillRect(a.x,a.y,4,4),this.ctx.lineWidth=1,n.outputs.forEach(l=>{l.link&&l.link.forEach(h=>{this.ctx.beginPath(),this.ctx.moveTo(a.x+2,a.y+2);let u=o(h.target.node);this.ctx.lineTo(u.x+2,u.y+2),this.ctx.stroke(),this.ctx.closePath()})})})}}const B=class B{static error(t=""){B.msg(t,"#fc5d65","#ffedee")}static info(t=""){B.msg(t,"#919398","#eef2fb")}static success(t=""){B.msg(t,"#7ec050","#f2f9ec")}static warning(t=""){B.msg(t,"#DCA550","#fcf6ed")}static msg(t="",e="#000",i="#fff"){t||(t="提示！");let s=new v,o=20;B.msgs.forEach(n=>{o+=n.DOM.getBoundingClientRect().height,o+=10}),s.setBackgroundColor(i).setColor(e).addClass("all-center").addClass("alert-msg-global").setPosition("fixed").setTop("0px").setHeight("40px").setWidth("200px","min").setBorderRadius("10px").setPaddingLeft("20px").setPaddingRight("20px").innerText(t),s.setStyle({lineHeight:"40px",opacity:"0",zIndex:"2001",textAlign:"center",transition:"top 0.5s ease-in-out,opacity 0.5s ease-in-out",fontWeight:"bold"}),setTimeout(()=>{s.setLeft(`calc(50% - ${s.DOM.getBoundingClientRect().width/2}px)`)},0),setTimeout(()=>{s.setStyle({opacity:"1",top:o+"px"})},200),document.body.appendChild(s.DOM),B.msgs.push(s),setTimeout(()=>{s.setStyle({opacity:"0",top:"0px"})},2500),setTimeout(()=>{document.body.removeChild(s.DOM)},3e3),setTimeout(()=>{B.msgs=B.msgs.filter(n=>{})},3200)}};r(B,"msgs",[]);let Z=B;const D=class D{constructor(t=null,e=null,i={controlShow:!0,searchBoxShow:!0,miniMapShow:!0,nodeIndexShow:!0,readonly:!1}){r(this,"rootDom");r(this,"graph");r(this,"runMode",!1);r(this,"events");r(this,"managers",{});r(this,"renderTargetMap",{[y.Node]:L.Dom,[y.Link]:L.Svg,[y.UI]:L.DomUI});r(this,"ActiveNodes",[]);r(this,"tools",{});r(this,"animate",0);r(this,"customContextMenuFuncs",[]);r(this,"option");var u;W.initDefaultWidget(),this.rootDom=new v,t||(this.runMode=!0,t=this.rootDom.DOM),t=t!=null?t:this.rootDom.DOM,this.rootDom.DOM=t,this.rootDom.setStyle({overflow:"hidden",userSelect:"none",webkitUserSelect:"none",position:"relative"}),t.addEventListener("dragstart",c=>{c.preventDefault()}),this.graph=e!=null?e:new _,this.graph.viewer=this,this.events=new Ge(this.rootDom,this);let s=[Je,Ae,it];this.runMode&&(s=[Ae]),this.rootDom.setId(this.graph.id),this.rootDom.setAttribute("graph-id",this.graph.id);for(let c of s){const p=new c(this.rootDom,this.events);this.managers[p.type]=p}this.initEventListener();const{controlShow:o=!0,searchBoxShow:n=!0,miniMapShow:a=!0,nodeIndexShow:l=!0,readonly:h=!1}=i;if(this.option={controlShow:o,searchBoxShow:n,miniMapShow:a,nodeIndexShow:l,readonly:h},this.option.readonly&&this.events.setReadOnly(!0),!this.runMode){if(this.option.searchBoxShow){let c=new Ke(this);this.rootDom.add(c),this.tools.searchBox=c}if(this.option.controlShow){let c=new Qe(this.graph,this.events);this.rootDom.add(c),this.tools.control=c}if(this.option.miniMapShow){let c=new st(this);this.rootDom.add(c),this.tools.miniMap=c}this.graph.parentNode&&((u=this.tools.miniMap)==null||u.hide()),i!=null&&i.backgroundColor&&this.setBackground(i.backgroundColor,"Color"),i!=null&&i.backgroundImage&&this.setBackground(i.backgroundImage,"Image")}}get registerNode(){return this.graph.registerNode.bind(this.graph)}get registerWidget(){return W.registerWidget.bind(this.graph)}get registerExternalGraph(){return this.graph.registerExternalGraph.bind(this.graph)}initEventListener(){document.addEventListener("keydown",e=>{e.code=="Delete"&&D.ActiveNode&&this.graph.runningStatus=="stop"&&this.removeNode(D.ActiveNode.node.id)});const t={x:0,y:0};document.onkeydown=e=>{if(e.key==="Delete"&&(D.ActiveNode&&this.removeNode(D.ActiveNode.node.id),this.ActiveNodes.length>0))for(const i of this.ActiveNodes)this.removeNode(i.node.id)},this.events.add(g.OpenContextMenu,({position:e,type:i,target:s})=>{const o=this.getRenderByTarget(y.UI);if(this.graph.isInSubgraph(e)){o.closeContextMenu();return}if(this.graph.parentNode){const a=this.graph.parentNode.widgets[0],l=a.viewer.events.getParentScale();if(e.x<0||e.y<0||e.x>a.viewerDom.getClientWidth()/l||e.y>a.viewerDom.getClientHeight()/l){o.closeContextMenu();return}}if(!o)return;let n=[];switch(i){case E.Widget:const a=s.widget;if(a.getContextMenu){n=a.getContextMenu();break}else return this.events.dispatch(g.CloseContextMenu),!1;case E.Slot:n=[...s.slotRender.getContextMenu()];case E.Node:const h=s.nodeRender;n=[...n,{label:"运行顺序",subMenu:[{label:"触发条件",callback:()=>{h.node.addInput({label:"触发条件",valueType:[oe],options:{remove:!0}})}},{label:"执行后",callback:()=>{h.node.addOutput({label:"执行后",valueType:oe,options:{remove:!0}})}}]}];const u=N.nodeStyles;let c=[];for(const p of u)c.push({label:p.name,callback:()=>{h.node.setOption("nodeColor",p.nodeColor),h.node.setOption("nodeTitleColor",p.nodeTitleColor),h.node.setOption("nodeFontColor",p.nodeFontColor),h.refresh()}});n=[...n,null,{label:"颜色",subMenu:c}],n=[...n,null,...h.getContextMenu()],this.ActiveNodes.length&&(n=[...n,null,{label:"批量操作",subMenu:[{label:`克隆${this.ActiveNodes.length}个节点`,callback:()=>{let p=[];this.ActiveNodes.forEach(x=>{var b;let f=this.cloneNode(x.node.id);(b=f==null?void 0:f.render)==null||b.setHighLight(),p.push(f==null?void 0:f.render)}),D.ActiveNode=void 0,this.ActiveNodes.forEach(x=>{x.cancelHighLight()}),this.ActiveNodes=p}},{label:`删除${this.ActiveNodes.length}个节点`,callback:()=>{D.ActiveNode=void 0,this.ActiveNodes.forEach(p=>{this.removeNode(p.node.id)}),this.ActiveNodes=[]}},{label:"合并到子图",callback:p=>{this.mergeToSubgraph(this.ActiveNodes)}}]}]);case E.None:n.length>0?n=[...o.getContextMenu(this),null,...n]:n=[...o.getContextMenu(this)]}if(this.graph.parentNode&&(this.graph.parentNode.inputs.length!==0||this.graph.parentNode.outputs.length!==0)){const a=this.getRenderByTarget(y.Node),l=this.graph.parentNode,h=[],u=[],c=[];if(l.outputs.length!==0){let p=!1;for(let x of l.outputs)x.subGraphNode||(h.push({label:x.label,callback:f=>{var m;const b=this.addNode(this.graph.subGraphOutputType,f);b.setParentSlot(x),(m=a.getNodeRender(b.id))==null||m.refresh()}}),p=!0);p&&c.push({label:"外部输出",subMenu:h})}if(l.inputs.length!==0){c.push({label:"外部输入",subMenu:u});for(let p of l.inputs)u.push({label:p.label,callback:x=>{var b;const f=this.addNode(this.graph.subGraphInputType,x);f.setParentSlot(p),(b=a.getNodeRender(f.id))==null||b.refresh()}})}n=[...n,{label:"子图插槽",subMenu:c}]}for(let a of this.customContextMenuFuncs)n=[...n,...a({position:e,type:i,target:s})];o.openContextMenu(e,n)}),this.events.add(g.CloseContextMenu,()=>{const e=this.getRenderByTarget(y.UI);e&&e.closeContextMenu()}),this.events.add(g.DragNodeStart,(e,{nodeRender:i})=>{const s=this.events.getScale();t.x=e.x/s-i.node.position.x,t.y=e.y/s-i.node.position.y}),this.events.add(g.DragNodeMove,(e,{nodeRender:i})=>{const s=this.getRenderByTarget(y.Link),o=this.getRenderByTarget(y.Node);if(!s||!o)return;const n=this.events.getScale(),a={x:e.x/n-t.x,y:e.y/n-t.y,z:0},l=i.node;if(this.ActiveNodes.indexOf(i)>-1){const h={x:a.x-l.position.x,y:a.y-l.position.y};this.ActiveNodes.forEach(u=>{const c={x:u.node.position.x+h.x,y:u.node.position.y+h.y,z:0};u.setPosition(c.x,c.y),u.node.setPosition(c)})}else i.setPosition(a.x,a.y),l.setPosition(a);s.refresh()}),this.events.add(g.DragSlotStart,(e,{nodeRender:i,slotRender:s})=>{var l,h;if(this.graph.runningStatus==="running")return;const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return;o.displayTempLine(!0);const a=s.slot;if(a.type===w.INPUT&&a.link){const u=a.link.origin,c=a.link;o.removeLink(c.id),this.graph.removeLink(c),(l=n.getNodeRender(c.originNode.id))==null||l.refresh(),(h=n.getNodeRender(c.targetNode.id))==null||h.refresh(),this.events.mouseInfo.target={nodeRender:i,slotRender:n.getSlotRender(u.node.id,u.index,!0)}}}),this.events.add(g.DragSlotMove,(e,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return;const a=s.slot;let l=s.getPosition(),h=s.getPosition(),u=!0;a.type===w.INPUT?(l=e,u=!1):h=e,o.setTempLine(l,h,u)}),this.events.add(g.DragSlotEnd,(e,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.Link);if(o){switch(o.displayTempLine(!1),this.events.mouseInfo.enterType){case E.Node:break;case E.Slot:const n=this.events.mouseInfo.enterTarget;if(s.slot.type===n.slot.type||s.slot.node===n.slot.node)return;s.slot.type===w.INPUT?this.addLink(n.slot.node.id,n.slot.index,s.slot.node.id,s.slot.index):this.addLink(s.slot.node.id,s.slot.index,n.slot.node.id,n.slot.index);break;case E.None:break}o.refresh()}}),this.events.add(g.DragViewMove,e=>{const i=this.getRenderByTarget(y.Link),s=this.getRenderByTarget(y.Node);!i||!s||(s.setPosition(),i.refresh())}),this.events.add(g.ViewScale,e=>{const i=this.getRenderByTarget(y.Link);this.getRenderByTarget(y.Node).setPosition(),i.refresh()}),this.events.add(g.MouseDown,()=>{var e;if(this.ActiveNodes.length){for(const i of this.ActiveNodes)i.cancelHighLight();this.ActiveNodes=[]}D.ActiveNode&&!this.graph.checkNodeRuned(D.ActiveNode.node)&&((e=D.ActiveNode)==null||e.cancelHighLight(),D.ActiveNode=void 0)}),this.events.add(g.NodeDown,(e,i)=>{this.getRenderByTarget(y.UI).closeContextMenu(),D.ActiveNode&&!this.graph.checkNodeRuned(D.ActiveNode.node)&&this.ActiveNodes.indexOf(i)==-1&&(D.ActiveNode.cancelHighLight(),this.ActiveNodes.forEach(o=>{o.cancelHighLight()}),this.ActiveNodes=[]),i.setHighLight(),i.node.events.dispatch(z.Down,i),D.ActiveNode=i}),this.events.add(g.SelectedNode,(e,i)=>{const o=this.managers.DomRender.getAllNodes();this.ActiveNodes=[];const n=this.events.getScale();for(const a of o){const l=a.node.position.x*n+this.events.viewPosition.x,h=a.node.position.y*n+this.events.viewPosition.y,u=a.getContent().getClientWidth()*n,c=a.getContent().getClientHeight()*n,p=[l,l+u],x=[h,h+c],f=[e.x,i.x],b=[e.y,i.y],m=(C,k)=>{let O=[Math.min(...C),Math.min(...k)],A=[Math.max(...C),Math.max(...k)];return Math.max(...O)<=Math.min(...A)};m(p,f)&&m(x,b)?(this.ActiveNodes.push(a),a.setHighLight()):a.cancelHighLight()}}),this.events.add(g.OpenAssociativeMenu,(e,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.UI);if(!o)return;const n=i.node;if(n.associativeNode.length>0){const a=[],l=this.graph.getNodeClassInfo();for(let h in l)n.associativeNode.indexOf(h)!==-1&&a.push(l[h]);o.openAssociativeMenu(n,s.slot,e,a)}}),this.events.add(g.CloseAssociativeMenu,()=>{const e=this.getRenderByTarget(y.UI);e&&e.closeAssociativeMenu()}),this.events.add(g.DoubleLeftClick,(e,i,s)=>{const o=this.getRenderByTarget(y.UI);if(o)switch(i.type){case E.Node:const n=i.target.nodeRender;this.focusOnNode(n.node.id,!1,()=>{o.openNodePanel(n)});break}}),this.events.add(M.AddNode,(e,i={x:0,y:0,z:0},s={},o={})=>{this.addNode(e,i,s,o)}),this.events.add(M.RemoveNode,e=>{this.removeNode(e)}),this.events.add(M.CloneNode,e=>{var s,o;let i=this.cloneNode(e);(s=D.ActiveNode)==null||s.cancelHighLight(),(o=i==null?void 0:i.render)==null||o.setHighLight()}),this.events.add(M.AddNodeInput,(e,i)=>{e.node.addInput(i),e.refresh()}),this.events.add(M.AddNodeOutput,(e,i)=>{e.node.addOutput(i),e.refresh()}),this.events.add(M.FocusOnNode,(e,i=!0,s)=>{this.focusOnNode(e,i,s)}),this.events.add(M.RemoveNodeSlot,e=>{const i=e.slot;this.removeSlot(i)})}getRenderByTarget(t){return this.managers[this.renderTargetMap[t]]}getNodeManager(){return this.managers.DomRender}addNode(t,e={x:0,y:0,z:0},i={},s={}){const o=this.graph.createNode(t,e,i,s),n=this.getRenderByTarget(y.Node);if(!n)return null;let a=n.addNode(o);return o.setRender(a),o.setViewer(this),o}addLink(t,e,i,s){const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return null;const a=this.graph.getNode(t),l=this.graph.getNode(i);if(!a||!l||a.outputs.length<=e||l.inputs.length<=s)return;const u=l.inputs[s].link,c=this.graph.addLink(a,e,l,s);if(!c)return;if(u){o.removeLink(u.id);const m=n.getSlotRender(u.originNode.id,u.origin.index,!0);m==null||m.setLinked(!1)}const p=n.getNodeRender(t),x=n.getNodeRender(i);if(!p||!x)return;const f=p.getOutput(e),b=x.getInput(s);!f||!b||(o.addLink(c,f,b),p.refresh(),x.refresh())}cloneNode(t){const e=this.graph.getNode(t);if(!e||e.options.notClone)return;const i={x:20,y:20};let s=e.serialize();s.id=T.createId(),s.position=[e.position.x+i.x,e.position.y+i.y,e.position.z],this.graph.nodeManager.deserializeNode(s);const o=this.graph.getNode(s.id);let a=this.getRenderByTarget(y.Node).addNode(o);return o.setRender(a),o.setViewer(this),o.deserialize(s),o}removeNode(t){const e=this.getRenderByTarget(y.Link),i=this.getRenderByTarget(y.Node);if(!e||!i)return;const s=this.graph.getNode(t);if(s){for(let o of s.getAllLinks())e.removeLink(o.id);i.removeNode(t),this.graph.removeNode(t),i.refresh()}}removeLink(t){const e=this.getRenderByTarget(y.Link),i=this.getRenderByTarget(y.Node);!e||!i||(this.graph.removeLinkById(t),e.removeLink(t),i.refresh())}setScale(t){this.events.setScale(t)}refresh(t=!1){const e=this.graph.getNodes(),i=this.getRenderByTarget(y.Node);if(e.forEach(n=>{if(!i)return null;let a=i.addNode(n);n.setRender(a),n.setViewer(this)}),this.runMode)return;const s=this.graph.getLinks(),o=this.getRenderByTarget(y.Link);s.forEach(n=>{const a=i.getNodeRender(n.originNode.id),l=i.getNodeRender(n.targetNode.id);if(!a||!l)return;const h=a.getOutput(n.origin.index),u=l.getInput(n.target.index);!h||!u||(o.addLink(n,h,u),a.refresh(),l.refresh())}),e.length>0&&t&&this.focusOnNode(e[0].id,!1)}serialize(){let t=this.graph.serialize();return Object.assign({viewPosition:this.events.viewPosition},t)}deserialize(t){this.graph.deserialize(t);const e=this.getRenderByTarget(y.Node);t.viewPosition&&(this.events.viewPosition=t.viewPosition,e.setPosition()),this.refresh()}clearAll(){this.graph.getNodes().forEach(s=>{this.graph.removeNode(s.id)});const e=this.getRenderByTarget(y.Node);this.getRenderByTarget(y.Link).clear(),e.root.clear(),setTimeout(()=>{this.events.dispatch(M.StopRun)},0),this.events.viewPosition.x=0,this.events.viewPosition.y=0,e.setPosition(),this.events.setScale(1)}focusOnNode(t,e=!0,i){cancelAnimationFrame(this.animate);let s=null;if(t)s=this.graph.getNode(t);else{let f=this.graph.getNodes();f.length&&(s=f[0])}if(!s)return;const o=this.getRenderByTarget(y.Node),n=this.events.getScale(),a=o.getNodeRender(s.id);let l=0;const h={x:-s.position.x*n+this.rootDom.DOM.getBoundingClientRect().width/2-a.getContent().getBoundingClientRect().width/2,y:-s.position.y*n+this.rootDom.DOM.getBoundingClientRect().height/2-a.getContent().getBoundingClientRect().height/2},u={x:h.x-this.events.viewPosition.x,y:h.y-this.events.viewPosition.y},c=this.graph.stepTime*.6,p=this.events.viewPosition;if(!t){this.events.viewPosition=u,o.setPosition();return}let x=f=>{l||(l=f);const b=f-l,m=p.x+u.x*(b/c),C=p.y+u.y*(b/c);this.events.viewPosition={x:m,y:C},o.setPosition(),b<=c?this.animate=requestAnimationFrame(x):i&&i()};this.animate=requestAnimationFrame(x),e&&setTimeout(()=>{var f;(f=s.render)==null||f.shake()},this.graph.stepTime*.5)}addCustomContextMenuFunc(t){this.customContextMenuFuncs.push(t)}getActiveNode(){var t;return(t=D.ActiveNode)==null?void 0:t.node}removeSlot(t){if(!t.options.remove)return;const e=this.getRenderByTarget(y.Node);if(!e)return;const i=t.node;if(t.type===w.INPUT)t.link&&this.removeLink(t.link.id);else if(t.link.length>0)for(let o of t.link)this.removeLink(o.id);this.graph.removeSlot(t);const s=e.getNodeRender(i.id);s==null||s.refresh()}setViewerMode(){this.events.setReadOnly(!0)}disbleViewerMode(){this.events.setReadOnly(!1)}setBackground(t,e="Color"){this.rootDom.setBackground(t,e)}mergeToSubgraph(t){if(!Ue(t))return Z.warning("[警告]选中节点并非连续节点，无法合并为子图");const e=t[0].getPosition(),i=this.addNode(this.graph.subGraphType,{x:e.x,y:e.y,z:0}),s=i.subViewer,o=Object.assign({},e),n={},a={};for(let l of t){const h=l.node;let u=h.serialize();u.id=T.createId(),u.position=[h.position.x-o.x,h.position.y-o.y,h.position.z],s.graph.nodeManager.deserializeNode(u);const c=s.graph.getNode(u.id);let x=s.getRenderByTarget(y.Node).addNode(c);c.setRender(x),c.setViewer(s),c.deserialize(u);for(let f of h.inputs.concat()){if(!f.link)continue;const b=f.link;if(t.indexOf(f.link.originNode.render)===-1){const m=i.addInput({label:f.label,valueType:f.valueType.concat(),options:{isVertical:!!f.options.isVertical},defaultValue:f.defaultValue}),C=s.addNode(this.graph.subGraphInputType,{x:c.position.x-128-100,y:c.position.y-f.index*40,z:c.position.z});C.setParentSlot(m),s.addLink(C.id,0,c.id,f.index),this.addLink(f.link.originNode.id,f.link.origin.index,i.id,m.index),this.removeLink(f.link.id)}else if(n[b.originNode.id]){const m=a[n[b.originNode.id]];s.addLink(m.id,b.origin.index,c.id,b.target.index)}}for(let f of h.outputs){let b=!1;for(let m of f.link.concat())if(t.indexOf(m.targetNode.render)===-1){const C=i.addOutput({label:f.label,valueType:f.valueType.concat(),options:{isVertical:!!f.options.isVertical},defaultValue:f.defaultValue}),k=s.addNode(this.graph.subGraphOutputType,{x:c.position.x+128+100,y:c.position.y-f.index*40,z:c.position.z});k.setParentSlot(C),b||(s.addLink(c.id,f.index,k.id,0),b=!0),this.addLink(i.id,C.index,m.targetNode.id,m.target.index)}else if(n[m.targetNode.id]){const C=a[n[m.targetNode.id]];s.addLink(c.id,m.origin.index,C.id,m.target.index)}}n[h.id]=c.id,a[c.id]=c}for(let l of t)this.removeNode(l.node.id)}getChildrenNodes(t=null){let e=[];return t?e.push(this.graph.getChildrenNodes(t)):this.graph.getNodes().forEach(s=>{if(s.inputs.length==0){e.push(this.graph.getChildrenNodes(s));return}let o=!1;s.inputs.forEach(n=>{n.link&&(o=!0)}),o||e.push(this.graph.getChildrenNodes(s))}),e}};r(D,"ActiveNode");let X=D;var ie=(d=>(d[d.min=0]="min",d[d.window=1]="window",d))(ie||{});class Oe extends F{constructor(e){var a;super();r(this,"graph");r(this,"viewer");r(this,"viewerDom");r(this,"minDom");r(this,"mode",1);r(this,"minSize",{w:400,h:300});r(this,"size",{w:this.minSize.w,h:this.minSize.h});const i=this.viewerDom=new v,s=new v;i.setStyle({position:"relative",top:"0px",left:"0px"}),s.setStyle({position:"absolute",top:"10px",left:"10px",width:"26px",height:"26px",backgroundColor:"rgb(26 26 26)",borderRadius:"5px",textAlign:"center",lineHeight:"23px",cursor:"pointer",color:"white"}).innerText("-"),s.onClick(()=>{this.setMode(0)});const o=this.minDom=new v;o.onContextmenu(l=>{l.preventDefault()});const n=new v;o.setStyle({width:"120px",height:"30px"}),n.setStyle({width:"100%",height:"100%",backgroundColor:"#6FA1FF",borderRadius:"6px",textAlign:"center",lineHeight:"30px"}),n.innerText("展开子图"),n.onMouseout(()=>{n.setBackgroundColor("#6FA1FF")}),n.onMouseover(()=>{n.setBackgroundColor("#409eff")}),n.onClick(()=>{this.setMode(1)}),o.add(n),this.add(o),this.add(i),this.graph=(a=e.graph)!=null?a:new _,e.rumMode?this.viewer=new X(null,this.graph):this.viewer=new X(i.DOM,this.graph),i.add(s),this.initEventListener(),this.setMode(this.mode)}initEventListener(){this.onMousedown(e=>{e.stopPropagation()}),this.onMouseup(e=>{}),this.onMousemove(e=>{}),this.onWheel(e=>{e.stopPropagation()}),this.onContextmenu(e=>{e.stopPropagation()})}setMode(e){var i,s,o,n;switch(this.mode=e,e){case 0:if(this.viewerDom.DOM.style.position=="absolute"){Z.warning("子图正处于放大状态，请先退出子图");return}(s=(i=this.graph.parentNode)==null?void 0:i.render)==null||s.widgetsBox.setAlignItems("center"),this.viewerDom.hide(),this.minDom.show();break;case 1:(n=(o=this.graph.parentNode)==null?void 0:o.render)==null||n.widgetsBox.setAlignItems("inherit"),this.viewerDom.show(),this.minDom.hide();break}this.refreshSize(),this.onChangeMode(e)}refreshSize(){switch(this.mode){case 0:this.setWidth(this.minDom.getClientWidth()),this.setHeight(this.minDom.getClientHeight());break;case 1:this.viewerDom.setWidth(this.size.w).setHeight(this.size.h),this.setWidth(this.size.w).setHeight(this.size.h);break}}onChange(e){}getValue(){}setValue(e){}onChangeMode(e){}setGraph(e){this.graph=e,this.viewer.graph=e,this.viewer.tools.control&&(this.viewer.tools.control.graph=e)}refresh(...e){this.viewer.refresh(...e)}changeSize(e){this.size.w+=e.w,this.size.h+=e.h,this.refreshSize()}}r(Oe,"widgetType","graph");class ue extends F{constructor(e){var i;super();r(this,"DOM");this.DOM=document.createElement("input"),this.DOM.type=(i=e==null?void 0:e.type)!=null?i:"text",e!=null&&e.placeholder&&(this.DOM.placeholder=e.placeholder),e!=null&&e.title&&(this.DOM.title=e.title),e!=null&&e.value&&(this.DOM.value=e.value),this.setStyle({flex:"1",border:"0",marginLeft:"4px",borderRadius:"5px",outline:"none",textIndent:"2px",fontSize:"14px",height:"20px",color:"black"}),this.onMousedown(s=>{s.stopPropagation()})}onChange(e){this.DOM.addEventListener("input",()=>{e(this.DOM.value)})}getValue(){return this.DOM.value}setValue(e){this.DOM.value=e}}r(ue,"widgetType","input");class Fe extends I{constructor(e,i){super();r(this,"label");r(this,"value");this.value=i.value,this.label=i.label,this.addClass("select-option").setPadding("5px 10px").setFontSize(14).setBorderRadius(),this.setStyle({pointerEvents:"visible"}),this.DOM.innerText=this.label,this.onMouseover(()=>{this.setBackgroundColor("#f3f4f5")}),this.onMouseout(()=>{this.setBackgroundColor("#fff")}),this.onMousedown(s=>{s.stopPropagation(),e.checked(this)})}active(e=!0){e?this.setColor("#409EFF"):this.setColor("#303133")}}class ot extends I{constructor(t){super(),this.addClass("select-dropdown").setStyle({position:"absolute",left:"2px",top:t,border:"1px solid #ccc",width:"100%",minHeight:"30px",maxHeight:"300px",boxSizing:"border-box",cursor:"pointer",color:"#656464",overflowY:"auto",zIndex:"1"}).setBorderRadius().setBoxShadow("#ccc 0px 0px 5px 1px").setBackgroundColor("#fff"),this.onWheel(e=>{e.stopPropagation()})}}class nt extends I{constructor(e){var i,s,o,n;super();r(this,"input");r(this,"value");r(this,"options");r(this,"multiple");r(this,"disabled");r(this,"dropdown");r(this,"activeOptions");r(this,"onChangeCallback");this.addClass("select").setStyle({position:"relative",padding:"0 3px"}),this.multiple=(i=e==null?void 0:e.multiple)!=null?i:!1,this.disabled=(s=e==null?void 0:e.disabled)!=null?s:!1,this.value=e!=null&&e.value&&!Array.isArray(e.value)?[e.value]:[],this.options=(o=e==null?void 0:e.options)!=null?o:[],this.activeOptions=[],this.onChangeCallback=(n=e==null?void 0:e.onChangeCallback)!=null?n:null,this.input=new te("","请选择"),this.input.DOM.style.cursor="pointer",this.input.setColor("black"),this.input.onClick(a=>{a.preventDefault(),this.dropdown.toggle()}),this.add(this.input),this.dropdown=new ot(`${this.input.DOM.clientHeight+25}px`),this.add(this.dropdown),this.setValue(this.value)}setValue(e){this.value=e;const i=this.getLabel();this.input.setValue(i.join()),this.dropdown.hide(),this.dropdown.clear(),this.options.forEach(s=>{const o=new Fe(this,s);this.dropdown.add(o),this.hasValue(s.value)&&(this.activeOptions.push(o),o.active())}),this.onChangeCallback&&this.onChangeCallback(this.value)}onChange(e){return this.onChangeCallback=e,this}addOption(e){return this.dropdown.add(e),this}checked(e){if(this.multiple){const s=this.activeOptions.indexOf(e);if(s>-1){this.activeOptions[s].active(!1),this.activeOptions.splice(s,1);const o=this.value.indexOf(e.value);this.value.splice(o,1)}else this.activeOptions.push(e),e.active(),this.value.push(e.value)}else this.activeOptions.length&&this.activeOptions[0].active(!1),this.activeOptions[0]=e,e.active(),this.value[0]=e.value,this.dropdown.toggle();const i=this.getLabel();this.input.setValue(i.join()),this.onChangeCallback&&this.onChangeCallback(this.value)}getLabel(e){var i;if(e===void 0){const s=[];return this.options.forEach(o=>{this.hasValue(o.value)&&s.push(o.label)}),s}else{let s=this.options.find(o=>o.value===e);return(i=s==null?void 0:s.label)!=null?i:""}}getValue(){return this.multiple?this.value:this.value[0]}hasValue(e){return this.value.indexOf(e)>-1}}class se extends F{constructor(e){super();r(this,"DOM");r(this,"selectInstance");this.selectInstance=new nt(e),this.DOM=this.selectInstance.DOM}onChange(e){this.selectInstance.onChange(i=>{e(i)})}getValue(){return this.selectInstance.value}setValue(e){this.selectInstance.setValue(e)}setOptions(e){this.selectInstance.dropdown.clear(),this.selectInstance.options=e,e.forEach(i=>{const s=new Fe(this.selectInstance,i);this.selectInstance.dropdown.add(s),this.selectInstance.hasValue(i.value)&&(this.selectInstance.activeOptions.push(s),s.active())})}}r(se,"widgetType","select");class rt extends I{constructor(e){var i,s,o,n,a,l,h,u,c;super();r(this,"input");r(this,"value");r(this,"activeText");r(this,"inactiveText");r(this,"activeValue");r(this,"inactiveValue");r(this,"activeColor");r(this,"inactiveColor");r(this,"disabled");r(this,"activeSpan");r(this,"inactiveSpan");r(this,"coreSpan");r(this,"switchSpan");r(this,"onChangeCallback");this.addClass("switch").setStyle({whiteSpace:"nowrap",textAlign:"right"}),this.value=(i=e==null?void 0:e.value)!=null?i:!1,this.activeText=(s=e==null?void 0:e.activeText)!=null?s:"",this.inactiveText=(o=e==null?void 0:e.inactiveText)!=null?o:"",this.activeValue=(n=e==null?void 0:e.activeValue)!=null?n:!0,this.inactiveValue=(a=e==null?void 0:e.inactiveValue)!=null?a:!1,this.activeColor=(l=e==null?void 0:e.activeColor)!=null?l:"#409EFF",this.inactiveColor=(h=e==null?void 0:e.inactiveColor)!=null?h:"#C0CCDA",this.disabled=(u=e==null?void 0:e.disabled)!=null?u:!1,this.input=new te("","请选择"),this.input.DOM.setAttribute("type","hidden"),this.inactiveSpan=new K,this.activeSpan=new K,this.coreSpan=new K,this.switchSpan=new K,this.onChangeCallback=(c=e==null?void 0:e.onChangeCallback)!=null?c:null,this.add(this.input),this.initSwitchDom()}initSwitchDom(){this.inactiveText&&(this.inactiveSpan.innerText(this.inactiveText),this.inactiveSpan.setStyle({marginRight:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.inactiveColor,lineHeight:"20px"}),this.add(this.inactiveSpan)),this.coreSpan.setStyle({position:"absolute",top:"2px",display:"block",borderRadius:"100%",width:"16px",height:"16px",backgroundColor:"#FFFFFF"});let e=this.value?this.activeColor:this.inactiveColor;this.switchSpan.setStyle({position:"relative",width:"40px",backgroundColor:e,display:"inline-block",height:"20px",borderRadius:"10px",boxSizing:"border-box",cursor:"pointer",transition:"border-color .3s,background-color .3s",verticalAlign:"middle"}),this.switchSpan.add(this.coreSpan),this.value?this.coreSpan.setRight(3):this.coreSpan.setLeft(3),this.add(this.switchSpan),this.switchSpan.onMousedown(i=>{i.stopPropagation(),this.value=!this.value,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)),this.onChangeCallback&&this.onChangeCallback(this.value)}),this.activeText&&(this.activeSpan.innerText(this.activeText),this.activeSpan.setStyle({marginLeft:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.activeColor,lineHeight:"20px"}),this.add(this.activeSpan))}onChange(e){return this.onChangeCallback=e,this}setValue(e){e!==this.value&&(this.value=e,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)))}}class Ee extends F{constructor(e){super();r(this,"DOM");r(this,"switchInstance");this.switchInstance=new rt(e);let i=new v;if(i.setStyle({display:"flex",justifyContent:"space-between"}),e!=null&&e.label){let s=new v,o=e==null?void 0:e.label;s.innerText(o),s.setStyle({fontSize:"14px",lineHeight:"25px",whiteSpace:"nowrap",textIndent:"5px",marginRight:"10px"}),i.add(s)}i.add(this.switchInstance),this.DOM=i.DOM,this.DOM.addEventListener("dblclick",s=>{s.stopPropagation()})}onChange(e){this.switchInstance.onChange(i=>{e(i)})}setValue(e){this.switchInstance.setValue(e)}getValue(){return this.switchInstance.value}}r(Ee,"widgetType","switch");const J=class J{static initDefaultWidget(){const t=[Re,Oe,ue,se,Ee];for(const e in t)J.registerWidget(t[e])}static registerWidget(t){t.prototype instanceof F&&(J.widgetsTypeMap[t.widgetType]||(J.widgetsTypeMap[t.widgetType]=t))}static createWidget(t,e={}){let i=J.widgetsTypeMap[t];return!t||!i?(console.warn(`widget类型:[${t}],并未注册`),new ue(e)):new i(e)}};r(J,"widgetsTypeMap",{});let W=J;const U=class U{constructor(){r(this,"graph");r(this,"id");r(this,"index",0);r(this,"position",{x:0,y:0,z:0});r(this,"events");r(this,"render",null);r(this,"viewer");r(this,"inputs",[]);r(this,"outputs",[]);r(this,"properties",{});r(this,"widgets",[]);r(this,"addInputsConfig",[]);r(this,"addOutputsConfig",[]);r(this,"childrenNode",[]);r(this,"_subGraph",null);r(this,"isEvent",!1);r(this,"options",{});r(this,"_label",this.constructor.NodeLabel);this.id=U.createId(),this.events=new Me}set subGraph(t){this.setSubGraph(t)}get subGraph(){return this._subGraph}get type(){return this.constructor.NodeType}get label(){return this.getLabel()}get associativeNode(){return this.constructor.AssociativeNode}static createId(){return`node_${ee("0123456789",10)()}`}_initOptions(t,e,i={},s={}){this.graph=t,this.position=e;for(let o in i)this.setProperty(o,i[o]);for(let o in s)this.setOption(o,s[o]);this.isEvent&&this.initEvents()}getSlotIndex(t){let e=[];switch(t.type){case w.INPUT:e=this.inputs;break;case w.OUTPUT:e=this.outputs;break}return e.indexOf(t)}initEvents(){}onTrigger(){}initedRender(){}getInput(t){return this.inputs[t]}getInputs(){return this.inputs}getOutputs(){return this.outputs}getInputData(t){var i;let e=this.getInput(t);return e?!(e!=null&&e.link)&&e.allow_input?e.value:(i=e.link)==null?void 0:i.origin.value:null}setOutputData(t,e,i=!1){var o;let s=this.getOutput(t);s&&(s.value=e,i&&((o=this.render)==null||o.outputs[t].refresh()))}beforeExecute(){}invoke(){this.graph.nodeRunning(this,this)}run(t=null){this.viewer&&this.viewer.events.dispatch("NodeBeforeExecute",this),this.beforeExecute(),this.onExecute(),this.afterExecute(),this.viewer&&this.viewer.events.dispatch("NodeAfterExecute",this)}doNext(t=null){this.outputs.forEach(e=>{e.link.forEach(i=>{this.graph.nodeRunning(i.targetNode,t)})})}afterExecute(){}onExecute(){}getOutput(t){return this.outputs[t]}addSlot(t){switch(t.node!==this&&(t.node=this),t.type){case w.INPUT:this.inputs.push(t);break;case w.OUTPUT:this.outputs.push(t);break}}addInput(t){var i;let e=G.create(this,t);return(i=this.render)==null||i.refresh(),e}addOutput(t){var i;const e=q.create(this,t);return(i=this.render)==null||i.refresh(),e}clone(){const t=this.graph.createNode(this.type,this.position,Object.assign({},this.properties));for(let e of this.inputs)e.clone(t);for(let e of this.outputs)e.clone(t);return t}serialize(){var n,a;const t=[],e=[],i={},s=[this.position.x,this.position.y,this.position.z];for(let l of this.inputs)t.push(l.serialize());for(let l of this.outputs)e.push(l.serialize());i.clientWidth=(n=this.render)==null?void 0:n.root.getClientWidth(),i.clientHeight=(a=this.render)==null?void 0:a.root.getClientHeight(),this.options.addInput&&(i.addInput=!0),this.options.addOutput&&(i.addOutput=!0),this.options.nodeColor&&(i.nodeColor=this.options.nodeColor),this.options.nodeTitleColor&&(i.nodeTitleColor=this.options.nodeTitleColor),this.options.nodeFontColor&&(i.nodeFontColor=this.options.nodeFontColor);const o={id:this.id,type:this.type,index:this.index,_label:this._label,position:s,inputs:t,outputs:e,properties:Object.assign({},this.properties),options:i};return this.subGraph&&(o.subGraph=this.subGraph.serialize()),o}deserialize(t){}setPosition(t){this.position=t}getAllLinks(){let t=[];for(let e of this.inputs)e.link&&t.push(e.link);for(let e of this.outputs)t=t.concat(e.link);return t}getAddInputs(){return[]}getAddOutputs(){return[]}setProperty(t,e){this.properties[t]=e,this.widgets.forEach(i=>{i.propertyName==t&&(i instanceof se&&(e=[e]),i.setValue(e))})}setInitProperty(t,e){this.properties[t]===void 0&&(this.properties[t]=e)}getProperty(t){return this.properties[t]}getOption(t){return this.options[t]}setOption(t,e){this.options[t]=e}getLabel(){return this._label||(this._label=this.constructor.NodeLabel),this._label}setLabel(t){this._label=t}onNodeHighLight(){}addWidget(t,e,i,s){let o=null;return this.runMode?t==Oe.widgetType?(e.rumMode=this.runMode,o=W.createWidget(t,e)):o=W.createWidget("input",this.options):o=W.createWidget(t,e),o?(i&&(o.label=i),s&&(o.propertyName=s,o.onChange(n=>{o instanceof se&&(n=n[0]),this.properties[s]=n})),this.widgets.push(o),setTimeout(()=>{var n;(n=this.render)==null||n.refresh()},0),o):null}getWidgetIndex(t){for(let e=0;e<this.widgets.length;e++)if(this.widgets[e]===t)return e;return-1}getWidget(t){let e=this.widgets[t];return e||null}setWidget(t,e){this.widgets[t]=e}removeWidget(t){let e=this.getWidget(t);e&&(e.remove(),this.widgets.splice(t,1))}renderInit(t){}setRender(t){this.render=t,this.renderInit(t)}setSubGraph(t){t&&(this._subGraph=t,t.parentNode=this)}getContextMenu(){return[]}onRemove(){}setViewer(t){this.viewer=t}};r(U,"NodeType","Node"),r(U,"NodeLabel","基础"),r(U,"NodePath",""),r(U,"AssociativeNode",[]),r(U,"NotAddContextMenu",!1);let T=U;class G{constructor(t,{label:e,valueType:i,options:s,defaultValue:o,allow_input:n,value:a,inputWidgetType:l},h=!0){r(this,"type",w.INPUT);r(this,"link",null);r(this,"label","未命名输入");r(this,"node");r(this,"valueType",[]);r(this,"options",{});r(this,"defaultValue",null);r(this,"allow_input",!1);r(this,"inputWidgetType","input");r(this,"value","");r(this,"subGraphNode",[]);this.node=t,e&&(this.label=e),i&&(this.valueType=i),s&&(this.options=s),n&&(this.allow_input=n),l&&(this.inputWidgetType=l),a&&(this.value=a),!Pe(o)&&!Ie(o)&&(this.defaultValue=o),h&&t.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(t,{label:e,valueType:i,options:s,defaultValue:o,allow_input:n,value:a,inputWidgetType:l},h=!0){return G.create(t,{label:e,valueType:i,options:s,defaultValue:o,allow_input:n,value:a,inputWidgetType:l},h)}static create(t,e={},i=!0){return new G(t,e,i)}clone(t){const e=G.create(t,{label:this.label,valueType:this.valueType.concat(),allow_input:this.allow_input,value:this.value,options:Object.assign(this.options)});return t.addSlot(e),e}update(){}destroy(){}serialize(){const t=this.link?this.link.id:null;return{type:this.type,label:this.label,link:t,valueType:this.valueType.concat(),options:Object.assign({},this.options),defaultValue:this.defaultValue,allow_input:this.allow_input,inputWidgetType:this.inputWidgetType,value:this.value}}deleteLink(){this.link=null}getLabel(){return this.label}}class q{constructor(t,{label:e,valueType:i,options:s,defaultValue:o},n=!0){r(this,"value",null);r(this,"type",w.OUTPUT);r(this,"link",[]);r(this,"label","未命名输出");r(this,"node");r(this,"valueType");r(this,"options",{});r(this,"defaultValue",null);r(this,"subGraphNode",null);this.node=t,e&&(this.label=e),s&&(this.options=s),!Pe(o)&&!Ie(o)&&(this.defaultValue=o,this.value=o),this.valueType=i,n&&t.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(t,{label:e,valueType:i,defaultValue:s,options:o},n=!0){return q.create(t,{label:e,valueType:i,defaultValue:s,options:o},n)}static create(t,e,i=!0){return new q(t,e,i)}clone(t){const e=q.create(t,{valueType:this.valueType,label:this.label,options:Object.assign(this.options)});return t.addSlot(e),e}update(){}destroy(){}serialize(){const t=[];for(let e of this.link)t.push(e.id);return{type:this.type,label:this.label,link:t,valueType:this.valueType,options:Object.assign({},this.options),defaultValue:this.defaultValue}}deleteLink(t){const e=this.link.indexOf(t);e!==-1&&this.link.splice(e,1)}hasLink(t){return this.link.indexOf(t)!==-1}getLabel(){return this.label}}class ce{constructor(t,e){r(this,"id");r(this,"origin");r(this,"target");r(this,"valueType");r(this,"index",0);r(this,"info",null);this.id=ce.createId(),this.origin=t,this.target=e,this.valueType=t.valueType,t.link.push(this),e.link=this}get originNode(){return this.origin.node}get targetNode(){return this.target.node}static createId(){return`link-${he(4)}`}static create(t,e){return new ce(t,e)}update(){}serialize(){return[this.id,this.origin.node.id,this.origin.index,this.target.node.id,this.target.index,this.valueType]}}const oe="_EventType",We="any";class _{constructor(){r(this,"subGraphType","subGraph");r(this,"subGraphInputType","subGraphInput");r(this,"subGraphOutputType","subGraphOutput");r(this,"parentNode",null);r(this,"viewer",null);r(this,"id");r(this,"version","1.00");r(this,"nodeManager");r(this,"externalGraph",{});r(this,"runningStatus","stop");r(this,"pauseNodes",[]);r(this,"eventRuns",{});r(this,"runedNodes",[]);r(this,"runtimers",[]);r(this,"stepTime",500);r(this,"waitNodes",[]);this.id=`graph-${he(6)}`,xe.get(),this.nodeManager=new Le(this)}get inputs(){return this.parentNode?this.parentNode.inputs:null}get outputs(){return this.parentNode?this.parentNode.outputs:null}get createNode(){return this.nodeManager.createNode.bind(this.nodeManager)}get getNode(){return this.nodeManager.getNode.bind(this.nodeManager)}get removeNode(){return this.nodeManager.removeNode.bind(this.nodeManager)}get addLink(){return this.nodeManager.addLink.bind(this.nodeManager)}get removeLink(){return this.nodeManager.removeLink.bind(this.nodeManager)}get removeLinkById(){return this.nodeManager.removeLinkById.bind(this.nodeManager)}get getNodeClassInfo(){return this.nodeManager.getNodeClassInfo.bind(this.nodeManager)}get getNodes(){return this.nodeManager.getNodes.bind(this.nodeManager)}get getChildrenNodes(){return this.nodeManager.getChildrenNodes.bind(this.nodeManager)}get getLinks(){return this.nodeManager.getLinks.bind(this.nodeManager)}get registerNode(){return this.nodeManager.register.bind(this.nodeManager)}get removeSlot(){return this.nodeManager.removeSlot.bind(this.nodeManager)}serialize(){const t=this.nodeManager.serialize();return Object.assign({version:this.version},t)}deserialize({nodes:t,links:e}){this.nodeManager.deserialize({nodes:t,links:e})}start(){if(this.runningStatus=="running")return;this.runningStatus="running";let t=this.getNodes(),e=[];t.forEach(s=>{if(s.inputs.length==0){e.push(s);return}let o=!1;s.inputs.forEach(n=>{n.link&&(o=!0)}),o||e.push(s)});let i=[];e.length&&e.forEach((s,o)=>{if(o==0)i.push({node:s,dis:0});else{let n=s.position.x-e[0].position.x,a=s.position.y-e[0].position.y,l=Math.sqrt(n*n+a*a);i.push({node:s,dis:l})}}),i.sort((s,o)=>s.dis-o.dis),i.forEach((s,o)=>{e[o]=s.node}),this.waitNodes=e,this.runByStep()}checkNodeRuned(t,e=null){if(e&&this.eventRuns[e.id]){for(let i=0;i<this.eventRuns[e.id].length;i++)if(this.eventRuns[e.id][i].id==t.id)return!0}else for(let i=0;i<this.runedNodes.length;i++)if(this.runedNodes[i].id==t.id)return!0;return!1}runByStep(t=null){var i,s,o,n;let e=this.waitNodes.shift();e&&(t&&e.id==t.id&&this.eventRuns[t.id]&&this.eventRuns[t.id].length&&(this.eventRuns[t.id].forEach(a=>{var l;(l=a.render)==null||l.cancelHighLight(),this.runedNodes=this.runedNodes.filter(h=>h.id!==a.id)}),this.eventRuns[t.id]=[]),this.checkIfCanRun(e,t)?((i=e.render)==null||i.events.dispatch(M.FocusOnNode,e.id),this.realRun(e,t),e.outputs.forEach(a=>{a.link&&a.link.length&&a.link.forEach(l=>{l.target.node&&this.waitNodes.unshift(l.target.node)})})):this.checkNodeRuned(e,t)||((s=e.render)==null||s.events.dispatch(M.FocusOnNode,e.id),(o=e.render)==null||o.setHighLight(N.style.NodeHighLightColor),(n=e.render)==null||n.shake()),setTimeout(()=>{this.runByStep(t)},this.stepTime))}checkIfCanRun(t,e=null){var s;if(this.runningStatus!=="running"||this.checkNodeRuned(t)&&!e||e&&this.checkNodeRuned(t,e))return!1;let i=!0;for(let o=0;o<t.inputs.length;o++){const n=t.inputs[o];let a=!1;for(let l=0;l<this.runedNodes.length;l++)this.runedNodes[l].id==((s=n.link)==null?void 0:s.origin.node.id)&&(a=!0);if(a||(i=!1),!i&&!n.link&&n.allow_input&&(i=!0),!i&&!n.link&&n.valueType.indexOf(oe)>-1&&(i=!0),!i)break}if(!i)return this.sendLog(t,"等待依赖值中。。。"),!1;if(t.isEvent){for(let o=0;o<this.pauseNodes.length;o++){const n=this.pauseNodes[o];if(n.id==t.id)return e&&e.id==n.id?(this.sendLog(t,"事件【被触发】"),!0):!1}return this.pauseNodes.push(t),t.onTrigger(),this.sendLog(t,"事件等待中。。。"),!1}else return this.sendLog(t),t.onTrigger(),!0}nodeRunning(t,e=null){this.runningStatus==="running"&&(this.waitNodes.length?this.waitNodes.push(t):(this.waitNodes.push(t),this.runByStep(e)))}realRun(t,e=null){this.runedNodes.push(t),e&&(this.eventRuns[e.id]||(this.eventRuns[e.id]=[]),this.eventRuns[e.id].push(t));let i=window.setTimeout(()=>{var s,o,n;(s=t.render)==null||s.events.dispatch(g.LinksFresh,this.runedNodes),t.run(e),e&&((o=t.render)==null||o.shake()),(n=t.render)==null||n.setHighLight(e?N.style.NodeEventColor:N.style.NodeRunningColor)},this.stepTime);this.runtimers.push(i)}pause(){}stop(){var e,i;this.runningStatus="stop",this.waitNodes=[],this.getNodes().forEach(s=>{var o;(o=s.render)==null||o.cancelHighLight()});let t=null;for(;t=this.runtimers.shift();)clearTimeout(t);(i=(e=this.runedNodes[0])==null?void 0:e.render)==null||i.events.dispatch(g.LinksFresh),this.runedNodes=[],this.pauseNodes=[]}sendLog(t,e="已运行"){var i;console.log(`节点${t.id} [${t.label}]：${e}`),(i=t.render)==null||i.events.dispatch(g.AddRunLog,{node:t,msg:e})}registerExternalGraph(t,e,i){this.externalGraph[t]={id:t,name:e,data:i}}isInSubgraph(t){var o;const e=this.getNodes();if(!e.length)return!1;const i=(o=e[0].viewer)==null?void 0:o.rootDom,s={x:t.x+i.getOffsetLeft(),y:t.y+i.getOffsetTop()};for(let n=0;n<e.length;n++){const a=e[n];if(a.subGraph){const h=a.widgets[0].viewerDom.getBoundingClientRect();if(s.x>h.x&&s.x<h.x+h.width&&s.y>h.y&&s.y<h.y+h.height)return!0}}return!1}getAllSubGraph(){const t=this.getNodes();if(!t.length)return[];let e=[];for(let i=0;i<t.length;i++){const s=t[i];if(s.subGraph){const o=s.widgets[0];e.push(o.viewer)}}return e}setStepTime(t){this.stepTime=t}}class ge extends T{constructor(){super();r(this,"graphWidget");r(this,"minSize",null);r(this,"originRect");r(this,"exitFunc",null);r(this,"isMaxmized",!1);r(this,"addInputsConfig",[{label:"输入项",options:{remove:!0},valueType:["any"]}]);r(this,"addOutputsConfig",[{label:"输出项",options:{remove:!0},valueType:"any"}]);this.subGraph=new _,this.subGraph.parentNode=this,this.setOption("addInput",!0),this.setOption("addOutput",!0),this.graphWidget=this.addWidget("graph",{graph:this.subGraph}),this.graphWidget.onChangeMode=e=>{this.graphWidget&&e===ie.min&&setTimeout(()=>{var i;(i=this.render)==null||i.setSize(this.graphWidget.minDom.getClientWidth(),this.graphWidget.minDom.getClientHeight())},0)},this.graphWidget.viewer.events.add(g.MouseUp,()=>be(this,null,function*(){}))}get subViewer(){return!this.graphWidget||!this.graphWidget.viewer?null:this.graphWidget.viewer}refreshViewer(){var e;(e=this.graphWidget)==null||e.refresh(!0)}setSubGraph(e){super.setSubGraph(e),this.graphWidget&&e&&this.graphWidget.setGraph(e)}initedRender(){var i;const e=this.render;e&&(this.minSize=e.getContent().getBoundingClientRect(),this.originRect=(i=this.graphWidget)==null?void 0:i.viewerDom.getBoundingClientRect(),e.events.add(g.ViewResize,()=>{this.exitFunc&&this.exitFunc()}))}onNodeHighLight(){if(this.graphWidget)switch(this.graphWidget.mode){case ie.min:this.setOption("notResize",!0);break;case ie.window:this.setOption("notResize",!1);break}}onRefresh(){const e=this.render;if(!e)return;let i=new v;i.innerText("+"),i.setStyle({position:"absolute",right:"6px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",width:"25px",borderRadius:"50%",backgroundColor:"black",color:"white"}),i.onClick(()=>{this.maxmizeViewer()}),e.title.add(i)}getName(){var e;return(e=this.graph)!=null&&e.parentNode?this.graph.parentNode.getName()+" => "+this.label:this.label}maxmizeViewer(){var p,x,f,b,m,C,k;if(((p=this.graphWidget)==null?void 0:p.mode)==ie.min){Z.warning("子图收缩中，无法放大");return}const e=this.render,i=(x=this.graphWidget)==null?void 0:x.viewer,s=e.events.viewer,o=s==null?void 0:s.rootDom.getBoundingClientRect(),n={position:i==null?void 0:i.rootDom.DOM.style.position,zIndex:i==null?void 0:i.rootDom.DOM.style.zIndex,left:i==null?void 0:i.rootDom.DOM.style.left,top:i==null?void 0:i.rootDom.DOM.style.top,width:i==null?void 0:i.rootDom.DOM.style.width,height:i==null?void 0:i.rootDom.DOM.style.height},a=i==null?void 0:i.events.viewPosition,l=e.events.getScale();i==null||i.rootDom.setAbsolute(-e.events.viewPosition.y-this.position.y,-e.events.viewPosition.x-this.position.x,99999).setWidth(o.width).setHeight(o.height).setStyle({transition:"all .5s ease"}),(f=s==null?void 0:s.tools.miniMap)==null||f.hide(),(b=s==null?void 0:s.tools.control)==null||b.hide();let h=new $("退出子图");h.setStyle({zIndex:"123123",marginLeft:"10px"}),h.onClick(()=>{c()}),(m=i==null?void 0:i.tools.control)==null||m.add(h),(C=i==null?void 0:i.tools.miniMap)==null||C.show(),s.setScale(1);let u=new v;u.innerText(this.getName()).setColor((k=this.getOption("nodeColor"))!=null?k:"white").setFontSize(30).setStyle({fontWeight:"bold",marginTop:"10px",userSelect:"none",webkitUserSelect:"none",width:"100%",textAlign:"center"}),i==null||i.rootDom.add(u),setTimeout(()=>{const O=i==null?void 0:i.graph.getNodes();O&&O.length&&(i==null||i.focusOnNode(O[0].id))},500);let c=()=>{var O,A,j,ae;this.exitFunc=null,s.setScale(l),i==null||i.rootDom.setStyle(n),s.graph.parentNode||(O=s.tools.miniMap)==null||O.show(),s.graph.parentNode&&s.rootDom.DOM.style.position=="absolute"&&((A=s.tools.miniMap)==null||A.show()),(j=s.tools.control)==null||j.setFlex(),h.remove(),u.remove(),(ae=i==null?void 0:i.tools.miniMap)==null||ae.hide(),setTimeout(()=>{i==null||i.rootDom.setStyle({transition:"none"})},500),i.events.viewPosition=a,i==null||i.getNodeManager().setPosition()};this.exitFunc=c}}r(ge,"NodeType","subGraph"),r(ge,"NodeLabel","子图"),r(ge,"NodePath","子图节点");class ne extends T{constructor(){super();r(this,"parentSlot",null);this.setOption("notClone",!0)}getLabel(){var e,i;return(i=(e=this.parentSlot)==null?void 0:e.label)!=null?i:"子图输出"}serialize(){var i,s;const e=super.serialize();return e.subGraphSlotIndex=(i=this.parentSlot)==null?void 0:i.index,e.subGraphSlotNodeId=(s=this.parentSlot)==null?void 0:s.node.id,e}deserialize(e){var l,h;if(!e.subGraphSlotIndex&&e.subGraphSlotIndex!==0||!e.subGraphSlotNodeId)return console.warn("序列化子图插槽失败！");const i=e.subGraphSlotIndex,s=e.subGraphSlotNodeId,o=(h=(l=this.graph)==null?void 0:l.parentNode)==null?void 0:h.graph,n=o==null?void 0:o.getNode(s);if(!n)return console.warn("序列化子图插槽失败！");const a=n.inputs[i];if(!a)return console.warn("序列化子图插槽失败！");this.setParentSlot(a)}onRemove(){this.parentSlot&&this.parentSlot.subGraphNode.splice(this.parentSlot.subGraphNode.indexOf(this),1)}setParentSlot(e){this.outputs=[],this.parentSlot=e,this.addOutput({label:this.parentSlot.label,valueType:this.parentSlot.valueType[0]}),this.parentSlot.subGraphNode.push(this)}}r(ne,"NodeType","subGraphInput"),r(ne,"NodeLabel","子图输出"),r(ne,"NodePath","子图节点"),r(ne,"NotAddContextMenu",!0);class re extends T{constructor(){super();r(this,"parentSlot",null)}getLabel(){var e,i;return(i=(e=this.parentSlot)==null?void 0:e.label)!=null?i:"子图输入"}serialize(){var i,s;const e=super.serialize();return e.subGraphSlotIndex=(i=this.parentSlot)==null?void 0:i.index,e.subGraphSlotNodeId=(s=this.parentSlot)==null?void 0:s.node.id,e}deserialize(e){var l,h;if(!e.subGraphSlotIndex&&e.subGraphSlotIndex!==0||!e.subGraphSlotNodeId)return console.warn("序列化子图插槽失败！");const i=e.subGraphSlotIndex,s=e.subGraphSlotNodeId,o=(h=(l=this.graph)==null?void 0:l.parentNode)==null?void 0:h.graph,n=o==null?void 0:o.getNode(s);if(!n)return console.warn("序列化子图插槽失败！");const a=n.outputs[i];if(!a)return console.warn("序列化子图插槽失败！");this.setParentSlot(a)}onRemove(){this.parentSlot&&(this.parentSlot.subGraphNode=null)}setParentSlot(e){this.inputs=[],this.parentSlot=e,this.addInput({label:this.parentSlot.label,valueType:[this.parentSlot.valueType]}),this.parentSlot.subGraphNode=this}}r(re,"NodeType","subGraphOutput"),r(re,"NodeLabel","子图输入"),r(re,"NodePath","子图节点"),r(re,"NotAddContextMenu",!0);class pe extends T{constructor(){super();r(this,"strInput");this.setProperty("__function__","ConstString"),this.setInitProperty("value",""),this.addOutput({label:"字符串",valueType:"string"}),this.strInput=this.addWidget("input",{placeholder:"请输入字符串"},"字符串","value")}onExecute(){this.setOutputData(0,this.strInput.getValue())}}r(pe,"NodeType","ConstString"),r(pe,"NodeLabel","字符串"),r(pe,"NodePath","基础节点");class fe extends T{constructor(){super();r(this,"numberInput");r(this,"NotAutoRegister",!0);this.setProperty("__function__","ConstantNumber"),this.setInitProperty("value",0),this.addOutput({label:"value",valueType:"number"}),this.numberInput=this.addWidget("input",{type:"number",placeholder:"请输入数字"},"数字","value")}onExecute(){this.setOutputData(0,parseFloat(this.numberInput.getValue()))}}r(fe,"NodeType","ConstantNumber"),r(fe,"NodeLabel","数字"),r(fe,"NodePath","基础节点");const at=Object.freeze(Object.defineProperty({__proto__:null,ConstString:pe,NSubGraph:ge,NSubGraphInput:ne,NSubGraphOutput:re,Number:fe},Symbol.toStringTag,{value:"Module"})),R=class R{constructor(t){r(this,"nodeIndex",-1);r(this,"nodeMap",{});r(this,"linkMap",{});r(this,"linkIndex",-1);r(this,"undefinedType","_undefined");r(this,"graph");this.graph=t,this.initDefaultNode()}initDefaultNode(){const t=at;for(const e in t)t[e].NotAutoRegister||this.register(t[e])}register(t){t.prototype instanceof T&&(R.nodeTypeMap[t.NodeType]||(R.nodeTypeMap[t.NodeType]=t))}createNode(t,e={x:0,y:0,z:0},i={},s={}){if(!R.nodeTypeMap[t])return;const o=R.nodeTypeMap[t];o.prototype.viewer=this.graph.viewer;const n=new o;if(n._initOptions(this.graph,e,i,s),!n.options.nodeColor&&N.createRandomStyleNode){let a=N.getRandomColor();n.setOption("nodeColor",a.nodeColor),n.setOption("nodeFontColor",a.nodeFontColor),n.setOption("nodeTitleColor",a.nodeTitleColor)}return this.addNode(n),n}addNode(t){this.nodeMap[t.id]||(this.nodeMap[t.id]=t,this.nodeIndex+=1,t.index=this.nodeIndex)}getNode(t){return this.nodeMap[t]}getNodes(){return Object.values(this.nodeMap)}reset(){this.nodeMap={},this.linkMap={},this.nodeIndex=-1,this.linkIndex=-1}removeNode(t){if(!this.nodeMap[t])return;const e=this.nodeMap[t];for(let i in this.linkMap){const s=this.linkMap[i];(s.originNode===e||s.targetNode===e)&&this.removeLink(s)}e.onRemove(),delete this.nodeMap[t]}addLink(t,e=0,i,s=0,o=!0){if(t===i)return null;const n=t.getOutput(e),a=i.getInput(s);return!n||!a?(console.warn(`连接失败 输入或输出不存在 输出[${t.id}:${e}] 输入[${i.id}:${s}] `),null):this.addLinkBySolt(n,a,o)}getLinks(){return Object.values(this.linkMap)}addLinkBySolt(t,e,i=!0){if(!this.canLink(t,e,i))return null;i&&e.link&&this.removeLink(e.link);const s=ce.create(t,e);return this.linkIndex+=1,s.index=this.linkIndex,this.linkMap[s.id]=s,s}canLink(t,e,i=!0){if(t.type!==w.OUTPUT||e.type!==w.INPUT)return console.warn("连接失败 参数错误"),!1;if(e.valueType.indexOf(t.valueType)===-1&&e.valueType.indexOf(We)===-1&&t.valueType!==We){let s=`连接失败 输入[${e.node.id}:${e.index}]接受类型为[${e.valueType.join(",")}] 连接类型为[${t.node.id}:${t.index}]->${t.valueType}`;console.warn(s);let o=`【类型不匹配】[ ${t.valueType} ] => 连接至 => [ ${e.valueType.join(",")} ]`;return Z.warning(o),!1}return e.node===t.node?(console.warn(`连接失败 不允许自身连接 [${e.node.id}]`),!1):!i&&e.link?(console.warn("连接失败 非强制连接模式已有连线"),!1):!0}removeLinkById(t){this.linkMap[t]&&this.removeLink(this.linkMap[t])}removeLink(t){const e=t.origin,i=t.target;i.link!==t||!e.hasLink(t)||(i.deleteLink(),e.deleteLink(t),delete this.linkMap[t.id])}getNodeList(){return Object.values(this.nodeMap).sort((e,i)=>e.index-i.index)}getLinkList(){return Object.values(this.linkMap).sort((e,i)=>e.index-i.index)}serialize(){const t={nodes:[],links:[]};for(const e of this.getNodeList())t.nodes.push(e.serialize());for(const e of this.getLinkList())t.links.push(e.serialize());return t}deserialize({nodes:t,links:e}){this.reset();const i=[];for(let s of t)i.push(this.deserializeNode(s));for(let s of i)s();for(let s of e)this.deserializeLink(s)}deserializeLink([t,e,i,s,o]){if(!this.nodeMap[e]||!this.nodeMap[s])return console.warn(`连接反序列失败 [${e}]-[${s}],无此节点`);const n=this.nodeMap[e],a=this.nodeMap[s];if(!this.addLink(n,i,a,o))return console.warn(`连接反序列失败 [${e}]-[${s}]`)}deserializeNode(t){var m,C;T.prototype.runMode=(m=this.graph.viewer)==null?void 0:m.runMode;const{id:e,type:i,position:s,inputs:o,outputs:n,properties:a,options:l,subGraph:h,index:u,_label:c}=t;let p=R.nodeTypeMap[i];p||(console.warn(`节点类型:[${i}],并未注册`),p=T);const x=new p;x._initOptions(this.graph,{x:s[0],y:s[1],z:(C=s[2])!=null?C:0},a,l),x.id=e,x._label=c;const f=[],b=[];o.forEach((k,O)=>{x!=null&&x.inputOptions&&(x!=null&&x.inputOptions[O])&&(k=Object.assign(k,x.inputOptions[O])),f.push(G.deserialize(x,k,!1))});for(let k of n)b.push(q.deserialize(x,k,!1));if(x.inputs=f,x.outputs=b,this.addNode(x),u&&(u<this.nodeIndex?x.index=this.nodeIndex:x.index=u),this.nodeIndex<u&&(this.nodeIndex=u+1),h){const k=x,O=new _;x.setSubGraph(O),O.deserialize(h),k.refreshViewer()}return()=>{x.deserialize(t)}}getNodeTypeList(){const t=[];for(let e in R.nodeTypeMap){const i=R.nodeTypeMap[e];["subGraphInput","subGraphOutput"].indexOf(e)>-1||t.push({label:i.NodeLabel,type:e})}return t}getNodeClassInfo(){const t={};for(let e in R.nodeTypeMap){const i=R.nodeTypeMap[e];t[i.NodeType]={type:i.NodeType,path:i.NodePath,label:i.NodeLabel,associativeNode:i.AssociativeNode,notAddContextMenu:i.NotAddContextMenu}}return t}removeSlot(t){const e=t.node;if(t.type===w.INPUT)t.link&&this.removeLinkById(t.link.id),e.inputs.splice(t.index,1);else{if(t.link.length>0)for(let i of t.link)this.removeLinkById(i.id);e.outputs.splice(t.index,1)}}getChildrenNodes(t){let e=[];return t.getOutputs().forEach(i=>{i.link.forEach(s=>{let o=s.target.node;this.getChildrenNodes(o),e.push(o)})}),t.childrenNode=e,t}};r(R,"nodeTypeMap",{});let Le=R,Te=null;class xe{constructor(){r(this,"defaultType");r(this,"typeMap",{});const t=[{id:"any",label:"通用类型"},{id:"string",label:"字符串"},{id:"number",label:"数字"},{id:"array",label:"数组"}];for(let e of t)this.register(e);this.defaultType=t[0].id}static get(){return Te||(Te=new xe),Te}register(t){this.typeMap[t.id]=t}get(t){return this.typeMap[t]}}S.BaseWidget=F,S.DataTypeMananger=xe,S.DomNodeRender=le,S.DomSlotRender=Ne,S.Graph=_,S.GraphViewer=X,S.InputWidget=ue,S.NativeDiv=v,S.Node=T,S.NodeInput=G,S.NodeOutput=q,S.SelectWidget=se,S.WidgetsManager=W,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
