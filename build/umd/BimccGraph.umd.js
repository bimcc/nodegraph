(function(C,w){typeof exports=="object"&&typeof module!="undefined"?w(exports):typeof define=="function"&&define.amd?define(["exports"],w):(C=typeof globalThis!="undefined"?globalThis:C||self,w(C.BimccGraph={}))})(this,function(C){"use strict";var ae=Object.defineProperty;var he=(C,w,L)=>w in C?ae(C,w,{enumerable:!0,configurable:!0,writable:!0,value:L}):C[w]=L;var a=(C,w,L)=>(he(C,typeof w!="symbol"?w+"":w,L),L);var mt=(C,w,L)=>new Promise((bt,tt)=>{var ht=O=>{try{y(L.next(O))}catch(c){tt(c)}},yt=O=>{try{y(L.throw(O))}catch(c){tt(c)}},y=O=>O.done?bt(O.value):Promise.resolve(O.value).then(ht,yt);y((L=L.apply(C,w)).next())});var w=(d=>(d[d.UNSPECIFIED=0]="UNSPECIFIED",d[d.INPUT=1]="INPUT",d[d.OUTPUT=2]="OUTPUT",d))(w||{});let L=d=>crypto.getRandomValues(new Uint8Array(d)),bt=(d,e,t)=>{let i=(2<<Math.log(d.length-1)/Math.LN2)-1,s=-~(1.6*i*e/d.length);return(o=e)=>{let n="";for(;;){let r=t(s),l=s;for(;l--;)if(n+=d[r[l]&i]||"",n.length===o)return n}}},tt=(d,e=21)=>bt(d,e,L),ht=(d=21)=>crypto.getRandomValues(new Uint8Array(d)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class yt{constructor(e){a(this,"handlerList",[]);a(this,"id");this.id=e}add(e){this.handlerList.push(e)}dispatch(...e){for(let t of this.handlerList)t(...e)}remove(e){const t=this.handlerList.indexOf(e);t!==-1&&this.handlerList.splice(t,1)}}var y=(d=>(d.Node="RenderNode",d.Link="RenderLink",d.UI="RenderUI",d))(y||{}),O=(d=>(d.Dom="DomRender",d.Svg="SvgRender",d.DomUI="DomUIRender",d))(O||{}),c=(d=>(d.MouseMove="MouseMove",d.MouseDown="MouseDown",d.MouseUp="MouseUp",d.SelectedNode="SelectedNode",d.NodeDown="NodeDown",d.NodeUp="NodeUp",d.NodeEnter="NodeEnter",d.NodeLeave="NodeLeave",d.DragNodeStart="DragNodeStart",d.DragNodeMove="DragNodeMove",d.DragNodeEnd="DragNodeEnd",d.WidgetDown="WidgetDown",d.WidgetUp="WidgetUp",d.WidgetEnter="WidgetEnter",d.WidgetLeave="WidgetLeave",d.SlotDown="SlotDown",d.SlotUp="SlotUp",d.SlotEnter="SlotEnter",d.SlotLeave="SlotLeave",d.DragSlotStart="DragSlotStart",d.DragSlotMove="DragSlotMove",d.DragSlotEnd="DragSlotEnd",d.DragViewStart="DragViewStart",d.DragViewMove="DragViewMove",d.DragViewEnd="DragViewEnd",d.OpenContextMenu="ContextMenu",d.CloseContextMenu="CloseContextMenu",d.OpenAssociativeMenu="OpenAssociativeMenu",d.CloseAssociativeMenu="CloseAssociativeMenu",d.Click="Click",d.DoubleClick="dblClick",d.DoubleLeftClick="DoubleLeftClick",d.DoubleRightClick="DoubleRightClick",d.ViewScale="ViewScale",d.ViewResize="ViewResize",d.LinksFresh="LinksFresh",d.AddRunLog="AddRunLog",d))(c||{}),S=(d=>(d.AddNode="ActionAddNode",d.RemoveNode="ActionRemoveNode",d.CloneNode="ActionCloneNode",d.AddNodeInput="ActionAddNodeInput",d.AddNodeOutput="ActionAddNodeOutput",d.FocusOnNode="FocusOnNode",d.StopRun="StopRun",d.StartRun="StartRun",d.RemoveNodeSlot="RemoveNodeSlot",d))(S||{}),z=(d=>(d.Resize="NodeRenderResize",d.Refresh="NodeRenderRefresh",d.Down="NodeRenderDown",d))(z||{}),j=(d=>(d.Widget="WidgetCustomEvetns",d.Node="NodeCustomEvetns",d))(j||{});class wt{constructor(){a(this,"signalMap",{});a(this,"readOnly",!1)}create(e){const t=new yt(e);return this.signalMap[e]=t,t}delete(e){delete this.signalMap[e]}get(e){return this.signalMap[e]}add(e,t){this.signalMap[e]&&this.signalMap[e].add(t)}dispatch(e,...t){if(!this.signalMap[e])return;const i=[c.DragViewMove,c.ViewScale,j.Widget,j.Node];(!this.readOnly||i.indexOf(e)>-1)&&this.signalMap[e].dispatch(...t)}remove(e,t){this.signalMap[e]&&this.signalMap[e].remove(t)}setReadOnly(e){this.readOnly=e}}const Lt=d=>d===void 0,Tt=d=>d===null,Wt=({x:d,y:e})=>({x:d/Math.sqrt(Math.pow(d,2)+Math.pow(e,2)),y:e/Math.sqrt(Math.pow(d,2)+Math.pow(e,2))}),Et=({x:d,y:e})=>{let t=0,i=0;return e!==0?(t=1,i=-d/e):(i=1,t=-e/d),Wt({x:t,y:i})},Vt=d=>Object.prototype.toString.apply(d),E=d=>Vt(d)==="[object Number]",St=(d=100)=>new Promise(e=>{setTimeout(()=>{e()},d)}),$t=d=>{if(d.length===1)return!1;for(let e of d){let t=!1;const i=e.node;for(let s of i.outputs){for(let o of s.link){if(d.indexOf(o.targetNode.render)!==-1){t=!0;break}if(t)break}if(t)break}if(!t){for(let s of i.inputs){if(s.link&&d.indexOf(s.link.originNode.render)!==-1){t=!0;break}if(t)break}if(!t)return!1}}return!0},$=class ${constructor(e="div"){a(this,"DOM");this.DOM=document.createElement(e)}setId(e){return this.DOM.id=`${$.prefix}${e}`,this}getClientWidth(){return this.DOM.clientWidth}getClientHeight(){return this.DOM.clientHeight}getOffsetHeight(){return this.DOM.offsetHeight}getOffsetWidth(){return this.DOM.offsetWidth}getOffsetLeft(){return this.DOM.offsetLeft}getOffsetTop(){return this.DOM.offsetTop}setStyle(e){for(let t in e)this.DOM.style[t]=e[t];return this}setPosition(e="absolute",t=0,i=0,s=0,o="px"){return this.setStyle({position:e,top:E(t)?`${t}${o}`:t,left:E(i)?`${i}${o}`:i,zIndex:E(s)?`${s}`:s})}setAbsolute(e=0,t=0,i=0,s="px"){return this.setPosition("absolute",e,t,i,s)}setLeft(e,t="px"){return this.setStyle({left:E(e)?`${e}${t}`:e})}setRight(e,t="px"){return this.setStyle({right:E(e)?`${e}${t}`:e})}setTop(e,t="px"){return this.setStyle({top:E(e)?`${e}${t}`:e})}addClass(e){return this.DOM.classList.add(`${$.prefix}${e}`),this}removeClass(e){return this.DOM.classList.remove(`${$.prefix}${e}`),this}replaceClass(e,t){return this.DOM.classList.replace(`${$.prefix}${e}`,`${$.prefix}${t}`),this}show(){return this.setStyle({display:"block"})}isShow(){return this.DOM.style.display==="block"}hide(){return this.setStyle({display:"none"})}isHidden(){return this.DOM.style.display==="none"}toggle(){return this.DOM.style.display==="none"?this.show():this.hide(),this}setWidth(e,t="",i="px"){return this.setStyle({[`${t}${t?"W":"w"}idth`]:E(e)?`${e}${i}`:e})}setHeight(e,t="",i="px"){return this.setStyle({[`${t}${t?"H":"h"}eight`]:E(e)?`${e}${i}`:e})}setBackgroundColor(e){return this.setStyle({backgroundColor:e})}setAttribute(e,t){return this.DOM.setAttribute(e,t),this}removeAttribute(e){this.DOM.removeAttribute(e)}getAttribute(e){return this.DOM.getAttribute(e)}setContentEditable(e=!1){return this.DOM.setAttribute("contentEditable",e.toString()),this}setPadding(e){return this.setStyle({padding:e})}setPaddingTop(e){return this.setStyle({paddingTop:e})}setPaddingBottom(e){return this.setStyle({paddingBottom:e})}setPaddingLeft(e){return this.setStyle({paddingLeft:e})}setPaddingRight(e){return this.setStyle({paddingRight:e})}setMargin(e){return this.setStyle({margin:e})}setMarginTop(e){return this.setStyle({marginTop:e})}setMarginLeft(e){return this.setStyle({marginLeft:e})}setMarginRight(e){return this.setStyle({marginRight:e})}setMarginBottom(e){return this.setStyle({marginBottom:e})}setFontSize(e,t="px"){return this.setStyle({fontSize:`${e}${t}`})}add(e){var t;return typeof e=="string"?this.DOM.appendChild(document.createTextNode(e)):this.DOM.appendChild((t=e.DOM)!=null?t:e),this}setBoxShadow(e="#ccc 0px 0px 10px 1px"){return this.setStyle({boxShadow:e})}setBorderRadius(e="5px"){return this.setStyle({borderRadius:e})}setColor(e){return this.setStyle({color:e})}setFlex(e="flex"){return this.setStyle({display:e})}setFlexWrap(e="nowrap"){return this.setStyle({flexWrap:e})}setJustifyContent(e="flex-start"){return this.setStyle({justifyContent:e})}setAlignItems(e="center"){return this.setStyle({alignItems:e})}setFlexDirection(e){return this.setStyle({flexDirection:e})}setOverflow(e="visible"){return this.setStyle({overflow:e})}setUserSelect(e="auto"){return this.setStyle({webkitUserSelect:e,userSelect:e})}setCursor(e="auto"){return this.setStyle({cursor:e})}setPointerEvents(e="auto"){return this.setStyle({pointerEvents:e})}setboxSizing(e="content-box"){return this.setStyle({boxSizing:e})}innerText(e){return this.DOM.innerText=e,this}getInnerText(){return this.DOM.innerText}remove(){this.DOM.remove()}clear(){this.DOM.innerHTML=""}onClick(e,t=!1){t?this.DOM.onclick=e:this.DOM.addEventListener("click",i=>{e(i)})}onWheel(e,t=!1,i=!0){t?this.DOM.onwheel=e:this.DOM.addEventListener("wheel",s=>{e(s)},{passive:i})}onContextmenu(e,t=!1){t?this.DOM.onclick=e:this.DOM.addEventListener("contextmenu",i=>{e(i)})}getBoundingClientRect(){return this.DOM.getBoundingClientRect()}onMouseover(e,t=!1){t?this.DOM.onmouseover=e:this.DOM.addEventListener("mouseover",i=>{e(i)})}onMouseout(e,t=!1){t?this.DOM.onmouseout=e:this.DOM.addEventListener("mouseout",i=>{e(i)})}onMousedown(e,t=!1){t?this.DOM.onmousedown=e:this.DOM.addEventListener("mousedown",i=>{e(i)})}onMouseup(e,t=!1){t?this.DOM.onmouseup=e:this.DOM.addEventListener("mouseup",i=>{e(i)})}onMousemove(e,t=!1){t?this.DOM.onmouseup=e:this.DOM.addEventListener("mousemove",i=>{e(i)})}onDblClick(e,t=!1){t?this.DOM.onmouseup=e:this.DOM.addEventListener("dblclick",i=>{e(i)})}};a($,"prefix","ra-graph-");let T=$;class Mt{constructor(e){a(this,"DOM");this.DOM=document.createElementNS("http://www.w3.org/2000/svg",e)}setAttribute(e,t){return this.DOM.setAttribute(e,t),this}add(e){return this.DOM.appendChild(e.DOM),this}setStyle(e){for(let t in e)this.DOM.style[t]=e[t];return this}show(){return this.setStyle({display:"block"})}isShow(){return this.DOM.style.display==="block"}hide(){return this.setStyle({display:"none"})}remove(){this.DOM.remove()}}class F extends T{constructor(){super();a(this,"id");a(this,"label",null);a(this,"isCustomClick",!1);a(this,"propertyName","");this.id=F.createId()}static createId(){return`widget_${tt("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",10)()}`}getLabel(){return this.label!==null?this.label:""}}class v extends T{}class V extends T{constructor(t){super("button");a(this,"DOM");this.DOM=document.createElement("button"),this.setStyle({minWidth:"50px",height:"30px",borderRadius:"4px",cursor:"pointer",color:"black",paddingLeft:"5px",paddingRight:"5px"}),this.add(t)}}class et extends T{constructor(t,i){super("input");a(this,"DOM");this.DOM=document.createElement("input"),this.DOM.className="Input",this.DOM.style.padding="2px",this.DOM.style.width="calc(100% - 2px)",this.DOM.style.borderRadius="5px",this.DOM.style.border="1px solid transparent",this.DOM.style.outline="none",this.DOM.setAttribute("autocomplete","off"),this.DOM.addEventListener("keydown",function(s){s.stopPropagation()}),this.setValue(t),this.DOM.setAttribute("placeholder",i)}getValue(){return this.DOM.value}setValue(t){return this.DOM.value=t,this}onChange(t){this.DOM.addEventListener("input",i=>{t(i)})}}class Pt extends F{constructor(t){super();a(this,"DOM");a(this,"inputDIVs");a(this,"closure",t=>{});if(this.inputDIVs=new v,this.inputDIVs.setFlex(),this.inputDIVs.setFlexDirection("column"),t!=null&&t.value){let o=[];typeof t.value=="string"?o=t.value.split(","):typeof t.value=="object"&&(o=t.value),o.forEach(n=>{this.addInputDIV(String(n))})}else this.addInputDIV();let i=new v;i.add(this.addButton());let s=new v;s.add(this.inputDIVs).add(i),this.DOM=s.DOM,this.DOM.addEventListener("dblclick",o=>{o.stopPropagation()})}addInputDIV(t=""){let i=new v;i.setStyle({minWidth:"170px"});let s=new et("","请输入");s.setColor("black"),s.DOM.addEventListener("input",()=>{this.closure(this.getValue())}),s.setStyle({width:"140px",marginBottom:"2px",marginRight:"2px"}),s.setValue(t),i.add(s).add(this.delButton(i.DOM)),this.inputDIVs.add(i)}addButton(){let t=new V("+");return t.setStyle({width:"20px",height:"20px"}),t.DOM.addEventListener("click",()=>{this.addInputDIV()}),t}delButton(t){let i=new V("-");return i.setStyle({width:"20px",height:"20px",minWidth:"20px"}),i.DOM.addEventListener("click",()=>{t.remove(),this.closure(this.getValue())}),i}onChange(t){this.closure=t,this.inputDIVs.DOM.childNodes.forEach(i=>{i.firstChild.addEventListener("input",()=>{this.closure(this.getValue())}),i.lastChild.addEventListener("click",()=>{this.closure(this.getValue())})})}getValue(){let t=[];return this.inputDIVs.DOM.childNodes.forEach(i=>{t.push(i.firstChild.value)}),t.join(",")}setValue(t){this.inputDIVs.DOM.childNodes.forEach(s=>{this.inputDIVs.DOM.removeChild(s)});let i=[];typeof t=="string"?i=t.split(","):typeof t=="object"&&(i=t),i.forEach(s=>{this.addInputDIV(String(s))})}}a(Pt,"widgetType","array");class J extends T{constructor(e=""){super("span"),e&&(this.DOM.innerText=e)}}class Ht extends Mt{constructor(){super("svg")}}class Ut extends Mt{constructor(){super("path")}drawFillBezierLine(e,t,i,s,o,n,r){if(isNaN(e.x)||isNaN(e.y)||isNaN(t.x)||isNaN(t.y))return;const l=Et({x:t.x-e.x,y:t.y-e.y});if(isNaN(l.x)||isNaN(l.y))return;const h=[{x:e.x+l.x*i,y:e.y+l.y*i},{x:t.x+l.x*i,y:t.y+l.y*i},{x:t.x+-l.x*i,y:t.y+-l.y*i},{x:e.x+-l.x*i,y:e.y+-l.y*i}],u=[`M ${h[0].x} ${h[0].y} `,`C ${h[0].x+r} ${h[0].y}, ${h[1].x-r} ${h[1].y}, ${h[1].x} ${h[1].y} `,`L ${h[2].x} ${h[2].y} `,`C ${h[2].x-r} ${h[2].y}, ${h[3].x+r} ${h[3].y}, ${h[3].x} ${h[3].y} `,"Z"];this.setAttribute("d",u.join("")),this.setAttribute("stroke",o),this.setAttribute("stroke-width",`${n}`),this.setAttribute("fill",s)}}class It extends Mt{constructor(){super("circle")}}var W=(d=>(d[d.None=0]="None",d[d.Node=1]="Node",d[d.Slot=2]="Slot",d[d.Widget=3]="Widget",d))(W||{});const jt=230;class Yt{constructor(e,t){a(this,"rootDom");a(this,"selectedBox",null);a(this,"viewer");a(this,"menuItems");a(this,"mouseInfo");a(this,"viewPosition",{x:0,y:0});a(this,"selectPos",{x:0,y:0});a(this,"events",new wt);a(this,"scale",1);this.viewer=t,this.rootDom=e,this.rootDom.setBackgroundColor("#838383"),this.mouseInfo={button:-1,isDown:!1,isDrag:!1,target:null,type:0,beforePos:{x:0,y:0},enterTarget:null,enterType:0,timeStamp:{mouseDown:0,mouseUp:0}},this.selectedBox=null,this.initEventListener()}getScale(e=!1){return e?this.getParentScale()*this.scale:this.scale}getParentScale(){return this.viewer.graph.parentNode&&this.viewer.graph.parentNode.viewer?1/this.viewer.graph.parentNode.viewer.events.getScale(!0):1}setScale(e){this.scale=e,this.events.dispatch(c.ViewScale,this.scale)}get add(){return this.events.add.bind(this.events)}get dispatch(){return this.events.dispatch.bind(this.events)}get get(){return this.events.get.bind(this.events)}get setReadOnly(){return this.events.setReadOnly.bind(this.events)}initEventListener(){const e=[c.MouseDown,c.MouseUp,c.MouseMove,c.DoubleClick,c.NodeDown,c.DragNodeMove,c.NodeUp,c.SlotDown,c.DragSlotMove,c.SlotUp,c.DragViewStart,c.DragViewMove,c.DragViewEnd,c.OpenContextMenu,c.CloseContextMenu,c.Click,c.OpenAssociativeMenu,c.CloseAssociativeMenu,c.DragSlotStart,c.DragSlotEnd,c.DragNodeStart,c.DragNodeEnd,c.NodeEnter,c.NodeLeave,c.SlotEnter,c.SlotLeave,c.ViewScale,c.ViewResize,c.LinksFresh,c.AddRunLog,c.SelectedNode,c.DoubleRightClick,c.DoubleLeftClick,c.WidgetDown,c.WidgetUp,c.WidgetEnter,c.WidgetLeave,S.AddNode,S.RemoveNode,S.CloneNode,S.AddNodeInput,S.AddNodeOutput,S.FocusOnNode,S.StartRun,S.StopRun,S.RemoveNodeSlot,j.Node,j.Widget];for(let o of e)this.events.create(o);const t=this.mouseInfo;let i=!0;this.rootDom.onContextmenu(o=>{o.preventDefault()}),this.rootDom.onMousedown(o=>{const n=this.rootDom.DOM.querySelectorAll(".ra-graph-select-dropdown");for(const h of n){const u=h;u.style.display="none"}this.rootDom.setCursor("auto");const r=this.rootDom.getBoundingClientRect(),l={x:o.clientX-r.x,y:o.clientY-r.y};if((o.ctrlKey||o.metaKey)&&(this.selectedBox=new v,this.selectPos={x:o.clientX-r.x,y:o.clientY-r.y},this.selectedBox.setStyle({position:"absolute",top:l.y+"px",left:l.x+"px",backgroundColor:"#00BFFF"}),this.rootDom.add(this.selectedBox)),o.ctrlKey||o.metaKey){this.selectedBox=new v,this.selectPos={x:o.clientX-r.x,y:o.clientY-r.y},this.selectedBox.setStyle({position:"absolute",top:l.y+"px",left:l.x+"px",backgroundColor:"rgba(173,175,173,0.3)"}),this.rootDom.add(this.selectedBox);return}this.events.dispatch(c.MouseDown,l),this.events.dispatch(c.CloseAssociativeMenu),this.events.dispatch(c.CloseContextMenu),t.button=o.button,t.isDown=!0,t.timeStamp.mouseDown=new Date().getTime()}),document.addEventListener("mouseup",o=>{const n=new Date().getTime();this.rootDom.setCursor("auto");const r=this.rootDom.getBoundingClientRect(),l={x:o.clientX-r.x,y:o.clientY-r.y};if(this.selectedBox){this.selectedBox.remove(),this.selectedBox=null;const h=l,u=this.selectPos;this.events.dispatch(c.SelectedNode,u,h);return}if(n-t.timeStamp.mouseUp<=jt)switch(this.events.dispatch(c.DoubleClick,l,o),t.button){case 0:this.events.dispatch(c.DoubleLeftClick,l,t,o);break;case 2:this.events.dispatch(c.DoubleRightClick,l,t,o);break}else{if(this.events.dispatch(c.MouseUp,l),t.isDrag){if(t.button===0)switch(t.type){case 2:this.events.dispatch(c.DragSlotEnd,Object.assign({},l),t.target),t.enterType===0&&this.events.dispatch(c.OpenAssociativeMenu,Object.assign({},l),t.target);break;case 1:this.events.dispatch(c.DragNodeEnd,Object.assign({},l),t.target);break;case 0:this.events.dispatch(c.DragViewEnd,Object.assign({},l),t.target);break}}else t.button===0&&this.events.dispatch(c.Click,{type:t.type,target:t.target,position:Object.assign({},l)});o.button===2&&this.events.dispatch(c.OpenContextMenu,{position:Object.assign({},l),target:t.target,type:t.type})}t.isDown=!1,t.isDrag=!1,t.target=null,t.type=0,t.timeStamp.mouseUp=n,i=!0}),this.rootDom.onMousemove(o=>{const n=this.rootDom.getBoundingClientRect(),r={x:o.clientX-n.x,y:o.clientY-n.y};if(this.selectedBox){let l=0,h=0,u=0,g=0;r.x>=this.selectPos.x&&r.y>=this.selectPos.y?(l=r.x-this.selectPos.x,h=r.y-this.selectPos.y,g=this.selectPos.y,u=this.selectPos.x):r.x>=this.selectPos.x&&r.y<this.selectPos.y?(l=r.x-this.selectPos.x,h=this.selectPos.y-r.y,g=r.y,u=this.selectPos.x):r.x<this.selectPos.x&&r.y<this.selectPos.y?(l=this.selectPos.x-r.x,h=this.selectPos.y-r.y,g=r.y,u=r.x):r.x<this.selectPos.x&&r.y>=this.selectPos.y&&(l=this.selectPos.x-r.x,h=r.y-this.selectPos.y,g=this.selectPos.y,u=r.x),this.selectedBox.setStyle({top:g+"px",left:u+"px",width:l+"px",height:h+"px"});return}if(this.events.dispatch(c.MouseMove,r),t.isDown&&(t.isDrag=!0),t.isDrag){if(t.button===0)switch(t.type){case 2:i&&this.events.dispatch(c.DragSlotStart,Object.assign({},r),t.target),this.events.dispatch(c.DragSlotMove,Object.assign({},r),t.target);break;case 1:i&&this.events.dispatch(c.DragNodeStart,Object.assign({},r),t.target),this.events.dispatch(c.DragNodeMove,Object.assign({},r),t.target);break;case 0:this.rootDom.setCursor("move"),this.viewPosition.x+=r.x-t.beforePos.x,this.viewPosition.y+=r.y-t.beforePos.y,i&&this.events.dispatch(c.DragViewStart,Object.assign({},r),t.target),this.events.dispatch(c.DragViewMove,Object.assign({},r),t.target);break}i=!1}t.beforePos={x:r.x,y:r.y}}),this.rootDom.DOM.addEventListener("wheel",o=>{o.preventDefault();let n=o.clientX-this.rootDom.DOM.getBoundingClientRect().left,r=o.clientY-this.rootDom.DOM.getBoundingClientRect().top;const l=(n-this.viewPosition.x)/this.scale,h=(r-this.viewPosition.y)/this.scale;if(o.altKey||o.ctrlKey||o.metaKey||o.deltaY.toString().indexOf(".")>-1){const u=this.scale-o.deltaY/(o.ctrlKey?200:2e3),g={x:-l*u+n,y:-h*u+r};if(u<.4||u>3)return;this.viewPosition.x=g.x,this.viewPosition.y=g.y,this.setScale(u)}else o.preventDefault(),this.viewPosition.x+=o.deltaX/1.5,this.viewPosition.y+=o.deltaY/1.5,this.events.dispatch(c.DragViewMove,Object.assign({},{x:o.deltaX,y:o.deltaY}),t.target)},{passive:!1}),new ResizeObserver(o=>{for(const n of o){const{width:r,height:l}=n.contentRect;this.events.dispatch(c.ViewResize,r,l)}}).observe(this.rootDom.DOM),this.rootDom.DOM.addEventListener("resize",()=>{this.events.dispatch(c.ViewResize,this.rootDom.DOM.clientWidth,this.rootDom.DOM.clientHeight)}),this.events.add(c.SlotDown,(o,n,r)=>{t.button=o.button,t.isDown=!0,t.type=2,t.target={nodeRender:n,slotRender:r}}),this.events.add(c.NodeDown,(o,n)=>{t.button=o.button,t.isDown=!0,t.type=1,t.target={nodeRender:n}}),this.events.add(c.NodeEnter,o=>{this.mouseInfo.enterTarget=o,this.mouseInfo.enterType=1}),this.events.add(c.NodeLeave,o=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0}),this.events.add(c.SlotEnter,o=>{this.mouseInfo.enterTarget=o,this.mouseInfo.enterType=2}),this.events.add(c.SlotLeave,o=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0}),this.events.add(c.WidgetDown,(o,n,r)=>{t.button=o.button,t.isDown=!0,t.type=3,t.target={nodeRender:n,widget:r}}),this.events.add(c.WidgetEnter,(o,n,r)=>{this.mouseInfo.enterTarget=r,this.mouseInfo.enterType=3}),this.events.add(c.WidgetLeave,(o,n,r)=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0})}}class Xt{constructor(){a(this,"zIndex",1e3);a(this,"style",{NodeHighLightColor:"#FFD700",NodeRunningColor:"#00FF00",LineRunningColor:"#00FF00",NodeEventColor:"#00BFFF",NodeTitleColor:"#363636",NodeFontColor:"#ffffff",NodeBackgroundColor:"#4b4b4b"});a(this,"createRandomStyleNode",!0);a(this,"nodeStyles",[{name:"默认",nodeColor:"rgb(75, 75, 75)",nodeTitleColor:"rgb(54, 54, 54)",nodeFontColor:"rgb(255, 255, 255)"},{name:"棕色",nodeColor:"#593930",nodeTitleColor:"#332922",nodeFontColor:"rgb(255, 255, 255)"},{name:"绿色",nodeColor:"#335533",nodeTitleColor:"#223322",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝色",nodeColor:"#333355",nodeTitleColor:"#222233",nodeFontColor:"rgb(255, 255, 255)"},{name:"浅蓝色",nodeColor:"#3F5159",nodeTitleColor:"#2A3638",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝绿色",nodeColor:"#335555",nodeTitleColor:"#223333",nodeFontColor:"rgb(255, 255, 255)"},{name:"紫色",nodeColor:"#553355",nodeTitleColor:"#332233",nodeFontColor:"rgb(255, 255, 255)"},{name:"黄色",nodeColor:"#665533",nodeTitleColor:"#443322",nodeFontColor:"rgb(255, 255, 255)"},{name:"黑色",nodeColor:"#000000",nodeTitleColor:"#222222",nodeFontColor:"rgb(255, 255, 255)"},{name:"深蓝色",nodeColor:"#001f3f",nodeTitleColor:"#0074D9",nodeFontColor:"#FFFFFF"},{name:"橙色",nodeColor:"#FF851B",nodeTitleColor:"#FF4136",nodeFontColor:"#FFFFFF"},{name:"紫红色",nodeColor:"#D5008F",nodeTitleColor:"#FF0066",nodeFontColor:"#FFFFFF"},{name:"柔和粉红",nodeColor:"#FFC0CB",nodeTitleColor:"#FF69B4",nodeFontColor:"#000000"},{name:"海洋蓝",nodeColor:"#0077B6",nodeTitleColor:"#00A8CC",nodeFontColor:"#FFFFFF"},{name:"阳光黄",nodeColor:"#FFD700",nodeTitleColor:"#FFA500",nodeFontColor:"#000000"},{name:"青草绿",nodeColor:"#7CB518",nodeTitleColor:"#4B830D",nodeFontColor:"#FFFFFF"},{name:"玫瑰金",nodeColor:"#E91E63",nodeTitleColor:"#FF5722",nodeFontColor:"#FFFFFF"},{name:"宁静紫",nodeColor:"#8E44AD",nodeTitleColor:"#9B59B6",nodeFontColor:"#FFFFFF"}]);a(this,"showGraphInfo",!0)}getRandomColor(){const e=parseInt((Math.random()*this.nodeStyles.length).toString());return this.nodeStyles[e]}}const N=new Xt;class Ct{constructor(e,t,i){a(this,"parent");a(this,"slot");a(this,"parentDom");a(this,"horizontal",{root:new v,pin:new v,label:new v,pinLinked:new v});a(this,"vertical",{root:new v,pin:new v,label:new v,pinLinked:new v});a(this,"linkInfo",null);a(this,"slotSize",10);a(this,"events");this.parent=e,this.slot=i,this.parentDom=t,this.events=e.events,this._initHorizontal(),this._initVertical(),this.setVerticalMode(this.isVerticalMode)}get isVerticalMode(){return!!this.slot.options.isVertical}_initHorizontal(){const{pin:e,label:t,root:i,pinLinked:s}=this.horizontal,o=this.slot;if(this.createPin(e,s),t.setMarginLeft("5px"),t.setMarginRight("5px"),t.setFontSize(13),t.setStyle({whiteSpace:"nowrap"}),t.add(`${o.getLabel()}`),i.setFlex(),i.setStyle({alignItems:"center",marginBottom:"6px"}),o.type===w.INPUT?(i.add(e),i.add(t),i.setJustifyContent("flex-start")):(i.add(t),i.add(e),i.setJustifyContent("flex-end")),o.allow_input){let n=Y.createWidget(o.inputWidgetType);n&&(n.setWidth(50,"min"),n.setValue(o.value),n.onChange(r=>{o.value=r}),i.add(n))}this.parentDom.add(i),[e,t].forEach(n=>{n.onMousedown(r=>{r.stopPropagation(),this.events.dispatch(c.SlotDown,r,this.parent,this)}),n.onMouseover(r=>{r.stopPropagation(),this.events.dispatch(c.SlotEnter,this)}),n.onMouseout(r=>{r.stopPropagation(),this.events.dispatch(c.SlotLeave,this)})})}_initVertical(){const{pin:e,label:t,root:i,pinLinked:s}=this.vertical,o=this.slot;this.createPin(e,s),t.setFontSize(13),t.setStyle({whiteSpace:"nowrap"}),t.add(`${o.getLabel()}`),e.setMarginLeft("0px").setMarginRight("0px"),this.slot.type===w.OUTPUT&&e.setBackgroundColor("rgb(54, 54, 54)"),i.setAbsolute(),i.add(e),i.add(t),this.parentDom.add(i),i.setStyle({marginBottom:"6px"}),i.onMousedown(n=>{n.stopPropagation(),this.events.dispatch(c.SlotDown,n,this.parent,this)}),[e,t].forEach(n=>{n.onMouseover(r=>{r.stopPropagation(),this.events.dispatch(c.SlotEnter,this)}),n.onMouseout(r=>{r.stopPropagation(),this.events.dispatch(c.SlotLeave,this)})})}refreshVerticalPosition(){return mt(this,null,function*(){yield St(0);const{pin:e,label:t,root:i,pinLinked:s}=this.vertical,o=this.parent.getContent().getClientWidth(),n=this.parent.getContent().getClientHeight(),r=this.slot;let l=0,h=0,u=0,g=0;if(t.setAbsolute().setLeft(-t.getClientWidth()/2+this.slotSize/2),r.type===w.INPUT){l=-this.slotSize/2;for(let p of r.node.inputs)p!==r&&(p.options.isVertical?u+=1:p.index<r.index&&(g+=1));t.setTop(-17)}else{l=n-this.slotSize/2;for(let p of r.node.outputs)p!==r&&(p.options.isVertical?u+=1:p.index<r.index&&(g+=1));t.setTop(13)}h=o/(u+2)*(r.index+1-g)-this.slotSize/2,i.setTop(l).setLeft(h)})}createPin(e=null,t=null){return e||(e=new v),t||(t=new v),t.setWidth(this.slotSize-2,"min"),t.setHeight(this.slotSize-2,"min"),t.setMarginTop("1px"),t.setMarginLeft("1px"),this.slot.valueType==ot||Array.isArray(this.slot.valueType)&&this.slot.valueType.indexOf(ot)>-1?t.setBackgroundColor(N.style.NodeHighLightColor):(t.setBackgroundColor(N.style.LineRunningColor),t.setStyle({borderRadius:"50%"}),e.setStyle({borderRadius:"50%"})),t.hide(),e.setWidth(this.slotSize,"min"),e.setHeight(this.slotSize,"min"),e.setMarginLeft("5px"),e.setMarginRight("5px"),e.setStyle({backgroundColor:"#767676",border:"1px solid rgb(36 36 36)"}),e.add(t),{pin:e,pinLinked:t}}onNodeInited(){this.refreshVerticalPosition()}setVerticalMode(e){this.slot.options.isVertical=e,e?(this.horizontal.root.hide(),this.refreshVerticalPosition()):this.vertical.root.hide()}getWidth(){return this.isVerticalMode?0:this.horizontal.root.getClientWidth()}setLinked(e){e?(this.horizontal.pinLinked.show(),this.vertical.pinLinked.show()):(this.horizontal.pinLinked.hide(),this.vertical.pinLinked.hide())}refresh(){const{label:e}=this.horizontal,{slot:t}=this;t.type===w.INPUT?this.setLinked(!!t.link):this.setLinked(t.link.length>0);const i=`${t.getLabel()}`;e.getInnerText()!==i&&(e.clear(),e.add(i)),this.refreshVerticalPosition()}getPosition(){const e=this.parent.getPosition();return this.isVerticalMode?{x:e.x+this.vertical.root.getOffsetLeft()+this.slotSize/2,y:e.y+this.vertical.root.getOffsetTop()+this.slotSize/2}:{x:e.x+this.horizontal.pin.getOffsetLeft()+this.slotSize/2,y:e.y+this.horizontal.pin.getOffsetTop()+this.slotSize/2}}getContextMenu(){const e=[];return this.slot.options.remove&&e.push({label:"删除插槽",callback:()=>{this.slot.options.removeFunc&&this.slot.options.removeFunc(this.slot),this.events.dispatch(S.RemoveNodeSlot,this)}}),e}remove(){this.horizontal.root.remove(),this.vertical.root.remove()}}class Nt extends Ct{constructor(e,t,i){super(e,t,i)}}class kt extends Ct{constructor(e,t,i){super(e,t,i)}}const vt=class vt{constructor(e,t,i,s){a(this,"events");a(this,"renderEvents",new wt);a(this,"node");a(this,"inputs",[]);a(this,"outputs",[]);a(this,"root");a(this,"title");a(this,"body");a(this,"subContent",null);a(this,"inputsDom");a(this,"outputsDom");a(this,"parentDom");a(this,"borderBox");a(this,"dragSpan");a(this,"dragImg","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjkwNTExMDkwODUxIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIyNzkiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik00NTEuMTA5IDk2MEgzNDhsNjEyLTYxMi0xLjY2MyAxMDMuMTA5TDQ1MS4xMDkgOTYweiBtMjY4LjQyNSAwSDYxNmwzNDQtMzQ0djEwMy41MzRMNzE5LjUzNCA5NjB6IiBmaWxsPSIjZjRlYTJhIiBwLWlkPSIyMjgwIj48L3BhdGg+PC9zdmc+");a(this,"viewPosition");a(this,"widgetsBox");a(this,"dragResize",!1);a(this,"minWidth",0);a(this,"minHeight",0);this.parentDom=e,this.node=t,this.root=new v,this.title=new v,this.body=new v,this.borderBox=new v,this.dragSpan=new J,this.inputsDom=new v,this.outputsDom=new v,this.events=s,this.viewPosition=i,this.widgetsBox=new v,this.widgetsBox.setStyle({width:"calc(100% - 4px)",display:"flex",flexDirection:"column"}),this.dragSpan.setStyle({position:"absolute",bottom:"1px",right:"1px",width:"20px",height:"20px",backgroundImage:`url('${this.dragImg}')`,backgroundPosition:"100% 100%",backgroundOrigin:"content-box",backgroundRepeat:"no-repeat",boxSizing:"border-box",cursor:"se-resize",zIndex:"100",pointerEvents:"visible"}),this._init(),this._initEventListener(),this.setTopIndex()}_init(){return mt(this,null,function*(){var p,x,f;const{root:e,title:t,body:i,inputsDom:s,outputsDom:o}=this,n=this.node,r=25,l=new v;e.setPosition("absolute",0,0).setStyle({backgroundColor:(p=this.node.options.nodeColor)!=null?p:N.style.NodeBackgroundColor,borderRadius:"8px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",webkitUserSelect:"none",cursor:"pointer",color:(x=this.node.options.nodeFontColor)!=null?x:N.style.NodeFontColor}),t.setWidth("100%"),t.setHeight(r,"min"),t.setStyle({lineHeight:`${r}px`,textAlign:"center",backgroundColor:(f=this.node.options.nodeTitleColor)!=null?f:N.style.NodeTitleColor,borderRadius:"8px 8px 0px 0px",fontWeight:"bold",padding:"4px 40px",boxSizing:"border-box",whiteSpace:"nowrap"}),this.body.setStyle({height:"auto",padding:"4px",paddingBottom:"8px",minWidth:"120px",paddingTop:"10px"}),t.innerText(n.label),this.borderBox.add(this.dragSpan),this.borderBox.setWidth("100%").setHeight("100%").setPosition("absolute",-4,-4).setStyle({border:"2px solid "+N.style.NodeHighLightColor,borderRadius:"9px",padding:"2px",pointerEvents:"none"}).hide(),l.setFlex(),l.setJustifyContent("space-between"),s.setStyle({flex:"1"}),i.setHeight(`calc( 100% - ${r}px )`);for(let m of n.outputs)this.outputs.push(new kt(this,o,m));for(let m of n.inputs)this.inputs.push(new Nt(this,s,m));l.add(s).add(o),this.body.add(l).add(this.widgetsBox),this.root.add(this.title).add(this.body).add(this.borderBox),this.parentDom.add(this.root),this.setPosition(n.position.x,n.position.y);const{width:h,height:u}=this.root.getBoundingClientRect();this.minWidth=h,this.minHeight=u;const g=[...this.inputs,...this.outputs];for(let m of g)m.onNodeInited();yield St(100),this.node.initedRender()})}setTopIndex(){N.zIndex=N.zIndex+1,this.root.setStyle({zIndex:N.zIndex+""})}_initEventListener(){this.renderEvents.create(z.Resize),this.renderEvents.create(z.Refresh),this.root.onMousedown(t=>{t.stopPropagation(),this.events.dispatch(c.NodeDown,t,this),this.setTopIndex(),console.log(`点击了节点【${this.node.label}】【${this.node.id}】`)});let e=null;this.root.onClick(t=>{t.detail===1&&(e=setTimeout(()=>{this.events.dispatch(j.Node,t,this)},200))}),this.root.onDblClick(t=>{clearTimeout(e)}),this.root.onMouseover(t=>{this.events.dispatch(c.NodeEnter,this)}),this.root.onMouseout(t=>{this.events.dispatch(c.NodeLeave,this)}),this.dragSpan.onMousedown(t=>{t.stopPropagation(),t.preventDefault(),document.onmousemove=i=>{i.stopPropagation(),i.preventDefault();const s=i.clientX,o=i.clientY,{x:n,y:r}=this.root.getBoundingClientRect(),l=s-n,h=o-r;this.setSize(l,h),this.events.dispatch(c.LinksFresh,this.node.graph.runedNodes)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null}})}setSize(e,t){var n,r;const i=this.events.getScale();let s=this.minWidth,o=this.minHeight;if(e>this.minWidth*i&&(s=e/i),t>this.minHeight*i&&(o=t/i),s!=this.minWidth||o!=this.minHeight){for(let l of this.inputs)l.refresh();for(let l of this.outputs)l.refresh();if(this.node.subGraph){const l=this.node;l.minSize&&l.minSize.width*i<=e&&((n=l.graphWidget)==null||n.viewerDom.setWidth((l.originRect.width*i+e-l.minSize.width*i)/i)),l.minSize&&l.minSize.height*i<=t&&((r=l.graphWidget)==null||r.viewerDom.setHeight((l.originRect.height*i+t-l.minSize.height*i)/i))}this.renderEvents.dispatch(z.Resize,s*i,o*i)}this.root.setWidth(s,"min").setHeight(o,"min")}setPosition(e,t){this.events.getScale(),this.root.setLeft(e).setTop(t)}adaption(){const{root:e,title:t,body:i,inputs:s,outputs:o}=this,n=17,r={w:130,h:80};let l=t.getClientWidth(),h=t.getClientHeight(),u=0;for(let x of s){const f=x.getWidth();u<f&&(u=f)}let g=0;for(let x of o){const f=x.getWidth();g<f&&(g=f)}l<g+u&&(l=g+u),l=l>i.getClientWidth()?l:i.getClientWidth();let p=s.length>o.length?s.length:o.length;h+=p*n,h<r.h&&(h=r.h),l<r.w&&(l=r.w),this.setSize(l,h)}getInput(e){return this.inputs[e]}getOutput(e){return this.outputs[e]}getPosition(){return{x:this.node.position.x,y:this.node.position.y}}refresh(){var l;const{root:e,title:t,body:i,inputsDom:s,outputsDom:o}=this;if(this.setPosition(this.node.position.x,this.node.position.y),t.innerText(this.node.label),vt.showNodeIndex){let h=new v;h.innerText((l=this.node.index.toString())!=null?l:"\\"),h.setStyle({position:"absolute",left:"2px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",minWidth:"25px",borderRadius:"50%",padding:"0 4px",backgroundColor:"black",color:"white",boxSizing:"border-box"}),t.add(h)}this.node.options.nodeColor&&e.setStyle({backgroundColor:this.node.options.nodeColor}),this.node.options.nodeTitleColor&&t.setStyle({backgroundColor:this.node.options.nodeTitleColor}),this.node.options.nodeFontColor&&e.setStyle({color:this.node.options.nodeFontColor});const n=[],r=[];if(this.node.inputs.length<this.inputs.length){const h=this.inputs.splice(this.node.inputs.length,this.inputs.length-this.node.inputs.length);for(let u of h)u.remove()}if(this.node.outputs.length<this.outputs.length){const h=this.outputs.splice(this.node.outputs.length,this.outputs.length-this.node.outputs.length);for(let u of h)u.remove()}for(let h of this.node.inputs){const u=this.inputs[h.index];if(!u){n.push(new Nt(this,s,h));continue}if(u.slot!==h){const g=new Nt(this,s,h);h.link&&h.link.info&&(h.link.info.end=g,g.linkInfo=h.link.info),g.refresh(),n.push(g),u.remove()}else u.refresh(),n.push(u)}for(let h of this.node.outputs){const u=this.outputs[h.index];if(!u){r.push(new kt(this,o,h));continue}if(u.slot!==h){const g=new kt(this,o,h);if(h.link&&h.link.length>0)for(let p of h.link)p.info&&(p.info.start=g,g.linkInfo=p.info);g.refresh(),r.push(g),u.remove()}else u.refresh(),r.push(u)}this.inputs=n,this.outputs=r,this.widgetsBox.clear();for(let h of this.node.widgets){if(h.onMouseover(u=>{this.events.dispatch(c.WidgetEnter,u,this,h)},!0),h.onMouseout(u=>{this.events.dispatch(c.WidgetLeave,u,this,h)},!0),h.onMousedown(u=>{this.events.dispatch(c.WidgetDown,u,this,h)},!0),h.isCustomClick&&h.onClick(u=>{u.stopPropagation(),this.events.dispatch(j.Widget,u,this,h)},!0),h.getLabel()){let u=new v;u.setFlex().setFlexDirection("row"),u.setStyle({justifyContent:"center",alignItems:"center",paddingLeft:"4px"});let g=new J(h.getLabel());g.setStyle({whiteSpace:"nowrap",lineHeight:"100%",fontSize:"14px",marginRight:"4px"}),h.setStyle({flexGrow:"1"}),u.add(g),u.add(h),u.setMarginBottom("6px"),this.widgetsBox.add(u)}else h.setMarginBottom("6px"),this.widgetsBox.add(h);this.renderEvents.dispatch(z.Refresh)}this.node.onRefresh&&this.node.onRefresh()}remove(){this.root.remove()}getContextMenu(){var i,s;const e=this.node.getContextMenu();!this.node.subGraph&&!this.node.options.notClone&&e.push({label:"克隆节点",callback:()=>{this.events.dispatch(S.CloneNode,this.node.id)}});let t=!1;if(this.node.options.addInput&&this.node.addInputsConfig.length>0){const o=[];for(let n of this.node.addInputsConfig)o.push({label:(i=n.label)!=null?i:"未命名输入",callback:()=>{this.events.dispatch(S.AddNodeInput,this,n)}});e.push({label:"添加输入",subMenu:o}),t=!0}if(this.node.options.addOutput&&this.node.addOutputsConfig.length>0){const o=[];for(let n of this.node.addOutputsConfig)o.push({label:(s=n.label)!=null?s:"未命名输出",callback:()=>{this.events.dispatch(S.AddNodeOutput,this,n)}});e.push({label:"添加输出",subMenu:o}),t=!0}return t&&e.push(null),e.push({label:"删除节点",callback:()=>{this.events.dispatch(S.RemoveNode,this.node.id)}}),e}setHighLight(e=""){this.node.onNodeHighLight(),e&&this.borderBox.setStyle({borderColor:e}),this.borderBox.show(),this.node.options.notResize?this.dragSpan.hide():this.dragSpan.show()}setLabel(e){this.node.setLabel(e),this.refresh()}shake(){const i=Date.now();let s=i,o=()=>{if(s=Date.now(),s-i<500){const r=Math.random()*5*2-5,l=Math.random()*5*2-5;this.root.DOM.style.transform=`translate(${r}px, ${l}px)`,requestAnimationFrame(o)}else this.root.DOM.style.transform="none"};o()}cancelHighLight(){this.borderBox.setStyle({borderColor:N.style.NodeHighLightColor}),this.borderBox.hide()}getContent(){return this.root}removeNode(){this.events.dispatch(S.RemoveNode,this.node.id)}setMinSize(e){this.minWidth=e.width,this.minHeight=e.height}};a(vt,"showNodeIndex",!0);let lt=vt;class Gt{constructor(e,t){a(this,"type",O.Dom);a(this,"rootDom");a(this,"events");a(this,"nodeMap",{});a(this,"root");this.rootDom=e,this.events=t,this.root=new v,this.root.setStyle({transformOrigin:"top left"}),this.root.setPosition("absolute",0,0),this.rootDom.add(this.root)}getAllNodes(){return Object.values(this.nodeMap)}addNode(e){if(this.nodeMap[e.id])return this.nodeMap[e.id];const t=new lt(this.root,e,this.events.viewPosition,this.events);return this.nodeMap[e.id]=t,t}removeNode(e){this.nodeMap[e]&&(this.nodeMap[e].remove(),delete this.nodeMap[e])}getNodeRender(e){return this.nodeMap[e]}getSlotRender(e,t,i){const s=this.getNodeRender(e);return s?i?s.getOutput(t):s.getInput(t):null}refresh(){this.nodeMap;for(let e in this.nodeMap)this.nodeMap[e].refresh()}setPosition(){const e=this.events.getScale(!0),t=this.events.getScale();this.root.setStyle({transform:`scale(${e}) translate(${this.events.viewPosition.x/t}px,${this.events.viewPosition.y/t}px)`});let i=this.events.viewer.graph.getAllSubGraph();i.length&&i.forEach(s=>{s.getNodeManager().setPosition()})}}class Rt extends T{constructor(){super("canvas");a(this,"ctx");this.ctx=this.DOM.getContext("2d"),this.ctx.translate(.5,.5)}}class qt{constructor(e,t){a(this,"type",O.Svg);a(this,"rootDom");a(this,"events");a(this,"root");a(this,"linkMap",{});a(this,"tempLine");a(this,"tempPoints");a(this,"commonLinks",{});a(this,"ctx");a(this,"canvas");a(this,"runedNodes",[]);a(this,"tempPointHeight",5);this.rootDom=e,this.events=t;let i=new Rt;i.setHeight(this.rootDom.getClientHeight()).setWidth(this.rootDom.getClientWidth());const s=window.devicePixelRatio;i.setAttribute("width",`${this.rootDom.getClientWidth()*s}`),i.setAttribute("height",`${this.rootDom.getClientHeight()*s}`),i.ctx.scale(s,s),i.setStyle({webkitUserSelect:"none",userSelect:"none",position:"absolute",top:"0px",left:"0px",zIndex:"0",pointerEvents:"none"}),this.canvas=i,this.ctx=i.ctx,this.rootDom.DOM.insertBefore(i.DOM,this.rootDom.DOM.firstChild);let o=()=>{this.refresh(),requestAnimationFrame(o)};o();const n=this.root=new Ht;n.setAttribute("width",`${this.rootDom.getClientWidth()}`),n.setAttribute("height",`${this.rootDom.getClientHeight()}`),n.setStyle({position:"absolute",top:"0px",left:"0px"}),this.tempLine=new Ut,this.tempLine.hide(),this.tempPoints=[new It,new It],this.tempPoints[0].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[0].setAttribute("fill","#00ff00"),this.tempPoints[1].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[1].setAttribute("fill","#00ff00"),this.tempPoints[0].hide(),this.tempPoints[1].hide(),this.root.add(this.tempLine),this.root.add(this.tempPoints[0]),this.root.add(this.tempPoints[1]),this.rootDom.add(n.DOM),this.events.add(c.LinksFresh,r=>{r!==null&&(this.runedNodes=r!=null?r:[]),this.refresh()}),this.events.add(c.ViewResize,(r,l)=>{this.root.setAttribute("width",r),this.root.setAttribute("height",l),this.canvas.DOM.setAttribute("height",l),this.canvas.DOM.setAttribute("width",r),this.root.setStyle({width:r+"px",height:l+"px"}),this.canvas.setStyle({width:r+"px",height:l+"px"}),this.refresh()})}clear(){this.commonLinks={},this.refresh()}addLink(e,t,i){const s=t.getPosition(),o=i.getPosition();if(isNaN(s.x)||isNaN(s.y)||isNaN(o.x)||isNaN(o.y))return;const n={start:t,end:i,link:e};this.commonLinks[e.id]=n,t.linkInfo=n,i.linkInfo=n,e.info=n,this.refresh()}removeLink(e){const t=this.commonLinks[e];t&&(t.start.linkInfo=null,t.end.linkInfo=null,t.link.info=null,delete this.commonLinks[e],this.refresh())}getLinkRender(e){return this.linkMap[e]}displayTempLine(e){const t=this.events.getParentScale();this.tempPoints.forEach(i=>{i.setAttribute("r",`${this.tempPointHeight*t}`)}),e?(this.tempLine.show(),this.tempPoints[0].show(),this.tempPoints[1].show()):(this.tempLine.hide(),this.tempPoints[0].hide(),this.tempPoints[1].hide())}setTempLine(e,t,i){const s=this.events.getScale(!0),o=this.events.getParentScale(),n=2*s,r="#00ff00",l="#000000";i?(e={x:e.x*s+this.events.viewPosition.x*o,y:e.y*s+this.events.viewPosition.y*o},t={x:t.x*o,y:t.y*o}):(e={x:e.x*o,y:e.y*o},t={x:t.x*s+this.events.viewPosition.x*o,y:t.y*s+this.events.viewPosition.y*o}),this.tempLine.drawFillBezierLine(e,t,n,r,l,1,10),this.tempPoints[1].setAttribute("cx",`${t.x}`),this.tempPoints[1].setAttribute("cy",`${t.y}`),this.tempPoints[0].setAttribute("cx",`${e.x}`),this.tempPoints[0].setAttribute("cy",`${e.y}`)}refresh(){this.ctx.clearRect(0,0,this.rootDom.getOffsetWidth(),this.rootDom.getOffsetHeight());const e=this.events.getParentScale(),t=window.devicePixelRatio;this.canvas.setAttribute("width",`${this.rootDom.getClientWidth()*t/e}`),this.canvas.setAttribute("height",`${this.rootDom.getClientHeight()*t/e}`),this.canvas.ctx.scale(t/e,t/e),N.showGraphInfo&&(this.ctx.fillStyle="white",this.ctx.font=`${10*e}px Aria`,this.ctx.fillText(`缩放率：${parseInt((this.events.getScale()*100).toString())}%`,10*e,this.rootDom.getOffsetHeight()-40*e),this.ctx.fillText(`连线数：${this.events.viewer.graph.getLinks().length}`,10*e,this.rootDom.getOffsetHeight()-25*e),this.ctx.fillText(`节点数：${this.events.viewer.graph.getNodes().length}`,10*e,this.rootDom.getOffsetHeight()-10*e));for(let i in this.commonLinks){const s=this.commonLinks[i],o=s.start.getPosition(),n=s.end.getPosition(),r=this.getLinkColor(s);this.canvasDrawLink(o,n,r,s.start.isVerticalMode,s.end.isVerticalMode)}}getLinkColor(e){const t=e.start.slot.node.id;let i="black",s=[];this.events.viewer.ActiveNodes.forEach(o=>{s.push(o.node.id)}),Z.ActiveNode&&s.push(Z.ActiveNode.node.id),e.start.slot.node.options.nodeColor&&(i=e.start.slot.node.options.nodeColor),s.forEach(o=>{(o==t||o==e.end.slot.node.id)&&(i=N.style.NodeHighLightColor)});for(let o=0;o<this.runedNodes.length;o++)this.runedNodes[o].id==t&&(i=N.style.LineRunningColor);return i}canvasDrawLink(e,t,i="black",s=!1,o=!1){const n=this.events.getScale(!0),r=this.events.getParentScale(),l=e.x*n+this.events.viewPosition.x*r,h=e.y*n+this.events.viewPosition.y*r,u=t.x*n+this.events.viewPosition.x*r,g=t.y*n+this.events.viewPosition.y*r;let p=l+50*n,x=h;s&&(p=l,x=h+50*n);let f=u-50*n,m=g;o&&(f=u,m=g-50*n),this.ctx.beginPath(),this.ctx.lineWidth=3*n,this.ctx.strokeStyle=i,this.ctx.moveTo(l,h),this.ctx.bezierCurveTo(p,x,f,m,u,g),this.ctx.stroke()}}class Jt extends v{constructor(t){super();a(this,"viewer");a(this,"nodeManager");a(this,"inputInstance",null);a(this,"nodesBox",null);a(this,"pointer",null);a(this,"searchText",null);a(this,"isCreate",!0);this.viewer=t,this.nodeManager=this.viewer.graph.nodeManager,this.initBox(),this.viewer.events.add(c.DoubleLeftClick,(i,s,o)=>{if(o.target instanceof HTMLCanvasElement||o.target instanceof SVGElement){if(this.viewer.graph.parentNode){const n=this.viewer.graph.parentNode.widgets[0].viewerDom;if(i.x<0||i.y<0||i.x>n.getClientWidth()||i.y>n.getClientHeight())return}if(this.viewer.graph.isInSubgraph(i))this.hide();else{this.showBox(i);return}}else this.hide()}),this.viewer.events.add(c.MouseDown,()=>{this.hide()}),this.onWheel(i=>{i.stopPropagation()})}initBox(){this.setPosition("absolute").setWidth(200).setHeight(200,"min").setBackgroundColor("black").setStyle({opacity:"0.8",cursor:"pointer",display:"flex",flexDirection:"column",transformOrigin:"left top"}).setBorderRadius("20px").setPadding("10px"),this.DOM.addEventListener("dblclick",t=>{t.stopPropagation()}),this.onMousedown(t=>{t.stopPropagation()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.hide()}),this.initSearchInput(),this.hide()}initSearchInput(){let t=new v;t.setWidth("100%").setHeight("20px").setMarginBottom("10px");let i=new et("","请输入关键字搜索");i.setWidth("100%").setStyle({opacity:"0.5",border:"0"}).setHeight("100%").setBorderRadius("8px").setPaddingLeft("10px").setMarginLeft("-6px").setColor("black").setFontSize(14),i.onChange(()=>{this.searchText=i.getValue(),this.refreshNodes()}),this.inputInstance=i,t.add(i),this.add(t);let s=new v;s.setStyle({display:"flex",justifyContent:"space-between",paddingBottom:"5px"}),this.add(s);let o=new V("新增节点");o.setWidth("49%").onClick(()=>{this.isCreate||(this.isCreate=!0,o.setBackgroundColor("white").setColor("black"),n.setBackgroundColor("black").setColor("white"),this.refreshNodes())});let n=new V("查询节点");n.setWidth("49%").setBackgroundColor("black").setColor("white").onClick(()=>{this.isCreate&&(this.isCreate=!1,o.setBackgroundColor("black").setColor("white"),n.setBackgroundColor("white").setColor("black"),this.refreshNodes())}),s.add(o).add(n)}refreshNodes(){if(this.nodesBox===null?(this.nodesBox=new v,this.nodesBox.setStyle({flexGrow:"1",overflowY:"auto",backgroundColor:"black",width:"100%",maxHeight:"200px",paddingTop:"5px"}),this.add(this.nodesBox)):this.nodesBox.clear(),this.isCreate)this.nodeManager.getNodeTypeList().forEach(i=>{this.searchText?(i.label.indexOf(this.searchText)>-1||i.type.indexOf(this.searchText)>-1)&&this.createNodeSelectItem(i):this.createNodeSelectItem(i)});else{const i=this.viewer.serialize().nodes;if(!i.length||!this.searchText)return;i.forEach(s=>{var o;JSON.stringify(s).indexOf(this.searchText)>-1&&this.createNodeSelectItem({label:`[${s.index}] ${(o=s._label)!=null?o:s.type}`,type:s.id})})}}createNodeSelectItem(t){var s;let i=new v;i.setColor("white").setStyle({lineHeight:"1.5rem",paddingLeft:".5rem",textAlign:"left"}).onMouseover(()=>{i.setBackgroundColor("white").setColor("black")}),i.onMouseout(()=>{i.setBackgroundColor("black").setColor("white")}),i.onClick(()=>{if(this.isCreate){const o=this.viewer.events.getScale();let n={x:this.pointer.x/o-60-this.viewer.events.viewPosition.x/o,y:this.pointer.y/o-this.viewer.events.viewPosition.y/o,z:0};this.viewer.addNode(t.type,n)}else this.viewer.focusOnNode(t.type);this.hide()}),i.DOM.innerText=t.label,(s=this.nodesBox)==null||s.add(i)}showBox(t){var s,o;this.searchText="",(s=this.inputInstance)==null||s.setValue(""),this.pointer=t;const i=this.viewer.events.getParentScale();this.setLeft(t.x*i-100*i).setTop(t.y*i-20*i).setStyle({transform:`scale(${i})`}),this.refreshNodes(),this.show(),(o=this.inputInstance)==null||o.DOM.focus()}show(){return this.setStyle({display:"flex"}),this}}class Kt extends v{constructor(t,i){super();a(this,"graph");a(this,"logPanel",null);a(this,"events");this.graph=t,this.events=i,this.initBox(),this.initButtons(),this.events.add(c.AddRunLog,s=>{var o;(o=this.logPanel)==null||o.log(s)})}initBox(){this.setStyle({position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"row",background:"black",opacity:"0.8",height:"30px",padding:"8px",borderRadius:"10px",cursor:"pointer",justifyContent:"center",alignItems:"center"}),this.DOM.addEventListener("dblclick",t=>{t.stopPropagation()})}initButtons(){let t=new Qt;t.setMarginRight("10px"),t.onClick(()=>{this.logPanel||(this.logPanel=new _t,this.add(this.logPanel)),this.graph.start()}),this.add(t),this.events.add(S.StartRun,()=>{t.DOM.click()});let i=new Zt;i.onClick(()=>{var s;(s=this.logPanel)==null||s.remove(),this.logPanel=null,t.stopAnimation(),this.graph.stop(),setTimeout(()=>{this.graph.stop()},this.graph.stepTime)}),this.events.add(S.StopRun,()=>{i.DOM.click()}),this.add(i)}addButton(t){if(!t.name||!t.callback){console.error("无效的按钮");return}let i=new V(t.name);i.onClick(()=>{t.callback()}),i.setMarginLeft("10px"),t.backgroundColor&&i.setBackgroundColor(t.backgroundColor),t.color&&i.setColor(t.color),this.add(i)}}class Qt extends v{constructor(){super();a(this,"isAnimating",!1);a(this,"animationFrameId",0);a(this,"scale",1);a(this,"scaleFactor",.01);a(this,"maxScale",1.2);a(this,"minScale",.8);this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">        <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />        <polygon points="10,7 18,12 10,17" fill="white" />      </svg>',this.setHeight(24),this.onClick(()=>{this.startAnimation()})}startAnimation(){this.isAnimating||(this.isAnimating=!0,this.animateScale())}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,cancelAnimationFrame(this.animationFrameId),this.scale=1,this.updateScale())}animateScale(){this.isAnimating&&(this.scale+=this.scaleFactor,(this.scale>=this.maxScale||this.scale<=this.minScale)&&(this.scaleFactor=-this.scaleFactor),this.updateScale(),this.animationFrameId=requestAnimationFrame(()=>{this.animateScale()}))}updateScale(){this.DOM.style.transform=`scale(${this.scale})`}}class Zt extends v{constructor(){super(),this.setHeight(24),this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">    <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />    <rect x="8" y="8" width="8" height="8" stroke="white" stroke-width="2" />  </svg>'}}class _t extends v{constructor(){super();a(this,"logs",[]);this.initBox(),this.render()}initBox(){this.setStyle({position:"absolute",left:"-20px",background:"black",height:"20px",width:"20px",top:"0",borderRadius:"6px",padding:"6px",overflowY:"auto",opacity:".8",transition:"all 0.5s ease"}),setTimeout(()=>{this.setWidth("200px").setLeft("-220px").setHeight("200px")},0),this.onWheel(t=>{t.stopPropagation()})}log(t){this.logs.unshift(t),this.render()}render(){this.clear(),this.logs.forEach(t=>{this.createLogItem(t)})}remove(){this.setLeft("0px").setTop(5).setWidth("24px").setHeight("24px"),setTimeout(()=>{this.clear()},300),setTimeout(()=>{super.remove()},500)}createLogItem(t){let i=new v;i.DOM.innerHTML=`节点${t.node.id} [${t.node.label}]：${t.msg}`,i.setStyle({color:"white",fontSize:"12px",padding:"2px",borderBottom:"1px solid white",borderRadius:"4px",cursor:"pointer",userSelect:"none",webkitUserSelect:"none"}),i.onMouseover(()=>{i.setStyle({background:"white",color:"black"})}),i.DOM.addEventListener("dblclick",s=>{s.stopPropagation()}),i.onMouseout(()=>{i.setStyle({background:"black",color:"white"})}),i.onClick(()=>{var s,o;(s=t.node.render)==null||s.events.dispatch(S.FocusOnNode,t.node.id),(o=t.node.render)==null||o.shake()}),this.add(i)}}class K{constructor(e){a(this,"parent");a(this,"root");a(this,"label");a(this,"input");a(this,"isReadOnly",!1);a(this,"styles",{fontColor:"#ffffff",backColor:"#4b4b4b"});this.parent=e,this.root=new v,this.label=new v,this.input=new et("","请输入"),this.init()}setReadOnly(e){const{input:t}=this;e?(t.setAttribute("readonly","readonly"),t.setStyle({backgroundColor:this.styles.backColor,fontSize:"17px"})):(t.removeAttribute("readonly"),t.setStyle({backgroundColor:"#a8a8a8"})),this.isReadOnly=e}setValue(e,t){this.input.setValue(e),t&&this.label.innerText(t)}onChange(e){this.input.onChange(()=>{e(this.input.getValue())})}init(){const{root:e,label:t,input:i}=this;e.setStyle({display:"flex",width:"calc( 100% - 20px)",height:"30px",margin:"5px 10px 0px 10px",color:this.styles.fontColor,backgroundColor:this.styles.backColor}),t.setStyle({width:"100px",lineHeight:"30px"}),t.innerText("测试"),i.setStyle({lineHeight:"30px",backgroundColor:"#a8a8a8",color:this.styles.fontColor,borderRadius:"2px",fontSize:"16px"}),e.add(t),e.add(i),this.parent.add(e)}refresh(){const{root:e,label:t,input:i}=this;e.setStyle({color:this.styles.fontColor,backgroundColor:this.styles.backColor}),i.setStyle({color:this.styles.fontColor}),this.setReadOnly(this.isReadOnly)}remove(){this.root.remove()}}class te{constructor(e){a(this,"parent");a(this,"render",null);a(this,"root");a(this,"title");a(this,"body");a(this,"footer");a(this,"isShow",!1);a(this,"onNodeRefresh",null);this.parent=e,this.root=new v,this.title={root:new v,label:new v};const t=new v;let i=new dt;t.add(i),this.body={root:t,divider:i,title:new K(t),idLabel:new K(t),props:[]},this.body.root.add(new dt("属性")),this.footer={root:new v,deleteBtn:new V("删除"),cancelBtn:new V("取消")},this.init()}init(){const{root:e,body:t,title:i,footer:s}=this;this.parent.DOM.addEventListener("mousedown",()=>{this.hide()}),e.setStyle({width:"400px",backgroundColor:"rgb(75 75 75)",borderRadius:"13px",color:"rgb(255 255 255)",transition:"all .5s ease-in-out",overflow:"hidden",border:"2px solid "+N.style.NodeHighLightColor}).setAbsolute(57,420),e.onMousemove(o=>{o.stopPropagation()}),e.onMouseup(o=>{o.stopPropagation()}),e.onMousedown(o=>{o.stopPropagation()}),e.onWheel(o=>{o.stopPropagation()}),this.initTitle(),this.initBody(),this.initFooter(),e.add(i.root),e.add(t.root),e.add(s.root),e.hide(),this.parent.add(this.root),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.isShow&&this.hide()})}initBody(){const{root:e,idLabel:t,title:i}=this.body;e.setStyle({width:"100%",overflowY:"auto",height:"calc(100% - 74px)"}),t.setReadOnly(!0),i.onChange(s=>{this.render.setLabel(s)})}initTitle(){const{root:e,label:t}=this.title;e.setStyle({width:"100%",backgroundColor:"rgb(54 54 54)",height:"40px",borderRadius:"5px 5px 0px 0px",fontWeight:"bold",lineHeight:"40px",textAlign:"center"}),t.innerText("测试"),e.add(t)}initFooter(){const{root:e,deleteBtn:t,cancelBtn:i}=this.footer;e.setStyle({width:"100%",height:"30px",textAlign:"center"}),[t,i].forEach(s=>{s.setStyle({height:"20px",marginTop:"5px"}),s.onMouseover(()=>{s.setStyle({backgroundColor:"#ffffff"})}),s.onMouseout(()=>{s.setStyle({backgroundColor:"#cacaca"})})}),t.onClick(()=>{this.render.removeNode(),this.hide()}),i.onClick(()=>{this.hide()}),i.setMarginLeft("15px"),e.add(t),e.add(i)}refresh(e){const t=this.render=e,i=t.node;this.title.label.innerText(`${i.label}`),this.body.title.setValue(i.label,"标题"),this.body.idLabel.setValue(i.id,"id"),this.body.divider.setMsg(`index: ${i.index.toString()}`);const s=i.getOption("nodeFontColor"),o=i.getOption("nodeTitleColor"),n=i.getOption("nodeColor");this.root.setStyle({backgroundColor:n!=null?n:"#4b4b4b"}),this.title.root.setStyle({backgroundColor:o!=null?o:"rgb(54 54 54)"}),this.body.idLabel.styles.fontColor=s!=null?s:"#ffffff",this.body.idLabel.styles.backColor=n!=null?n:"#4b4b4b",this.body.title.styles.fontColor=s!=null?s:"#ffffff",this.body.title.styles.backColor=n!=null?n:"#4b4b4b",this.body.idLabel.refresh(),this.body.title.refresh();for(let r of this.body.props)r.remove();this.body.props=[];for(let r in i.properties){const l=i.properties[r];switch(typeof l){case"string":const h=new K(this.body.root);h.setValue(l.toString(),r),h.styles.backColor=n!=null?n:"#4b4b4b",h.styles.fontColor=s!=null?s:"#ffffff",h.refresh(),h.onChange(g=>{i.setProperty(r,g)}),this.body.props.push(h);break;case"number":const u=new K(this.body.root);u.input.setAttribute("type","number"),u.setValue(l.toString(),r),u.styles.backColor=n!=null?n:"#4b4b4b",u.styles.fontColor=s!=null?s:"#ffffff",u.refresh(),u.onChange(g=>{i.setProperty(r,g)}),this.body.props.push(u);break}}if(t.node.inputs.length){let r=new dt("输入参数");this.body.props.push(r),this.body.root.add(r);for(let l=0;l<t.node.inputs.length;l++){const h=t.node.inputs[l],u=new K(this.body.root);u.setValue(h.label),u.label.innerText("输入"+(l+1)),u.onChange(g=>{var p,x;h.label=g,(x=(p=h.node.render)==null?void 0:p.getInput(l))==null||x.refresh()}),this.body.props.push(u)}}if(t.node.outputs.length){let r=new dt("输出参数");this.body.root.add(r),this.body.props.push(r);for(let l=0;l<t.node.outputs.length;l++){const h=t.node.outputs[l],u=new K(this.body.root);u.setValue(h.label),u.label.innerText("输入"+(l+1)),u.onChange(g=>{var p,x;h.label=g,(x=(p=h.node.render)==null?void 0:p.getOutput(l))==null||x.refresh()}),this.body.props.push(u)}}}show(e){this.render&&this.render.renderEvents.remove(z.Refresh,this.onNodeRefresh);const t=e,i=1/t.events.getScale(!0),s=t.events.getParentScale(),o=t.root.DOM.getBoundingClientRect(),n=this.parent.DOM.getBoundingClientRect(),r=(o.left-n.left)*s,l=(o.top-n.top)*s;this.root.setStyle({position:"absolute",width:o.width+"px",height:o.height+"px",top:l+"px",left:r+"px",opacity:"0.7",zIndex:"99999",boxSizing:"border-box",transformOrigin:"left top"}),setTimeout(()=>{let h=o.width*i*s*2,u=o.height*i*s*2,g=l-(u-o.height)/2*s,p=r-(h-o.width)/2*s;h>=n.width&&(h=n.width,p=0),u>=n.height&&(u=n.height,g=0),p<=0&&(p=0),g<=0&&(g=0),this.root.setStyle({width:h+"px",height:u+"px",left:p+"px",top:g+"px",opacity:"1",transform:`scale(${s})`})},0),this.refresh(e),this.onNodeRefresh=()=>{this.render&&this.refresh(this.render)},e.renderEvents.add(z.Refresh,this.onNodeRefresh),setTimeout(()=>{this.body.root.DOM.scrollTop=0},0),this.root.show(),this.isShow=!0}hide(){if(this.render){this.render.renderEvents.remove(z.Refresh,this.onNodeRefresh);const e=this.render,t=e.events.getParentScale(),i=e.root.DOM.getBoundingClientRect(),s=this.parent.DOM.getBoundingClientRect(),o=(i.left-s.left)*t,n=(i.top-s.top)*t;this.root.setStyle({width:i.width+"px",height:i.height+"px",top:n+"px",left:o+"px"})}St(450).then(()=>{this.root.hide()}),this.render=null,this.isShow=!1}}class dt extends v{constructor(t=""){super();a(this,"label");a(this,"msg","标题");t&&(this.msg=t),this.label=new v,this.init()}init(){this.setStyle({backgroundColor:"rgb(54 54 54)",width:"calc( 100% - 10px )",height:"4px",marginLeft:"5px",marginRight:"5px",marginTop:"15px",marginBottom:"15px",textAlign:"center",position:"relative",userSelect:"auto",webkitUserSelect:"auto"}),this.label.innerText(this.msg).setBackgroundColor("rgb(54 54 54)").setAbsolute().setFontSize(16).setPaddingLeft("10px").setPaddingRight("10px").setTop("-10px").setLeft("10px").setStyle({lineHeight:"24px"}),this.add(this.label)}setMsg(t=""){this.label.innerText(t)}}class ee{constructor(e,t){a(this,"type",O.DomUI);a(this,"rootDom");a(this,"events");a(this,"contextMenu");a(this,"associativeMenu");a(this,"nodePanel");a(this,"isShowContextMenu",!1);this.rootDom=e,this.events=t,this.contextMenu=this.createMenu(this.rootDom),this.associativeMenu=this.createMenu(this.rootDom),this.nodePanel=new te(this.rootDom),this.events.add(c.NodeDown,(i,s)=>{this.nodePanel.render&&s!==this.nodePanel.render&&this.nodePanel.hide()})}createMenu(e){const t=new v;t.setAbsolute(),t.addClass("g-menu").setStyle({minWidth:"88px",width:"88px",minHeight:"20px",backgroundColor:"rgb(59, 59, 59)",borderRadius:"3px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",display:"flex",alignContent:"center",flexWrap:"wrap",flex:"1"}).hide();const i=s=>(s.stopPropagation(),!1);return t.DOM.addEventListener("pointerdown",i),t.DOM.addEventListener("pointerup",i),t.DOM.addEventListener("pointermove",i),t.DOM.addEventListener("mousedown",i),t.DOM.addEventListener("mouseup",i),t.DOM.addEventListener("mousemove",i),t.onWheel(s=>{s.stopPropagation(),s.wheelDelta>0?t.setTop(t.getOffsetTop()+10):t.setTop(t.getOffsetTop()-10)}),e.add(t),{menu:t,width:0,directionX:"left"}}onMenuClick(e,t,i,s,o,n){return()=>{const r=i.menu;o&&o(e);const l=r.DOM.getElementsByClassName(`${v.prefix}g-menu`);for(let h of l)r.DOM.removeChild(h);if(!s)n&&n();else{const h=this.createMenu(r);h.directionX=i.directionX,h.menu.setStyle({display:"flex"}).setLeft(r.DOM.offsetWidth+2).setTop(26*t),i.directionX==="right"&&setTimeout(()=>{h.menu.setLeft(-h.menu.getClientWidth()-3)},0),this.addItemInMenu(e,h,s,n)}}}addItemInMenu(e,t,i,s){const o=t.menu;let n=0;for(let r in i){const l=i[r],h=new v;if(!l)n+=1,h.setStyle({backgroundColor:"#919191",width:"calc( 100% - 10px )",height:"1px",marginLeft:"5px",marginRight:"5px"});else{const{label:u,callback:g,subMenu:p}=l;h.setStyle({height:"18px",width:"100%",color:"white",fontSize:"13px",cursor:"pointer",borderRadius:"3px",padding:"4px",textAlign:"center"}).innerText(u),h.onMouseover(()=>{h.setStyle({backgroundColor:"#505050"})}),h.onMouseout(()=>{h.setStyle({backgroundColor:"rgb(59, 59, 59)"})});const x=Math.trunc(u.length/5);if(x>=1){const f=x*88+u.length%5*.1*88;o.getClientWidth()<f&&o.setWidth(f),t.width=f}else t.width=88;if(p){const f=new v;f.setStyle({position:"absolute",width:"3px",height:"18px",right:"3px",top:`${(parseInt(r)-n)*26+n*1+4}px`,background:"#61ff3c",borderRadius:"5px"}),h.add(f)}h.onClick(this.onMenuClick(e,parseInt(r)-n,t,p,g,s))}o.add(h)}}showMenu(e,t,i){const s=e.menu,o=this.events.getParentScale(),n=this.rootDom.getClientWidth();s.setStyle({transform:`scale(${o})`,transformOrigin:"left top"}),(e.width+t)*o>n?(s.setLeft((t-e.width)*o).setTop(i*o),e.directionX="right"):(s.setLeft(t*o).setTop(i*o),e.directionX="left"),setTimeout(()=>{s.setStyle({display:"flex"})},0)}openContextMenu({x:e,y:t},i){this.contextMenu.menu.innerText(""),this.addItemInMenu({x:e,y:t},this.contextMenu,i,()=>{this.closeContextMenu()}),this.showMenu(this.contextMenu,e,t),this.isShowContextMenu=!0}closeContextMenu(){this.contextMenu.menu.hide(),this.isShowContextMenu=!1}getContextMenu(e){const t=e.graph,i=t.getNodeClassInfo(),s=g=>{const p=this.events.getScale();return x=>{this.events.dispatch(S.AddNode,g,{x:(x.x-this.events.viewPosition.x)/p,y:(x.y-this.events.viewPosition.y)/p})}},o=[],n={};for(let g in i){const{label:p,path:x,notAddContextMenu:f}=i[g];if(f)continue;const m={label:p,callback:s(g)};if(x==="")o.push(m);else{const b=x.split("/");let M="";for(let D in b){const R=b[D],A=`${M}_${R}`;if(parseInt(D)===0){if(!n[A]){const U=[];n[A]=U,o.push({label:R,subMenu:U})}}else if(!n[A]){const U=n[M],at=[];n[A]=at,U.push({label:R,subMenu:at})}parseInt(D)===b.length-1&&n[A].push(m),M=A}}}const r=[],l=t.externalGraph,h=this.events.getScale();for(let g in l){const{name:p,data:x}=l[g];r.push({label:p,callback:f=>{const m=new _;m.deserialize(x);const b=e.addNode(t.subGraphType,{x:(f.x-this.events.viewPosition.x)/h,y:(f.y-this.events.viewPosition.y)/h,z:0});b&&(b.setSubGraph(m),b.refreshViewer(),b.getLabel=()=>p)}})}const u=[{label:"添加节点",subMenu:o}];return r.length!==0&&u.push({label:"游离子图",subMenu:r}),u}openAssociativeMenu(e,t,i,s){const o=[];this.associativeMenu.menu.innerText("");for(let{type:n,label:r,path:l,associativeNode:h}of s)o.push({label:r,callback:()=>{this.events.dispatch(S.AddNode,n,i)}});o.length!==0&&(this.addItemInMenu(i,this.associativeMenu,o,()=>{this.closeAssociativeMenu()}),this.showMenu(this.associativeMenu,i.x,i.y))}closeAssociativeMenu(){this.associativeMenu.menu.hide()}openNodePanel(e){this.nodePanel.show(e)}}class ie extends Rt{constructor(t){super();a(this,"viewer");a(this,"viewStart",null);a(this,"viewEnd",null);this.viewer=t,this.setStyle({position:"absolute",right:"10px",bottom:"10px",width:"304px",height:"204px",background:"black",opacity:"0.8",borderRadius:"10px",cursor:"pointer"});const i=window.devicePixelRatio;this.setAttribute("width",`${304*i}`),this.setAttribute("height",`${204*i}`),this.ctx.scale(i,i);let s=()=>{this.render(),requestAnimationFrame(s)};s(),this.initEvents()}initEvents(){this.onDblClick(i=>{i.stopPropagation()});let t=null;this.onMousedown(i=>{i.stopPropagation(),t={x:i.offsetX,y:i.offsetY},this.setViewPosition({x:i.offsetX,y:i.offsetY})}),this.onMousemove(i=>{t!==null&&(i.stopPropagation(),this.setViewPosition({x:i.offsetX,y:i.offsetY}))}),document.addEventListener("mouseup",i=>{t=null})}setViewPosition(t){const{Xscale:i,Yscale:s,viewStart:o,viewEnd:n,minX:r,minY:l}=this.getViewInfo();let h={x:-r,y:-l},u={x:(t.x-Math.abs(n.x-o.x)/2)/i,y:(t.y-Math.abs(n.y-o.y)/2)/s};const g=this.viewer.events.getScale();h={x:(h.x-u.x)*g,y:(h.y-u.y)*g},this.viewer.events.viewPosition=h,this.viewer.getRenderByTarget(y.Node).setPosition()}getViewInfo(){const t=this.viewer.graph.getNodes(),i=this.viewer.rootDom.DOM.getBoundingClientRect();t.sort((m,b)=>m.position.x-b.position.x);let s=t[t.length-1].position.x;const o=t[0].position.x;t.sort((m,b)=>m.position.y-b.position.y);let n=t[t.length-1].position.y;const r=t[0].position.y;n-r<i.height&&(n=r+i.height),s-o<i.width&&(s=o+i.width);const l=300/(s-o),h=200/(n-r);let u=m=>{let b=(m.position.x-o)*l,M=(m.position.y-r)*h;return{x:b,y:M}};const g=this.viewer.events.getScale(),p=this.viewer.events.viewPosition,x={x:(-p.x/g-o)*l,y:(-p.y/g-r)*h};this.viewStart=x;const f={x:x.x+i.width*l/g,y:x.y+i.height*h/g};return{Xscale:l,Yscale:h,viewStart:x,viewEnd:f,minX:o,minY:r,getMiniPosition:u}}render(){this.ctx.clearRect(0,0,304,204);const t=this.viewer.graph.getNodes();if(!t.length)return;const{viewStart:i,viewEnd:s,getMiniPosition:o}=this.getViewInfo();this.ctx.beginPath(),this.ctx.lineWidth=2,this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(i.x,s.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(s.x,i.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.closePath(),t.forEach(n=>{let r=o(n);this.viewer.graph.checkNodeRuned(n)?(this.ctx.fillStyle=N.style.NodeRunningColor,this.ctx.strokeStyle=N.style.LineRunningColor):(this.ctx.fillStyle=N.style.NodeHighLightColor,this.ctx.strokeStyle="white"),this.ctx.fillRect(r.x,r.y,4,4),this.ctx.lineWidth=1,n.outputs.forEach(l=>{l.link&&l.link.forEach(h=>{this.ctx.beginPath(),this.ctx.moveTo(r.x+2,r.y+2);let u=o(h.target.node);this.ctx.lineTo(u.x+2,u.y+2),this.ctx.stroke(),this.ctx.closePath()})})})}}const B=class B{static error(e=""){B.msg(e,"#fc5d65","#ffedee")}static info(e=""){B.msg(e,"#919398","#eef2fb")}static success(e=""){B.msg(e,"#7ec050","#f2f9ec")}static warning(e=""){B.msg(e,"#DCA550","#fcf6ed")}static msg(e="",t="#000",i="#fff"){e||(e="提示！");let s=new v,o=20;B.msgs.forEach(n=>{o+=n.DOM.getBoundingClientRect().height,o+=10}),s.setBackgroundColor(i).setColor(t).addClass("all-center").addClass("alert-msg-global").setPosition("fixed").setTop("0px").setHeight("40px").setWidth("200px","min").setBorderRadius("10px").setPaddingLeft("20px").setPaddingRight("20px").innerText(e),s.setStyle({lineHeight:"40px",opacity:"0",zIndex:"2001",textAlign:"center",transition:"top 0.5s ease-in-out,opacity 0.5s ease-in-out",fontWeight:"bold"}),setTimeout(()=>{s.setLeft(`calc(50% - ${s.DOM.getBoundingClientRect().width/2}px)`)},0),setTimeout(()=>{s.setStyle({opacity:"1",top:o+"px"})},200),document.body.appendChild(s.DOM),B.msgs.push(s),setTimeout(()=>{s.setStyle({opacity:"0",top:"0px"})},2500),setTimeout(()=>{document.body.removeChild(s.DOM)},3e3),setTimeout(()=>{B.msgs=B.msgs.filter(n=>{})},3200)}};a(B,"msgs",[]);let Q=B;const k=class k{constructor(e,t=null,i={controlShow:!0,searchBoxShow:!0,miniMapShow:!0,readonly:!1}){a(this,"rootDom");a(this,"graph");a(this,"events");a(this,"managers",{});a(this,"renderTargetMap",{[y.Node]:O.Dom,[y.Link]:O.Svg,[y.UI]:O.DomUI});a(this,"ActiveNodes",[]);a(this,"tools",{});a(this,"animate",0);a(this,"customContextMenuFuncs",[]);var o;Y.initDefaultWidget(),this.rootDom=new v,this.rootDom.DOM=e,this.rootDom.setStyle({overflow:"hidden",userSelect:"none",webkitUserSelect:"none",position:"relative"}),e.addEventListener("dragstart",n=>{n.preventDefault()}),this.graph=t!=null?t:new _,this.events=new Yt(this.rootDom,this),i!=null&&i.readonly&&this.events.setReadOnly(!0);const s=[qt,Gt,ee];this.rootDom.setId(this.graph.id),this.rootDom.setAttribute("graph-id",this.graph.id);for(let n of s){const r=new n(this.rootDom,this.events);this.managers[r.type]=r}if(this.initEventListener(),i.searchBoxShow){let n=new Jt(this);this.rootDom.add(n),this.tools.searchBox=n}if(i.controlShow){let n=new Kt(this.graph,this.events);this.rootDom.add(n),this.tools.control=n}if(i.miniMapShow){let n=new ie(this);this.rootDom.add(n),this.tools.miniMap=n}this.graph.parentNode&&((o=this.tools.miniMap)==null||o.hide())}get registerNode(){return this.graph.registerNode.bind(this.graph)}get registerWidget(){return Y.registerWidget.bind(this.graph)}get registerExternalGraph(){return this.graph.registerExternalGraph.bind(this.graph)}initEventListener(){document.addEventListener("keydown",t=>{t.code=="Delete"&&k.ActiveNode&&this.graph.runningStatus=="stop"&&this.removeNode(k.ActiveNode.node.id)});const e={x:0,y:0};document.onkeydown=t=>{if(t.key==="Delete"&&(k.ActiveNode&&this.removeNode(k.ActiveNode.node.id),this.ActiveNodes.length>0))for(const i of this.ActiveNodes)this.removeNode(i.node.id)},this.events.add(c.OpenContextMenu,({position:t,type:i,target:s})=>{const o=this.getRenderByTarget(y.UI);if(this.graph.isInSubgraph(t)){o.closeContextMenu();return}if(this.graph.parentNode){const r=this.graph.parentNode.widgets[0],l=r.viewer.events.getParentScale();if(t.x<0||t.y<0||t.x>r.viewerDom.getClientWidth()/l||t.y>r.viewerDom.getClientHeight()/l){o.closeContextMenu();return}}if(!o)return;let n=[];switch(i){case W.Widget:const r=s.widget;if(r.getContextMenu){n=r.getContextMenu();break}else return this.events.dispatch(c.CloseContextMenu),!1;case W.Slot:n=[...s.slotRender.getContextMenu()];case W.Node:const h=s.nodeRender;n=[...n,{label:"运行顺序",subMenu:[{label:"触发条件",callback:()=>{h.node.addInput({label:"触发条件",valueType:[ot],options:{remove:!0}})}},{label:"执行后",callback:()=>{h.node.addOutput({label:"执行后",valueType:ot,options:{remove:!0}})}}]}];const u=N.nodeStyles;let g=[];for(const p of u)g.push({label:p.name,callback:()=>{h.node.setOption("nodeColor",p.nodeColor),h.node.setOption("nodeTitleColor",p.nodeTitleColor),h.node.setOption("nodeFontColor",p.nodeFontColor),h.refresh()}});n=[...n,null,{label:"颜色",subMenu:g}],n=[...n,null,...h.getContextMenu()],this.ActiveNodes.length&&(n=[...n,null,{label:"批量操作",subMenu:[{label:`克隆${this.ActiveNodes.length}个节点`,callback:()=>{let p=[];this.ActiveNodes.forEach(x=>{var m;let f=this.cloneNode(x.node.id);(m=f==null?void 0:f.render)==null||m.setHighLight(),p.push(f==null?void 0:f.render)}),k.ActiveNode=void 0,this.ActiveNodes.forEach(x=>{x.cancelHighLight()}),this.ActiveNodes=p}},{label:`删除${this.ActiveNodes.length}个节点`,callback:()=>{k.ActiveNode=void 0,this.ActiveNodes.forEach(p=>{this.removeNode(p.node.id)}),this.ActiveNodes=[]}},{label:"合并到子图",callback:p=>{this.mergeToSubgraph(this.ActiveNodes)}}]}]);case W.None:n.length>0?n=[...o.getContextMenu(this),null,...n]:n=[...o.getContextMenu(this)]}if(this.graph.parentNode&&(this.graph.parentNode.inputs.length!==0||this.graph.parentNode.outputs.length!==0)){const r=this.getRenderByTarget(y.Node),l=this.graph.parentNode,h=[],u=[],g=[];if(l.outputs.length!==0){let p=!1;for(let x of l.outputs)x.subGraphNode||(h.push({label:x.label,callback:f=>{var b;const m=this.addNode(this.graph.subGraphOutputType,f);m.setParentSlot(x),(b=r.getNodeRender(m.id))==null||b.refresh()}}),p=!0);p&&g.push({label:"外部输出",subMenu:h})}if(l.inputs.length!==0){g.push({label:"外部输入",subMenu:u});for(let p of l.inputs)u.push({label:p.label,callback:x=>{var m;const f=this.addNode(this.graph.subGraphInputType,x);f.setParentSlot(p),(m=r.getNodeRender(f.id))==null||m.refresh()}})}n=[...n,{label:"子图插槽",subMenu:g}]}for(let r of this.customContextMenuFuncs)n=[...n,...r({position:t,type:i,target:s})];o.openContextMenu(t,n)}),this.events.add(c.CloseContextMenu,()=>{const t=this.getRenderByTarget(y.UI);t&&t.closeContextMenu()}),this.events.add(c.DragNodeStart,(t,{nodeRender:i})=>{const s=this.events.getScale();e.x=t.x/s-i.node.position.x,e.y=t.y/s-i.node.position.y}),this.events.add(c.DragNodeMove,(t,{nodeRender:i})=>{const s=this.getRenderByTarget(y.Link),o=this.getRenderByTarget(y.Node);if(!s||!o)return;const n=this.events.getScale(),r={x:t.x/n-e.x,y:t.y/n-e.y,z:0},l=i.node;if(this.ActiveNodes.indexOf(i)>-1){const h={x:r.x-l.position.x,y:r.y-l.position.y};this.ActiveNodes.forEach(u=>{const g={x:u.node.position.x+h.x,y:u.node.position.y+h.y,z:0};u.setPosition(g.x,g.y),u.node.setPosition(g)})}else i.setPosition(r.x,r.y),l.setPosition(r);s.refresh()}),this.events.add(c.DragSlotStart,(t,{nodeRender:i,slotRender:s})=>{var l,h;if(this.graph.runningStatus==="running")return;const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return;o.displayTempLine(!0);const r=s.slot;if(r.type===w.INPUT&&r.link){const u=r.link.origin,g=r.link;o.removeLink(g.id),this.graph.removeLink(g),(l=n.getNodeRender(g.originNode.id))==null||l.refresh(),(h=n.getNodeRender(g.targetNode.id))==null||h.refresh(),this.events.mouseInfo.target={nodeRender:i,slotRender:n.getSlotRender(u.node.id,u.index,!0)}}}),this.events.add(c.DragSlotMove,(t,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return;const r=s.slot;let l=s.getPosition(),h=s.getPosition(),u=!0;r.type===w.INPUT?(l=t,u=!1):h=t,o.setTempLine(l,h,u)}),this.events.add(c.DragSlotEnd,(t,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.Link);if(o){switch(o.displayTempLine(!1),this.events.mouseInfo.enterType){case W.Node:break;case W.Slot:const n=this.events.mouseInfo.enterTarget;if(s.slot.type===n.slot.type||s.slot.node===n.slot.node)return;s.slot.type===w.INPUT?this.addLink(n.slot.node.id,n.slot.index,s.slot.node.id,s.slot.index):this.addLink(s.slot.node.id,s.slot.index,n.slot.node.id,n.slot.index);break;case W.None:break}o.refresh()}}),this.events.add(c.DragViewMove,t=>{const i=this.getRenderByTarget(y.Link),s=this.getRenderByTarget(y.Node);!i||!s||(s.setPosition(),i.refresh())}),this.events.add(c.ViewScale,t=>{const i=this.getRenderByTarget(y.Link);this.getRenderByTarget(y.Node).setPosition(),i.refresh()}),this.events.add(c.MouseDown,()=>{var t;if(this.ActiveNodes.length){for(const i of this.ActiveNodes)i.cancelHighLight();this.ActiveNodes=[]}k.ActiveNode&&!this.graph.checkNodeRuned(k.ActiveNode.node)&&((t=k.ActiveNode)==null||t.cancelHighLight(),k.ActiveNode=void 0)}),this.events.add(c.NodeDown,(t,i)=>{this.getRenderByTarget(y.UI).closeContextMenu(),k.ActiveNode&&!this.graph.checkNodeRuned(k.ActiveNode.node)&&this.ActiveNodes.indexOf(i)==-1&&(k.ActiveNode.cancelHighLight(),this.ActiveNodes.forEach(o=>{o.cancelHighLight()}),this.ActiveNodes=[]),i.setHighLight(),i.node.events.dispatch(z.Down,i),k.ActiveNode=i}),this.events.add(c.SelectedNode,(t,i)=>{const o=this.managers.DomRender.getAllNodes();this.ActiveNodes=[];const n=this.events.getScale();for(const r of o){const l=r.node.position.x*n+this.events.viewPosition.x,h=r.node.position.y*n+this.events.viewPosition.y,u=r.getContent().getClientWidth()*n,g=r.getContent().getClientHeight()*n,p=[l,l+u],x=[h,h+g],f=[t.x,i.x],m=[t.y,i.y],b=(M,D)=>{let R=[Math.min(...M),Math.min(...D)],A=[Math.max(...M),Math.max(...D)];return Math.max(...R)<=Math.min(...A)};b(p,f)&&b(x,m)?(this.ActiveNodes.push(r),r.setHighLight()):r.cancelHighLight()}}),this.events.add(c.OpenAssociativeMenu,(t,{nodeRender:i,slotRender:s})=>{const o=this.getRenderByTarget(y.UI);if(!o)return;const n=i.node;if(n.associativeNode.length>0){const r=[],l=this.graph.getNodeClassInfo();for(let h in l)n.associativeNode.indexOf(h)!==-1&&r.push(l[h]);o.openAssociativeMenu(n,s.slot,t,r)}}),this.events.add(c.CloseAssociativeMenu,()=>{const t=this.getRenderByTarget(y.UI);t&&t.closeAssociativeMenu()}),this.events.add(c.DoubleLeftClick,(t,i,s)=>{const o=this.getRenderByTarget(y.UI);if(o)switch(i.type){case W.Node:const n=i.target.nodeRender;this.focusOnNode(n.node.id,!1,()=>{o.openNodePanel(n)});break}}),this.events.add(S.AddNode,(t,i={x:0,y:0,z:0},s={},o={})=>{this.addNode(t,i,s,o)}),this.events.add(S.RemoveNode,t=>{this.removeNode(t)}),this.events.add(S.CloneNode,t=>{var s,o;let i=this.cloneNode(t);(s=k.ActiveNode)==null||s.cancelHighLight(),(o=i==null?void 0:i.render)==null||o.setHighLight()}),this.events.add(S.AddNodeInput,(t,i)=>{t.node.addInput(i),t.refresh()}),this.events.add(S.AddNodeOutput,(t,i)=>{t.node.addOutput(i),t.refresh()}),this.events.add(S.FocusOnNode,(t,i=!0,s)=>{this.focusOnNode(t,i,s)}),this.events.add(S.RemoveNodeSlot,t=>{const i=t.slot;this.removeSlot(i)})}getRenderByTarget(e){return this.managers[this.renderTargetMap[e]]}getNodeManager(){return this.managers.DomRender}addNode(e,t={x:0,y:0,z:0},i={},s={}){const o=this.graph.createNode(e,t,i,s),n=this.getRenderByTarget(y.Node);if(!n)return null;let r=n.addNode(o);return o.setRender(r),o.setViewer(this),o}addLink(e,t,i,s){const o=this.getRenderByTarget(y.Link),n=this.getRenderByTarget(y.Node);if(!o||!n)return null;const r=this.graph.getNode(e),l=this.graph.getNode(i);if(!r||!l||r.outputs.length<=t||l.inputs.length<=s)return;const u=l.inputs[s].link,g=this.graph.addLink(r,t,l,s);if(!g)return;if(u){o.removeLink(u.id);const b=n.getSlotRender(u.originNode.id,u.origin.index,!0);b==null||b.setLinked(!1)}const p=n.getNodeRender(e),x=n.getNodeRender(i);if(!p||!x)return;const f=p.getOutput(t),m=x.getInput(s);!f||!m||(o.addLink(g,f,m),p.refresh(),x.refresh())}cloneNode(e){const t=this.graph.getNode(e);if(!t||t.options.notClone)return;const i={x:20,y:20};let s=t.serialize();s.id=P.createId(),s.position=[t.position.x+i.x,t.position.y+i.y,t.position.z],this.graph.nodeManager.deserializeNode(s);const o=this.graph.getNode(s.id);let r=this.getRenderByTarget(y.Node).addNode(o);return o.setRender(r),o.setViewer(this),o.deserialize(s),o}removeNode(e){const t=this.getRenderByTarget(y.Link),i=this.getRenderByTarget(y.Node);if(!t||!i)return;const s=this.graph.getNode(e);if(s){for(let o of s.getAllLinks())t.removeLink(o.id);i.removeNode(e),this.graph.removeNode(e),i.refresh()}}removeLink(e){const t=this.getRenderByTarget(y.Link),i=this.getRenderByTarget(y.Node);!t||!i||(this.graph.removeLinkById(e),t.removeLink(e),i.refresh())}setScale(e){this.events.setScale(e)}refresh(e=!1){const t=this.graph.getNodes(),i=this.getRenderByTarget(y.Node);t.forEach(n=>{if(!i)return null;let r=i.addNode(n);n.setRender(r),n.setViewer(this)});const s=this.graph.getLinks(),o=this.getRenderByTarget(y.Link);s.forEach(n=>{const r=i.getNodeRender(n.originNode.id),l=i.getNodeRender(n.targetNode.id);if(!r||!l)return;const h=r.getOutput(n.origin.index),u=l.getInput(n.target.index);!h||!u||(o.addLink(n,h,u),r.refresh(),l.refresh())}),t.length>0&&e&&this.focusOnNode(t[0].id,!1)}serialize(){let e=this.graph.serialize();return Object.assign({viewPosition:this.events.viewPosition},e)}deserialize(e){this.graph.deserialize(e);const t=this.getRenderByTarget(y.Node);e.viewPosition&&(this.events.viewPosition=e.viewPosition,t.setPosition()),this.refresh()}clearAll(){this.graph.getNodes().forEach(s=>{this.graph.removeNode(s.id)});const t=this.getRenderByTarget(y.Node);this.getRenderByTarget(y.Link).clear(),t.root.clear(),setTimeout(()=>{this.events.dispatch(S.StopRun)},0),this.events.viewPosition.x=0,this.events.viewPosition.y=0,t.setPosition(),this.events.setScale(1)}focusOnNode(e,t=!0,i){cancelAnimationFrame(this.animate);let s=null;if(e)s=this.graph.getNode(e);else{let f=this.graph.getNodes();f.length&&(s=f[0])}if(!s)return;const o=this.getRenderByTarget(y.Node),n=this.events.getScale(),r=o.getNodeRender(s.id);let l=0;const h={x:-s.position.x*n+this.rootDom.DOM.getBoundingClientRect().width/2-r.getContent().getBoundingClientRect().width/2,y:-s.position.y*n+this.rootDom.DOM.getBoundingClientRect().height/2-r.getContent().getBoundingClientRect().height/2},u={x:h.x-this.events.viewPosition.x,y:h.y-this.events.viewPosition.y},g=this.graph.stepTime*.6,p=this.events.viewPosition;if(!e){this.events.viewPosition=u,o.setPosition();return}let x=f=>{l||(l=f);const m=f-l,b=p.x+u.x*(m/g),M=p.y+u.y*(m/g);this.events.viewPosition={x:b,y:M},o.setPosition(),m<=g?this.animate=requestAnimationFrame(x):i&&i()};this.animate=requestAnimationFrame(x),t&&setTimeout(()=>{var f;(f=s.render)==null||f.shake()},this.graph.stepTime*.5)}addCustomContextMenuFunc(e){this.customContextMenuFuncs.push(e)}getActiveNode(){var e;return(e=k.ActiveNode)==null?void 0:e.node}removeSlot(e){if(!e.options.remove)return;const t=this.getRenderByTarget(y.Node);if(!t)return;const i=e.node;if(e.type===w.INPUT)e.link&&this.removeLink(e.link.id);else if(e.link.length>0)for(let o of e.link)this.removeLink(o.id);this.graph.removeSlot(e);const s=t.getNodeRender(i.id);s==null||s.refresh()}setViewerMode(){this.events.setReadOnly(!0)}disbleViewerMode(){this.events.setReadOnly(!1)}mergeToSubgraph(e){if(!$t(e))return Q.warning("[警告]选中节点并非连续节点，无法合并为子图");const t=e[0].getPosition(),i=this.addNode(this.graph.subGraphType,{x:t.x,y:t.y,z:0}),s=i.subViewer,o=Object.assign({},t),n={},r={};for(let l of e){const h=l.node;let u=h.serialize();u.id=P.createId(),u.position=[h.position.x-o.x,h.position.y-o.y,h.position.z],s.graph.nodeManager.deserializeNode(u);const g=s.graph.getNode(u.id);let x=s.getRenderByTarget(y.Node).addNode(g);g.setRender(x),g.setViewer(s),g.deserialize(u);for(let f of h.inputs.concat()){if(!f.link)continue;const m=f.link;if(e.indexOf(f.link.originNode.render)===-1){const b=i.addInput({label:f.label,valueType:f.valueType.concat(),options:{isVertical:!!f.options.isVertical},defaultValue:f.defaultValue}),M=s.addNode(this.graph.subGraphInputType,{x:g.position.x-128-100,y:g.position.y-f.index*40,z:g.position.z});M.setParentSlot(b),s.addLink(M.id,0,g.id,f.index),this.addLink(f.link.originNode.id,f.link.origin.index,i.id,b.index),this.removeLink(f.link.id)}else if(n[m.originNode.id]){const b=r[n[m.originNode.id]];s.addLink(b.id,m.origin.index,g.id,m.target.index)}}for(let f of h.outputs){let m=!1;for(let b of f.link.concat())if(e.indexOf(b.targetNode.render)===-1){const M=i.addOutput({label:f.label,valueType:f.valueType.concat(),options:{isVertical:!!f.options.isVertical},defaultValue:f.defaultValue}),D=s.addNode(this.graph.subGraphOutputType,{x:g.position.x+128+100,y:g.position.y-f.index*40,z:g.position.z});D.setParentSlot(M),m||(s.addLink(g.id,f.index,D.id,0),m=!0),this.addLink(i.id,M.index,b.targetNode.id,b.target.index)}else if(n[b.targetNode.id]){const M=r[n[b.targetNode.id]];s.addLink(g.id,b.origin.index,M.id,b.target.index)}}n[h.id]=g.id,r[g.id]=g}for(let l of e)this.removeNode(l.node.id)}};a(k,"ActiveNode");let Z=k;var it=(d=>(d[d.min=0]="min",d[d.window=1]="window",d))(it||{});class Bt extends F{constructor(t){var r;super();a(this,"graph");a(this,"viewer");a(this,"viewerDom");a(this,"minDom");a(this,"mode",1);a(this,"minSize",{w:400,h:300});a(this,"size",{w:this.minSize.w,h:this.minSize.h});const i=this.viewerDom=new v,s=new v;i.setStyle({position:"relative",top:"0px",left:"0px"}),s.setStyle({position:"absolute",top:"10px",left:"10px",width:"26px",height:"26px",backgroundColor:"rgb(26 26 26)",borderRadius:"5px",textAlign:"center",lineHeight:"23px",cursor:"pointer",color:"white"}).innerText("-"),s.onClick(()=>{this.setMode(0)});const o=this.minDom=new v;o.onContextmenu(l=>{l.preventDefault()});const n=new v;o.setStyle({width:"120px",height:"30px"}),n.setStyle({width:"100%",height:"100%",backgroundColor:"#6FA1FF",borderRadius:"6px",textAlign:"center",lineHeight:"30px"}),n.innerText("展开子图"),n.onMouseout(()=>{n.setBackgroundColor("#6FA1FF")}),n.onMouseover(()=>{n.setBackgroundColor("#409eff")}),n.onClick(()=>{this.setMode(1)}),o.add(n),this.add(o),this.add(i),this.graph=(r=t.graph)!=null?r:new _,this.viewer=new Z(i.DOM,this.graph),i.add(s),this.initEventListener(),this.setMode(this.mode)}initEventListener(){this.onMousedown(t=>{t.stopPropagation()}),this.onMouseup(t=>{}),this.onMousemove(t=>{}),this.onWheel(t=>{t.stopPropagation()}),this.onContextmenu(t=>{t.stopPropagation()})}setMode(t){var i,s,o,n;switch(this.mode=t,t){case 0:if(this.viewerDom.DOM.style.position=="absolute"){Q.warning("子图正处于放大状态，请先退出子图");return}(s=(i=this.graph.parentNode)==null?void 0:i.render)==null||s.widgetsBox.setAlignItems("center"),this.viewerDom.hide(),this.minDom.show();break;case 1:(n=(o=this.graph.parentNode)==null?void 0:o.render)==null||n.widgetsBox.setAlignItems("inherit"),this.viewerDom.show(),this.minDom.hide();break}this.refreshSize(),this.onChangeMode(t)}refreshSize(){switch(this.mode){case 0:this.setWidth(this.minDom.getClientWidth()),this.setHeight(this.minDom.getClientHeight());break;case 1:this.viewerDom.setWidth(this.size.w).setHeight(this.size.h),this.setWidth(this.size.w).setHeight(this.size.h);break}}onChange(t){}getValue(){}setValue(t){}onChangeMode(t){}setGraph(t){this.graph=t,this.viewer.graph=t,this.viewer.tools.control.graph=t}refresh(...t){this.viewer.refresh(...t)}changeSize(t){this.size.w+=t.w,this.size.h+=t.h,this.refreshSize()}}a(Bt,"widgetType","graph");class ut extends F{constructor(t){var i;super();a(this,"DOM");this.DOM=document.createElement("input"),this.DOM.type=(i=t==null?void 0:t.type)!=null?i:"text",t!=null&&t.placeholder&&(this.DOM.placeholder=t.placeholder),t!=null&&t.title&&(this.DOM.title=t.title),t!=null&&t.value&&(this.DOM.value=t.value),this.setStyle({flex:"1",border:"0",marginLeft:"4px",borderRadius:"5px",outline:"none",textIndent:"2px",fontSize:"14px",height:"20px",color:"black"}),this.onMousedown(s=>{s.stopPropagation()})}onChange(t){this.DOM.addEventListener("input",()=>{t(this.DOM.value)})}getValue(){return this.DOM.value}setValue(t){this.DOM.value=t}}a(ut,"widgetType","input");class At extends T{constructor(t,i){super();a(this,"label");a(this,"value");this.value=i.value,this.label=i.label,this.addClass("select-option").setPadding("5px 10px").setFontSize(14).setBorderRadius(),this.setStyle({pointerEvents:"visible"}),this.DOM.innerText=this.label,this.onMouseover(()=>{this.setBackgroundColor("#f3f4f5")}),this.onMouseout(()=>{this.setBackgroundColor("#fff")}),this.onMousedown(s=>{s.stopPropagation(),t.checked(this)})}active(t=!0){t?this.setColor("#409EFF"):this.setColor("#303133")}}class se extends T{constructor(e){super(),this.addClass("select-dropdown").setStyle({position:"absolute",left:"2px",top:e,border:"1px solid #ccc",width:"100%",minHeight:"30px",maxHeight:"300px",boxSizing:"border-box",cursor:"pointer",color:"#656464",overflowY:"auto",zIndex:"1"}).setBorderRadius().setBoxShadow("#ccc 0px 0px 5px 1px").setBackgroundColor("#fff"),this.onWheel(t=>{t.stopPropagation()})}}class oe extends T{constructor(t){var i,s,o,n;super();a(this,"input");a(this,"value");a(this,"options");a(this,"multiple");a(this,"disabled");a(this,"dropdown");a(this,"activeOptions");a(this,"onChangeCallback");this.addClass("select").setStyle({position:"relative",padding:"0 3px"}),this.multiple=(i=t==null?void 0:t.multiple)!=null?i:!1,this.disabled=(s=t==null?void 0:t.disabled)!=null?s:!1,this.value=t!=null&&t.value&&!Array.isArray(t.value)?[t.value]:[],this.options=(o=t==null?void 0:t.options)!=null?o:[],this.activeOptions=[],this.onChangeCallback=(n=t==null?void 0:t.onChangeCallback)!=null?n:null,this.input=new et("","请选择"),this.input.DOM.style.cursor="pointer",this.input.setColor("black"),this.input.onClick(r=>{r.preventDefault(),this.dropdown.toggle()}),this.add(this.input),this.dropdown=new se(`${this.input.DOM.clientHeight+25}px`),this.add(this.dropdown),this.setValue(this.value)}setValue(t){this.value=t;const i=this.getLabel();this.input.setValue(i.join()),this.dropdown.hide(),this.dropdown.clear(),this.options.forEach(s=>{const o=new At(this,s);this.dropdown.add(o),this.hasValue(s.value)&&(this.activeOptions.push(o),o.active())}),this.onChangeCallback&&this.onChangeCallback(this.value)}onChange(t){return this.onChangeCallback=t,this}addOption(t){return this.dropdown.add(t),this}checked(t){if(this.multiple){const s=this.activeOptions.indexOf(t);if(s>-1){this.activeOptions[s].active(!1),this.activeOptions.splice(s,1);const o=this.value.indexOf(t.value);this.value.splice(o,1)}else this.activeOptions.push(t),t.active(),this.value.push(t.value)}else this.activeOptions.length&&this.activeOptions[0].active(!1),this.activeOptions[0]=t,t.active(),this.value[0]=t.value,this.dropdown.toggle();const i=this.getLabel();this.input.setValue(i.join()),this.onChangeCallback&&this.onChangeCallback(this.value)}getLabel(t){var i;if(t===void 0){const s=[];return this.options.forEach(o=>{this.hasValue(o.value)&&s.push(o.label)}),s}else{let s=this.options.find(o=>o.value===t);return(i=s==null?void 0:s.label)!=null?i:""}}getValue(){return this.multiple?this.value:this.value[0]}hasValue(t){return this.value.indexOf(t)>-1}}class st extends F{constructor(t){super();a(this,"DOM");a(this,"selectInstance");this.selectInstance=new oe(t),this.DOM=this.selectInstance.DOM}onChange(t){this.selectInstance.onChange(i=>{t(i)})}getValue(){return this.selectInstance.value}setValue(t){this.selectInstance.setValue(t)}setOptions(t){this.selectInstance.dropdown.clear(),this.selectInstance.options=t,t.forEach(i=>{const s=new At(this.selectInstance,i);this.selectInstance.dropdown.add(s),this.selectInstance.hasValue(i.value)&&(this.selectInstance.activeOptions.push(s),s.active())})}}a(st,"widgetType","select");class ne extends T{constructor(t){var i,s,o,n,r,l,h,u,g;super();a(this,"input");a(this,"value");a(this,"activeText");a(this,"inactiveText");a(this,"activeValue");a(this,"inactiveValue");a(this,"activeColor");a(this,"inactiveColor");a(this,"disabled");a(this,"activeSpan");a(this,"inactiveSpan");a(this,"coreSpan");a(this,"switchSpan");a(this,"onChangeCallback");this.addClass("switch").setStyle({whiteSpace:"nowrap",textAlign:"right"}),this.value=(i=t==null?void 0:t.value)!=null?i:!1,this.activeText=(s=t==null?void 0:t.activeText)!=null?s:"",this.inactiveText=(o=t==null?void 0:t.inactiveText)!=null?o:"",this.activeValue=(n=t==null?void 0:t.activeValue)!=null?n:!0,this.inactiveValue=(r=t==null?void 0:t.inactiveValue)!=null?r:!1,this.activeColor=(l=t==null?void 0:t.activeColor)!=null?l:"#409EFF",this.inactiveColor=(h=t==null?void 0:t.inactiveColor)!=null?h:"#C0CCDA",this.disabled=(u=t==null?void 0:t.disabled)!=null?u:!1,this.input=new et("","请选择"),this.input.DOM.setAttribute("type","hidden"),this.inactiveSpan=new J,this.activeSpan=new J,this.coreSpan=new J,this.switchSpan=new J,this.onChangeCallback=(g=t==null?void 0:t.onChangeCallback)!=null?g:null,this.add(this.input),this.initSwitchDom()}initSwitchDom(){this.inactiveText&&(this.inactiveSpan.innerText(this.inactiveText),this.inactiveSpan.setStyle({marginRight:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.inactiveColor,lineHeight:"20px"}),this.add(this.inactiveSpan)),this.coreSpan.setStyle({position:"absolute",top:"2px",display:"block",borderRadius:"100%",width:"16px",height:"16px",backgroundColor:"#FFFFFF"});let t=this.value?this.activeColor:this.inactiveColor;this.switchSpan.setStyle({position:"relative",width:"40px",backgroundColor:t,display:"inline-block",height:"20px",borderRadius:"10px",boxSizing:"border-box",cursor:"pointer",transition:"border-color .3s,background-color .3s",verticalAlign:"middle"}),this.switchSpan.add(this.coreSpan),this.value?this.coreSpan.setRight(3):this.coreSpan.setLeft(3),this.add(this.switchSpan),this.switchSpan.onMousedown(i=>{i.stopPropagation(),this.value=!this.value,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)),this.onChangeCallback&&this.onChangeCallback(this.value)}),this.activeText&&(this.activeSpan.innerText(this.activeText),this.activeSpan.setStyle({marginLeft:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.activeColor,lineHeight:"20px"}),this.add(this.activeSpan))}onChange(t){return this.onChangeCallback=t,this}setValue(t){t!==this.value&&(this.value=t,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)))}}class zt extends F{constructor(t){super();a(this,"DOM");a(this,"switchInstance");this.switchInstance=new ne(t);let i=new v;if(i.setStyle({display:"flex",justifyContent:"space-between"}),t!=null&&t.label){let s=new v,o=t==null?void 0:t.label;s.innerText(o),s.setStyle({fontSize:"14px",lineHeight:"25px",whiteSpace:"nowrap",textIndent:"5px",marginRight:"10px"}),i.add(s)}i.add(this.switchInstance),this.DOM=i.DOM,this.DOM.addEventListener("dblclick",s=>{s.stopPropagation()})}onChange(t){this.switchInstance.onChange(i=>{t(i)})}setValue(t){this.switchInstance.setValue(t)}getValue(){return this.switchInstance.value}}a(zt,"widgetType","switch");const q=class q{static initDefaultWidget(){const e=[Pt,Bt,ut,st,zt];for(const t in e)q.registerWidget(e[t])}static registerWidget(e){e.prototype instanceof F&&(q.widgetsTypeMap[e.widgetType]||(q.widgetsTypeMap[e.widgetType]=e))}static createWidget(e,t={}){let i=q.widgetsTypeMap[e];return!e||!i?(console.warn(`widget类型:[${e}],并未注册`),new ut(t)):new i(t)}};a(q,"widgetsTypeMap",{});let Y=q;const H=class H{constructor(){a(this,"graph",null);a(this,"id");a(this,"index",0);a(this,"position",{x:0,y:0,z:0});a(this,"events");a(this,"render",null);a(this,"viewer",null);a(this,"inputs",[]);a(this,"outputs",[]);a(this,"properties",{});a(this,"widgets",[]);a(this,"addInputsConfig",[]);a(this,"addOutputsConfig",[]);a(this,"_subGraph",null);a(this,"isEvent",!1);a(this,"options",{});a(this,"_label",this.constructor.NodeLabel);this.id=H.createId(),this.events=new wt}set subGraph(e){this.setSubGraph(e)}get subGraph(){return this._subGraph}get type(){return this.constructor.NodeType}get label(){return this.getLabel()}get associativeNode(){return this.constructor.AssociativeNode}static createId(){return`node_${tt("0123456789",10)()}`}_initOptions(e,t,i={},s={}){this.graph=e,this.position=t;for(let o in i)this.setProperty(o,i[o]);for(let o in s)this.setOption(o,s[o]);this.isEvent&&this.initEvents()}getSlotIndex(e){let t=[];switch(e.type){case w.INPUT:t=this.inputs;break;case w.OUTPUT:t=this.outputs;break}return t.indexOf(e)}initEvents(){}onTrigger(){}initedRender(){}getInput(e){return this.inputs[e]}getInputs(){return this.inputs}getOutputs(){return this.outputs}getInputData(e){var i;let t=this.getInput(e);return t?!(t!=null&&t.link)&&t.allow_input?t.value:(i=t.link)==null?void 0:i.origin.value:null}setOutputData(e,t,i=!1){var o;let s=this.getOutput(e);s&&(s.value=t,i&&((o=this.render)==null||o.outputs[e].refresh()))}beforeExecute(){}invoke(){this.graph.nodeRunning(this,this)}run(e=null){this.beforeExecute(),this.onExecute(),this.afterExecute()}doNext(e=null){this.outputs.forEach(t=>{t.link.forEach(i=>{this.graph.nodeRunning(i.targetNode,e)})})}afterExecute(){}onExecute(){}getOutput(e){return this.outputs[e]}addSlot(e){switch(e.node!==this&&(e.node=this),e.type){case w.INPUT:this.inputs.push(e);break;case w.OUTPUT:this.outputs.push(e);break}}addInput(e){var i;let t=X.create(this,e);return(i=this.render)==null||i.refresh(),t}addOutput(e){var i;const t=G.create(this,e);return(i=this.render)==null||i.refresh(),t}clone(){const e=this.graph.createNode(this.type,this.position,Object.assign({},this.properties));for(let t of this.inputs)t.clone(e);for(let t of this.outputs)t.clone(e);return e}serialize(){const e=[],t=[],i={},s=[this.position.x,this.position.y,this.position.z];for(let n of this.inputs)e.push(n.serialize());for(let n of this.outputs)t.push(n.serialize());this.options.addInput&&(i.addInput=!0),this.options.addOutput&&(i.addOutput=!0),this.options.nodeColor&&(i.nodeColor=this.options.nodeColor),this.options.nodeTitleColor&&(i.nodeTitleColor=this.options.nodeTitleColor),this.options.nodeFontColor&&(i.nodeFontColor=this.options.nodeFontColor);const o={id:this.id,type:this.type,index:this.index,_label:this._label,position:s,inputs:e,outputs:t,properties:Object.assign({},this.properties),options:i};return this.subGraph&&(o.subGraph=this.subGraph.serialize()),o}deserialize(e){}setPosition(e){this.position=e}getAllLinks(){let e=[];for(let t of this.inputs)t.link&&e.push(t.link);for(let t of this.outputs)e=e.concat(t.link);return e}getAddInputs(){return[]}getAddOutputs(){return[]}setProperty(e,t){this.properties[e]=t,this.widgets.forEach(i=>{i.propertyName==e&&(i instanceof st&&(t=[t]),i.setValue(t))})}setInitProperty(e,t){this.properties[e]===void 0&&(this.properties[e]=t)}getProperty(e){return this.properties[e]}getOption(e){return this.options[e]}setOption(e,t){this.options[e]=t}getLabel(){return this._label||(this._label=this.constructor.NodeLabel),this._label}setLabel(e){this._label=e}onNodeHighLight(){}addWidget(e,t,i,s){let o=Y.createWidget(e,t);return o?(i&&(o.label=i),s&&(o.propertyName=s,o.onChange(n=>{o instanceof st&&(n=n[0]),this.properties[s]=n})),this.widgets.push(o),setTimeout(()=>{var n;(n=this.render)==null||n.refresh()},0),o):null}getWidgetIndex(e){for(let t=0;t<this.widgets.length;t++)if(this.widgets[t]===e)return t;return-1}getWidget(e){let t=this.widgets[e];return t||null}setWidget(e,t){this.widgets[e]=t}removeWidget(e){let t=this.getWidget(e);t&&(t.remove(),this.widgets.splice(e,1))}renderInit(e){}setRender(e){this.render=e,this.renderInit(e)}setSubGraph(e){e&&(this._subGraph=e,e.parentNode=this)}getContextMenu(){return[]}onRemove(){}setViewer(e){this.viewer=e}};a(H,"NodeType","Node"),a(H,"NodeLabel","基础"),a(H,"NodePath",""),a(H,"AssociativeNode",[]),a(H,"NotAddContextMenu",!1);let P=H;class X{constructor(e,{label:t,valueType:i,options:s,defaultValue:o,allow_input:n,value:r,inputWidgetType:l},h=!0){a(this,"type",w.INPUT);a(this,"link",null);a(this,"label","未命名输入");a(this,"node");a(this,"valueType",[]);a(this,"options",{});a(this,"defaultValue",null);a(this,"allow_input",!1);a(this,"inputWidgetType","input");a(this,"value","");a(this,"subGraphNode",[]);this.node=e,t&&(this.label=t),i&&(this.valueType=i),s&&(this.options=s),n&&(this.allow_input=n),l&&(this.inputWidgetType=l),r&&(this.value=r),!Lt(o)&&!Tt(o)&&(this.defaultValue=o),h&&e.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(e,{label:t,valueType:i,options:s,defaultValue:o,allow_input:n,value:r,inputWidgetType:l},h=!0){return X.create(e,{label:t,valueType:i,options:s,defaultValue:o,allow_input:n,value:r,inputWidgetType:l},h)}static create(e,t={},i=!0){return new X(e,t,i)}clone(e){const t=X.create(e,{label:this.label,valueType:this.valueType.concat(),allow_input:this.allow_input,value:this.value,options:Object.assign(this.options)});return e.addSlot(t),t}update(){}destroy(){}serialize(){const e=this.link?this.link.id:null;return{type:this.type,label:this.label,link:e,valueType:this.valueType.concat(),options:Object.assign({},this.options),defaultValue:this.defaultValue,allow_input:this.allow_input,inputWidgetType:this.inputWidgetType,value:this.value}}deleteLink(){this.link=null}getLabel(){return this.label}}class G{constructor(e,{label:t,valueType:i,options:s,defaultValue:o},n=!0){a(this,"value",null);a(this,"type",w.OUTPUT);a(this,"link",[]);a(this,"label","未命名输出");a(this,"node");a(this,"valueType");a(this,"options",{});a(this,"defaultValue",null);a(this,"subGraphNode",null);this.node=e,t&&(this.label=t),s&&(this.options=s),!Lt(o)&&!Tt(o)&&(this.defaultValue=o,this.value=o),this.valueType=i,n&&e.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(e,{label:t,valueType:i,defaultValue:s,options:o},n=!0){return G.create(e,{label:t,valueType:i,defaultValue:s,options:o},n)}static create(e,t,i=!0){return new G(e,t,i)}clone(e){const t=G.create(e,{valueType:this.valueType,label:this.label,options:Object.assign(this.options)});return e.addSlot(t),t}update(){}destroy(){}serialize(){const e=[];for(let t of this.link)e.push(t.id);return{type:this.type,label:this.label,link:e,valueType:this.valueType,options:Object.assign({},this.options),defaultValue:this.defaultValue}}deleteLink(e){const t=this.link.indexOf(e);t!==-1&&this.link.splice(t,1)}hasLink(e){return this.link.indexOf(e)!==-1}getLabel(){return this.label}}class ct{constructor(e,t){a(this,"id");a(this,"origin");a(this,"target");a(this,"valueType");a(this,"index",0);a(this,"info",null);this.id=ct.createId(),this.origin=e,this.target=t,this.valueType=e.valueType,e.link.push(this),t.link=this}get originNode(){return this.origin.node}get targetNode(){return this.target.node}static createId(){return`link-${ht(4)}`}static create(e,t){return new ct(e,t)}update(){}serialize(){return[this.id,this.origin.node.id,this.origin.index,this.target.node.id,this.target.index,this.valueType]}}const ot="_EventType",Ft="any";class _{constructor(){a(this,"subGraphType","subGraph");a(this,"subGraphInputType","subGraphInput");a(this,"subGraphOutputType","subGraphOutput");a(this,"parentNode",null);a(this,"id");a(this,"version","1.00");a(this,"nodeManager");a(this,"externalGraph",{});a(this,"runningStatus","stop");a(this,"pauseNodes",[]);a(this,"eventRuns",{});a(this,"runedNodes",[]);a(this,"runtimers",[]);a(this,"stepTime",500);a(this,"waitNodes",[]);this.id=`graph-${ht(6)}`,xt.get(),this.nodeManager=new Dt(this)}get inputs(){return this.parentNode?this.parentNode.inputs:null}get outputs(){return this.parentNode?this.parentNode.outputs:null}get createNode(){return this.nodeManager.createNode.bind(this.nodeManager)}get getNode(){return this.nodeManager.getNode.bind(this.nodeManager)}get removeNode(){return this.nodeManager.removeNode.bind(this.nodeManager)}get addLink(){return this.nodeManager.addLink.bind(this.nodeManager)}get removeLink(){return this.nodeManager.removeLink.bind(this.nodeManager)}get removeLinkById(){return this.nodeManager.removeLinkById.bind(this.nodeManager)}get getNodeClassInfo(){return this.nodeManager.getNodeClassInfo.bind(this.nodeManager)}get getNodes(){return this.nodeManager.getNodes.bind(this.nodeManager)}get getLinks(){return this.nodeManager.getLinks.bind(this.nodeManager)}get registerNode(){return this.nodeManager.register.bind(this.nodeManager)}get removeSlot(){return this.nodeManager.removeSlot.bind(this.nodeManager)}serialize(){const e=this.nodeManager.serialize();return Object.assign({version:this.version},e)}deserialize({nodes:e,links:t}){this.nodeManager.deserialize({nodes:e,links:t})}start(){if(this.runningStatus=="running")return;this.runningStatus="running";let e=this.getNodes(),t=[];e.forEach(s=>{if(s.inputs.length==0){t.push(s);return}let o=!1;s.inputs.forEach(n=>{n.link&&(o=!0)}),o||t.push(s)});let i=[];t.length&&t.forEach((s,o)=>{if(o==0)i.push({node:s,dis:0});else{let n=s.position.x-t[0].position.x,r=s.position.y-t[0].position.y,l=Math.sqrt(n*n+r*r);i.push({node:s,dis:l})}}),i.sort((s,o)=>s.dis-o.dis),i.forEach((s,o)=>{t[o]=s.node}),this.waitNodes=t,this.runByStep()}checkNodeRuned(e,t=null){if(t&&this.eventRuns[t.id]){for(let i=0;i<this.eventRuns[t.id].length;i++)if(this.eventRuns[t.id][i].id==e.id)return!0}else for(let i=0;i<this.runedNodes.length;i++)if(this.runedNodes[i].id==e.id)return!0;return!1}runByStep(e=null){var i,s,o,n;let t=this.waitNodes.shift();t&&(e&&t.id==e.id&&this.eventRuns[e.id]&&this.eventRuns[e.id].length&&(this.eventRuns[e.id].forEach(r=>{var l;(l=r.render)==null||l.cancelHighLight(),this.runedNodes=this.runedNodes.filter(h=>h.id!==r.id)}),this.eventRuns[e.id]=[]),this.checkIfCanRun(t,e)?((i=t.render)==null||i.events.dispatch(S.FocusOnNode,t.id),this.realRun(t,e),t.outputs.forEach(r=>{r.link&&r.link.length&&r.link.forEach(l=>{l.target.node&&this.waitNodes.unshift(l.target.node)})})):this.checkNodeRuned(t,e)||((s=t.render)==null||s.events.dispatch(S.FocusOnNode,t.id),(o=t.render)==null||o.setHighLight(N.style.NodeHighLightColor),(n=t.render)==null||n.shake()),setTimeout(()=>{this.runByStep(e)},this.stepTime))}checkIfCanRun(e,t=null){var s;if(this.runningStatus!=="running"||this.checkNodeRuned(e)&&!t||t&&this.checkNodeRuned(e,t))return!1;let i=!0;for(let o=0;o<e.inputs.length;o++){const n=e.inputs[o];let r=!1;for(let l=0;l<this.runedNodes.length;l++)this.runedNodes[l].id==((s=n.link)==null?void 0:s.origin.node.id)&&(r=!0);if(r||(i=!1),!i&&!n.link&&n.allow_input&&(i=!0),!i&&!n.link&&n.valueType.indexOf(ot)>-1&&(i=!0),!i)break}if(!i)return this.sendLog(e,"等待依赖值中。。。"),!1;if(e.isEvent){for(let o=0;o<this.pauseNodes.length;o++){const n=this.pauseNodes[o];if(n.id==e.id)return t&&t.id==n.id?(this.sendLog(e,"事件【被触发】"),!0):!1}return this.pauseNodes.push(e),e.onTrigger(),this.sendLog(e,"事件等待中。。。"),!1}else return this.sendLog(e),e.onTrigger(),!0}nodeRunning(e,t=null){this.runningStatus==="running"&&(this.waitNodes.length?this.waitNodes.push(e):(this.waitNodes.push(e),this.runByStep(t)))}realRun(e,t=null){this.runedNodes.push(e),t&&(this.eventRuns[t.id]||(this.eventRuns[t.id]=[]),this.eventRuns[t.id].push(e));let i=window.setTimeout(()=>{var s,o,n;(s=e.render)==null||s.events.dispatch(c.LinksFresh,this.runedNodes),e.run(t),t&&((o=e.render)==null||o.shake()),(n=e.render)==null||n.setHighLight(t?N.style.NodeEventColor:N.style.NodeRunningColor)},this.stepTime);this.runtimers.push(i)}pause(){}stop(){var t,i;this.runningStatus="stop",this.waitNodes=[],this.getNodes().forEach(s=>{var o;(o=s.render)==null||o.cancelHighLight()});let e=null;for(;e=this.runtimers.shift();)clearTimeout(e);(i=(t=this.runedNodes[0])==null?void 0:t.render)==null||i.events.dispatch(c.LinksFresh),this.runedNodes=[],this.pauseNodes=[]}sendLog(e,t="已运行"){var i;console.log(`节点${e.id} [${e.label}]：${t}`),(i=e.render)==null||i.events.dispatch(c.AddRunLog,{node:e,msg:t})}registerExternalGraph(e,t,i){this.externalGraph[e]={id:e,name:t,data:i}}isInSubgraph(e){var o;const t=this.getNodes();if(!t.length)return!1;const i=(o=t[0].viewer)==null?void 0:o.rootDom,s={x:e.x+i.getOffsetLeft(),y:e.y+i.getOffsetTop()};for(let n=0;n<t.length;n++){const r=t[n];if(r.subGraph){const h=r.widgets[0].viewerDom.getBoundingClientRect();if(s.x>h.x&&s.x<h.x+h.width&&s.y>h.y&&s.y<h.y+h.height)return!0}}return!1}getAllSubGraph(){const e=this.getNodes();if(!e.length)return[];let t=[];for(let i=0;i<e.length;i++){const s=e[i];if(s.subGraph){const o=s.widgets[0];t.push(o.viewer)}}return t}}class gt extends P{constructor(){super();a(this,"graphWidget");a(this,"minSize",null);a(this,"originRect");a(this,"exitFunc",null);a(this,"isMaxmized",!1);a(this,"addInputsConfig",[{label:"输入项",options:{remove:!0},valueType:["any"]}]);a(this,"addOutputsConfig",[{label:"输出项",options:{remove:!0},valueType:"any"}]);this.subGraph=new _,this.subGraph.parentNode=this,this.setOption("addInput",!0),this.setOption("addOutput",!0),this.graphWidget=this.addWidget("graph",{graph:this.subGraph}),this.graphWidget.onChangeMode=t=>{this.graphWidget&&t===it.min&&setTimeout(()=>{var i;(i=this.render)==null||i.setSize(this.graphWidget.minDom.getClientWidth(),this.graphWidget.minDom.getClientHeight())},0)},this.graphWidget.viewer.events.add(c.MouseUp,()=>mt(this,null,function*(){}))}get subViewer(){return!this.graphWidget||!this.graphWidget.viewer?null:this.graphWidget.viewer}refreshViewer(){var t;(t=this.graphWidget)==null||t.refresh(!0)}setSubGraph(t){super.setSubGraph(t),this.graphWidget&&t&&this.graphWidget.setGraph(t)}initedRender(){var i;const t=this.render;t&&(this.minSize=t.getContent().getBoundingClientRect(),this.originRect=(i=this.graphWidget)==null?void 0:i.viewerDom.getBoundingClientRect(),t.events.add(c.ViewResize,()=>{this.exitFunc&&this.exitFunc()}))}onNodeHighLight(){if(this.graphWidget)switch(this.graphWidget.mode){case it.min:this.setOption("notResize",!0);break;case it.window:this.setOption("notResize",!1);break}}onRefresh(){const t=this.render;if(!t)return;let i=new v;i.innerText("+"),i.setStyle({position:"absolute",right:"6px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",width:"25px",borderRadius:"50%",backgroundColor:"black",color:"white"}),i.onClick(()=>{this.maxmizeViewer()}),t.title.add(i)}getName(){var t;return(t=this.graph)!=null&&t.parentNode?this.graph.parentNode.getName()+" => "+this.label:this.label}maxmizeViewer(){var p,x,f,m,b,M,D;if(((p=this.graphWidget)==null?void 0:p.mode)==it.min){Q.warning("子图收缩中，无法放大");return}const t=this.render,i=(x=this.graphWidget)==null?void 0:x.viewer,s=t.events.viewer,o=s==null?void 0:s.rootDom.getBoundingClientRect(),n={position:i==null?void 0:i.rootDom.DOM.style.position,zIndex:i==null?void 0:i.rootDom.DOM.style.zIndex,left:i==null?void 0:i.rootDom.DOM.style.left,top:i==null?void 0:i.rootDom.DOM.style.top,width:i==null?void 0:i.rootDom.DOM.style.width,height:i==null?void 0:i.rootDom.DOM.style.height},r=i==null?void 0:i.events.viewPosition,l=t.events.getScale();i==null||i.rootDom.setAbsolute(-t.events.viewPosition.y-this.position.y,-t.events.viewPosition.x-this.position.x,99999).setWidth(o.width).setHeight(o.height).setStyle({transition:"all .5s ease"}),(f=s==null?void 0:s.tools.miniMap)==null||f.hide(),(m=s==null?void 0:s.tools.control)==null||m.hide();let h=new V("退出子图");h.setStyle({zIndex:"123123",marginLeft:"10px"}),h.onClick(()=>{g()}),(b=i==null?void 0:i.tools.control)==null||b.add(h),(M=i==null?void 0:i.tools.miniMap)==null||M.show(),s.setScale(1);let u=new v;u.innerText(this.getName()).setColor((D=this.getOption("nodeColor"))!=null?D:"white").setFontSize(30).setStyle({fontWeight:"bold",marginTop:"10px",userSelect:"none",webkitUserSelect:"none",width:"100%",textAlign:"center"}),i==null||i.rootDom.add(u),setTimeout(()=>{const R=i==null?void 0:i.graph.getNodes();R&&R.length&&(i==null||i.focusOnNode(R[0].id))},500);let g=()=>{var R,A,U,at;this.exitFunc=null,s.setScale(l),i==null||i.rootDom.setStyle(n),s.graph.parentNode||(R=s.tools.miniMap)==null||R.show(),s.graph.parentNode&&s.rootDom.DOM.style.position=="absolute"&&((A=s.tools.miniMap)==null||A.show()),(U=s.tools.control)==null||U.setFlex(),h.remove(),u.remove(),(at=i==null?void 0:i.tools.miniMap)==null||at.hide(),setTimeout(()=>{i==null||i.rootDom.setStyle({transition:"none"})},500),i.events.viewPosition=r,i==null||i.getNodeManager().setPosition()};this.exitFunc=g}}a(gt,"NodeType","subGraph"),a(gt,"NodeLabel","子图"),a(gt,"NodePath","子图节点");class nt extends P{constructor(){super();a(this,"parentSlot",null);this.setOption("notClone",!0)}getLabel(){var t,i;return(i=(t=this.parentSlot)==null?void 0:t.label)!=null?i:"子图输出"}serialize(){var i,s;const t=super.serialize();return t.subGraphSlotIndex=(i=this.parentSlot)==null?void 0:i.index,t.subGraphSlotNodeId=(s=this.parentSlot)==null?void 0:s.node.id,t}deserialize(t){var l,h;if(!t.subGraphSlotIndex&&t.subGraphSlotIndex!==0||!t.subGraphSlotNodeId)return console.warn("序列化子图插槽失败！");const i=t.subGraphSlotIndex,s=t.subGraphSlotNodeId,o=(h=(l=this.graph)==null?void 0:l.parentNode)==null?void 0:h.graph,n=o==null?void 0:o.getNode(s);if(!n)return console.warn("序列化子图插槽失败！");const r=n.inputs[i];if(!r)return console.warn("序列化子图插槽失败！");this.setParentSlot(r)}onRemove(){this.parentSlot&&this.parentSlot.subGraphNode.splice(this.parentSlot.subGraphNode.indexOf(this),1)}setParentSlot(t){this.outputs=[],this.parentSlot=t,this.addOutput({label:this.parentSlot.label,valueType:this.parentSlot.valueType[0]}),this.parentSlot.subGraphNode.push(this)}}a(nt,"NodeType","subGraphInput"),a(nt,"NodeLabel","子图输出"),a(nt,"NodePath","子图节点"),a(nt,"NotAddContextMenu",!0);class rt extends P{constructor(){super();a(this,"parentSlot",null)}getLabel(){var t,i;return(i=(t=this.parentSlot)==null?void 0:t.label)!=null?i:"子图输入"}serialize(){var i,s;const t=super.serialize();return t.subGraphSlotIndex=(i=this.parentSlot)==null?void 0:i.index,t.subGraphSlotNodeId=(s=this.parentSlot)==null?void 0:s.node.id,t}deserialize(t){var l,h;if(!t.subGraphSlotIndex&&t.subGraphSlotIndex!==0||!t.subGraphSlotNodeId)return console.warn("序列化子图插槽失败！");const i=t.subGraphSlotIndex,s=t.subGraphSlotNodeId,o=(h=(l=this.graph)==null?void 0:l.parentNode)==null?void 0:h.graph,n=o==null?void 0:o.getNode(s);if(!n)return console.warn("序列化子图插槽失败！");const r=n.outputs[i];if(!r)return console.warn("序列化子图插槽失败！");this.setParentSlot(r)}onRemove(){this.parentSlot&&(this.parentSlot.subGraphNode=null)}setParentSlot(t){this.inputs=[],this.parentSlot=t,this.addInput({label:this.parentSlot.label,valueType:[this.parentSlot.valueType]}),this.parentSlot.subGraphNode=this}}a(rt,"NodeType","subGraphOutput"),a(rt,"NodeLabel","子图输入"),a(rt,"NodePath","子图节点"),a(rt,"NotAddContextMenu",!0);class pt extends P{constructor(){super();a(this,"strInput");this.setProperty("__function__","ConstString"),this.setInitProperty("value",""),this.addOutput({label:"字符串",valueType:"string"}),this.strInput=this.addWidget("input",{placeholder:"请输入字符串"},"字符串","value")}onExecute(){this.setOutputData(0,this.strInput.getValue())}}a(pt,"NodeType","ConstString"),a(pt,"NodeLabel","字符串"),a(pt,"NodePath","基础节点");class ft extends P{constructor(){super();a(this,"numberInput");a(this,"NotAutoRegister",!0);this.setProperty("__function__","ConstantNumber"),this.setInitProperty("value",0),this.addOutput({label:"value",valueType:"number"}),this.numberInput=this.addWidget("input",{type:"number",placeholder:"请输入数字"},"数字","value")}onExecute(){this.setOutputData(0,parseFloat(this.numberInput.getValue()))}}a(ft,"NodeType","ConstantNumber"),a(ft,"NodeLabel","数字"),a(ft,"NodePath","基础节点");const re=Object.freeze(Object.defineProperty({__proto__:null,ConstString:pt,NSubGraph:gt,NSubGraphInput:nt,NSubGraphOutput:rt,Number:ft},Symbol.toStringTag,{value:"Module"})),I=class I{constructor(e){a(this,"nodeIndex",-1);a(this,"nodeMap",{});a(this,"linkMap",{});a(this,"linkIndex",-1);a(this,"undefinedType","_undefined");a(this,"graph");this.graph=e,this.initDefaultNode()}initDefaultNode(){const e=re;for(const t in e)e[t].NotAutoRegister||this.register(e[t])}register(e){e.prototype instanceof P&&(I.nodeTypeMap[e.NodeType]||(I.nodeTypeMap[e.NodeType]=e))}createNode(e,t={x:0,y:0,z:0},i={},s={}){if(!I.nodeTypeMap[e])return;const o=I.nodeTypeMap[e],n=new o;if(n._initOptions(this.graph,t,i,s),!n.options.nodeColor&&N.createRandomStyleNode){let r=N.getRandomColor();n.setOption("nodeColor",r.nodeColor),n.setOption("nodeFontColor",r.nodeFontColor),n.setOption("nodeTitleColor",r.nodeTitleColor)}return this.addNode(n),n}addNode(e){this.nodeMap[e.id]||(this.nodeMap[e.id]=e,this.nodeIndex+=1,e.index=this.nodeIndex)}getNode(e){return this.nodeMap[e]}getNodes(){return Object.values(this.nodeMap)}reset(){this.nodeMap={},this.linkMap={},this.nodeIndex=-1,this.linkIndex=-1}removeNode(e){if(!this.nodeMap[e])return;const t=this.nodeMap[e];for(let i in this.linkMap){const s=this.linkMap[i];(s.originNode===t||s.targetNode===t)&&this.removeLink(s)}t.onRemove(),delete this.nodeMap[e]}addLink(e,t=0,i,s=0,o=!0){if(e===i)return null;const n=e.getOutput(t),r=i.getInput(s);return!n||!r?(console.warn(`连接失败 输入或输出不存在 输出[${e.id}:${t}] 输入[${i.id}:${s}] `),null):this.addLinkBySolt(n,r,o)}getLinks(){return Object.values(this.linkMap)}addLinkBySolt(e,t,i=!0){if(!this.canLink(e,t,i))return null;i&&t.link&&this.removeLink(t.link);const s=ct.create(e,t);return this.linkIndex+=1,s.index=this.linkIndex,this.linkMap[s.id]=s,s}canLink(e,t,i=!0){if(e.type!==w.OUTPUT||t.type!==w.INPUT)return console.warn("连接失败 参数错误"),!1;if(t.valueType.indexOf(e.valueType)===-1&&t.valueType.indexOf(Ft)===-1&&e.valueType!==Ft){let s=`连接失败 输入[${t.node.id}:${t.index}]接受类型为[${t.valueType.join(",")}] 连接类型为[${e.node.id}:${e.index}]->${e.valueType}`;console.warn(s);let o=`【类型不匹配】[ ${e.valueType} ] => 连接至 => [ ${t.valueType.join(",")} ]`;return Q.warning(o),!1}return t.node===e.node?(console.warn(`连接失败 不允许自身连接 [${t.node.id}]`),!1):!i&&t.link?(console.warn("连接失败 非强制连接模式已有连线"),!1):!0}removeLinkById(e){this.linkMap[e]&&this.removeLink(this.linkMap[e])}removeLink(e){const t=e.origin,i=e.target;i.link!==e||!t.hasLink(e)||(i.deleteLink(),t.deleteLink(e),delete this.linkMap[e.id])}getNodeList(){return Object.values(this.nodeMap).sort((t,i)=>t.index-i.index)}getLinkList(){return Object.values(this.linkMap).sort((t,i)=>t.index-i.index)}serialize(){const e={nodes:[],links:[]};for(const t of this.getNodeList())e.nodes.push(t.serialize());for(const t of this.getLinkList())e.links.push(t.serialize());return e}deserialize({nodes:e,links:t}){this.reset();const i=[];for(let s of e)i.push(this.deserializeNode(s));for(let s of i)s();for(let s of t)this.deserializeLink(s)}deserializeLink([e,t,i,s,o]){if(!this.nodeMap[t]||!this.nodeMap[s])return console.warn(`连接反序列失败 [${t}]-[${s}],无此节点`);const n=this.nodeMap[t],r=this.nodeMap[s];if(!this.addLink(n,i,r,o))return console.warn(`连接反序列失败 [${t}]-[${s}]`)}deserializeNode(e){var b;const{id:t,type:i,position:s,inputs:o,outputs:n,properties:r,options:l,subGraph:h,index:u,_label:g}=e;let p=I.nodeTypeMap[i];p||(console.warn(`节点类型:[${i}],并未注册`),p=P);const x=new p;x._initOptions(this.graph,{x:s[0],y:s[1],z:(b=s[2])!=null?b:0},r,l),x.id=t,x._label=g;const f=[],m=[];o.forEach((M,D)=>{x!=null&&x.inputOptions&&(x!=null&&x.inputOptions[D])&&(M=Object.assign(M,x.inputOptions[D])),f.push(X.deserialize(x,M,!1))});for(let M of n)m.push(G.deserialize(x,M,!1));if(x.inputs=f,x.outputs=m,this.addNode(x),u&&(u<this.nodeIndex?x.index=this.nodeIndex:x.index=u),this.nodeIndex<u&&(this.nodeIndex=u+1),h){const M=x,D=new _;x.setSubGraph(D),D.deserialize(h),M.refreshViewer()}return()=>{x.deserialize(e)}}getNodeTypeList(){const e=[];for(let t in I.nodeTypeMap){const i=I.nodeTypeMap[t];["subGraphInput","subGraphOutput"].indexOf(t)>-1||e.push({label:i.NodeLabel,type:t})}return e}getNodeClassInfo(){const e={};for(let t in I.nodeTypeMap){const i=I.nodeTypeMap[t];e[i.NodeType]={type:i.NodeType,path:i.NodePath,label:i.NodeLabel,associativeNode:i.AssociativeNode,notAddContextMenu:i.NotAddContextMenu}}return e}removeSlot(e){const t=e.node;if(e.type===w.INPUT)e.link&&this.removeLinkById(e.link.id),t.inputs.splice(e.index,1);else{if(e.link.length>0)for(let i of e.link)this.removeLinkById(i.id);t.outputs.splice(e.index,1)}}};a(I,"nodeTypeMap",{});let Dt=I,Ot=null;class xt{constructor(){a(this,"defaultType");a(this,"typeMap",{});const e=[{id:"any",label:"通用类型"},{id:"string",label:"字符串"},{id:"number",label:"数字"},{id:"array",label:"数组"}];for(let t of e)this.register(t);this.defaultType=e[0].id}static get(){return Ot||(Ot=new xt),Ot}register(e){this.typeMap[e.id]=e}get(e){return this.typeMap[e]}}C.BaseWidget=F,C.DataTypeMananger=xt,C.DomNodeRender=lt,C.DomSlotRender=Ct,C.Graph=_,C.GraphViewer=Z,C.InputWidget=ut,C.NativeDiv=v,C.Node=P,C.NodeInput=X,C.NodeOutput=G,C.SelectWidget=st,C.WidgetsManager=Y,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
