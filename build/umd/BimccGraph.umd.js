!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BimccGraph={})}(this,(function(t){"use strict";var e=Object.defineProperty,i=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s),s=(t,e,i)=>new Promise(((s,o)=>{var n=t=>{try{h(i.next(t))}catch(e){o(e)}},r=t=>{try{h(i.throw(t))}catch(e){o(e)}},h=t=>t.done?s(t.value):Promise.resolve(t.value).then(n,r);h((i=i.apply(t,e)).next())})),o=(t=>(t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.INPUT=1]="INPUT",t[t.OUTPUT=2]="OUTPUT",t))(o||{});let n=t=>crypto.getRandomValues(new Uint8Array(t)),r=(t,e=21)=>((t,e,i)=>{let s=(2<<Math.log(t.length-1)/Math.LN2)-1,o=-~(1.6*s*e/t.length);return(n=e)=>{let r="";for(;;){let e=i(o),h=o;for(;h--;)if(r+=t[e[h]&s]||"",r.length===n)return r}}})(t,e,n),h=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+=(e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_"),"");class l{constructor(t){i(this,"handlerList",[]),i(this,"id"),this.id=t}add(t){this.handlerList.push(t)}dispatch(...t){for(let e of this.handlerList)e(...t)}remove(t){const e=this.handlerList.indexOf(t);-1!==e&&this.handlerList.splice(e,1)}}var d=(t=>(t.Node="RenderNode",t.Link="RenderLink",t.UI="RenderUI",t))(d||{}),a=(t=>(t.Dom="DomRender",t.Svg="SvgRender",t.DomUI="DomUIRender",t))(a||{}),u=(t=>(t.MouseMove="MouseMove",t.MouseDown="MouseDown",t.MouseUp="MouseUp",t.SelectedNode="SelectedNode",t.NodeDown="NodeDown",t.NodeUp="NodeUp",t.NodeEnter="NodeEnter",t.NodeLeave="NodeLeave",t.DragNodeStart="DragNodeStart",t.DragNodeMove="DragNodeMove",t.DragNodeEnd="DragNodeEnd",t.WidgetDown="WidgetDown",t.WidgetUp="WidgetUp",t.WidgetEnter="WidgetEnter",t.WidgetLeave="WidgetLeave",t.SlotDown="SlotDown",t.SlotUp="SlotUp",t.SlotEnter="SlotEnter",t.SlotLeave="SlotLeave",t.DragSlotStart="DragSlotStart",t.DragSlotMove="DragSlotMove",t.DragSlotEnd="DragSlotEnd",t.DragViewStart="DragViewStart",t.DragViewMove="DragViewMove",t.DragViewEnd="DragViewEnd",t.OpenContextMenu="ContextMenu",t.CloseContextMenu="CloseContextMenu",t.OpenAssociativeMenu="OpenAssociativeMenu",t.CloseAssociativeMenu="CloseAssociativeMenu",t.Click="Click",t.DoubleClick="dblClick",t.DoubleLeftClick="DoubleLeftClick",t.DoubleRightClick="DoubleRightClick",t.ViewScale="ViewScale",t.ViewResize="ViewResize",t.LinksFresh="LinksFresh",t.AddRunLog="AddRunLog",t))(u||{}),p=(t=>(t.AddNode="ActionAddNode",t.RemoveNode="ActionRemoveNode",t.CloneNode="ActionCloneNode",t.AddNodeInput="ActionAddNodeInput",t.AddNodeOutput="ActionAddNodeOutput",t.FocusOnNode="FocusOnNode",t.StopRun="StopRun",t.StartRun="StartRun",t.RemoveNodeSlot="RemoveNodeSlot",t))(p||{}),c=(t=>(t.Resize="NodeRenderResize",t.Refresh="NodeRenderRefresh",t.Down="NodeRenderDown",t))(c||{}),g=(t=>(t.BeforeExecute="NodeBeforeExecute",t.AfterExecute="NodeAfterExecute",t))(g||{}),v=(t=>(t.Widget="WidgetCustomEvetns",t.Node="NodeCustomEvetns",t))(v||{});class x{constructor(){i(this,"signalMap",{}),i(this,"readOnly",!1)}create(t){const e=new l(t);return this.signalMap[t]=e,e}delete(t){delete this.signalMap[t]}get(t){return this.signalMap[t]}add(t,e){this.signalMap[t]&&this.signalMap[t].add(e)}dispatch(t,...e){if(!this.signalMap[t])return;const i=[u.DragViewMove,u.ViewScale,v.Widget,v.Node];(!this.readOnly||i.indexOf(t)>-1)&&this.signalMap[t].dispatch(...e)}remove(t,e){this.signalMap[t]&&this.signalMap[t].remove(e)}setReadOnly(t){this.readOnly=t}}const f=t=>void 0===t,y=t=>null===t,b=({x:t,y:e})=>{let i=0,s=0;return 0!==e?(i=1,s=-t/e):(s=1,i=-e/t),(({x:t,y:e})=>({x:t/Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),y:e/Math.sqrt(Math.pow(t,2)+Math.pow(e,2))}))({x:i,y:s})},m=t=>"[object Number]"===(t=>Object.prototype.toString.apply(t))(t),w=(t=100)=>new Promise((e=>{setTimeout((()=>{e()}),t)})),S=class t{constructor(t="div"){i(this,"DOM"),this.DOM=document.createElement(t)}setId(e){return this.DOM.id=`${t.prefix}${e}`,this}getClientWidth(){return this.DOM.clientWidth}getClientHeight(){return this.DOM.clientHeight}getOffsetHeight(){return this.DOM.offsetHeight}getOffsetWidth(){return this.DOM.offsetWidth}getOffsetLeft(){return this.DOM.offsetLeft}getOffsetTop(){return this.DOM.offsetTop}setStyle(t){for(let e in t)this.DOM.style[e]=t[e];return this}setPosition(t="absolute",e=0,i=0,s=0,o="px"){return this.setStyle({position:t,top:m(e)?`${e}${o}`:e,left:m(i)?`${i}${o}`:i,zIndex:m(s)?`${s}`:s})}setAbsolute(t=0,e=0,i=0,s="px"){return this.setPosition("absolute",t,e,i,s)}setLeft(t,e="px"){return this.setStyle({left:m(t)?`${t}${e}`:t})}setRight(t,e="px"){return this.setStyle({right:m(t)?`${t}${e}`:t})}setTop(t,e="px"){return this.setStyle({top:m(t)?`${t}${e}`:t})}addClass(e){return this.DOM.classList.add(`${t.prefix}${e}`),this}removeClass(e){return this.DOM.classList.remove(`${t.prefix}${e}`),this}replaceClass(e,i){return this.DOM.classList.replace(`${t.prefix}${e}`,`${t.prefix}${i}`),this}show(){return this.setStyle({display:"block"})}isShow(){return"block"===this.DOM.style.display}hide(){return this.setStyle({display:"none"})}isHidden(){return"none"===this.DOM.style.display}toggle(){return"none"===this.DOM.style.display?this.show():this.hide(),this}setWidth(t,e="",i="px"){return this.setStyle({[`${e}${e?"W":"w"}idth`]:m(t)?`${t}${i}`:t})}setHeight(t,e="",i="px"){return this.setStyle({[`${e}${e?"H":"h"}eight`]:m(t)?`${t}${i}`:t})}setBackgroundColor(t){return this.setStyle({backgroundColor:t})}setBackground(t,e="Color"){return this.setStyle({[`background${e}`]:"Color"===e?t:`url(${t})`,backgroundSize:"100% 100%"})}setAttribute(t,e){return this.DOM.setAttribute(t,e),this}removeAttribute(t){this.DOM.removeAttribute(t)}getAttribute(t){return this.DOM.getAttribute(t)}setContentEditable(t=!1){return this.DOM.setAttribute("contentEditable",t.toString()),this}setPadding(t){return this.setStyle({padding:t})}setPaddingTop(t){return this.setStyle({paddingTop:t})}setPaddingBottom(t){return this.setStyle({paddingBottom:t})}setPaddingLeft(t){return this.setStyle({paddingLeft:t})}setPaddingRight(t){return this.setStyle({paddingRight:t})}setMargin(t){return this.setStyle({margin:t})}setMarginTop(t){return this.setStyle({marginTop:t})}setMarginLeft(t){return this.setStyle({marginLeft:t})}setMarginRight(t){return this.setStyle({marginRight:t})}setMarginBottom(t){return this.setStyle({marginBottom:t})}setFontSize(t,e="px"){return this.setStyle({fontSize:`${t}${e}`})}add(t){var e;return"string"==typeof t?this.DOM.appendChild(document.createTextNode(t)):this.DOM.appendChild(null!=(e=t.DOM)?e:t),this}setBoxShadow(t="#ccc 0px 0px 10px 1px"){return this.setStyle({boxShadow:t})}setBorderRadius(t="5px"){return this.setStyle({borderRadius:t})}setColor(t){return this.setStyle({color:t})}setFlex(t="flex"){return this.setStyle({display:t})}setFlexWrap(t="nowrap"){return this.setStyle({flexWrap:t})}setJustifyContent(t="flex-start"){return this.setStyle({justifyContent:t})}setAlignItems(t="center"){return this.setStyle({alignItems:t})}setFlexDirection(t){return this.setStyle({flexDirection:t})}setOverflow(t="visible"){return this.setStyle({overflow:t})}setUserSelect(t="auto"){return this.setStyle({webkitUserSelect:t,userSelect:t})}setCursor(t="auto"){return this.setStyle({cursor:t})}setPointerEvents(t="auto"){return this.setStyle({pointerEvents:t})}setboxSizing(t="content-box"){return this.setStyle({boxSizing:t})}innerText(t){return this.DOM.innerText=t,this}getInnerText(){return this.DOM.innerText}remove(){this.DOM.remove()}clear(){this.DOM.innerHTML=""}onClick(t,e=!1){e?this.DOM.onclick=t:this.DOM.addEventListener("click",(e=>{t(e)}))}onWheel(t,e=!1,i=!0){e?this.DOM.onwheel=t:this.DOM.addEventListener("wheel",(e=>{t(e)}),{passive:i})}onContextmenu(t,e=!1){e?this.DOM.onclick=t:this.DOM.addEventListener("contextmenu",(e=>{t(e)}))}getBoundingClientRect(){return this.DOM.getBoundingClientRect()}onMouseover(t,e=!1){e?this.DOM.onmouseover=t:this.DOM.addEventListener("mouseover",(e=>{t(e)}))}onMouseout(t,e=!1){e?this.DOM.onmouseout=t:this.DOM.addEventListener("mouseout",(e=>{t(e)}))}onMousedown(t,e=!1){e?this.DOM.onmousedown=t:this.DOM.addEventListener("mousedown",(e=>{t(e)}))}onMouseup(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("mouseup",(e=>{t(e)}))}onMousemove(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("mousemove",(e=>{t(e)}))}onDblClick(t,e=!1){e?this.DOM.onmouseup=t:this.DOM.addEventListener("dblclick",(e=>{t(e)}))}};i(S,"prefix","ra-graph-");let C=S;class M{constructor(t){i(this,"DOM"),this.DOM=document.createElementNS("http://www.w3.org/2000/svg",t)}setAttribute(t,e){return this.DOM.setAttribute(t,e),this}add(t){return this.DOM.appendChild(t.DOM),this}setStyle(t){for(let e in t)this.DOM.style[e]=t[e];return this}show(){return this.setStyle({display:"block"})}isShow(){return"block"===this.DOM.style.display}hide(){return this.setStyle({display:"none"})}remove(){this.DOM.remove()}}class N extends C{constructor(){super(),i(this,"id"),i(this,"label",null),i(this,"isCustomClick",!1),i(this,"propertyName",""),this.id=N.createId()}static createId(){return`widget_${r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",10)()}`}getLabel(){return null!==this.label?this.label:""}}class k extends C{}class D extends C{constructor(t){super("button"),i(this,"DOM"),this.DOM=document.createElement("button"),this.setStyle({minWidth:"50px",height:"30px",borderRadius:"4px",cursor:"pointer",color:"black",paddingLeft:"5px",paddingRight:"5px"}),this.add(t)}}class T extends C{constructor(t,e){super("input"),i(this,"DOM"),this.DOM=document.createElement("input"),this.DOM.className="Input",this.DOM.style.padding="2px",this.DOM.style.width="calc(100% - 2px)",this.DOM.style.borderRadius="5px",this.DOM.style.border="1px solid transparent",this.DOM.style.outline="none",this.DOM.setAttribute("autocomplete","off"),this.DOM.addEventListener("keydown",(function(t){t.stopPropagation()})),this.setValue(t),this.DOM.setAttribute("placeholder",e)}getValue(){return this.DOM.value}setValue(t){return this.DOM.value=t,this}onChange(t){this.DOM.addEventListener("input",(e=>{t(e)}))}}class O extends N{constructor(t){if(super(),i(this,"DOM"),i(this,"inputDIVs"),i(this,"closure",(t=>{})),this.inputDIVs=new k,this.inputDIVs.setFlex(),this.inputDIVs.setFlexDirection("column"),null==t?void 0:t.value){let e=[];"string"==typeof t.value?e=t.value.split(","):"object"==typeof t.value&&(e=t.value),e.forEach((t=>{this.addInputDIV(String(t))}))}else this.addInputDIV();let e=new k;e.add(this.addButton());let s=new k;s.add(this.inputDIVs).add(e),this.DOM=s.DOM,this.DOM.addEventListener("dblclick",(t=>{t.stopPropagation()}))}addInputDIV(t=""){let e=new k;e.setStyle({minWidth:"170px"});let i=new T("","请输入");i.setColor("black"),i.DOM.addEventListener("input",(()=>{this.closure(this.getValue())})),i.setStyle({width:"140px",marginBottom:"2px",marginRight:"2px"}),i.setValue(t),e.add(i).add(this.delButton(e.DOM)),this.inputDIVs.add(e)}addButton(){let t=new D("+");return t.setStyle({width:"20px",height:"20px"}),t.DOM.addEventListener("click",(()=>{this.addInputDIV()})),t}delButton(t){let e=new D("-");return e.setStyle({width:"20px",height:"20px",minWidth:"20px"}),e.DOM.addEventListener("click",(()=>{t.remove(),this.closure(this.getValue())})),e}onChange(t){this.closure=t,this.inputDIVs.DOM.childNodes.forEach((t=>{t.firstChild.addEventListener("input",(()=>{this.closure(this.getValue())})),t.lastChild.addEventListener("click",(()=>{this.closure(this.getValue())}))}))}getValue(){let t=[];return this.inputDIVs.DOM.childNodes.forEach((e=>{t.push(e.firstChild.value)})),t.join(",")}setValue(t){this.inputDIVs.DOM.childNodes.forEach((t=>{this.inputDIVs.DOM.removeChild(t)}));let e=[];"string"==typeof t?e=t.split(","):"object"==typeof t&&(e=t),e.forEach((t=>{this.addInputDIV(String(t))}))}}i(O,"widgetType","array");class L extends C{constructor(t=""){super("span"),t&&(this.DOM.innerText=t)}}class R extends M{constructor(){super("svg")}}class I extends M{constructor(){super("path")}drawFillBezierLine(t,e,i,s,o,n,r){if(isNaN(t.x)||isNaN(t.y)||isNaN(e.x)||isNaN(e.y))return;const h=b({x:e.x-t.x,y:e.y-t.y});if(isNaN(h.x)||isNaN(h.y))return;const l=[{x:t.x+h.x*i,y:t.y+h.y*i},{x:e.x+h.x*i,y:e.y+h.y*i},{x:e.x+-h.x*i,y:e.y+-h.y*i},{x:t.x+-h.x*i,y:t.y+-h.y*i}],d=[`M ${l[0].x} ${l[0].y} `,`C ${l[0].x+r} ${l[0].y}, ${l[1].x-r} ${l[1].y}, ${l[1].x} ${l[1].y} `,`L ${l[2].x} ${l[2].y} `,`C ${l[2].x-r} ${l[2].y}, ${l[3].x+r} ${l[3].y}, ${l[3].x} ${l[3].y} `,"Z"];this.setAttribute("d",d.join("")),this.setAttribute("stroke",o),this.setAttribute("stroke-width",`${n}`),this.setAttribute("fill",s)}}class P extends M{constructor(){super("circle")}}var B=(t=>(t[t.None=0]="None",t[t.Node=1]="Node",t[t.Slot=2]="Slot",t[t.Widget=3]="Widget",t))(B||{});class A{constructor(t,e){i(this,"rootDom"),i(this,"selectedBox",null),i(this,"viewer"),i(this,"menuItems"),i(this,"mouseInfo"),i(this,"viewPosition",{x:0,y:0}),i(this,"selectPos",{x:0,y:0}),i(this,"events",new x),i(this,"scale",1),this.viewer=e,this.rootDom=t,this.rootDom.setBackgroundColor("#838383"),this.mouseInfo={button:-1,isDown:!1,isDrag:!1,target:null,type:0,beforePos:{x:0,y:0},enterTarget:null,enterType:0,timeStamp:{mouseDown:0,mouseUp:0}},this.selectedBox=null,this.initEventListener()}getScale(t=!1){return t?this.getParentScale()*this.scale:this.scale}getParentScale(){return this.viewer.graph.parentNode&&this.viewer.graph.parentNode.viewer?1/this.viewer.graph.parentNode.viewer.events.getScale(!0):1}setScale(t){this.scale=t,this.events.dispatch(u.ViewScale,this.scale)}get add(){return this.events.add.bind(this.events)}get dispatch(){return this.events.dispatch.bind(this.events)}get get(){return this.events.get.bind(this.events)}get setReadOnly(){return this.events.setReadOnly.bind(this.events)}initEventListener(){const t=[u.MouseDown,u.MouseUp,u.MouseMove,u.DoubleClick,u.NodeDown,u.DragNodeMove,u.NodeUp,u.SlotDown,u.DragSlotMove,u.SlotUp,u.DragViewStart,u.DragViewMove,u.DragViewEnd,u.OpenContextMenu,u.CloseContextMenu,u.Click,u.OpenAssociativeMenu,u.CloseAssociativeMenu,u.DragSlotStart,u.DragSlotEnd,u.DragNodeStart,u.DragNodeEnd,u.NodeEnter,u.NodeLeave,u.SlotEnter,u.SlotLeave,u.ViewScale,u.ViewResize,u.LinksFresh,u.AddRunLog,u.SelectedNode,u.DoubleRightClick,u.DoubleLeftClick,u.WidgetDown,u.WidgetUp,u.WidgetEnter,u.WidgetLeave,p.AddNode,p.RemoveNode,p.CloneNode,p.AddNodeInput,p.AddNodeOutput,p.FocusOnNode,p.StartRun,p.StopRun,p.RemoveNodeSlot,g.BeforeExecute,g.AfterExecute,v.Node,v.Widget];for(let s of t)this.events.create(s);const e=this.mouseInfo;let i=!0;this.rootDom.onContextmenu((t=>{t.preventDefault()})),this.rootDom.onMousedown((t=>{const i=this.rootDom.DOM.querySelectorAll(".ra-graph-select-dropdown");for(const e of i){e.style.display="none"}this.rootDom.setCursor("auto");const s=this.rootDom.getBoundingClientRect(),o={x:t.clientX-s.x,y:t.clientY-s.y};if((t.ctrlKey||t.metaKey)&&(this.selectedBox=new k,this.selectPos={x:t.clientX-s.x,y:t.clientY-s.y},this.selectedBox.setStyle({position:"absolute",top:o.y+"px",left:o.x+"px",backgroundColor:"#00BFFF"}),this.rootDom.add(this.selectedBox)),t.ctrlKey||t.metaKey)return this.selectedBox=new k,this.selectPos={x:t.clientX-s.x,y:t.clientY-s.y},this.selectedBox.setStyle({position:"absolute",top:o.y+"px",left:o.x+"px",backgroundColor:"rgba(173,175,173,0.3)"}),void this.rootDom.add(this.selectedBox);this.events.dispatch(u.MouseDown,o),this.events.dispatch(u.CloseAssociativeMenu),this.events.dispatch(u.CloseContextMenu),e.button=t.button,e.isDown=!0,e.timeStamp.mouseDown=(new Date).getTime()})),document.addEventListener("mouseup",(t=>{const s=(new Date).getTime();this.rootDom.setCursor("auto");const o=this.rootDom.getBoundingClientRect(),n={x:t.clientX-o.x,y:t.clientY-o.y};if(this.selectedBox){this.selectedBox.remove(),this.selectedBox=null;const t=n,e=this.selectPos;this.events.dispatch(u.SelectedNode,e,t)}else{if(s-e.timeStamp.mouseUp<=230)switch(this.events.dispatch(u.DoubleClick,n,t),e.button){case 0:this.events.dispatch(u.DoubleLeftClick,n,e,t);break;case 2:this.events.dispatch(u.DoubleRightClick,n,e,t)}else{if(this.events.dispatch(u.MouseUp,n),e.isDrag){if(0===e.button)switch(e.type){case 2:this.events.dispatch(u.DragSlotEnd,Object.assign({},n),e.target),0===e.enterType&&this.events.dispatch(u.OpenAssociativeMenu,Object.assign({},n),e.target);break;case 1:this.events.dispatch(u.DragNodeEnd,Object.assign({},n),e.target);break;case 0:this.events.dispatch(u.DragViewEnd,Object.assign({},n),e.target)}}else 0===e.button&&this.events.dispatch(u.Click,{type:e.type,target:e.target,position:Object.assign({},n)});2===t.button&&this.events.dispatch(u.OpenContextMenu,{position:Object.assign({},n),target:e.target,type:e.type})}e.isDown=!1,e.isDrag=!1,e.target=null,e.type=0,e.timeStamp.mouseUp=s,i=!0}})),this.rootDom.onMousemove((t=>{const s=this.rootDom.getBoundingClientRect(),o={x:t.clientX-s.x,y:t.clientY-s.y};if(this.selectedBox){let t=0,e=0,i=0,s=0;return o.x>=this.selectPos.x&&o.y>=this.selectPos.y?(t=o.x-this.selectPos.x,e=o.y-this.selectPos.y,s=this.selectPos.y,i=this.selectPos.x):o.x>=this.selectPos.x&&o.y<this.selectPos.y?(t=o.x-this.selectPos.x,e=this.selectPos.y-o.y,s=o.y,i=this.selectPos.x):o.x<this.selectPos.x&&o.y<this.selectPos.y?(t=this.selectPos.x-o.x,e=this.selectPos.y-o.y,s=o.y,i=o.x):o.x<this.selectPos.x&&o.y>=this.selectPos.y&&(t=this.selectPos.x-o.x,e=o.y-this.selectPos.y,s=this.selectPos.y,i=o.x),void this.selectedBox.setStyle({top:s+"px",left:i+"px",width:t+"px",height:e+"px"})}if(this.events.dispatch(u.MouseMove,o),e.isDown&&(e.isDrag=!0),e.isDrag){if(0===e.button)switch(e.type){case 2:i&&this.events.dispatch(u.DragSlotStart,Object.assign({},o),e.target),this.events.dispatch(u.DragSlotMove,Object.assign({},o),e.target);break;case 1:i&&this.events.dispatch(u.DragNodeStart,Object.assign({},o),e.target),this.events.dispatch(u.DragNodeMove,Object.assign({},o),e.target);break;case 0:this.rootDom.setCursor("move"),this.viewPosition.x+=o.x-e.beforePos.x,this.viewPosition.y+=o.y-e.beforePos.y,i&&this.events.dispatch(u.DragViewStart,Object.assign({},o),e.target),this.events.dispatch(u.DragViewMove,Object.assign({},o),e.target)}i=!1}e.beforePos={x:o.x,y:o.y}})),this.rootDom.DOM.addEventListener("wheel",(t=>{t.preventDefault();let i=t.clientX-this.rootDom.DOM.getBoundingClientRect().left,s=t.clientY-this.rootDom.DOM.getBoundingClientRect().top;const o=(i-this.viewPosition.x)/this.scale,n=(s-this.viewPosition.y)/this.scale;if(t.altKey||t.ctrlKey||t.metaKey||t.deltaY.toString().indexOf(".")>-1){const e=this.scale-t.deltaY/(t.ctrlKey?200:2e3),r={x:-o*e+i,y:-n*e+s};if(e<.4||e>3)return;this.viewPosition.x=r.x,this.viewPosition.y=r.y,this.setScale(e)}else t.preventDefault(),this.viewPosition.x+=t.deltaX/1.5,this.viewPosition.y+=t.deltaY/1.5,this.events.dispatch(u.DragViewMove,Object.assign({},{x:t.deltaX,y:t.deltaY}),e.target)}),{passive:!1});new ResizeObserver((t=>{for(const e of t){const{width:t,height:i}=e.contentRect;this.events.dispatch(u.ViewResize,t,i)}})).observe(this.rootDom.DOM),this.rootDom.DOM.addEventListener("resize",(()=>{this.events.dispatch(u.ViewResize,this.rootDom.DOM.clientWidth,this.rootDom.DOM.clientHeight)})),this.events.add(u.SlotDown,((t,i,s)=>{e.button=t.button,e.isDown=!0,e.type=2,e.target={nodeRender:i,slotRender:s}})),this.events.add(u.NodeDown,((t,i)=>{e.button=t.button,e.isDown=!0,e.type=1,e.target={nodeRender:i}})),this.events.add(u.NodeEnter,(t=>{this.mouseInfo.enterTarget=t,this.mouseInfo.enterType=1})),this.events.add(u.NodeLeave,(t=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0})),this.events.add(u.SlotEnter,(t=>{this.mouseInfo.enterTarget=t,this.mouseInfo.enterType=2})),this.events.add(u.SlotLeave,(t=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0})),this.events.add(u.WidgetDown,((t,i,s)=>{e.button=t.button,e.isDown=!0,e.type=3,e.target={nodeRender:i,widget:s}})),this.events.add(u.WidgetEnter,((t,e,i)=>{this.mouseInfo.enterTarget=i,this.mouseInfo.enterType=3})),this.events.add(u.WidgetLeave,((t,e,i)=>{this.mouseInfo.enterTarget=null,this.mouseInfo.enterType=0}))}}const E=new class{constructor(){i(this,"zIndex",1e3),i(this,"style",{NodeHighLightColor:"#FFD700",NodeRunningColor:"#00FF00",LineRunningColor:"#00FF00",NodeEventColor:"#00BFFF",NodeTitleColor:"#363636",NodeFontColor:"#ffffff",NodeBackgroundColor:"#4b4b4b"}),i(this,"createRandomStyleNode",!0),i(this,"nodeStyles",[{name:"默认",nodeColor:"rgb(75, 75, 75)",nodeTitleColor:"rgb(54, 54, 54)",nodeFontColor:"rgb(255, 255, 255)"},{name:"棕色",nodeColor:"#593930",nodeTitleColor:"#332922",nodeFontColor:"rgb(255, 255, 255)"},{name:"绿色",nodeColor:"#335533",nodeTitleColor:"#223322",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝色",nodeColor:"#333355",nodeTitleColor:"#222233",nodeFontColor:"rgb(255, 255, 255)"},{name:"浅蓝色",nodeColor:"#3F5159",nodeTitleColor:"#2A3638",nodeFontColor:"rgb(255, 255, 255)"},{name:"蓝绿色",nodeColor:"#335555",nodeTitleColor:"#223333",nodeFontColor:"rgb(255, 255, 255)"},{name:"紫色",nodeColor:"#553355",nodeTitleColor:"#332233",nodeFontColor:"rgb(255, 255, 255)"},{name:"黄色",nodeColor:"#665533",nodeTitleColor:"#443322",nodeFontColor:"rgb(255, 255, 255)"},{name:"黑色",nodeColor:"#000000",nodeTitleColor:"#222222",nodeFontColor:"rgb(255, 255, 255)"},{name:"深蓝色",nodeColor:"#001f3f",nodeTitleColor:"#0074D9",nodeFontColor:"#FFFFFF"},{name:"橙色",nodeColor:"#FF851B",nodeTitleColor:"#FF4136",nodeFontColor:"#FFFFFF"},{name:"紫红色",nodeColor:"#D5008F",nodeTitleColor:"#FF0066",nodeFontColor:"#FFFFFF"},{name:"柔和粉红",nodeColor:"#FFC0CB",nodeTitleColor:"#FF69B4",nodeFontColor:"#000000"},{name:"海洋蓝",nodeColor:"#0077B6",nodeTitleColor:"#00A8CC",nodeFontColor:"#FFFFFF"},{name:"阳光黄",nodeColor:"#FFD700",nodeTitleColor:"#FFA500",nodeFontColor:"#000000"},{name:"青草绿",nodeColor:"#7CB518",nodeTitleColor:"#4B830D",nodeFontColor:"#FFFFFF"},{name:"玫瑰金",nodeColor:"#E91E63",nodeTitleColor:"#FF5722",nodeFontColor:"#FFFFFF"},{name:"宁静紫",nodeColor:"#8E44AD",nodeTitleColor:"#9B59B6",nodeFontColor:"#FFFFFF"}]),i(this,"showGraphInfo",!0)}getRandomColor(){const t=parseInt((Math.random()*this.nodeStyles.length).toString());return this.nodeStyles[t]}};class z{constructor(t,e,s){i(this,"parent"),i(this,"slot"),i(this,"parentDom"),i(this,"horizontal",{root:new k,pin:new k,label:new k,pinLinked:new k}),i(this,"vertical",{root:new k,pin:new k,label:new k,pinLinked:new k}),i(this,"linkInfo",null),i(this,"slotSize",10),i(this,"events"),this.parent=t,this.slot=s,this.parentDom=e,this.events=t.events,this._initHorizontal(),this._initVertical(),this.setVerticalMode(this.isVerticalMode)}get isVerticalMode(){return!!this.slot.options.isVertical}_initHorizontal(){const{pin:t,label:e,root:i,pinLinked:s}=this.horizontal,n=this.slot;if(this.createPin(t,s),e.setMarginLeft("5px"),e.setMarginRight("5px"),e.setFontSize(13),e.setStyle({whiteSpace:"nowrap"}),e.add(`${n.getLabel()}`),i.setFlex(),i.setStyle({alignItems:"center",marginBottom:"6px"}),n.type===o.INPUT?(i.add(t),i.add(e),i.setJustifyContent("flex-start")):(i.add(e),i.add(t),i.setJustifyContent("flex-end")),n.allow_input){let t=vt.createWidget(n.inputWidgetType);t&&(t.setWidth(50,"min"),t.setValue(n.value),t.onChange((t=>{n.value=t})),i.add(t))}this.parentDom.add(i),[t,e].forEach((t=>{t.onMousedown((t=>{t.stopPropagation(),this.events.dispatch(u.SlotDown,t,this.parent,this)})),t.onMouseover((t=>{t.stopPropagation(),this.events.dispatch(u.SlotEnter,this)})),t.onMouseout((t=>{t.stopPropagation(),this.events.dispatch(u.SlotLeave,this)}))}))}_initVertical(){const{pin:t,label:e,root:i,pinLinked:s}=this.vertical,n=this.slot;this.createPin(t,s),e.setFontSize(13),e.setStyle({whiteSpace:"nowrap"}),e.add(`${n.getLabel()}`),t.setMarginLeft("0px").setMarginRight("0px"),this.slot.type===o.OUTPUT&&t.setBackgroundColor("rgb(54, 54, 54)"),i.setAbsolute(),i.add(t),i.add(e),this.parentDom.add(i),i.setStyle({marginBottom:"6px"}),i.onMousedown((t=>{t.stopPropagation(),this.events.dispatch(u.SlotDown,t,this.parent,this)})),[t,e].forEach((t=>{t.onMouseover((t=>{t.stopPropagation(),this.events.dispatch(u.SlotEnter,this)})),t.onMouseout((t=>{t.stopPropagation(),this.events.dispatch(u.SlotLeave,this)}))}))}refreshVerticalPosition(){return s(this,null,(function*(){yield w(0);const{pin:t,label:e,root:i,pinLinked:s}=this.vertical,n=this.parent.getContent().getClientWidth(),r=this.parent.getContent().getClientHeight(),h=this.slot;let l=0,d=0,a=0,u=0;if(e.setAbsolute().setLeft(-e.getClientWidth()/2+this.slotSize/2),h.type===o.INPUT){l=-this.slotSize/2;for(let t of h.node.inputs)t!==h&&(t.options.isVertical?a+=1:t.index<h.index&&(u+=1));e.setTop(-17)}else{l=r-this.slotSize/2;for(let t of h.node.outputs)t!==h&&(t.options.isVertical?a+=1:t.index<h.index&&(u+=1));e.setTop(13)}d=n/(a+2)*(h.index+1-u)-this.slotSize/2,i.setTop(l).setLeft(d)}))}createPin(t=null,e=null){return t||(t=new k),e||(e=new k),e.setWidth(this.slotSize-2,"min"),e.setHeight(this.slotSize-2,"min"),e.setMarginTop("1px"),e.setMarginLeft("1px"),this.slot.valueType==wt||Array.isArray(this.slot.valueType)&&this.slot.valueType.indexOf(wt)>-1?e.setBackgroundColor(E.style.NodeHighLightColor):(e.setBackgroundColor(E.style.LineRunningColor),e.setStyle({borderRadius:"50%"}),t.setStyle({borderRadius:"50%"})),e.hide(),t.setWidth(this.slotSize,"min"),t.setHeight(this.slotSize,"min"),t.setMarginLeft("5px"),t.setMarginRight("5px"),t.setStyle({backgroundColor:"#767676",border:"1px solid rgb(36 36 36)"}),t.add(e),{pin:t,pinLinked:e}}onNodeInited(){this.refreshVerticalPosition()}setVerticalMode(t){this.slot.options.isVertical=t,t?(this.horizontal.root.hide(),this.refreshVerticalPosition()):this.vertical.root.hide()}getWidth(){return this.isVerticalMode?0:this.horizontal.root.getClientWidth()}setLinked(t){t?(this.horizontal.pinLinked.show(),this.vertical.pinLinked.show()):(this.horizontal.pinLinked.hide(),this.vertical.pinLinked.hide())}refresh(){const{label:t}=this.horizontal,{slot:e}=this;e.type===o.INPUT?this.setLinked(!!e.link):this.setLinked(e.link.length>0);const i=`${e.getLabel()}`;t.getInnerText()!==i&&(t.clear(),t.add(i)),this.refreshVerticalPosition()}getPosition(){const t=this.parent.getPosition();return this.isVerticalMode?{x:t.x+this.vertical.root.getOffsetLeft()+this.slotSize/2,y:t.y+this.vertical.root.getOffsetTop()+this.slotSize/2}:{x:t.x+this.horizontal.pin.getOffsetLeft()+this.slotSize/2,y:t.y+this.horizontal.pin.getOffsetTop()+this.slotSize/2}}getContextMenu(){const t=[];return this.slot.options.remove&&t.push({label:"删除插槽",callback:()=>{this.slot.options.removeFunc&&this.slot.options.removeFunc(this.slot),this.events.dispatch(p.RemoveNodeSlot,this)}}),t}remove(){this.horizontal.root.remove(),this.vertical.root.remove()}}class F extends z{constructor(t,e,i){super(t,e,i)}}class W extends z{constructor(t,e,i){super(t,e,i)}}const V=class t{constructor(t,e,s,o){i(this,"events"),i(this,"renderEvents",new x),i(this,"node"),i(this,"inputs",[]),i(this,"outputs",[]),i(this,"root"),i(this,"title"),i(this,"body"),i(this,"subContent",null),i(this,"inputsDom"),i(this,"outputsDom"),i(this,"parentDom"),i(this,"borderBox"),i(this,"dragSpan"),i(this,"dragImg","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjkwNTExMDkwODUxIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIyNzkiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik00NTEuMTA5IDk2MEgzNDhsNjEyLTYxMi0xLjY2MyAxMDMuMTA5TDQ1MS4xMDkgOTYweiBtMjY4LjQyNSAwSDYxNmwzNDQtMzQ0djEwMy41MzRMNzE5LjUzNCA5NjB6IiBmaWxsPSIjZjRlYTJhIiBwLWlkPSIyMjgwIj48L3BhdGg+PC9zdmc+"),i(this,"viewPosition"),i(this,"widgetsBox"),i(this,"dragResize",!1),i(this,"minWidth",0),i(this,"minHeight",0),this.parentDom=t,this.node=e,this.root=new k,this.title=new k,this.body=new k,this.borderBox=new k,this.dragSpan=new L,this.inputsDom=new k,this.outputsDom=new k,this.events=o,this.viewPosition=s,this.widgetsBox=new k,this.widgetsBox.setStyle({width:"calc(100% - 4px)",display:"flex",flexDirection:"column"}),this.dragSpan.setStyle({position:"absolute",bottom:"1px",right:"1px",width:"20px",height:"20px",backgroundImage:`url('${this.dragImg}')`,backgroundPosition:"100% 100%",backgroundOrigin:"content-box",backgroundRepeat:"no-repeat",boxSizing:"border-box",cursor:"se-resize",zIndex:"100",pointerEvents:"visible"}),this._init(),this._initEventListener(),this.setTopIndex()}_init(){return s(this,null,(function*(){var t,e,i;const{root:s,title:o,body:n,inputsDom:r,outputsDom:h}=this,l=this.node,d=new k;s.setPosition("absolute",0,0).setStyle({backgroundColor:null!=(t=this.node.options.nodeColor)?t:E.style.NodeBackgroundColor,borderRadius:"8px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",webkitUserSelect:"none",cursor:"pointer",color:null!=(e=this.node.options.nodeFontColor)?e:E.style.NodeFontColor}),l.getOption("clientWidth")&&s.setWidth(l.getOption("clientWidth"),"min"),l.getOption("clientHeight")&&s.setHeight(l.getOption("clientHeight"),"min"),o.setWidth("100%"),o.setHeight(25,"min"),o.setStyle({lineHeight:"25px",textAlign:"center",backgroundColor:null!=(i=this.node.options.nodeTitleColor)?i:E.style.NodeTitleColor,borderRadius:"8px 8px 0px 0px",fontWeight:"bold",padding:"4px 40px",boxSizing:"border-box",whiteSpace:"nowrap"}),this.body.setStyle({height:"auto",padding:"4px",paddingBottom:"8px",minWidth:"120px",paddingTop:"10px"}),o.innerText(l.label),this.borderBox.add(this.dragSpan),this.borderBox.setWidth("100%").setHeight("100%").setPosition("absolute",-4,-4).setStyle({border:"2px solid "+E.style.NodeHighLightColor,borderRadius:"9px",padding:"2px",pointerEvents:"none"}).hide(),d.setFlex(),d.setJustifyContent("space-between"),r.setStyle({flex:"1"}),n.setHeight("calc( 100% - 25px )");for(let c of l.outputs)this.outputs.push(new W(this,h,c));for(let c of l.inputs)this.inputs.push(new F(this,r,c));d.add(r).add(h),this.body.add(d).add(this.widgetsBox),this.root.add(this.title).add(this.body).add(this.borderBox),this.parentDom.add(this.root),this.setPosition(l.position.x,l.position.y);const{width:a,height:u}=this.root.getBoundingClientRect();this.minWidth=a,this.minHeight=u;const p=[...this.inputs,...this.outputs];for(let c of p)c.onNodeInited();yield w(100),this.node.initedRender()}))}setTopIndex(){E.zIndex=E.zIndex+1,this.root.setStyle({zIndex:E.zIndex+""})}_initEventListener(){this.renderEvents.create(c.Resize),this.renderEvents.create(c.Refresh),this.root.onMousedown((t=>{t.stopPropagation(),this.events.dispatch(u.NodeDown,t,this),this.setTopIndex()}));let t=null;this.root.onClick((e=>{1===e.detail&&(t=setTimeout((()=>{this.events.dispatch(v.Node,e,this)}),200))})),this.root.onDblClick((e=>{clearTimeout(t)})),this.root.onMouseover((t=>{this.events.dispatch(u.NodeEnter,this)})),this.root.onMouseout((t=>{this.events.dispatch(u.NodeLeave,this)})),this.dragSpan.onMousedown((t=>{t.stopPropagation(),t.preventDefault(),document.onmousemove=t=>{t.stopPropagation(),t.preventDefault();const e=t.clientX,i=t.clientY,{x:s,y:o}=this.root.getBoundingClientRect(),n=e-s,r=i-o;this.setSize(n,r),this.events.dispatch(u.LinksFresh,this.node.graph.runedNodes)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null}}))}setSize(t,e){var i,s;const o=this.events.getScale();let n=this.minWidth,r=this.minHeight;if(t>this.minWidth*o&&(n=t/o),e>this.minHeight*o&&(r=e/o),n!=this.minWidth||r!=this.minHeight){for(let t of this.inputs)t.refresh();for(let t of this.outputs)t.refresh();if(this.node.subGraph){const n=this.node;n.minSize&&n.minSize.width*o<=t&&(null==(i=n.graphWidget)||i.viewerDom.setWidth((n.originRect.width*o+t-n.minSize.width*o)/o)),n.minSize&&n.minSize.height*o<=e&&(null==(s=n.graphWidget)||s.viewerDom.setHeight((n.originRect.height*o+e-n.minSize.height*o)/o))}this.renderEvents.dispatch(c.Resize,n*o,r*o)}this.root.setWidth(n,"min").setHeight(r,"min")}setPosition(t,e){this.events.getScale(),this.root.setLeft(t).setTop(e)}adaption(){const{root:t,title:e,body:i,inputs:s,outputs:o}=this,n=130,r=80;let h=e.getClientWidth(),l=e.getClientHeight(),d=0;for(let u of s){const t=u.getWidth();d<t&&(d=t)}let a=0;for(let u of o){const t=u.getWidth();a<t&&(a=t)}h<a+d&&(h=a+d),h=h>i.getClientWidth()?h:i.getClientWidth(),l+=17*(s.length>o.length?s.length:o.length),l<r&&(l=r),h<n&&(h=n),this.setSize(h,l)}getInput(t){return this.inputs[t]}getOutput(t){return this.outputs[t]}getPosition(){return{x:this.node.position.x,y:this.node.position.y}}refresh(){var e;const{root:i,title:s,body:o,inputsDom:n,outputsDom:r}=this;if(this.setPosition(this.node.position.x,this.node.position.y),s.innerText(this.node.label),this.events.viewer.option.nodeIndexShow&&t.showNodeIndex){let t=new k;t.innerText(null!=(e=this.node.index.toString())?e:"\\"),t.setStyle({position:"absolute",left:"2px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",minWidth:"25px",borderRadius:"50%",padding:"0 4px",backgroundColor:"black",color:"white",boxSizing:"border-box"}),s.add(t)}this.node.options.nodeColor&&i.setStyle({backgroundColor:this.node.options.nodeColor}),this.node.options.nodeTitleColor&&s.setStyle({backgroundColor:this.node.options.nodeTitleColor}),this.node.options.nodeFontColor&&i.setStyle({color:this.node.options.nodeFontColor});const h=[],l=[];if(this.node.inputs.length<this.inputs.length){const t=this.inputs.splice(this.node.inputs.length,this.inputs.length-this.node.inputs.length);for(let e of t)e.remove()}if(this.node.outputs.length<this.outputs.length){const t=this.outputs.splice(this.node.outputs.length,this.outputs.length-this.node.outputs.length);for(let e of t)e.remove()}for(let t of this.node.inputs){const e=this.inputs[t.index];if(e)if(e.slot!==t){const i=new F(this,n,t);t.link&&t.link.info&&(t.link.info.end=i,i.linkInfo=t.link.info),i.refresh(),h.push(i),e.remove()}else e.refresh(),h.push(e);else h.push(new F(this,n,t))}for(let t of this.node.outputs){const e=this.outputs[t.index];if(e)if(e.slot!==t){const i=new W(this,r,t);if(t.link&&t.link.length>0)for(let e of t.link)e.info&&(e.info.start=i,i.linkInfo=e.info);i.refresh(),l.push(i),e.remove()}else e.refresh(),l.push(e);else l.push(new W(this,r,t))}this.inputs=h,this.outputs=l,this.widgetsBox.clear();for(let t of this.node.widgets){if(t.onMouseover((e=>{this.events.dispatch(u.WidgetEnter,e,this,t)}),!0),t.onMouseout((e=>{this.events.dispatch(u.WidgetLeave,e,this,t)}),!0),t.onMousedown((e=>{this.events.dispatch(u.WidgetDown,e,this,t)}),!0),t.isCustomClick&&t.onClick((e=>{e.stopPropagation(),this.events.dispatch(v.Widget,e,this,t)}),!0),t.getLabel()){let e=new k;e.setFlex().setFlexDirection("row"),e.setStyle({justifyContent:"center",alignItems:"center",paddingLeft:"4px"});let i=new L(t.getLabel());i.setStyle({whiteSpace:"nowrap",lineHeight:"100%",fontSize:"14px",marginRight:"4px"}),t.setStyle({flexGrow:"1"}),e.add(i),e.add(t),e.setMarginBottom("6px"),this.widgetsBox.add(e)}else t.setMarginBottom("6px"),this.widgetsBox.add(t);this.renderEvents.dispatch(c.Refresh)}this.node.onRefresh&&this.node.onRefresh()}remove(){this.root.remove()}getContextMenu(){var t,e;const i=this.node.getContextMenu();this.node.subGraph||this.node.options.notClone||i.push({label:"克隆节点",callback:()=>{this.events.dispatch(p.CloneNode,this.node.id)}});let s=!1;if(this.node.options.addInput&&this.node.addInputsConfig.length>0){const e=[];for(let i of this.node.addInputsConfig)e.push({label:null!=(t=i.label)?t:"未命名输入",callback:()=>{this.events.dispatch(p.AddNodeInput,this,i)}});i.push({label:"添加输入",subMenu:e}),s=!0}if(this.node.options.addOutput&&this.node.addOutputsConfig.length>0){const t=[];for(let i of this.node.addOutputsConfig)t.push({label:null!=(e=i.label)?e:"未命名输出",callback:()=>{this.events.dispatch(p.AddNodeOutput,this,i)}});i.push({label:"添加输出",subMenu:t}),s=!0}return s&&i.push(null),i.push({label:"删除节点",callback:()=>{this.events.dispatch(p.RemoveNode,this.node.id)}}),i}setHighLight(t=""){this.node.onNodeHighLight(),t&&this.borderBox.setStyle({borderColor:t}),this.borderBox.show(),this.node.options.notResize?this.dragSpan.hide():this.dragSpan.show()}setLabel(t){this.node.setLabel(t),this.refresh()}shake(){const t=Date.now();let e=t,i=()=>{e=Date.now();if(e-t<500){const t=5*Math.random()*2-5,e=5*Math.random()*2-5;this.root.DOM.style.transform=`translate(${t}px, ${e}px)`,requestAnimationFrame(i)}else this.root.DOM.style.transform="none"};i()}cancelHighLight(){this.borderBox.setStyle({borderColor:E.style.NodeHighLightColor}),this.borderBox.hide()}getContent(){return this.root}removeNode(){this.events.dispatch(p.RemoveNode,this.node.id)}setMinSize(t){this.minWidth=t.width,this.minHeight=t.height}};i(V,"showNodeIndex",!0);let H=V;class G{constructor(t,e){i(this,"type",a.Dom),i(this,"rootDom"),i(this,"events"),i(this,"nodeMap",{}),i(this,"root"),this.rootDom=t,this.events=e,this.root=new k,this.root.setStyle({transformOrigin:"top left"}),this.root.setPosition("absolute",0,0),this.rootDom.add(this.root)}getAllNodes(){return Object.values(this.nodeMap)}addNode(t){if(this.events.viewer.runMode)return null;if(this.nodeMap[t.id])return this.nodeMap[t.id];const e=new H(this.root,t,this.events.viewPosition,this.events);return this.nodeMap[t.id]=e,e}removeNode(t){this.nodeMap[t]&&(this.nodeMap[t].remove(),delete this.nodeMap[t])}getNodeRender(t){return this.nodeMap[t]}getSlotRender(t,e,i){const s=this.getNodeRender(t);return s?i?s.getOutput(e):s.getInput(e):null}refresh(){this.nodeMap;for(let t in this.nodeMap){this.nodeMap[t].refresh()}}setPosition(){const t=this.events.getScale(!0),e=this.events.getScale();this.root.setStyle({transform:`scale(${t}) translate(${this.events.viewPosition.x/e}px,${this.events.viewPosition.y/e}px)`});let i=this.events.viewer.graph.getAllSubGraph();i.length&&i.forEach((t=>{t.getNodeManager().setPosition()}))}}class $ extends C{constructor(){super("canvas"),i(this,"ctx"),this.ctx=this.DOM.getContext("2d"),this.ctx.translate(.5,.5)}}class U{constructor(t,e){i(this,"type",a.Svg),i(this,"rootDom"),i(this,"events"),i(this,"root"),i(this,"linkMap",{}),i(this,"tempLine"),i(this,"tempPoints"),i(this,"commonLinks",{}),i(this,"ctx"),i(this,"canvas"),i(this,"runedNodes",[]),i(this,"tempPointHeight",5),this.rootDom=t,this.events=e;let s=new $;s.setHeight(this.rootDom.getClientHeight()).setWidth(this.rootDom.getClientWidth());const o=window.devicePixelRatio;s.setAttribute("width",""+this.rootDom.getClientWidth()*o),s.setAttribute("height",""+this.rootDom.getClientHeight()*o),s.ctx.scale(o,o),s.setStyle({webkitUserSelect:"none",userSelect:"none",position:"absolute",top:"0px",left:"0px",zIndex:"0",pointerEvents:"none"}),this.canvas=s,this.ctx=s.ctx,this.rootDom.DOM.insertBefore(s.DOM,this.rootDom.DOM.firstChild);let n=()=>{this.refresh(),requestAnimationFrame(n)};n();const r=this.root=new R;r.setAttribute("width",`${this.rootDom.getClientWidth()}`),r.setAttribute("height",`${this.rootDom.getClientHeight()}`),r.setStyle({position:"absolute",top:"0px",left:"0px"}),this.tempLine=new I,this.tempLine.hide(),this.tempPoints=[new P,new P],this.tempPoints[0].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[0].setAttribute("fill","#00ff00"),this.tempPoints[1].setAttribute("r",this.tempPointHeight.toString()),this.tempPoints[1].setAttribute("fill","#00ff00"),this.tempPoints[0].hide(),this.tempPoints[1].hide(),this.root.add(this.tempLine),this.root.add(this.tempPoints[0]),this.root.add(this.tempPoints[1]),this.rootDom.add(r.DOM),this.events.add(u.LinksFresh,(t=>{null!==t&&(this.runedNodes=null!=t?t:[]),this.refresh()})),this.events.add(u.ViewResize,((t,e)=>{this.root.setAttribute("width",t),this.root.setAttribute("height",e),this.canvas.DOM.setAttribute("height",e),this.canvas.DOM.setAttribute("width",t),this.root.setStyle({width:t+"px",height:e+"px"}),this.canvas.setStyle({width:t+"px",height:e+"px"}),this.refresh()}))}clear(){this.commonLinks={},this.refresh()}addLink(t,e,i){const s=e.getPosition(),o=i.getPosition();if(isNaN(s.x)||isNaN(s.y)||isNaN(o.x)||isNaN(o.y))return;const n={start:e,end:i,link:t};this.commonLinks[t.id]=n,e.linkInfo=n,i.linkInfo=n,t.info=n,this.refresh()}removeLink(t){const e=this.commonLinks[t];e&&(e.start.linkInfo=null,e.end.linkInfo=null,e.link.info=null,delete this.commonLinks[t],this.refresh())}getLinkRender(t){return this.linkMap[t]}displayTempLine(t){const e=this.events.getParentScale();this.tempPoints.forEach((t=>{t.setAttribute("r",""+this.tempPointHeight*e)})),t?(this.tempLine.show(),this.tempPoints[0].show(),this.tempPoints[1].show()):(this.tempLine.hide(),this.tempPoints[0].hide(),this.tempPoints[1].hide())}setTempLine(t,e,i){const s=this.events.getScale(!0),o=this.events.getParentScale(),n=2*s;i?(t={x:t.x*s+this.events.viewPosition.x*o,y:t.y*s+this.events.viewPosition.y*o},e={x:e.x*o,y:e.y*o}):(t={x:t.x*o,y:t.y*o},e={x:e.x*s+this.events.viewPosition.x*o,y:e.y*s+this.events.viewPosition.y*o}),this.tempLine.drawFillBezierLine(t,e,n,"#00ff00","#000000",1,10),this.tempPoints[1].setAttribute("cx",`${e.x}`),this.tempPoints[1].setAttribute("cy",`${e.y}`),this.tempPoints[0].setAttribute("cx",`${t.x}`),this.tempPoints[0].setAttribute("cy",`${t.y}`)}refresh(){this.ctx.clearRect(0,0,this.rootDom.getOffsetWidth(),this.rootDom.getOffsetHeight());const t=this.events.getParentScale(),e=window.devicePixelRatio;this.canvas.setAttribute("width",""+this.rootDom.getClientWidth()*e/t),this.canvas.setAttribute("height",""+this.rootDom.getClientHeight()*e/t),this.canvas.ctx.scale(e/t,e/t),E.showGraphInfo&&(this.ctx.fillStyle="white",this.ctx.font=10*t+"px Aria",this.ctx.fillText(`缩放率：${parseInt((100*this.events.getScale()).toString())}%`,10*t,this.rootDom.getOffsetHeight()-40*t),this.ctx.fillText(`连线数：${this.events.viewer.graph.getLinks().length}`,10*t,this.rootDom.getOffsetHeight()-25*t),this.ctx.fillText(`节点数：${this.events.viewer.graph.getNodes().length}`,10*t,this.rootDom.getOffsetHeight()-10*t));for(let i in this.commonLinks){const t=this.commonLinks[i],e=t.start.getPosition(),s=t.end.getPosition(),o=this.getLinkColor(t);this.canvasDrawLink(e,s,o,t.start.isVerticalMode,t.end.isVerticalMode)}}getLinkColor(t){const e=t.start.slot.node.id;let i="black",s=[];this.events.viewer.ActiveNodes.forEach((t=>{s.push(t.node.id)})),ot.ActiveNode&&s.push(ot.ActiveNode.node.id),t.start.slot.node.options.nodeColor&&(i=t.start.slot.node.options.nodeColor),s.forEach((s=>{s!=e&&s!=t.end.slot.node.id||(i=E.style.NodeHighLightColor)}));for(let o=0;o<this.runedNodes.length;o++){this.runedNodes[o].id==e&&(i=E.style.LineRunningColor)}return i}canvasDrawLink(t,e,i="black",s=!1,o=!1){const n=this.events.getScale(!0),r=this.events.getParentScale(),h=t.x*n+this.events.viewPosition.x*r,l=t.y*n+this.events.viewPosition.y*r,d=e.x*n+this.events.viewPosition.x*r,a=e.y*n+this.events.viewPosition.y*r;let u=h+50*n,p=l;s&&(u=h,p=l+50*n);let c=d-50*n,g=a;o&&(c=d,g=a-50*n),this.ctx.beginPath(),this.ctx.lineWidth=3*n,this.ctx.strokeStyle=i,this.ctx.moveTo(h,l),this.ctx.bezierCurveTo(u,p,c,g,d,a),this.ctx.stroke()}}class j extends k{constructor(t){super(),i(this,"viewer"),i(this,"nodeManager"),i(this,"inputInstance",null),i(this,"nodesBox",null),i(this,"pointer",null),i(this,"searchText",null),i(this,"isCreate",!0),this.viewer=t,this.nodeManager=this.viewer.graph.nodeManager,this.initBox(),this.viewer.events.add(u.DoubleLeftClick,((t,e,i)=>{if(i.target instanceof HTMLCanvasElement||i.target instanceof SVGElement){if(this.viewer.graph.parentNode){const e=this.viewer.graph.parentNode.widgets[0].viewerDom;if(t.x<0||t.y<0||t.x>e.getClientWidth()||t.y>e.getClientHeight())return}if(!this.viewer.graph.isInSubgraph(t))return void this.showBox(t);this.hide()}else this.hide()})),this.viewer.events.add(u.MouseDown,(()=>{this.hide()})),this.onWheel((t=>{t.stopPropagation()}))}initBox(){this.setPosition("absolute").setWidth(200).setHeight(200,"min").setBackgroundColor("black").setStyle({opacity:"0.8",cursor:"pointer",display:"flex",flexDirection:"column",transformOrigin:"left top"}).setBorderRadius("20px").setPadding("10px"),this.DOM.addEventListener("dblclick",(t=>{t.stopPropagation()})),this.onMousedown((t=>{t.stopPropagation()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&this.hide()})),this.initSearchInput(),this.hide()}initSearchInput(){let t=new k;t.setWidth("100%").setHeight("20px").setMarginBottom("10px");let e=new T("","请输入关键字搜索");e.setWidth("100%").setStyle({opacity:"0.5",border:"0"}).setHeight("100%").setBorderRadius("8px").setPaddingLeft("10px").setMarginLeft("-6px").setColor("black").setFontSize(14),e.onChange((()=>{this.searchText=e.getValue(),this.refreshNodes()})),this.inputInstance=e,t.add(e),this.add(t);let i=new k;i.setStyle({display:"flex",justifyContent:"space-between",paddingBottom:"5px"}),this.add(i);let s=new D("新增节点");s.setWidth("49%").onClick((()=>{this.isCreate||(this.isCreate=!0,s.setBackgroundColor("white").setColor("black"),o.setBackgroundColor("black").setColor("white"),this.refreshNodes())}));let o=new D("查询节点");o.setWidth("49%").setBackgroundColor("black").setColor("white").onClick((()=>{this.isCreate&&(this.isCreate=!1,s.setBackgroundColor("black").setColor("white"),o.setBackgroundColor("white").setColor("black"),this.refreshNodes())})),i.add(s).add(o)}refreshNodes(){if(null===this.nodesBox?(this.nodesBox=new k,this.nodesBox.setStyle({flexGrow:"1",overflowY:"auto",backgroundColor:"black",width:"100%",maxHeight:"200px",paddingTop:"5px"}),this.add(this.nodesBox)):this.nodesBox.clear(),this.isCreate){this.nodeManager.getNodeTypeList().forEach((t=>{this.searchText?(t.label.indexOf(this.searchText)>-1||t.type.indexOf(this.searchText)>-1)&&this.createNodeSelectItem(t):this.createNodeSelectItem(t)}))}else{const t=this.viewer.serialize().nodes;if(!t.length||!this.searchText)return;t.forEach((t=>{var e;JSON.stringify(t).indexOf(this.searchText)>-1&&this.createNodeSelectItem({label:`[${t.index}] ${null!=(e=t._label)?e:t.type}`,type:t.id})}))}}createNodeSelectItem(t){var e;let i=new k;i.setColor("white").setStyle({lineHeight:"1.5rem",paddingLeft:".5rem",textAlign:"left"}).onMouseover((()=>{i.setBackgroundColor("white").setColor("black")})),i.onMouseout((()=>{i.setBackgroundColor("black").setColor("white")})),i.onClick((()=>{if(this.isCreate){const e=this.viewer.events.getScale();let i={x:this.pointer.x/e-60-this.viewer.events.viewPosition.x/e,y:this.pointer.y/e-this.viewer.events.viewPosition.y/e,z:0};this.viewer.addNode(t.type,i)}else this.viewer.focusOnNode(t.type);this.hide()})),i.DOM.innerText=t.label,null==(e=this.nodesBox)||e.add(i)}showBox(t){var e,i;this.searchText="",null==(e=this.inputInstance)||e.setValue(""),this.pointer=t;const s=this.viewer.events.getParentScale();this.setLeft(t.x*s-100*s).setTop(t.y*s-20*s).setStyle({transform:`scale(${s})`}),this.refreshNodes(),this.show(),null==(i=this.inputInstance)||i.DOM.focus()}show(){return this.setStyle({display:"flex"}),this}}class _ extends k{constructor(t,e){super(),i(this,"graph"),i(this,"logPanel",null),i(this,"events"),this.graph=t,this.events=e,this.initBox(),this.initButtons(),this.events.add(u.AddRunLog,(t=>{var e;null==(e=this.logPanel)||e.log(t)}))}initBox(){this.setStyle({position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"row",background:"black",opacity:"0.8",height:"30px",padding:"8px",borderRadius:"10px",cursor:"pointer",justifyContent:"center",alignItems:"center"}),this.DOM.addEventListener("dblclick",(t=>{t.stopPropagation()}))}initButtons(){let t=new Y;t.setMarginRight("10px"),t.onClick((()=>{this.logPanel||(this.logPanel=new q,this.add(this.logPanel)),this.graph.start()})),this.add(t),this.events.add(p.StartRun,(()=>{t.DOM.click()}));let e=new X;e.onClick((()=>{var e;null==(e=this.logPanel)||e.remove(),this.logPanel=null,t.stopAnimation(),this.graph.stop(),setTimeout((()=>{this.graph.stop()}),this.graph.stepTime)})),this.events.add(p.StopRun,(()=>{e.DOM.click()})),this.add(e)}addButton(t){if(!t.name||!t.callback)return;let e=new D(t.name);e.onClick((()=>{t.callback()})),e.setMarginLeft("10px"),t.backgroundColor&&e.setBackgroundColor(t.backgroundColor),t.color&&e.setColor(t.color),this.add(e)}}class Y extends k{constructor(){super(),i(this,"isAnimating",!1),i(this,"animationFrameId",0),i(this,"scale",1),i(this,"scaleFactor",.01),i(this,"maxScale",1.2),i(this,"minScale",.8),this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">        <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />        <polygon points="10,7 18,12 10,17" fill="white" />      </svg>',this.setHeight(24),this.onClick((()=>{this.startAnimation()}))}startAnimation(){this.isAnimating||(this.isAnimating=!0,this.animateScale())}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,cancelAnimationFrame(this.animationFrameId),this.scale=1,this.updateScale())}animateScale(){this.isAnimating&&(this.scale+=this.scaleFactor,(this.scale>=this.maxScale||this.scale<=this.minScale)&&(this.scaleFactor=-this.scaleFactor),this.updateScale(),this.animationFrameId=requestAnimationFrame((()=>{this.animateScale()})))}updateScale(){this.DOM.style.transform=`scale(${this.scale})`}}class X extends k{constructor(){super(),this.setHeight(24),this.DOM.innerHTML='<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">    <circle cx="12" cy="12" r="11" stroke="white" stroke-width="2" />    <rect x="8" y="8" width="8" height="8" stroke="white" stroke-width="2" />  </svg>'}}class q extends k{constructor(){super(),i(this,"logs",[]),this.initBox(),this.render()}initBox(){this.setStyle({position:"absolute",left:"-20px",background:"black",height:"20px",width:"20px",top:"0",borderRadius:"6px",padding:"6px",overflowY:"auto",opacity:".8",transition:"all 0.5s ease"}),setTimeout((()=>{this.setWidth("200px").setLeft("-220px").setHeight("200px")}),0),this.onWheel((t=>{t.stopPropagation()}))}log(t){this.logs.unshift(t),this.render()}render(){this.clear(),this.logs.forEach((t=>{this.createLogItem(t)}))}remove(){this.setLeft("0px").setTop(5).setWidth("24px").setHeight("24px"),setTimeout((()=>{this.clear()}),300),setTimeout((()=>{super.remove()}),500)}createLogItem(t){let e=new k;e.DOM.innerHTML=`节点${t.node.id} [${t.node.label}]：${t.msg}`,e.setStyle({color:"white",fontSize:"12px",padding:"2px",borderBottom:"1px solid white",borderRadius:"4px",cursor:"pointer",userSelect:"none",webkitUserSelect:"none"}),e.onMouseover((()=>{e.setStyle({background:"white",color:"black"})})),e.DOM.addEventListener("dblclick",(t=>{t.stopPropagation()})),e.onMouseout((()=>{e.setStyle({background:"black",color:"white"})})),e.onClick((()=>{var e,i;null==(e=t.node.render)||e.events.dispatch(p.FocusOnNode,t.node.id),null==(i=t.node.render)||i.shake()})),this.add(e)}}class J{constructor(t){i(this,"parent"),i(this,"root"),i(this,"label"),i(this,"input"),i(this,"isReadOnly",!1),i(this,"styles",{fontColor:"#ffffff",backColor:"#4b4b4b"}),this.parent=t,this.root=new k,this.label=new k,this.input=new T("","请输入"),this.init()}setReadOnly(t){const{input:e}=this;t?(e.setAttribute("readonly","readonly"),e.setStyle({backgroundColor:this.styles.backColor,fontSize:"17px"})):(e.removeAttribute("readonly"),e.setStyle({backgroundColor:"#a8a8a8"})),this.isReadOnly=t}setValue(t,e){this.input.setValue(t),e&&this.label.innerText(e)}onChange(t){this.input.onChange((()=>{t(this.input.getValue())}))}init(){const{root:t,label:e,input:i}=this;t.setStyle({display:"flex",width:"calc( 100% - 20px)",height:"30px",margin:"5px 10px 0px 10px",color:this.styles.fontColor,backgroundColor:this.styles.backColor}),e.setStyle({width:"100px",lineHeight:"30px"}),e.innerText("测试"),i.setStyle({lineHeight:"30px",backgroundColor:"#a8a8a8",color:this.styles.fontColor,borderRadius:"2px",fontSize:"16px"}),t.add(e),t.add(i),this.parent.add(t)}refresh(){const{root:t,label:e,input:i}=this;t.setStyle({color:this.styles.fontColor,backgroundColor:this.styles.backColor}),i.setStyle({color:this.styles.fontColor}),this.setReadOnly(this.isReadOnly)}remove(){this.root.remove()}}class K{constructor(t){i(this,"parent"),i(this,"render",null),i(this,"root"),i(this,"title"),i(this,"body"),i(this,"footer"),i(this,"isShow",!1),i(this,"onNodeRefresh",null),this.parent=t,this.root=new k,this.title={root:new k,label:new k};const e=new k;let s=new Q;e.add(s),this.body={root:e,divider:s,title:new J(e),idLabel:new J(e),props:[]},this.body.root.add(new Q("属性")),this.footer={root:new k,deleteBtn:new D("删除"),cancelBtn:new D("取消")},this.init()}init(){const{root:t,body:e,title:i,footer:s}=this;this.parent.DOM.addEventListener("mousedown",(()=>{this.hide()})),t.setStyle({width:"400px",backgroundColor:"rgb(75 75 75)",borderRadius:"13px",color:"rgb(255 255 255)",transition:"all .5s ease-in-out",overflow:"hidden",border:"2px solid "+E.style.NodeHighLightColor}).setAbsolute(57,420),t.onMousemove((t=>{t.stopPropagation()})),t.onMouseup((t=>{t.stopPropagation()})),t.onMousedown((t=>{t.stopPropagation()})),t.onWheel((t=>{t.stopPropagation()})),this.initTitle(),this.initBody(),this.initFooter(),t.add(i.root),t.add(e.root),t.add(s.root),t.hide(),this.parent.add(this.root),document.addEventListener("keydown",(t=>{"Escape"===t.key&&this.isShow&&this.hide()}))}initBody(){const{root:t,idLabel:e,title:i}=this.body;t.setStyle({width:"100%",overflowY:"auto",height:"calc(100% - 74px)"}),e.setReadOnly(!0),i.onChange((t=>{this.render.setLabel(t)}))}initTitle(){const{root:t,label:e}=this.title;t.setStyle({width:"100%",backgroundColor:"rgb(54 54 54)",height:"40px",borderRadius:"5px 5px 0px 0px",fontWeight:"bold",lineHeight:"40px",textAlign:"center"}),e.innerText("测试"),t.add(e)}initFooter(){const{root:t,deleteBtn:e,cancelBtn:i}=this.footer;t.setStyle({width:"100%",height:"30px",textAlign:"center"}),[e,i].forEach((t=>{t.setStyle({height:"20px",marginTop:"5px"}),t.onMouseover((()=>{t.setStyle({backgroundColor:"#ffffff"})})),t.onMouseout((()=>{t.setStyle({backgroundColor:"#cacaca"})}))})),e.onClick((()=>{this.render.removeNode(),this.hide()})),i.onClick((()=>{this.hide()})),i.setMarginLeft("15px"),t.add(e),t.add(i)}refresh(t){const e=this.render=t,i=e.node;this.title.label.innerText(`${i.label}`),this.body.title.setValue(i.label,"标题"),this.body.idLabel.setValue(i.id,"id"),this.body.divider.setMsg(`index: ${i.index.toString()}`);const s=i.getOption("nodeFontColor"),o=i.getOption("nodeTitleColor"),n=i.getOption("nodeColor");this.root.setStyle({backgroundColor:null!=n?n:"#4b4b4b"}),this.title.root.setStyle({backgroundColor:null!=o?o:"rgb(54 54 54)"}),this.body.idLabel.styles.fontColor=null!=s?s:"#ffffff",this.body.idLabel.styles.backColor=null!=n?n:"#4b4b4b",this.body.title.styles.fontColor=null!=s?s:"#ffffff",this.body.title.styles.backColor=null!=n?n:"#4b4b4b",this.body.idLabel.refresh(),this.body.title.refresh();for(let r of this.body.props)r.remove();this.body.props=[];for(let r in i.properties){const t=i.properties[r];switch(typeof t){case"string":const e=new J(this.body.root);e.setValue(t.toString(),r),e.styles.backColor=null!=n?n:"#4b4b4b",e.styles.fontColor=null!=s?s:"#ffffff",e.refresh(),e.onChange((t=>{i.setProperty(r,t)})),this.body.props.push(e);break;case"number":const o=new J(this.body.root);o.input.setAttribute("type","number"),o.setValue(t.toString(),r),o.styles.backColor=null!=n?n:"#4b4b4b",o.styles.fontColor=null!=s?s:"#ffffff",o.refresh(),o.onChange((t=>{i.setProperty(r,t)})),this.body.props.push(o)}}if(e.node.inputs.length){let t=new Q("输入参数");this.body.props.push(t),this.body.root.add(t);for(let i=0;i<e.node.inputs.length;i++){const t=e.node.inputs[i],s=new J(this.body.root);s.setValue(t.label),s.label.innerText("输入"+(i+1)),s.onChange((e=>{var s,o;t.label=e,null==(o=null==(s=t.node.render)?void 0:s.getInput(i))||o.refresh()})),this.body.props.push(s)}}if(e.node.outputs.length){let t=new Q("输出参数");this.body.root.add(t),this.body.props.push(t);for(let i=0;i<e.node.outputs.length;i++){const t=e.node.outputs[i],s=new J(this.body.root);s.setValue(t.label),s.label.innerText("输入"+(i+1)),s.onChange((e=>{var s,o;t.label=e,null==(o=null==(s=t.node.render)?void 0:s.getOutput(i))||o.refresh()})),this.body.props.push(s)}}}show(t){this.render&&this.render.renderEvents.remove(c.Refresh,this.onNodeRefresh);const e=t,i=1/e.events.getScale(!0),s=e.events.getParentScale(),o=e.root.DOM.getBoundingClientRect(),n=this.parent.DOM.getBoundingClientRect(),r=(o.left-n.left)*s,h=(o.top-n.top)*s;this.root.setStyle({position:"absolute",width:o.width+"px",height:o.height+"px",top:h+"px",left:r+"px",opacity:"0.7",zIndex:"99999",boxSizing:"border-box",transformOrigin:"left top"}),setTimeout((()=>{let t=o.width*i*s*2,e=o.height*i*s*2,l=h-(e-o.height)/2*s,d=r-(t-o.width)/2*s;t>=n.width&&(t=n.width,d=0),e>=n.height&&(e=n.height,l=0),d<=0&&(d=0),l<=0&&(l=0),this.root.setStyle({width:t+"px",height:e+"px",left:d+"px",top:l+"px",opacity:"1",transform:`scale(${s})`})}),0),this.refresh(t),this.onNodeRefresh=()=>{this.render&&this.refresh(this.render)},t.renderEvents.add(c.Refresh,this.onNodeRefresh),setTimeout((()=>{this.body.root.DOM.scrollTop=0}),0),this.root.show(),this.isShow=!0}hide(){if(this.render){this.render.renderEvents.remove(c.Refresh,this.onNodeRefresh);const t=this.render,e=t.events.getParentScale(),i=t.root.DOM.getBoundingClientRect(),s=this.parent.DOM.getBoundingClientRect(),o=(i.left-s.left)*e,n=(i.top-s.top)*e;this.root.setStyle({width:i.width+"px",height:i.height+"px",top:n+"px",left:o+"px"})}w(450).then((()=>{this.root.hide()})),this.render=null,this.isShow=!1}}class Q extends k{constructor(t=""){super(),i(this,"label"),i(this,"msg","标题"),t&&(this.msg=t),this.label=new k,this.init()}init(){this.setStyle({backgroundColor:"rgb(54 54 54)",width:"calc( 100% - 10px )",height:"4px",marginLeft:"5px",marginRight:"5px",marginTop:"15px",marginBottom:"15px",textAlign:"center",position:"relative",userSelect:"auto",webkitUserSelect:"auto"}),this.label.innerText(this.msg).setBackgroundColor("rgb(54 54 54)").setAbsolute().setFontSize(16).setPaddingLeft("10px").setPaddingRight("10px").setTop("-10px").setLeft("10px").setStyle({lineHeight:"24px"}),this.add(this.label)}setMsg(t=""){this.label.innerText(t)}}class Z{constructor(t,e){i(this,"type",a.DomUI),i(this,"rootDom"),i(this,"events"),i(this,"contextMenu"),i(this,"associativeMenu"),i(this,"nodePanel"),i(this,"isShowContextMenu",!1),this.rootDom=t,this.events=e,this.contextMenu=this.createMenu(this.rootDom),this.associativeMenu=this.createMenu(this.rootDom),this.nodePanel=new K(this.rootDom),this.events.add(u.NodeDown,((t,e)=>{this.nodePanel.render&&e!==this.nodePanel.render&&this.nodePanel.hide()}))}createMenu(t){const e=new k;e.setAbsolute(),e.addClass("g-menu").setStyle({minWidth:"88px",width:"88px",minHeight:"20px",backgroundColor:"rgb(59, 59, 59)",borderRadius:"3px",boxShadow:"2px 2px 7px 1px rgba(0, 0, 0, .2)",userSelect:"none",display:"flex",alignContent:"center",flexWrap:"wrap",flex:"1"}).hide();const i=t=>(t.stopPropagation(),!1);return e.DOM.addEventListener("pointerdown",i),e.DOM.addEventListener("pointerup",i),e.DOM.addEventListener("pointermove",i),e.DOM.addEventListener("mousedown",i),e.DOM.addEventListener("mouseup",i),e.DOM.addEventListener("mousemove",i),e.onWheel((t=>{t.stopPropagation(),t.wheelDelta>0?e.setTop(e.getOffsetTop()+10):e.setTop(e.getOffsetTop()-10)})),t.add(e),{menu:e,width:0,directionX:"left"}}onMenuClick(t,e,i,s,o,n){return()=>{const r=i.menu;o&&o(t);const h=r.DOM.getElementsByClassName(`${k.prefix}g-menu`);for(let t of h)r.DOM.removeChild(t);if(s){const o=this.createMenu(r);o.directionX=i.directionX,o.menu.setStyle({display:"flex"}).setLeft(r.DOM.offsetWidth+2).setTop(26*e),"right"===i.directionX&&setTimeout((()=>{o.menu.setLeft(-o.menu.getClientWidth()-3)}),0),this.addItemInMenu(t,o,s,n)}else n&&n()}}addItemInMenu(t,e,i,s){const o=e.menu;let n=0;for(let r in i){const h=i[r],l=new k;if(h){const{label:i,callback:d,subMenu:a}=h;l.setStyle({height:"18px",width:"100%",color:"white",fontSize:"13px",cursor:"pointer",borderRadius:"3px",padding:"4px",textAlign:"center"}).innerText(i),l.onMouseover((()=>{l.setStyle({backgroundColor:"#505050"})})),l.onMouseout((()=>{l.setStyle({backgroundColor:"rgb(59, 59, 59)"})}));const u=Math.trunc(i.length/5);if(u>=1){const t=88*u+i.length%5*.1*88;o.getClientWidth()<t&&o.setWidth(t),e.width=t}else e.width=88;if(a){const t=new k;t.setStyle({position:"absolute",width:"3px",height:"18px",right:"3px",top:26*(parseInt(r)-n)+1*n+4+"px",background:"#61ff3c",borderRadius:"5px"}),l.add(t)}l.onClick(this.onMenuClick(t,parseInt(r)-n,e,a,d,s))}else n+=1,l.setStyle({backgroundColor:"#919191",width:"calc( 100% - 10px )",height:"1px",marginLeft:"5px",marginRight:"5px"});o.add(l)}}showMenu(t,e,i){const s=t.menu,o=this.events.getParentScale(),n=this.rootDom.getClientWidth();s.setStyle({transform:`scale(${o})`,transformOrigin:"left top"}),(t.width+e)*o>n?(s.setLeft((e-t.width)*o).setTop(i*o),t.directionX="right"):(s.setLeft(e*o).setTop(i*o),t.directionX="left"),setTimeout((()=>{s.setStyle({display:"flex"})}),0)}openContextMenu({x:t,y:e},i){this.contextMenu.menu.innerText(""),this.addItemInMenu({x:t,y:e},this.contextMenu,i,(()=>{this.closeContextMenu()})),this.showMenu(this.contextMenu,t,e),this.isShowContextMenu=!0}closeContextMenu(){this.contextMenu.menu.hide(),this.isShowContextMenu=!1}getContextMenu(t){const e=t.graph,i=e.getNodeClassInfo(),s=t=>{const e=this.events.getScale();return i=>{this.events.dispatch(p.AddNode,t,{x:(i.x-this.events.viewPosition.x)/e,y:(i.y-this.events.viewPosition.y)/e})}},o=[],n={};for(let a in i){const{label:t,path:e,notAddContextMenu:r}=i[a];if(r)continue;const h={label:t,callback:s(a)};if(""===e)o.push(h);else{const t=e.split("/");let i="";for(let e in t){const s=t[e],r=`${i}_${s}`;if(0===parseInt(e)){if(!n[r]){const t=[];n[r]=t,o.push({label:s,subMenu:t})}}else if(!n[r]){const t=n[i],e=[];n[r]=e,t.push({label:s,subMenu:e})}if(parseInt(e)===t.length-1){n[r].push(h)}i=r}}}const r=[],h=e.externalGraph,l=this.events.getScale();for(let a in h){const{name:i,data:s}=h[a];r.push({label:i,callback:o=>{const n=new St;n.deserialize(s);const r=t.addNode(e.subGraphType,{x:(o.x-this.events.viewPosition.x)/l,y:(o.y-this.events.viewPosition.y)/l,z:0});r&&(r.setSubGraph(n),r.refreshViewer(),r.getLabel=()=>i)}})}const d=[{label:"添加节点",subMenu:o}];return 0!==r.length&&d.push({label:"游离子图",subMenu:r}),d}openAssociativeMenu(t,e,i,s){const o=[];this.associativeMenu.menu.innerText("");for(let{type:n,label:r,path:h,associativeNode:l}of s)o.push({label:r,callback:()=>{t.viewer&&(i.x-=t.viewer.events.viewPosition.x,i.y-=t.viewer.events.viewPosition.y),this.events.dispatch(p.AddNode,n,i)}});0!==o.length&&(this.addItemInMenu(i,this.associativeMenu,o,(()=>{this.closeAssociativeMenu()})),this.showMenu(this.associativeMenu,i.x,i.y))}closeAssociativeMenu(){this.associativeMenu.menu.hide()}openNodePanel(t){this.nodePanel.show(t)}}class tt extends ${constructor(t){super(),i(this,"viewer"),i(this,"viewStart",null),i(this,"viewEnd",null),this.viewer=t,this.setStyle({position:"absolute",right:"10px",bottom:"10px",width:"304px",height:"204px",background:"black",opacity:"0.8",borderRadius:"10px",cursor:"pointer"});const e=window.devicePixelRatio;this.setAttribute("width",""+304*e),this.setAttribute("height",""+204*e),this.ctx.scale(e,e);let s=()=>{this.render(),requestAnimationFrame(s)};s(),this.initEvents()}initEvents(){this.onDblClick((t=>{t.stopPropagation()}));let t=null;this.onMousedown((e=>{e.stopPropagation(),t={x:e.offsetX,y:e.offsetY},this.setViewPosition({x:e.offsetX,y:e.offsetY})})),this.onMousemove((e=>{null!==t&&(e.stopPropagation(),this.setViewPosition({x:e.offsetX,y:e.offsetY}))})),document.addEventListener("mouseup",(e=>{t=null}))}setViewPosition(t){const{Xscale:e,Yscale:i,viewStart:s,viewEnd:o,minX:n,minY:r}=this.getViewInfo();let h={x:-n,y:-r},l=(t.x-Math.abs(o.x-s.x)/2)/e,a=(t.y-Math.abs(o.y-s.y)/2)/i;const u=this.viewer.events.getScale();h={x:(h.x-l)*u,y:(h.y-a)*u},this.viewer.events.viewPosition=h;this.viewer.getRenderByTarget(d.Node).setPosition()}getViewInfo(){const t=this.viewer.graph.getNodes(),e=this.viewer.rootDom.DOM.getBoundingClientRect();t.sort(((t,e)=>t.position.x-e.position.x));let i=t[t.length-1].position.x;const s=t[0].position.x;t.sort(((t,e)=>t.position.y-e.position.y));let o=t[t.length-1].position.y;const n=t[0].position.y;o-n<e.height&&(o=n+e.height),i-s<e.width&&(i=s+e.width);const r=300/(i-s),h=200/(o-n);const l=this.viewer.events.getScale(),d=this.viewer.events.viewPosition,a={x:(-d.x/l-s)*r,y:(-d.y/l-n)*h};this.viewStart=a;const u={x:a.x+e.width*r/l,y:a.y+e.height*h/l};return{Xscale:r,Yscale:h,viewStart:a,viewEnd:u,minX:s,minY:n,getMiniPosition:t=>({x:(t.position.x-s)*r,y:(t.position.y-n)*h})}}render(){this.ctx.clearRect(0,0,304,204);const t=this.viewer.graph.getNodes();if(!t.length)return;const{viewStart:e,viewEnd:i,getMiniPosition:s}=this.getViewInfo();this.ctx.beginPath(),this.ctx.lineWidth=2,this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x,i.y),this.ctx.lineTo(i.x,i.y),this.ctx.lineTo(i.x,e.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke(),this.ctx.closePath(),t.forEach((t=>{let e=s(t);this.viewer.graph.checkNodeRuned(t)?(this.ctx.fillStyle=E.style.NodeRunningColor,this.ctx.strokeStyle=E.style.LineRunningColor):(this.ctx.fillStyle=E.style.NodeHighLightColor,this.ctx.strokeStyle="white"),this.ctx.fillRect(e.x,e.y,4,4),this.ctx.lineWidth=1,t.outputs.forEach((t=>{t.link&&t.link.forEach((t=>{this.ctx.beginPath(),this.ctx.moveTo(e.x+2,e.y+2);let i=s(t.target.node);this.ctx.lineTo(i.x+2,i.y+2),this.ctx.stroke(),this.ctx.closePath()}))}))}))}}const et=class t{static error(e=""){t.msg(e,"#fc5d65","#ffedee")}static info(e=""){t.msg(e,"#919398","#eef2fb")}static success(e=""){t.msg(e,"#7ec050","#f2f9ec")}static warning(e=""){t.msg(e,"#DCA550","#fcf6ed")}static msg(e="",i="#000",s="#fff"){e||(e="提示！");let o=new k,n=20;t.msgs.forEach((t=>{n+=t.DOM.getBoundingClientRect().height,n+=10})),o.setBackgroundColor(s).setColor(i).addClass("all-center").addClass("alert-msg-global").setPosition("fixed").setTop("0px").setHeight("40px").setWidth("200px","min").setBorderRadius("10px").setPaddingLeft("20px").setPaddingRight("20px").innerText(e),o.setStyle({lineHeight:"40px",opacity:"0",zIndex:"2001",textAlign:"center",transition:"top 0.5s ease-in-out,opacity 0.5s ease-in-out",fontWeight:"bold"}),setTimeout((()=>{o.setLeft(`calc(50% - ${o.DOM.getBoundingClientRect().width/2}px)`)}),0),setTimeout((()=>{o.setStyle({opacity:"1",top:n+"px"})}),200),document.body.appendChild(o.DOM),t.msgs.push(o),setTimeout((()=>{o.setStyle({opacity:"0",top:"0px"})}),2500),setTimeout((()=>{document.body.removeChild(o.DOM)}),3e3),setTimeout((()=>{t.msgs=t.msgs.filter((t=>{}))}),3200)}};i(et,"msgs",[]);let it=et;const st=class t{constructor(t=null,e=null,s={controlShow:!0,searchBoxShow:!0,miniMapShow:!0,nodeIndexShow:!0,readonly:!1}){var o;i(this,"rootDom"),i(this,"graph"),i(this,"runMode",!1),i(this,"events"),i(this,"managers",{}),i(this,"renderTargetMap",{[d.Node]:a.Dom,[d.Link]:a.Svg,[d.UI]:a.DomUI}),i(this,"ActiveNodes",[]),i(this,"tools",{}),i(this,"animate",0),i(this,"customContextMenuFuncs",[]),i(this,"option"),vt.initDefaultWidget(),this.rootDom=new k,t||(this.runMode=!0,t=this.rootDom.DOM),t=null!=t?t:this.rootDom.DOM,this.rootDom.DOM=t,this.rootDom.setStyle({overflow:"hidden",userSelect:"none",webkitUserSelect:"none",position:"relative"}),t.addEventListener("dragstart",(t=>{t.preventDefault()})),this.graph=null!=e?e:new St,this.graph.viewer=this,this.events=new A(this.rootDom,this);let n=[U,G,Z];this.runMode&&(n=[G]),this.rootDom.setId(this.graph.id),this.rootDom.setAttribute("graph-id",this.graph.id);for(let i of n){const t=new i(this.rootDom,this.events);this.managers[t.type]=t}this.initEventListener();const{controlShow:r=!0,searchBoxShow:h=!0,miniMapShow:l=!0,nodeIndexShow:u=!0,readonly:p=!1}=s;if(this.option={controlShow:r,searchBoxShow:h,miniMapShow:l,nodeIndexShow:u,readonly:p},this.option.readonly&&this.events.setReadOnly(!0),!this.runMode){if(this.option.searchBoxShow){let t=new j(this);this.rootDom.add(t),this.tools.searchBox=t}if(this.option.controlShow){let t=new _(this.graph,this.events);this.rootDom.add(t),this.tools.control=t}if(this.option.miniMapShow){let t=new tt(this);this.rootDom.add(t),this.tools.miniMap=t}this.graph.parentNode&&(null==(o=this.tools.miniMap)||o.hide()),(null==s?void 0:s.backgroundColor)&&this.setBackground(s.backgroundColor,"Color"),(null==s?void 0:s.backgroundImage)&&this.setBackground(s.backgroundImage,"Image")}}get registerNode(){return this.graph.registerNode.bind(this.graph)}get registerWidget(){return vt.registerWidget.bind(this.graph)}get registerExternalGraph(){return this.graph.registerExternalGraph.bind(this.graph)}initEventListener(){document.addEventListener("keydown",(e=>{"Delete"==e.code&&t.ActiveNode&&"stop"==this.graph.runningStatus&&this.removeNode(t.ActiveNode.node.id)}));const e={x:0,y:0};document.onkeydown=e=>{if("Delete"===e.key&&(t.ActiveNode&&this.removeNode(t.ActiveNode.node.id),this.ActiveNodes.length>0))for(const t of this.ActiveNodes)this.removeNode(t.node.id)},this.events.add(u.OpenContextMenu,(({position:e,type:i,target:s})=>{const o=this.getRenderByTarget(d.UI);if(this.graph.isInSubgraph(e))return void o.closeContextMenu();if(this.graph.parentNode){const t=this.graph.parentNode.widgets[0],i=t.viewer.events.getParentScale();if(e.x<0||e.y<0||e.x>t.viewerDom.getClientWidth()/i||e.y>t.viewerDom.getClientHeight()/i)return void o.closeContextMenu()}if(!o)return;let n=[];switch(i){case B.Widget:const e=s.widget;if(e.getContextMenu){n=e.getContextMenu();break}return this.events.dispatch(u.CloseContextMenu),!1;case B.Slot:n=[...s.slotRender.getContextMenu()];case B.Node:const i=s.nodeRender;n=[...n,{label:"运行顺序",subMenu:[{label:"触发条件",callback:()=>{i.node.addInput({label:"触发条件",valueType:[wt],options:{remove:!0}})}},{label:"执行后",callback:()=>{i.node.addOutput({label:"执行后",valueType:wt,options:{remove:!0}})}}]}];const r=E.nodeStyles;let h=[];for(const t of r)h.push({label:t.name,callback:()=>{i.node.setOption("nodeColor",t.nodeColor),i.node.setOption("nodeTitleColor",t.nodeTitleColor),i.node.setOption("nodeFontColor",t.nodeFontColor),i.refresh()}});n=[...n,null,{label:"颜色",subMenu:h}],n=[...n,null,...i.getContextMenu()],this.ActiveNodes.length&&(n=[...n,null,{label:"批量操作",subMenu:[{label:`克隆${this.ActiveNodes.length}个节点`,callback:()=>{let e=[];this.ActiveNodes.forEach((t=>{var i;let s=this.cloneNode(t.node.id);null==(i=null==s?void 0:s.render)||i.setHighLight(),e.push(null==s?void 0:s.render)})),t.ActiveNode=void 0,this.ActiveNodes.forEach((t=>{t.cancelHighLight()})),this.ActiveNodes=e}},{label:`删除${this.ActiveNodes.length}个节点`,callback:()=>{t.ActiveNode=void 0,this.ActiveNodes.forEach((t=>{this.removeNode(t.node.id)})),this.ActiveNodes=[]}},{label:"合并到子图",callback:t=>{this.mergeToSubgraph(this.ActiveNodes)}}]}]);case B.None:n=n.length>0?[...o.getContextMenu(this),null,...n]:[...o.getContextMenu(this)]}if(this.graph.parentNode&&(0!==this.graph.parentNode.inputs.length||0!==this.graph.parentNode.outputs.length)){const t=this.getRenderByTarget(d.Node),e=this.graph.parentNode,i=[],s=[],o=[];if(0!==e.outputs.length){let s=!1;for(let o of e.outputs)o.subGraphNode||(i.push({label:o.label,callback:e=>{var i;const s=this.addNode(this.graph.subGraphOutputType,e);s.setParentSlot(o),null==(i=t.getNodeRender(s.id))||i.refresh()}}),s=!0);s&&o.push({label:"外部输出",subMenu:i})}if(0!==e.inputs.length){o.push({label:"外部输入",subMenu:s});for(let i of e.inputs)s.push({label:i.label,callback:e=>{var s;const o=this.addNode(this.graph.subGraphInputType,e);o.setParentSlot(i),null==(s=t.getNodeRender(o.id))||s.refresh()}})}n=[...n,{label:"子图插槽",subMenu:o}]}for(let t of this.customContextMenuFuncs)n=[...n,...t({position:e,type:i,target:s})];o.openContextMenu(e,n)})),this.events.add(u.CloseContextMenu,(()=>{const t=this.getRenderByTarget(d.UI);t&&t.closeContextMenu()})),this.events.add(u.DragNodeStart,((t,{nodeRender:i})=>{const s=this.events.getScale();e.x=t.x/s-i.node.position.x,e.y=t.y/s-i.node.position.y})),this.events.add(u.DragNodeMove,((t,{nodeRender:i})=>{const s=this.getRenderByTarget(d.Link),o=this.getRenderByTarget(d.Node);if(!s||!o)return;const n=this.events.getScale(),r={x:t.x/n-e.x,y:t.y/n-e.y,z:0},h=i.node;if(this.ActiveNodes.indexOf(i)>-1){const t={x:r.x-h.position.x,y:r.y-h.position.y};this.ActiveNodes.forEach((e=>{const i={x:e.node.position.x+t.x,y:e.node.position.y+t.y,z:0};e.setPosition(i.x,i.y),e.node.setPosition(i)}))}else i.setPosition(r.x,r.y),h.setPosition(r);s.refresh()})),this.events.add(u.DragSlotStart,((t,{nodeRender:e,slotRender:i})=>{var s,n;if("running"===this.graph.runningStatus)return;const r=this.getRenderByTarget(d.Link),h=this.getRenderByTarget(d.Node);if(!r||!h)return;r.displayTempLine(!0);const l=i.slot;if(l.type===o.INPUT&&l.link){const t=l.link.origin,i=l.link;r.removeLink(i.id),this.graph.removeLink(i),null==(s=h.getNodeRender(i.originNode.id))||s.refresh(),null==(n=h.getNodeRender(i.targetNode.id))||n.refresh(),this.events.mouseInfo.target={nodeRender:e,slotRender:h.getSlotRender(t.node.id,t.index,!0)}}})),this.events.add(u.DragSlotMove,((t,{nodeRender:e,slotRender:i})=>{const s=this.getRenderByTarget(d.Link),n=this.getRenderByTarget(d.Node);if(!s||!n)return;const r=i.slot;let h=i.getPosition(),l=i.getPosition(),a=!0;r.type===o.INPUT?(h=t,a=!1):l=t,s.setTempLine(h,l,a)})),this.events.add(u.DragSlotEnd,((t,{nodeRender:e,slotRender:i})=>{const s=this.getRenderByTarget(d.Link);if(s){switch(s.displayTempLine(!1),this.events.mouseInfo.enterType){case B.Node:break;case B.Slot:const t=this.events.mouseInfo.enterTarget;if(i.slot.type===t.slot.type)return;if(i.slot.node===t.slot.node)return;i.slot.type===o.INPUT?this.addLink(t.slot.node.id,t.slot.index,i.slot.node.id,i.slot.index):this.addLink(i.slot.node.id,i.slot.index,t.slot.node.id,t.slot.index);case B.None:}s.refresh()}})),this.events.add(u.DragViewMove,(t=>{const e=this.getRenderByTarget(d.Link),i=this.getRenderByTarget(d.Node);e&&i&&(i.setPosition(),e.refresh())})),this.events.add(u.ViewScale,(t=>{const e=this.getRenderByTarget(d.Link);this.getRenderByTarget(d.Node).setPosition(),e.refresh()})),this.events.add(u.MouseDown,(()=>{var e;if(this.ActiveNodes.length){for(const t of this.ActiveNodes)t.cancelHighLight();this.ActiveNodes=[]}t.ActiveNode&&!this.graph.checkNodeRuned(t.ActiveNode.node)&&(null==(e=t.ActiveNode)||e.cancelHighLight(),t.ActiveNode=void 0)})),this.events.add(u.NodeDown,((e,i)=>{this.getRenderByTarget(d.UI).closeContextMenu(),t.ActiveNode&&!this.graph.checkNodeRuned(t.ActiveNode.node)&&-1==this.ActiveNodes.indexOf(i)&&(t.ActiveNode.cancelHighLight(),this.ActiveNodes.forEach((t=>{t.cancelHighLight()})),this.ActiveNodes=[]),i.setHighLight(),i.node.events.dispatch(c.Down,i),t.ActiveNode=i})),this.events.add(u.SelectedNode,((t,e)=>{const i=this.managers.DomRender.getAllNodes();this.ActiveNodes=[];const s=this.events.getScale();for(const o of i){const i=o.node.position.x*s+this.events.viewPosition.x,n=o.node.position.y*s+this.events.viewPosition.y,r=[i,i+o.getContent().getClientWidth()*s],h=[n,n+o.getContent().getClientHeight()*s],l=[t.x,e.x],d=[t.y,e.y],a=(t,e)=>{let i=[Math.min(...t),Math.min(...e)],s=[Math.max(...t),Math.max(...e)];return Math.max(...i)<=Math.min(...s)};a(r,l)&&a(h,d)?(this.ActiveNodes.push(o),o.setHighLight()):o.cancelHighLight()}})),this.events.add(u.OpenAssociativeMenu,((t,{nodeRender:e,slotRender:i})=>{const s=this.getRenderByTarget(d.UI);if(!s)return;const o=e.node;if(o.associativeNode.length>0){const e=[],n=this.graph.getNodeClassInfo();for(let t in n)-1!==o.associativeNode.indexOf(t)&&e.push(n[t]);s.openAssociativeMenu(o,i.slot,t,e)}})),this.events.add(u.CloseAssociativeMenu,(()=>{const t=this.getRenderByTarget(d.UI);t&&t.closeAssociativeMenu()})),this.events.add(u.DoubleLeftClick,((t,e,i)=>{const s=this.getRenderByTarget(d.UI);if(s&&e.type===B.Node){const t=e.target.nodeRender;this.focusOnNode(t.node.id,!1,(()=>{s.openNodePanel(t)}))}})),this.events.add(p.AddNode,((t,e={x:0,y:0,z:0},i={},s={})=>{this.addNode(t,e,i,s)})),this.events.add(p.RemoveNode,(t=>{this.removeNode(t)})),this.events.add(p.CloneNode,(e=>{var i,s;let o=this.cloneNode(e);null==(i=t.ActiveNode)||i.cancelHighLight(),null==(s=null==o?void 0:o.render)||s.setHighLight()})),this.events.add(p.AddNodeInput,((t,e)=>{t.node.addInput(e),t.refresh()})),this.events.add(p.AddNodeOutput,((t,e)=>{t.node.addOutput(e),t.refresh()})),this.events.add(p.FocusOnNode,((t,e=!0,i)=>{this.focusOnNode(t,e,i)})),this.events.add(p.RemoveNodeSlot,(t=>{const e=t.slot;this.removeSlot(e)}))}getRenderByTarget(t){return this.managers[this.renderTargetMap[t]]}getNodeManager(){return this.managers.DomRender}addNode(t,e={x:0,y:0,z:0},i={},s={}){const o=this.graph.createNode(t,e,i,s),n=this.getRenderByTarget(d.Node);if(!n)return null;let r=n.addNode(o);return o.setRender(r),o.setViewer(this),o}addLink(t,e,i,s){const o=this.getRenderByTarget(d.Link),n=this.getRenderByTarget(d.Node);if(!o||!n)return null;const r=this.graph.getNode(t),h=this.graph.getNode(i);if(!r||!h)return;if(r.outputs.length<=e||h.inputs.length<=s)return;const l=h.inputs[s].link,a=this.graph.addLink(r,e,h,s);if(!a)return;if(l){o.removeLink(l.id);const t=n.getSlotRender(l.originNode.id,l.origin.index,!0);null==t||t.setLinked(!1)}const u=n.getNodeRender(t),p=n.getNodeRender(i);if(!u||!p)return;const c=u.getOutput(e),g=p.getInput(s);c&&g&&(o.addLink(a,c,g),u.refresh(),p.refresh())}cloneNode(t){const e=this.graph.getNode(t);if(!e)return;if(e.options.notClone)return;const i=20,s=20;let o=e.serialize();o.id=ft.createId(),o.position=[e.position.x+i,e.position.y+s,e.position.z],this.graph.nodeManager.deserializeNode(o);const n=this.graph.getNode(o.id);let r=this.getRenderByTarget(d.Node).addNode(n);return n.setRender(r),n.setViewer(this),n.deserialize(o),n}removeNode(t){const e=this.getRenderByTarget(d.Link),i=this.getRenderByTarget(d.Node);if(!e||!i)return;const s=this.graph.getNode(t);if(s){for(let t of s.getAllLinks())e.removeLink(t.id);i.removeNode(t),this.graph.removeNode(t),i.refresh()}}removeLink(t){const e=this.getRenderByTarget(d.Link),i=this.getRenderByTarget(d.Node);e&&i&&(this.graph.removeLinkById(t),e.removeLink(t),i.refresh())}setScale(t){this.events.setScale(t)}refresh(t=!1){const e=this.graph.getNodes(),i=this.getRenderByTarget(d.Node);if(e.forEach((t=>{if(!i)return null;let e=i.addNode(t);t.setRender(e),t.setViewer(this)})),this.runMode)return;const s=this.graph.getLinks(),o=this.getRenderByTarget(d.Link);s.forEach((t=>{const e=i.getNodeRender(t.originNode.id),s=i.getNodeRender(t.targetNode.id);if(!e||!s)return;const n=e.getOutput(t.origin.index),r=s.getInput(t.target.index);n&&r&&(o.addLink(t,n,r),e.refresh(),s.refresh())})),e.length>0&&t&&this.focusOnNode(e[0].id,!1)}serialize(){let t=this.graph.serialize();return Object.assign({viewPosition:this.events.viewPosition},t)}deserialize(t){this.graph.deserialize(t);const e=this.getRenderByTarget(d.Node);t.viewPosition&&(this.events.viewPosition=t.viewPosition,e.setPosition()),this.refresh()}clearAll(){this.graph.getNodes().forEach((t=>{this.graph.removeNode(t.id)}));const t=this.getRenderByTarget(d.Node);this.getRenderByTarget(d.Link).clear(),t.root.clear(),setTimeout((()=>{this.events.dispatch(p.StopRun)}),0),this.events.viewPosition.x=0,this.events.viewPosition.y=0,t.setPosition(),this.events.setScale(1)}focusOnNode(t,e=!0,i){cancelAnimationFrame(this.animate);let s=null;if(t)s=this.graph.getNode(t);else{let t=this.graph.getNodes();t.length&&(s=t[0])}if(!s)return;const o=this.getRenderByTarget(d.Node),n=this.events.getScale(),r=o.getNodeRender(s.id);let h=0;const l=-s.position.x*n+this.rootDom.DOM.getBoundingClientRect().width/2-r.getContent().getBoundingClientRect().width/2,a=-s.position.y*n+this.rootDom.DOM.getBoundingClientRect().height/2-r.getContent().getBoundingClientRect().height/2,u={x:l-this.events.viewPosition.x,y:a-this.events.viewPosition.y},p=.6*this.graph.stepTime,c=this.events.viewPosition;if(!t)return this.events.viewPosition=u,void o.setPosition();let g=t=>{h||(h=t);const e=t-h,s=c.x+u.x*(e/p),n=c.y+u.y*(e/p);this.events.viewPosition={x:s,y:n},o.setPosition(),e<=p?this.animate=requestAnimationFrame(g):i&&i()};this.animate=requestAnimationFrame(g),e&&setTimeout((()=>{var t;null==(t=s.render)||t.shake()}),.5*this.graph.stepTime)}addCustomContextMenuFunc(t){this.customContextMenuFuncs.push(t)}getActiveNode(){var e;return null==(e=t.ActiveNode)?void 0:e.node}removeSlot(t){if(!t.options.remove)return;const e=this.getRenderByTarget(d.Node);if(!e)return;const i=t.node;if(t.type===o.INPUT)t.link&&this.removeLink(t.link.id);else if(t.link.length>0)for(let o of t.link)this.removeLink(o.id);this.graph.removeSlot(t);const s=e.getNodeRender(i.id);null==s||s.refresh()}setViewerMode(){this.events.setReadOnly(!0)}disbleViewerMode(){this.events.setReadOnly(!1)}setBackground(t,e="Color"){this.rootDom.setBackground(t,e)}mergeToSubgraph(t){if(!(t=>{if(1===t.length)return!1;for(let e of t){let i=!1;const s=e.node;for(let e of s.outputs){for(let s of e.link){if(-1!==t.indexOf(s.targetNode.render)){i=!0;break}if(i)break}if(i)break}if(!i){for(let e of s.inputs){if(e.link&&-1!==t.indexOf(e.link.originNode.render)){i=!0;break}if(i)break}if(!i)return!1}}return!0})(t))return it.warning("[警告]选中节点并非连续节点，无法合并为子图");const e=t[0].getPosition(),i=this.addNode(this.graph.subGraphType,{x:e.x,y:e.y,z:0}),s=i.subViewer,o=Object.assign({},e),n={},r={};for(let h of t){const e=h.node;let l=e.serialize();l.id=ft.createId(),l.position=[e.position.x-o.x,e.position.y-o.y,e.position.z],s.graph.nodeManager.deserializeNode(l);const a=s.graph.getNode(l.id);let u=s.getRenderByTarget(d.Node).addNode(a);a.setRender(u),a.setViewer(s),a.deserialize(l);for(let o of e.inputs.concat()){if(!o.link)continue;const e=o.link;if(-1===t.indexOf(o.link.originNode.render)){const t=i.addInput({label:o.label,valueType:o.valueType.concat(),options:{isVertical:!!o.options.isVertical},defaultValue:o.defaultValue}),e=s.addNode(this.graph.subGraphInputType,{x:a.position.x-128-100,y:a.position.y-40*o.index,z:a.position.z});e.setParentSlot(t),s.addLink(e.id,0,a.id,o.index),this.addLink(o.link.originNode.id,o.link.origin.index,i.id,t.index),this.removeLink(o.link.id)}else if(n[e.originNode.id]){const t=r[n[e.originNode.id]];s.addLink(t.id,e.origin.index,a.id,e.target.index)}}for(let o of e.outputs){let e=!1;for(let h of o.link.concat())if(-1===t.indexOf(h.targetNode.render)){const t=i.addOutput({label:o.label,valueType:o.valueType.concat(),options:{isVertical:!!o.options.isVertical},defaultValue:o.defaultValue}),n=s.addNode(this.graph.subGraphOutputType,{x:a.position.x+128+100,y:a.position.y-40*o.index,z:a.position.z});n.setParentSlot(t),e||(s.addLink(a.id,o.index,n.id,0),e=!0),this.addLink(i.id,t.index,h.targetNode.id,h.target.index)}else if(n[h.targetNode.id]){const t=r[n[h.targetNode.id]];s.addLink(a.id,h.origin.index,t.id,h.target.index)}}n[e.id]=a.id,r[a.id]=a}for(let h of t)this.removeNode(h.node.id)}getChildrenNodes(t=null){let e=[];if(t)e.push(this.graph.getChildrenNodes(t));else{this.graph.getNodes().forEach((t=>{if(0==t.inputs.length)return void e.push(this.graph.getChildrenNodes(t));let i=!1;t.inputs.forEach((t=>{t.link&&(i=!0)})),i||e.push(this.graph.getChildrenNodes(t))}))}return e}};i(st,"ActiveNode");let ot=st;var nt=(t=>(t[t.min=0]="min",t[t.window=1]="window",t))(nt||{});class rt extends N{constructor(t){var e;super(),i(this,"graph"),i(this,"viewer"),i(this,"viewerDom"),i(this,"minDom"),i(this,"mode",1),i(this,"minSize",{w:400,h:300}),i(this,"size",{w:this.minSize.w,h:this.minSize.h});const s=this.viewerDom=new k,o=new k;s.setStyle({position:"relative",top:"0px",left:"0px"}),o.setStyle({position:"absolute",top:"10px",left:"10px",width:"26px",height:"26px",backgroundColor:"rgb(26 26 26)",borderRadius:"5px",textAlign:"center",lineHeight:"23px",cursor:"pointer",color:"white"}).innerText("-"),o.onClick((()=>{this.setMode(0)}));const n=this.minDom=new k;n.onContextmenu((t=>{t.preventDefault()}));const r=new k;n.setStyle({width:"120px",height:"30px"}),r.setStyle({width:"100%",height:"100%",backgroundColor:"#6FA1FF",borderRadius:"6px",textAlign:"center",lineHeight:"30px"}),r.innerText("展开子图"),r.onMouseout((()=>{r.setBackgroundColor("#6FA1FF")})),r.onMouseover((()=>{r.setBackgroundColor("#409eff")})),r.onClick((()=>{this.setMode(1)})),n.add(r),this.add(n),this.add(s),this.graph=null!=(e=t.graph)?e:new St,t.rumMode?this.viewer=new ot(null,this.graph):this.viewer=new ot(s.DOM,this.graph),s.add(o),this.initEventListener(),this.setMode(this.mode)}initEventListener(){this.onMousedown((t=>{t.stopPropagation()})),this.onMouseup((t=>{})),this.onMousemove((t=>{})),this.onWheel((t=>{t.stopPropagation()})),this.onContextmenu((t=>{t.stopPropagation()}))}setMode(t){var e,i,s,o;switch(this.mode=t,t){case 0:if("absolute"==this.viewerDom.DOM.style.position)return void it.warning("子图正处于放大状态，请先退出子图");null==(i=null==(e=this.graph.parentNode)?void 0:e.render)||i.widgetsBox.setAlignItems("center"),this.viewerDom.hide(),this.minDom.show();break;case 1:null==(o=null==(s=this.graph.parentNode)?void 0:s.render)||o.widgetsBox.setAlignItems("inherit"),this.viewerDom.show(),this.minDom.hide()}this.refreshSize(),this.onChangeMode(t)}refreshSize(){switch(this.mode){case 0:this.setWidth(this.minDom.getClientWidth()),this.setHeight(this.minDom.getClientHeight());break;case 1:this.viewerDom.setWidth(this.size.w).setHeight(this.size.h),this.setWidth(this.size.w).setHeight(this.size.h)}}onChange(t){}getValue(){}setValue(t){}onChangeMode(t){}setGraph(t){this.graph=t,this.viewer.graph=t,this.viewer.tools.control&&(this.viewer.tools.control.graph=t)}refresh(...t){this.viewer.refresh(...t)}changeSize(t){this.size.w+=t.w,this.size.h+=t.h,this.refreshSize()}}i(rt,"widgetType","graph");class ht extends N{constructor(t){var e;super(),i(this,"DOM"),this.DOM=document.createElement("input"),this.DOM.type=null!=(e=null==t?void 0:t.type)?e:"text",(null==t?void 0:t.placeholder)&&(this.DOM.placeholder=t.placeholder),(null==t?void 0:t.title)&&(this.DOM.title=t.title),(null==t?void 0:t.value)&&(this.DOM.value=t.value),this.setStyle({flex:"1",border:"0",marginLeft:"4px",borderRadius:"5px",outline:"none",textIndent:"2px",fontSize:"14px",height:"20px",color:"black"}),this.onMousedown((t=>{t.stopPropagation()}))}onChange(t){this.DOM.addEventListener("input",(()=>{t(this.DOM.value)}))}getValue(){return this.DOM.value}setValue(t){this.DOM.value=t}}i(ht,"widgetType","input");class lt extends C{constructor(t,e){super(),i(this,"label"),i(this,"value"),this.value=e.value,this.label=e.label,this.addClass("select-option").setPadding("5px 10px").setFontSize(14).setBorderRadius(),this.setStyle({pointerEvents:"visible"}),this.DOM.innerText=this.label,this.onMouseover((()=>{this.setBackgroundColor("#f3f4f5")})),this.onMouseout((()=>{this.setBackgroundColor("#fff")})),this.onMousedown((e=>{e.stopPropagation(),t.checked(this)}))}active(t=!0){t?this.setColor("#409EFF"):this.setColor("#303133")}}class dt extends C{constructor(t){super(),this.addClass("select-dropdown").setStyle({position:"absolute",left:"2px",top:t,border:"1px solid #ccc",width:"100%",minHeight:"30px",maxHeight:"300px",boxSizing:"border-box",cursor:"pointer",color:"#656464",overflowY:"auto",zIndex:"1"}).setBorderRadius().setBoxShadow("#ccc 0px 0px 5px 1px").setBackgroundColor("#fff"),this.onWheel((t=>{t.stopPropagation()}))}}class at extends C{constructor(t){var e,s,o,n;super(),i(this,"input"),i(this,"value"),i(this,"options"),i(this,"multiple"),i(this,"disabled"),i(this,"dropdown"),i(this,"activeOptions"),i(this,"onChangeCallback"),this.addClass("select").setStyle({position:"relative",padding:"0 3px"}),this.multiple=null!=(e=null==t?void 0:t.multiple)&&e,this.disabled=null!=(s=null==t?void 0:t.disabled)&&s,this.value=(null==t?void 0:t.value)&&!Array.isArray(t.value)?[t.value]:[],this.options=null!=(o=null==t?void 0:t.options)?o:[],this.activeOptions=[],this.onChangeCallback=null!=(n=null==t?void 0:t.onChangeCallback)?n:null,this.input=new T("","请选择"),this.input.DOM.style.cursor="pointer",this.input.setColor("black"),this.input.onClick((t=>{t.preventDefault(),this.dropdown.toggle()})),this.add(this.input),this.dropdown=new dt(`${this.input.DOM.clientHeight+25}px`),this.add(this.dropdown),this.setValue(this.value)}setValue(t){this.value=t;const e=this.getLabel();this.input.setValue(e.join()),this.dropdown.hide(),this.dropdown.clear(),this.options.forEach((t=>{const e=new lt(this,t);this.dropdown.add(e),this.hasValue(t.value)&&(this.activeOptions.push(e),e.active())})),this.onChangeCallback&&this.onChangeCallback(this.value)}onChange(t){return this.onChangeCallback=t,this}addOption(t){return this.dropdown.add(t),this}checked(t){if(this.multiple){const e=this.activeOptions.indexOf(t);if(e>-1){this.activeOptions[e].active(!1),this.activeOptions.splice(e,1);const i=this.value.indexOf(t.value);this.value.splice(i,1)}else this.activeOptions.push(t),t.active(),this.value.push(t.value)}else this.activeOptions.length&&this.activeOptions[0].active(!1),this.activeOptions[0]=t,t.active(),this.value[0]=t.value,this.dropdown.toggle();const e=this.getLabel();this.input.setValue(e.join()),this.onChangeCallback&&this.onChangeCallback(this.value)}getLabel(t){var e;if(void 0===t){const t=[];return this.options.forEach((e=>{this.hasValue(e.value)&&t.push(e.label)})),t}{let i=this.options.find((e=>e.value===t));return null!=(e=null==i?void 0:i.label)?e:""}}getValue(){return this.multiple?this.value:this.value[0]}hasValue(t){return this.value.indexOf(t)>-1}}class ut extends N{constructor(t){super(),i(this,"DOM"),i(this,"selectInstance"),this.selectInstance=new at(t),this.DOM=this.selectInstance.DOM}onChange(t){this.selectInstance.onChange((e=>{t(e)}))}getValue(){return this.selectInstance.value}setValue(t){this.selectInstance.setValue(t)}setOptions(t){this.selectInstance.dropdown.clear(),this.selectInstance.options=t,t.forEach((t=>{const e=new lt(this.selectInstance,t);this.selectInstance.dropdown.add(e),this.selectInstance.hasValue(t.value)&&(this.selectInstance.activeOptions.push(e),e.active())}))}}i(ut,"widgetType","select");class pt extends C{constructor(t){var e,s,o,n,r,h,l,d,a;super(),i(this,"input"),i(this,"value"),i(this,"activeText"),i(this,"inactiveText"),i(this,"activeValue"),i(this,"inactiveValue"),i(this,"activeColor"),i(this,"inactiveColor"),i(this,"disabled"),i(this,"activeSpan"),i(this,"inactiveSpan"),i(this,"coreSpan"),i(this,"switchSpan"),i(this,"onChangeCallback"),this.addClass("switch").setStyle({whiteSpace:"nowrap",textAlign:"right"}),this.value=null!=(e=null==t?void 0:t.value)&&e,this.activeText=null!=(s=null==t?void 0:t.activeText)?s:"",this.inactiveText=null!=(o=null==t?void 0:t.inactiveText)?o:"",this.activeValue=null==(n=null==t?void 0:t.activeValue)||n,this.inactiveValue=null!=(r=null==t?void 0:t.inactiveValue)&&r,this.activeColor=null!=(h=null==t?void 0:t.activeColor)?h:"#409EFF",this.inactiveColor=null!=(l=null==t?void 0:t.inactiveColor)?l:"#C0CCDA",this.disabled=null!=(d=null==t?void 0:t.disabled)&&d,this.input=new T("","请选择"),this.input.DOM.setAttribute("type","hidden"),this.inactiveSpan=new L,this.activeSpan=new L,this.coreSpan=new L,this.switchSpan=new L,this.onChangeCallback=null!=(a=null==t?void 0:t.onChangeCallback)?a:null,this.add(this.input),this.initSwitchDom()}initSwitchDom(){this.inactiveText&&(this.inactiveSpan.innerText(this.inactiveText),this.inactiveSpan.setStyle({marginRight:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.inactiveColor,lineHeight:"20px"}),this.add(this.inactiveSpan)),this.coreSpan.setStyle({position:"absolute",top:"2px",display:"block",borderRadius:"100%",width:"16px",height:"16px",backgroundColor:"#FFFFFF"});let t=this.value?this.activeColor:this.inactiveColor;this.switchSpan.setStyle({position:"relative",width:"40px",backgroundColor:t,display:"inline-block",height:"20px",borderRadius:"10px",boxSizing:"border-box",cursor:"pointer",transition:"border-color .3s,background-color .3s",verticalAlign:"middle"}),this.switchSpan.add(this.coreSpan),this.value?this.coreSpan.setRight(3):this.coreSpan.setLeft(3),this.add(this.switchSpan),this.switchSpan.onMousedown((t=>{t.stopPropagation(),this.value=!this.value,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)),this.onChangeCallback&&this.onChangeCallback(this.value)})),this.activeText&&(this.activeSpan.innerText(this.activeText),this.activeSpan.setStyle({marginLeft:"10px",height:"20px",display:"inline-block",fontSize:"14px",fontWeight:"500",cursor:"pointer",verticalAlign:"middle",color:this.activeColor,lineHeight:"20px"}),this.add(this.activeSpan))}onChange(t){return this.onChangeCallback=t,this}setValue(t){t!==this.value&&(this.value=t,this.value?(this.coreSpan.setLeft(""),this.coreSpan.setRight(3),this.switchSpan.setBackgroundColor(this.activeColor),this.activeSpan.setColor(this.activeColor),this.inactiveSpan.setColor(this.inactiveColor)):(this.coreSpan.setLeft(3),this.coreSpan.setRight(""),this.switchSpan.setBackgroundColor(this.inactiveColor),this.activeSpan.setColor(this.inactiveColor),this.inactiveSpan.setColor(this.activeColor)))}}class ct extends N{constructor(t){super(),i(this,"DOM"),i(this,"switchInstance"),this.switchInstance=new pt(t);let e=new k;if(e.setStyle({display:"flex",justifyContent:"space-between"}),null==t?void 0:t.label){let i=new k,s=null==t?void 0:t.label;i.innerText(s),i.setStyle({fontSize:"14px",lineHeight:"25px",whiteSpace:"nowrap",textIndent:"5px",marginRight:"10px"}),e.add(i)}e.add(this.switchInstance),this.DOM=e.DOM,this.DOM.addEventListener("dblclick",(t=>{t.stopPropagation()}))}onChange(t){this.switchInstance.onChange((e=>{t(e)}))}setValue(t){this.switchInstance.setValue(t)}getValue(){return this.switchInstance.value}}i(ct,"widgetType","switch");const gt=class t{static initDefaultWidget(){const e=[O,rt,ht,ut,ct];for(const i in e)t.registerWidget(e[i])}static registerWidget(e){e.prototype instanceof N&&(t.widgetsTypeMap[e.widgetType]||(t.widgetsTypeMap[e.widgetType]=e))}static createWidget(e,i={}){let s=t.widgetsTypeMap[e];return e&&s?new s(i):new ht(i)}};i(gt,"widgetsTypeMap",{});let vt=gt;const xt=class t{constructor(){i(this,"graph"),i(this,"id"),i(this,"index",0),i(this,"position",{x:0,y:0,z:0}),i(this,"events"),i(this,"render",null),i(this,"viewer"),i(this,"inputs",[]),i(this,"outputs",[]),i(this,"properties",{}),i(this,"widgets",[]),i(this,"addInputsConfig",[]),i(this,"addOutputsConfig",[]),i(this,"childrenNode",[]),i(this,"_subGraph",null),i(this,"isEvent",!1),i(this,"options",{}),i(this,"_label",this.constructor.NodeLabel),this.id=t.createId(),this.events=new x}set subGraph(t){this.setSubGraph(t)}get subGraph(){return this._subGraph}get type(){return this.constructor.NodeType}get label(){return this.getLabel()}get associativeNode(){return this.constructor.AssociativeNode}static createId(){return`node_${r("0123456789",10)()}`}_initOptions(t,e,i={},s={}){this.graph=t,this.position=e;for(let o in i)this.setProperty(o,i[o]);for(let o in s)this.setOption(o,s[o]);this.isEvent&&this.initEvents()}getSlotIndex(t){let e=[];switch(t.type){case o.INPUT:e=this.inputs;break;case o.OUTPUT:e=this.outputs}return e.indexOf(t)}initEvents(){}onTrigger(){}initedRender(){}getInput(t){return this.inputs[t]}getInputs(){return this.inputs}getOutputs(){return this.outputs}getInputData(t){var e;let i=this.getInput(t);return i?!(null==i?void 0:i.link)&&i.allow_input?i.value:null==(e=i.link)?void 0:e.origin.value:null}setOutputData(t,e,i=!1){var s;let o=this.getOutput(t);o&&(o.value=e,i&&(null==(s=this.render)||s.outputs[t].refresh()))}beforeExecute(){}invoke(){this.graph.nodeRunning(this,this)}run(t=null){this.viewer&&this.viewer.events.dispatch("NodeBeforeExecute",this),this.beforeExecute(),this.onExecute(),this.afterExecute(),this.viewer&&this.viewer.events.dispatch("NodeAfterExecute",this)}doNext(t=null){this.outputs.forEach((e=>{e.link.forEach((e=>{this.graph.nodeRunning(e.targetNode,t)}))}))}afterExecute(){}onExecute(){}getOutput(t){return this.outputs[t]}addSlot(t){switch(t.node!==this&&(t.node=this),t.type){case o.INPUT:this.inputs.push(t);break;case o.OUTPUT:this.outputs.push(t)}}addInput(t){var e;let i=yt.create(this,t);return null==(e=this.render)||e.refresh(),i}addOutput(t){var e;const i=bt.create(this,t);return null==(e=this.render)||e.refresh(),i}clone(){const t=this.graph.createNode(this.type,this.position,Object.assign({},this.properties));for(let e of this.inputs)e.clone(t);for(let e of this.outputs)e.clone(t);return t}serialize(){var t,e;const i=[],s=[],o={},n=[this.position.x,this.position.y,this.position.z];for(let h of this.inputs)i.push(h.serialize());for(let h of this.outputs)s.push(h.serialize());o.clientWidth=null==(t=this.render)?void 0:t.root.getClientWidth(),o.clientHeight=null==(e=this.render)?void 0:e.root.getClientHeight(),this.options.addInput&&(o.addInput=!0),this.options.addOutput&&(o.addOutput=!0),this.options.nodeColor&&(o.nodeColor=this.options.nodeColor),this.options.nodeTitleColor&&(o.nodeTitleColor=this.options.nodeTitleColor),this.options.nodeFontColor&&(o.nodeFontColor=this.options.nodeFontColor);const r={id:this.id,type:this.type,index:this.index,_label:this._label,position:n,inputs:i,outputs:s,properties:Object.assign({},this.properties),options:o};return this.subGraph&&(r.subGraph=this.subGraph.serialize()),r}deserialize(t){}setPosition(t){this.position=t}getAllLinks(){let t=[];for(let e of this.inputs)e.link&&t.push(e.link);for(let e of this.outputs)t=t.concat(e.link);return t}getAddInputs(){return[]}getAddOutputs(){return[]}setProperty(t,e){this.properties[t]=e,this.widgets.forEach((i=>{i.propertyName==t&&(i instanceof ut&&(e=[e]),i.setValue(e))}))}setInitProperty(t,e){void 0===this.properties[t]&&(this.properties[t]=e)}getProperty(t){return this.properties[t]}getOption(t){return this.options[t]}setOption(t,e){this.options[t]=e}getLabel(){return this._label||(this._label=this.constructor.NodeLabel),this._label}setLabel(t){this._label=t}onNodeHighLight(){}addWidget(t,e,i,s){let o=null;return this.runMode?t==rt.widgetType?(e.rumMode=this.runMode,o=vt.createWidget(t,e)):o=vt.createWidget("input",this.options):o=vt.createWidget(t,e),o?(i&&(o.label=i),s&&(o.propertyName=s,o.onChange((t=>{o instanceof ut&&(t=t[0]),this.properties[s]=t}))),this.widgets.push(o),setTimeout((()=>{var t;null==(t=this.render)||t.refresh()}),0),o):null}getWidgetIndex(t){for(let e=0;e<this.widgets.length;e++)if(this.widgets[e]===t)return e;return-1}getWidget(t){let e=this.widgets[t];return e||null}setWidget(t,e){this.widgets[t]=e}removeWidget(t){let e=this.getWidget(t);e&&(e.remove(),this.widgets.splice(t,1))}renderInit(t){}setRender(t){this.render=t,this.renderInit(t)}setSubGraph(t){t&&(this._subGraph=t,t.parentNode=this)}getContextMenu(){return[]}onRemove(){}setViewer(t){this.viewer=t}};i(xt,"NodeType","Node"),i(xt,"NodeLabel","基础"),i(xt,"NodePath",""),i(xt,"AssociativeNode",[]),i(xt,"NotAddContextMenu",!1);let ft=xt;class yt{constructor(t,{label:e,valueType:s,options:n,defaultValue:r,allow_input:h,value:l,inputWidgetType:d},a=!0){i(this,"type",o.INPUT),i(this,"link",null),i(this,"label","未命名输入"),i(this,"node"),i(this,"valueType",[]),i(this,"options",{}),i(this,"defaultValue",null),i(this,"allow_input",!1),i(this,"inputWidgetType","input"),i(this,"value",""),i(this,"subGraphNode",[]),this.node=t,e&&(this.label=e),s&&(this.valueType=s),n&&(this.options=n),h&&(this.allow_input=h),d&&(this.inputWidgetType=d),l&&(this.value=l),f(r)||y(r)||(this.defaultValue=r),a&&t.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(t,{label:e,valueType:i,options:s,defaultValue:o,allow_input:n,value:r,inputWidgetType:h},l=!0){return yt.create(t,{label:e,valueType:i,options:s,defaultValue:o,allow_input:n,value:r,inputWidgetType:h},l)}static create(t,e={},i=!0){return new yt(t,e,i)}clone(t){const e=yt.create(t,{label:this.label,valueType:this.valueType.concat(),allow_input:this.allow_input,value:this.value,options:Object.assign(this.options)});return t.addSlot(e),e}update(){}destroy(){}serialize(){const t=this.link?this.link.id:null;return{type:this.type,label:this.label,link:t,valueType:this.valueType.concat(),options:Object.assign({},this.options),defaultValue:this.defaultValue,allow_input:this.allow_input,inputWidgetType:this.inputWidgetType,value:this.value}}deleteLink(){this.link=null}getLabel(){return this.label}}class bt{constructor(t,{label:e,valueType:s,options:n,defaultValue:r},h=!0){i(this,"value",null),i(this,"type",o.OUTPUT),i(this,"link",[]),i(this,"label","未命名输出"),i(this,"node"),i(this,"valueType"),i(this,"options",{}),i(this,"defaultValue",null),i(this,"subGraphNode",null),this.node=t,e&&(this.label=e),n&&(this.options=n),f(r)||y(r)||(this.defaultValue=r,this.value=r),this.valueType=s,h&&t.addSlot(this)}get index(){return this.node.getSlotIndex(this)}static deserialize(t,{label:e,valueType:i,defaultValue:s,options:o},n=!0){return bt.create(t,{label:e,valueType:i,defaultValue:s,options:o},n)}static create(t,e,i=!0){return new bt(t,e,i)}clone(t){const e=bt.create(t,{valueType:this.valueType,label:this.label,options:Object.assign(this.options)});return t.addSlot(e),e}update(){}destroy(){}serialize(){const t=[];for(let e of this.link)t.push(e.id);return{type:this.type,label:this.label,link:t,valueType:this.valueType,options:Object.assign({},this.options),defaultValue:this.defaultValue}}deleteLink(t){const e=this.link.indexOf(t);-1!==e&&this.link.splice(e,1)}hasLink(t){return-1!==this.link.indexOf(t)}getLabel(){return this.label}}class mt{constructor(t,e){i(this,"id"),i(this,"origin"),i(this,"target"),i(this,"valueType"),i(this,"index",0),i(this,"info",null),this.id=mt.createId(),this.origin=t,this.target=e,this.valueType=t.valueType,t.link.push(this),e.link=this}get originNode(){return this.origin.node}get targetNode(){return this.target.node}static createId(){return`link-${h(4)}`}static create(t,e){return new mt(t,e)}update(){}serialize(){return[this.id,this.origin.node.id,this.origin.index,this.target.node.id,this.target.index,this.valueType]}}const wt="_EventType";class St{constructor(){i(this,"subGraphType","subGraph"),i(this,"subGraphInputType","subGraphInput"),i(this,"subGraphOutputType","subGraphOutput"),i(this,"parentNode",null),i(this,"viewer",null),i(this,"id"),i(this,"version","1.00"),i(this,"nodeManager"),i(this,"externalGraph",{}),i(this,"runningStatus","stop"),i(this,"pauseNodes",[]),i(this,"eventRuns",{}),i(this,"runedNodes",[]),i(this,"runtimers",[]),i(this,"stepTime",500),i(this,"waitNodes",[]),this.id=`graph-${h(6)}`,It.get(),this.nodeManager=new Lt(this)}get inputs(){return this.parentNode?this.parentNode.inputs:null}get outputs(){return this.parentNode?this.parentNode.outputs:null}get createNode(){return this.nodeManager.createNode.bind(this.nodeManager)}get getNode(){return this.nodeManager.getNode.bind(this.nodeManager)}get removeNode(){return this.nodeManager.removeNode.bind(this.nodeManager)}get addLink(){return this.nodeManager.addLink.bind(this.nodeManager)}get removeLink(){return this.nodeManager.removeLink.bind(this.nodeManager)}get removeLinkById(){return this.nodeManager.removeLinkById.bind(this.nodeManager)}get getNodeClassInfo(){return this.nodeManager.getNodeClassInfo.bind(this.nodeManager)}get getNodes(){return this.nodeManager.getNodes.bind(this.nodeManager)}get getChildrenNodes(){return this.nodeManager.getChildrenNodes.bind(this.nodeManager)}get getLinks(){return this.nodeManager.getLinks.bind(this.nodeManager)}get registerNode(){return this.nodeManager.register.bind(this.nodeManager)}get removeSlot(){return this.nodeManager.removeSlot.bind(this.nodeManager)}serialize(){const t=this.nodeManager.serialize();return Object.assign({version:this.version},t)}deserialize({nodes:t,links:e}){this.nodeManager.deserialize({nodes:t,links:e})}start(){if("running"==this.runningStatus)return;this.runningStatus="running";let t=this.getNodes(),e=[];t.forEach((t=>{if(0==t.inputs.length)return void e.push(t);let i=!1;t.inputs.forEach((t=>{t.link&&(i=!0)})),i||e.push(t)}));let i=[];e.length&&e.forEach(((t,s)=>{if(0==s)i.push({node:t,dis:0});else{let s=t.position.x-e[0].position.x,o=t.position.y-e[0].position.y,n=Math.sqrt(s*s+o*o);i.push({node:t,dis:n})}})),i.sort(((t,e)=>t.dis-e.dis)),i.forEach(((t,i)=>{e[i]=t.node})),this.waitNodes=e,this.runByStep()}checkNodeRuned(t,e=null){if(e&&this.eventRuns[e.id])for(let i=0;i<this.eventRuns[e.id].length;i++){if(this.eventRuns[e.id][i].id==t.id)return!0}else for(let i=0;i<this.runedNodes.length;i++){if(this.runedNodes[i].id==t.id)return!0}return!1}runByStep(t=null){var e,i,s,o;let n=this.waitNodes.shift();n&&(t&&n.id==t.id&&this.eventRuns[t.id]&&this.eventRuns[t.id].length&&(this.eventRuns[t.id].forEach((t=>{var e;null==(e=t.render)||e.cancelHighLight(),this.runedNodes=this.runedNodes.filter((e=>e.id!==t.id))})),this.eventRuns[t.id]=[]),this.checkIfCanRun(n,t)?(null==(e=n.render)||e.events.dispatch(p.FocusOnNode,n.id),this.realRun(n,t),n.outputs.forEach((t=>{t.link&&t.link.length&&t.link.forEach((t=>{t.target.node&&this.waitNodes.unshift(t.target.node)}))}))):this.checkNodeRuned(n,t)||(null==(i=n.render)||i.events.dispatch(p.FocusOnNode,n.id),null==(s=n.render)||s.setHighLight(E.style.NodeHighLightColor),null==(o=n.render)||o.shake()),setTimeout((()=>{this.runByStep(t)}),this.stepTime))}checkIfCanRun(t,e=null){var i;if("running"!==this.runningStatus)return!1;if(this.checkNodeRuned(t)&&!e)return!1;if(e&&this.checkNodeRuned(t,e))return!1;let s=!0;for(let o=0;o<t.inputs.length;o++){const e=t.inputs[o];let n=!1;for(let t=0;t<this.runedNodes.length;t++){this.runedNodes[t].id==(null==(i=e.link)?void 0:i.origin.node.id)&&(n=!0)}if(n||(s=!1),s||e.link||!e.allow_input||(s=!0),!s&&!e.link&&e.valueType.indexOf(wt)>-1&&(s=!0),!s)break}if(!s)return this.sendLog(t,"等待依赖值中。。。"),!1;if(t.isEvent){for(let i=0;i<this.pauseNodes.length;i++){const s=this.pauseNodes[i];if(s.id==t.id)return!(!e||e.id!=s.id)&&(this.sendLog(t,"事件【被触发】"),!0)}return this.pauseNodes.push(t),t.onTrigger(),this.sendLog(t,"事件等待中。。。"),!1}return this.sendLog(t),t.onTrigger(),!0}nodeRunning(t,e=null){"running"===this.runningStatus&&(this.waitNodes.length?this.waitNodes.push(t):(this.waitNodes.push(t),this.runByStep(e)))}realRun(t,e=null){this.runedNodes.push(t),e&&(this.eventRuns[e.id]||(this.eventRuns[e.id]=[]),this.eventRuns[e.id].push(t));let i=window.setTimeout((()=>{var i,s,o;null==(i=t.render)||i.events.dispatch(u.LinksFresh,this.runedNodes),t.run(e),e&&(null==(s=t.render)||s.shake()),null==(o=t.render)||o.setHighLight(e?E.style.NodeEventColor:E.style.NodeRunningColor)}),this.stepTime);this.runtimers.push(i)}pause(){}stop(){var t,e;this.runningStatus="stop",this.waitNodes=[],this.getNodes().forEach((t=>{var e;null==(e=t.render)||e.cancelHighLight()}));let i=null;for(;i=this.runtimers.shift();)clearTimeout(i);null==(e=null==(t=this.runedNodes[0])?void 0:t.render)||e.events.dispatch(u.LinksFresh),this.runedNodes=[],this.pauseNodes=[]}sendLog(t,e="已运行"){var i;null==(i=t.render)||i.events.dispatch(u.AddRunLog,{node:t,msg:e})}registerExternalGraph(t,e,i){this.externalGraph[t]={id:t,name:e,data:i}}isInSubgraph(t){var e;const i=this.getNodes();if(!i.length)return!1;const s=null==(e=i[0].viewer)?void 0:e.rootDom,o=t.x+s.getOffsetLeft(),n=t.y+s.getOffsetTop();for(let r=0;r<i.length;r++){const t=i[r];if(t.subGraph){const e=t.widgets[0].viewerDom.getBoundingClientRect();if(o>e.x&&o<e.x+e.width&&n>e.y&&n<e.y+e.height)return!0}}return!1}getAllSubGraph(){const t=this.getNodes();if(!t.length)return[];let e=[];for(let i=0;i<t.length;i++){const s=t[i];if(s.subGraph){const t=s.widgets[0];e.push(t.viewer)}}return e}setStepTime(t){this.stepTime=t}}class Ct extends ft{constructor(){super(),i(this,"graphWidget"),i(this,"minSize",null),i(this,"originRect"),i(this,"exitFunc",null),i(this,"isMaxmized",!1),i(this,"addInputsConfig",[{label:"输入项",options:{remove:!0},valueType:["any"]}]),i(this,"addOutputsConfig",[{label:"输出项",options:{remove:!0},valueType:"any"}]),this.subGraph=new St,this.subGraph.parentNode=this,this.setOption("addInput",!0),this.setOption("addOutput",!0),this.graphWidget=this.addWidget("graph",{graph:this.subGraph}),this.graphWidget.onChangeMode=t=>{this.graphWidget&&t===nt.min&&setTimeout((()=>{var t;null==(t=this.render)||t.setSize(this.graphWidget.minDom.getClientWidth(),this.graphWidget.minDom.getClientHeight())}),0)},this.graphWidget.viewer.events.add(u.MouseUp,(()=>s(this,null,(function*(){}))))}get subViewer(){return this.graphWidget&&this.graphWidget.viewer?this.graphWidget.viewer:null}refreshViewer(){var t;null==(t=this.graphWidget)||t.refresh(!0)}setSubGraph(t){super.setSubGraph(t),this.graphWidget&&t&&this.graphWidget.setGraph(t)}initedRender(){var t;const e=this.render;e&&(this.minSize=e.getContent().getBoundingClientRect(),this.originRect=null==(t=this.graphWidget)?void 0:t.viewerDom.getBoundingClientRect(),e.events.add(u.ViewResize,(()=>{this.exitFunc&&this.exitFunc()})))}onNodeHighLight(){if(this.graphWidget)switch(this.graphWidget.mode){case nt.min:this.setOption("notResize",!0);break;case nt.window:this.setOption("notResize",!1)}}onRefresh(){const t=this.render;if(!t)return;let e=new k;e.innerText("+"),e.setStyle({position:"absolute",right:"6px",top:"4px",height:"25px",lineHeight:"25px",textAlign:"center",width:"25px",borderRadius:"50%",backgroundColor:"black",color:"white"}),e.onClick((()=>{this.maxmizeViewer()})),t.title.add(e)}getName(){var t;if(null==(t=this.graph)?void 0:t.parentNode){return this.graph.parentNode.getName()+" => "+this.label}return this.label}maxmizeViewer(){var t,e,i,s,o,n,r;if((null==(t=this.graphWidget)?void 0:t.mode)==nt.min)return void it.warning("子图收缩中，无法放大");const h=this.render,l=null==(e=this.graphWidget)?void 0:e.viewer,d=h.events.viewer,a=null==d?void 0:d.rootDom.getBoundingClientRect(),u={position:null==l?void 0:l.rootDom.DOM.style.position,zIndex:null==l?void 0:l.rootDom.DOM.style.zIndex,left:null==l?void 0:l.rootDom.DOM.style.left,top:null==l?void 0:l.rootDom.DOM.style.top,width:null==l?void 0:l.rootDom.DOM.style.width,height:null==l?void 0:l.rootDom.DOM.style.height},p=null==l?void 0:l.events.viewPosition,c=h.events.getScale();null==l||l.rootDom.setAbsolute(-h.events.viewPosition.y-this.position.y,-h.events.viewPosition.x-this.position.x,99999).setWidth(a.width).setHeight(a.height).setStyle({transition:"all .5s ease"}),null==(i=null==d?void 0:d.tools.miniMap)||i.hide(),null==(s=null==d?void 0:d.tools.control)||s.hide();let g=new D("退出子图");g.setStyle({zIndex:"123123",marginLeft:"10px"}),g.onClick((()=>{x()})),null==(o=null==l?void 0:l.tools.control)||o.add(g),null==(n=null==l?void 0:l.tools.miniMap)||n.show(),d.setScale(1);let v=new k;v.innerText(this.getName()).setColor(null!=(r=this.getOption("nodeColor"))?r:"white").setFontSize(30).setStyle({fontWeight:"bold",marginTop:"10px",userSelect:"none",webkitUserSelect:"none",width:"100%",textAlign:"center"}),null==l||l.rootDom.add(v),setTimeout((()=>{const t=null==l?void 0:l.graph.getNodes();t&&t.length&&(null==l||l.focusOnNode(t[0].id))}),500);let x=()=>{var t,e,i,s;this.exitFunc=null,d.setScale(c),null==l||l.rootDom.setStyle(u),d.graph.parentNode||null==(t=d.tools.miniMap)||t.show(),d.graph.parentNode&&"absolute"==d.rootDom.DOM.style.position&&(null==(e=d.tools.miniMap)||e.show()),null==(i=d.tools.control)||i.setFlex(),g.remove(),v.remove(),null==(s=null==l?void 0:l.tools.miniMap)||s.hide(),setTimeout((()=>{null==l||l.rootDom.setStyle({transition:"none"})}),500),l.events.viewPosition=p,null==l||l.getNodeManager().setPosition()};this.exitFunc=x}}i(Ct,"NodeType","subGraph"),i(Ct,"NodeLabel","子图"),i(Ct,"NodePath","子图节点");class Mt extends ft{constructor(){super(),i(this,"parentSlot",null),this.setOption("notClone",!0)}getLabel(){var t,e;return null!=(e=null==(t=this.parentSlot)?void 0:t.label)?e:"子图输出"}serialize(){var t,e;const i=super.serialize();return i.subGraphSlotIndex=null==(t=this.parentSlot)?void 0:t.index,i.subGraphSlotNodeId=null==(e=this.parentSlot)?void 0:e.node.id,i}deserialize(t){var e,i;if(!t.subGraphSlotIndex&&0!==t.subGraphSlotIndex||!t.subGraphSlotNodeId)return;const s=t.subGraphSlotIndex,o=t.subGraphSlotNodeId,n=null==(i=null==(e=this.graph)?void 0:e.parentNode)?void 0:i.graph,r=null==n?void 0:n.getNode(o);if(!r)return;const h=r.inputs[s];h&&this.setParentSlot(h)}onRemove(){this.parentSlot&&this.parentSlot.subGraphNode.splice(this.parentSlot.subGraphNode.indexOf(this),1)}setParentSlot(t){this.outputs=[],this.parentSlot=t,this.addOutput({label:this.parentSlot.label,valueType:this.parentSlot.valueType[0]}),this.parentSlot.subGraphNode.push(this)}}i(Mt,"NodeType","subGraphInput"),i(Mt,"NodeLabel","子图输出"),i(Mt,"NodePath","子图节点"),i(Mt,"NotAddContextMenu",!0);class Nt extends ft{constructor(){super(),i(this,"parentSlot",null)}getLabel(){var t,e;return null!=(e=null==(t=this.parentSlot)?void 0:t.label)?e:"子图输入"}serialize(){var t,e;const i=super.serialize();return i.subGraphSlotIndex=null==(t=this.parentSlot)?void 0:t.index,i.subGraphSlotNodeId=null==(e=this.parentSlot)?void 0:e.node.id,i}deserialize(t){var e,i;if(!t.subGraphSlotIndex&&0!==t.subGraphSlotIndex||!t.subGraphSlotNodeId)return;const s=t.subGraphSlotIndex,o=t.subGraphSlotNodeId,n=null==(i=null==(e=this.graph)?void 0:e.parentNode)?void 0:i.graph,r=null==n?void 0:n.getNode(o);if(!r)return;const h=r.outputs[s];h&&this.setParentSlot(h)}onRemove(){this.parentSlot&&(this.parentSlot.subGraphNode=null)}setParentSlot(t){this.inputs=[],this.parentSlot=t,this.addInput({label:this.parentSlot.label,valueType:[this.parentSlot.valueType]}),this.parentSlot.subGraphNode=this}}i(Nt,"NodeType","subGraphOutput"),i(Nt,"NodeLabel","子图输入"),i(Nt,"NodePath","子图节点"),i(Nt,"NotAddContextMenu",!0);class kt extends ft{constructor(){super(),i(this,"strInput"),this.setProperty("__function__","ConstString"),this.setInitProperty("value",""),this.addOutput({label:"字符串",valueType:"string"}),this.strInput=this.addWidget("input",{placeholder:"请输入字符串"},"字符串","value")}onExecute(){this.setOutputData(0,this.strInput.getValue())}}i(kt,"NodeType","ConstString"),i(kt,"NodeLabel","字符串"),i(kt,"NodePath","基础节点");class Dt extends ft{constructor(){super(),i(this,"numberInput"),i(this,"NotAutoRegister",!0),this.setProperty("__function__","ConstantNumber"),this.setInitProperty("value",0),this.addOutput({label:"value",valueType:"number"}),this.numberInput=this.addWidget("input",{type:"number",placeholder:"请输入数字"},"数字","value")}onExecute(){this.setOutputData(0,parseFloat(this.numberInput.getValue()))}}i(Dt,"NodeType","ConstantNumber"),i(Dt,"NodeLabel","数字"),i(Dt,"NodePath","基础节点");const Tt=Object.freeze(Object.defineProperty({__proto__:null,ConstString:kt,NSubGraph:Ct,NSubGraphInput:Mt,NSubGraphOutput:Nt,Number:Dt},Symbol.toStringTag,{value:"Module"})),Ot=class t{constructor(t){i(this,"nodeIndex",-1),i(this,"nodeMap",{}),i(this,"linkMap",{}),i(this,"linkIndex",-1),i(this,"undefinedType","_undefined"),i(this,"graph"),this.graph=t,this.initDefaultNode()}initDefaultNode(){const t=Tt;for(const e in t)t[e].NotAutoRegister||this.register(t[e])}register(e){e.prototype instanceof ft&&(t.nodeTypeMap[e.NodeType]||(t.nodeTypeMap[e.NodeType]=e))}createNode(e,i={x:0,y:0,z:0},s={},o={}){if(!t.nodeTypeMap[e])return;const n=t.nodeTypeMap[e];n.prototype.viewer=this.graph.viewer;const r=new n;if(r._initOptions(this.graph,i,s,o),!r.options.nodeColor&&E.createRandomStyleNode){let t=E.getRandomColor();r.setOption("nodeColor",t.nodeColor),r.setOption("nodeFontColor",t.nodeFontColor),r.setOption("nodeTitleColor",t.nodeTitleColor)}return this.addNode(r),r}addNode(t){this.nodeMap[t.id]||(this.nodeMap[t.id]=t,this.nodeIndex+=1,t.index=this.nodeIndex)}getNode(t){return this.nodeMap[t]}getNodes(){return Object.values(this.nodeMap)}reset(){this.nodeMap={},this.linkMap={},this.nodeIndex=-1,this.linkIndex=-1}removeNode(t){if(!this.nodeMap[t])return;const e=this.nodeMap[t];for(let i in this.linkMap){const t=this.linkMap[i];t.originNode!==e&&t.targetNode!==e||this.removeLink(t)}e.onRemove(),delete this.nodeMap[t]}addLink(t,e=0,i,s=0,o=!0){if(t===i)return null;const n=t.getOutput(e),r=i.getInput(s);return n&&r?this.addLinkBySolt(n,r,o):null}getLinks(){return Object.values(this.linkMap)}addLinkBySolt(t,e,i=!0){if(!this.canLink(t,e,i))return null;i&&e.link&&this.removeLink(e.link);const s=mt.create(t,e);return this.linkIndex+=1,s.index=this.linkIndex,this.linkMap[s.id]=s,s}canLink(t,e,i=!0){if(t.type!==o.OUTPUT||e.type!==o.INPUT)return!1;if(-1===e.valueType.indexOf(t.valueType)&&-1===e.valueType.indexOf("any")&&"any"!==t.valueType){e.node.id,e.index,e.valueType.join(","),t.node.id,t.index,t.valueType;let i=`【类型不匹配】[ ${t.valueType} ] => 连接至 => [ ${e.valueType.join(",")} ]`;return it.warning(i),!1}return e.node!==t.node&&!(!i&&e.link)}removeLinkById(t){this.linkMap[t]&&this.removeLink(this.linkMap[t])}removeLink(t){const e=t.origin,i=t.target;i.link===t&&e.hasLink(t)&&(i.deleteLink(),e.deleteLink(t),delete this.linkMap[t.id])}getNodeList(){return Object.values(this.nodeMap).sort(((t,e)=>t.index-e.index))}getLinkList(){return Object.values(this.linkMap).sort(((t,e)=>t.index-e.index))}serialize(){const t={nodes:[],links:[]};for(const e of this.getNodeList())t.nodes.push(e.serialize());for(const e of this.getLinkList())t.links.push(e.serialize());return t}deserialize({nodes:t,links:e}){this.reset();const i=[];for(let s of t)i.push(this.deserializeNode(s));for(let s of i)s();for(let s of e)this.deserializeLink(s)}deserializeLink([t,e,i,s,o]){if(!this.nodeMap[e]||!this.nodeMap[s])return;const n=this.nodeMap[e],r=this.nodeMap[s];this.addLink(n,i,r,o)}deserializeNode(e){var i,s;ft.prototype.runMode=null==(i=this.graph.viewer)?void 0:i.runMode;const{id:o,type:n,position:r,inputs:h,outputs:l,properties:d,options:a,subGraph:u,index:p,_label:c}=e;let g=t.nodeTypeMap[n];g||(g=ft);const v=new g;v._initOptions(this.graph,{x:r[0],y:r[1],z:null!=(s=r[2])?s:0},d,a),v.id=o,v._label=c;const x=[],f=[];h.forEach(((t,e)=>{(null==v?void 0:v.inputOptions)&&(null==v?void 0:v.inputOptions[e])&&(t=Object.assign(t,v.inputOptions[e])),x.push(yt.deserialize(v,t,!1))}));for(let t of l)f.push(bt.deserialize(v,t,!1));if(v.inputs=x,v.outputs=f,this.addNode(v),p&&(p<this.nodeIndex?v.index=this.nodeIndex:v.index=p),this.nodeIndex<p&&(this.nodeIndex=p+1),u){const t=v,e=new St;v.setSubGraph(e),e.deserialize(u),t.refreshViewer()}return()=>{v.deserialize(e)}}getNodeTypeList(){const e=[];for(let i in t.nodeTypeMap){const s=t.nodeTypeMap[i];["subGraphInput","subGraphOutput"].indexOf(i)>-1||e.push({label:s.NodeLabel,type:i})}return e}getNodeClassInfo(){const e={};for(let i in t.nodeTypeMap){const s=t.nodeTypeMap[i];e[s.NodeType]={type:s.NodeType,path:s.NodePath,label:s.NodeLabel,associativeNode:s.AssociativeNode,notAddContextMenu:s.NotAddContextMenu}}return e}removeSlot(t){const e=t.node;if(t.type===o.INPUT)t.link&&this.removeLinkById(t.link.id),e.inputs.splice(t.index,1);else{if(t.link.length>0)for(let e of t.link)this.removeLinkById(e.id);e.outputs.splice(t.index,1)}}getChildrenNodes(t){let e=[];return t.getOutputs().forEach((t=>{t.link.forEach((t=>{let i=t.target.node;this.getChildrenNodes(i),e.push(i)}))})),t.childrenNode=e,t}};i(Ot,"nodeTypeMap",{});let Lt=Ot,Rt=null;class It{constructor(){i(this,"defaultType"),i(this,"typeMap",{});const t=[{id:"any",label:"通用类型"},{id:"string",label:"字符串"},{id:"number",label:"数字"},{id:"array",label:"数组"}];for(let e of t)this.register(e);this.defaultType=t[0].id}static get(){return Rt||(Rt=new It),Rt}register(t){this.typeMap[t.id]=t}get(t){return this.typeMap[t]}}t.BaseWidget=N,t.DataTypeMananger=It,t.DomNodeRender=H,t.DomSlotRender=z,t.Graph=St,t.GraphViewer=ot,t.InputWidget=ht,t.NativeDiv=k,t.Node=ft,t.NodeInput=yt,t.NodeOutput=bt,t.SelectWidget=ut,t.WidgetsManager=vt,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
